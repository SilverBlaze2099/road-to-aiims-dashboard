<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Road to AIIMS</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            /* Static vibrant and complex gradient for the background - no dynamic image generation */
            background: linear-gradient(to bottom right, #e0f7fa, #bbdefb, #e3f2fd);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem;
            box-sizing: border-box;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        .container {
            background-color: rgba(255, 255, 255, 0.95); /* Slightly transparent white for content */
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            padding: 2.5rem;
            width: 100%;
            max-width: 1100px;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        textarea {
            min-height: 150px;
            resize: vertical;
        }
        input[type="text"], input[type="number"], input[type="date"], textarea, select { /* Added select */
            background-color: #f8fafc;
            border: 1px solid #cbd5e1;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
        }
        input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, textarea:focus, select:focus { /* Added select */
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        .data-display {
            background-color: #f0f4f7;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1.25rem;
            min-height: 120px;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-y: auto;
            max-height: 350px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            color: #334155;
        }
        .tab-button {
            padding: 0.85rem 1.8rem;
            border-radius: 0.75rem;
            font-weight: 700;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 2px solid transparent;
            background-color: #e2e8f0;
            color: #475569;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .tab-button.active {
            background: linear-gradient(to right, #60a5fa, #3b82f6);
            color: #ffffff;
            border-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(59, 130, 246, 0.3);
        }
        .tab-button:not(.active):hover {
            background-color: #d1d5db;
            color: #1e293b;
            transform: translateY(-1px);
        }
        .sub-tab-button {
            padding: 0.6rem 1.2rem;
            border-radius: 0.6rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 1px solid transparent;
            font-size: 0.95rem;
            background-color: #e0f2f7;
            color: #0d9488;
        }
        .sub-tab-button.active {
            background: linear-gradient(to right, #2dd4bf, #14b8a6);
            color: #ffffff;
            border-color: #0f766e;
            box-shadow: 0 3px 6px rgba(45, 212, 191, 0.3);
        }
        .sub-tab-button:not(.active):hover {
            background-color: #a7f3d0;
            color: #064e3b;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .sub-tab-content {
            display: none;
        }
        .sub-tab-content.active {
            display: block;
        }
        .status-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .status-message.show {
            opacity: 1;
        }
        .status-message.success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status-message.error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .status-message.info {
            background-color: #e0f2fe;
            color: #1e40af;
        }
        .chart-container {
            width: 100%;
            max-width: 700px;
            height: 350px;
            margin: 1rem auto;
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            box-sizing: border-box;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        #countdown-container {
            background: rgba(255, 255, 255, 0.7); /* Semi-transparent white for glass effect */
            backdrop-filter: blur(10px); /* Glassmorphism blur */
            border: 1px solid rgba(255, 255, 255, 0.3); /* Subtle border */
            padding: 1.5rem;
            border-radius: 1rem;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); /* Stronger, more vibrant shadow */
            color: #1a202c; /* Darker text for contrast */
            position: relative; /* For potential pseudo-elements */
            overflow: hidden; /* Ensure content stays within bounds */
        }
        #countdown-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.0) 100%);
            pointer-events: none;
            z-index: -1;
        }
        #countdown-timer {
            font-size: 2.5rem; /* text-5xl, slightly larger */
            font-weight: 800; /* Extra bold */
            color: #00796b; /* Dark teal for timer */
            margin-top: 0.5rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        #motivational-quote {
            font-style: italic;
            margin-top: 1rem;
            font-size: 1.25rem; /* text-xl, larger */
            color: #4a5568; /* Darker gray text */
            line-height: 1.5;
        }
        .chapter-button {
            display: block;
            width: 100%;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-align: left;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            background-color: #e2e8f0;
            color: #475569;
            border: 1px solid #cbd5e1;
            white-space: nowrap; /* Prevent text wrapping */
            overflow: hidden; /* Hide overflow */
            text-overflow: ellipsis; /* Show ellipsis for overflow */
        }
        .chapter-button:hover:not(.completed) {
            background-color: #d1d5db;
            transform: translateY(-1px);
        }
        .chapter-button.completed {
            color: #ffffff;
            border-color: #16a34a;
            box-shadow: 0 2px 5px rgba(34, 197, 94, 0.3);
            transform: translateY(-1px);
        }
        .chapter-button.completed:hover {
            opacity: 0.9;
        }
        /* Gradient colors for chapter buttons based on level */
        .color-level-0 { background: linear-gradient(to right, #22c55e, #10b981); } /* Beginner - Green */
        .color-level-1 { background: linear-gradient(to right, #34d399, #10b981); }
        .color-level-2 { background: linear-gradient(to right, #6ee7b7, #34d399); }
        .color-level-3 { background: linear-gradient(to right, #a7f3d0, #6ee7b7); }
        .color-level-4 { background: linear-gradient(to right, #facc15, #eab308); } /* Intermediate - Yellow */
        .color-level-5 { background: linear-gradient(to right, #fbbf24, #f59e0b); }
        .color-level-6 { background: linear-gradient(to right, #f97316, #ea580c); } /* Advanced - Orange */
        .color-level-7 { background: linear-gradient(to right, #ef4444, #dc2626); } /* Master - Red */

        .chapter-header {
            font-weight: 700;
            color: #1e293b;
            padding: 0.5rem 0;
            border-bottom: 2px solid #cbd5e1;
            margin-bottom: 1rem;
            display: grid;
            gap: 0.5rem; /* Reduced gap */
            align-items: center;
        }
        .chapter-row {
            display: grid;
            gap: 0.5rem; /* Reduced gap */
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #e2e8f0;
        }
        .chapter-row:last-child {
            border-bottom: none;
        }
        .chapter-row > div {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chapter-name-col {
            font-weight: 500;
            color: #334155;
        }
        /* Dynamic grid template columns will be set by JS */

        /* Full-screen login page styling */
        #login-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://placehold.co/1920x1080/60a5fa/ffffff?text=NEET+Success+Journey') no-repeat center center/cover; /* Placeholder image */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease-in-out;
            opacity: 1;
        }
        #login-page.hidden {
            opacity: 0;
            pointer-events: none; /* Disable interactions when hidden */
        }
        #login-card {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border-radius: 1.5rem;
            padding: 2.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            text-align: center;
            width: 90%;
            max-width: 500px;
            animation: fadeInScale 0.7s ease-out forwards;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        #login-quote {
            font-style: italic;
            margin-bottom: 1.5rem;
            color: #4a5568;
            font-size: 1.1rem;
            line-height: 1.5;
        }
        #google-signin-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            background-color: #4285F4; /* Google Blue */
            color: white;
            font-weight: 600;
            padding: 0.85rem 1.5rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            font-size: 1.1rem;
            width: 100%; /* Full width */
        }
        #google-signin-button:hover {
            background-color: #357ae8;
            transform: translateY(-2px);
        }
        #google-signin-button svg {
            width: 1.5rem;
            height: 1.5rem;
        }
        
        /* Calendar and Daily Routine Tab Styles */
        .daily-routine-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .daily-tab-button {
            padding: 0.6rem 1.2rem;
            border-radius: 0.6rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 1px solid transparent;
            font-size: 0.9rem;
            background-color: #f1f5f9;
            color: #475569;
        }
        
        .daily-tab-button.active {
            background: linear-gradient(to right, #06b6d4, #0891b2);
            color: #ffffff;
            border-color: #0e7490;
            box-shadow: 0 3px 6px rgba(6, 182, 212, 0.3);
        }
        
        .daily-tab-button:not(.active):hover {
            background-color: #e2e8f0;
            color: #1e293b;
        }
        
        .daily-tab-content {
            display: none;
        }
        
        .daily-tab-content.active {
            display: block;
        }
        
        /* MCQ Quota Circular Progress */
        .mcq-quota-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .mcq-quota-circle {
            position: relative;
            width: 120px;
            height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: conic-gradient(from 0deg, #e5e7eb 0deg, #e5e7eb 360deg);
            font-weight: bold;
            color: #374151;
        }
        
        .mcq-quota-circle.physics {
            background: conic-gradient(from 0deg, #3b82f6 var(--progress, 0deg), #e5e7eb var(--progress, 0deg));
        }
        
        .mcq-quota-circle.chemistry {
            background: conic-gradient(from 0deg, #10b981 var(--progress, 0deg), #e5e7eb var(--progress, 0deg));
        }
        
        .mcq-quota-circle.biology {
            background: conic-gradient(from 0deg, #f59e0b var(--progress, 0deg), #e5e7eb var(--progress, 0deg));
        }
        
        .mcq-quota-text {
            text-align: center;
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }
        
        /* Calendar Styles */
        .calendar-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.25rem;
            margin-top: 1rem;
        }
        
        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.25rem;
            margin-bottom: 0.5rem;
        }
        
        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            padding: 0.5rem;
            color: #374151;
            font-size: 0.8rem;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.8rem;
            position: relative;
            transition: all 0.2s;
        }
        
        .calendar-day:hover {
            background-color: #f3f4f6;
        }
        
        .calendar-day.today {
            background-color: #3b82f6;
            color: white;
        }
        
        .calendar-day.has-tuition {
            background-color: #10b981;
            color: white;
        }
        
        .calendar-day.has-backlog {
            background-color: #ef4444;
            color: white;
        }
        
        .calendar-day.quota-complete {
            border: 2px solid #10b981;
        }
        
        .calendar-day.quota-exceeded {
            border: 2px solid #f59e0b;
        }
        
        .tuition-schedule {
            margin-top: 1rem;
            font-size: 0.8rem;
        }
        
        .tuition-day {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        /* Enhanced form styles */
        .form-section {
            background: #f8fafc;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e2e8f0;
        }
        
        .form-section h3 {
            margin-bottom: 1rem;
            color: #1e293b;
            font-weight: 600;
        }
        
        .optional-field {
            border-left: 3px solid #6b7280;
            padding-left: 0.5rem;
        }
        
        .required-field {
            border-left: 3px solid #ef4444;
            padding-left: 0.5rem;
        }
        
        /* Topic checklist styles */
        .topic-checklist {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem;
            background-color: #ffffff;
        }
        
        .topic-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0;
        }
        
        .topic-item input[type="checkbox"] {
            margin: 0;
        }
    </style>
</head>
<body>
    <!-- Full-screen Login Page -->
    <div id="login-page">
        <div id="login-card">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-4">Road to AIIMS</h1>
            <p id="login-quote" class="text-lg"></p>
            <p class="text-gray-700 mb-6 text-xl font-semibold">Sign in to continue your journey!</p>

            <button id="google-signin-button">
                <svg viewBox="0 0 48 48" width="24px" height="24px">
                    <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.62-6.62C34.7 2.5 29.79 0 24 0 14.28 0 6.27 5.79 2.45 14.07l7.55 5.86C12.44 13.9 17.84 9.5 24 9.5z"/>
                    <path fill="#4285F4" d="M46.72 24c0-1.57-.13-3.07-.38-4.57H24v9.15h12.47c-.61 3.39-2.5 6.22-5.32 8.16l6.62 6.62c3.8-3.53 6.01-8.54 6.01-14.16z"/>
                    <path fill="#FBBC04" d="M9.98 29.69c-.71-2.19-.71-4.49 0-6.68L2.45 17.14C-.82 20.57-.82 27.43 2.45 30.86l7.53-5.86z"/>
                    <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.9-5.79l-6.62-6.62c-2.82 1.94-6.71 3.05-9.28 3.05-6.16 0-11.56-4.4-14.07-10.79l-7.55 5.86C6.27 42.21 14.28 48 24 48z"/>
                    <path fill="none" d="M0 0h48v48H0z"/>
                </svg>
                Sign in with Google
            </button>

            <!-- Removed Email/Password section -->
        </div>
    </div>

    <!-- Main App Content (Hidden until logged in) -->
    <div id="main-app-content" class="container hidden">
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-6">Road to AIIMS</h1>

        <!-- NEET Countdown & Motivational Quote -->
        <div id="countdown-container">
            <p class="text-2xl font-semibold text-gray-700">Welcome, Future Doctor!</p>
            <p class="text-xl font-medium text-gray-600 mb-2">Time until NEET UG 2026:</p>
            <div id="countdown-timer" class="font-mono"></div>
            <p id="motivational-quote"></p>
        </div>

        <!-- Main Tab Navigation -->
        <div class="flex justify-center gap-4 mb-8 flex-wrap">
            <button id="tabRegularData" class="tab-button active">Daily Routine</button>
            <button id="tabTests" class="tab-button">My Tests</button>
            <button id="tabAnalytics" class="tab-button">Analytics & Graphs</button>
            <button id="tabGoals" class="tab-button">Goals</button> <!-- Renamed from Syllabus -->
            <button id="tabAISuggestions" class="tab-button">AI Suggestions</button>
        </div>

        <div class="text-sm text-gray-500 mt-4 text-center">
            Logged in as: <span id="userIdDisplay" class="font-mono text-gray-600">Not Logged In</span>
            <button id="signOutButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75 ml-4">
                Sign Out
            </button>
        </div>

        <!-- Tab Content Areas -->
        <div id="contentRegularData" class="tab-content active">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Daily Routine</h2>
            
            <!-- Calendar Section -->
            <div class="calendar-container">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Study Calendar</h3>
                    <div class="flex gap-2">
                        <button id="prevMonth" class="px-3 py-1 bg-gray-200 rounded">&lt;</button>
                        <span id="currentMonth" class="px-4 py-1 font-semibold"></span>
                        <button id="nextMonth" class="px-3 py-1 bg-gray-200 rounded">&gt;</button>
                    </div>
                </div>
                <div class="calendar-header">
                    <div class="calendar-day-header">Sun</div>
                    <div class="calendar-day-header">Mon</div>
                    <div class="calendar-day-header">Tue</div>
                    <div class="calendar-day-header">Wed</div>
                    <div class="calendar-day-header">Thu</div>
                    <div class="calendar-day-header">Fri</div>
                    <div class="calendar-day-header">Sat</div>
                </div>
                <div id="calendarGrid" class="calendar-grid"></div>
                
                <!-- Tuition Schedule -->
                <div class="tuition-schedule">
                    <h4 class="font-semibold mb-2 text-gray-700">Weekly Tuition Schedule:</h4>
                    <div class="tuition-day"><span>Monday:</span> <span>Biology (9:00 AM - 12:00 PM)</span></div>
                    <div class="tuition-day"><span>Wednesday:</span> <span>Chemistry & Physics (9:00 AM - 3:30 PM)</span></div>
                    <div class="tuition-day"><span>Thursday:</span> <span>Biology (9:00 AM - 12:00 PM)</span></div>
                    <div class="tuition-day"><span>Saturday:</span> <span>Physics & Chemistry (9:00 AM - 3:30 PM)</span></div>
                </div>
            </div>
            
            <!-- MCQ Daily Quota Progress -->
            <div class="mcq-quota-container">
                <div class="text-center">
                    <div id="physicsQuota" class="mcq-quota-circle physics" style="--progress: 0deg;">
                        <div class="text-sm font-bold">Physics</div>
                        <div id="physicsQuotaText" class="text-xs">0/100</div>
                    </div>
                    <div class="mcq-quota-text">Daily Target: 100</div>
                </div>
                <div class="text-center">
                    <div id="chemistryQuota" class="mcq-quota-circle chemistry" style="--progress: 0deg;">
                        <div class="text-sm font-bold">Chemistry</div>
                        <div id="chemistryQuotaText" class="text-xs">0/100</div>
                    </div>
                    <div class="mcq-quota-text">Daily Target: 100</div>
                </div>
                <div class="text-center">
                    <div id="biologyQuota" class="mcq-quota-circle biology" style="--progress: 0deg;">
                        <div class="text-sm font-bold">Biology</div>
                        <div id="biologyQuotaText" class="text-xs">0/150</div>
                    </div>
                    <div class="mcq-quota-text">Daily Target: 150</div>
                </div>
            </div>
            
            <!-- Daily Routine Sub-Tabs -->
            <div class="daily-routine-tabs">
                <button id="dailyTabToday" class="daily-tab-button active">📅 Today</button>
                <button id="dailyTabUpcoming" class="daily-tab-button">🔮 Upcoming Plans</button>
                <button id="dailyTabBacklogs" class="daily-tab-button">⏳ Backlogs</button>
                <button id="dailyTabCompleted" class="daily-tab-button">✅ Completed</button>
            </div>
            
            <!-- Today Tab Content -->
            <div id="dailyContentToday" class="daily-tab-content active">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Today's Study Log</h3>
                
                <!-- Summary Block -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h4 class="font-semibold text-blue-800 mb-2">Today's Summary</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div><span class="font-medium">Chapters Done:</span> <span id="todayChapters">0</span></div>
                        <div><span class="font-medium">Time Spent:</span> <span id="todayTime">0h 0m</span></div>
                        <div><span class="font-medium">Total MCQs:</span> <span id="todayMcqs">0</span></div>
                        <div><span class="font-medium">Completion:</span> <span id="todayCompletion">0%</span></div>
                    </div>
                </div>
                
                <!-- Physics Section -->
                <div class="form-section">
                    <h3 class="text-lg font-semibold text-blue-600 mb-3">🔬 Physics</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="optional-field">
                            <label class="text-sm font-medium text-gray-700 block mb-1">Book/Source</label>
                            <select id="physicsBook" class="w-full">
                                <option value="">Select Book (Optional)</option>
                                <option value="bb_classes_module">BB Classes Module</option>
                                <option value="disha">Disha</option>
                                <option value="mtg">MTG</option>
                                <option value="cengage">Cengage</option>
                                <option value="errorless">Errorless</option>
                                <option value="ncert_questions">NCERT Questions</option>
                                <option value="jee_mains_pyqs">JEE-Mains PYQs</option>
                            </select>
                        </div>
                        <div class="optional-field">
                            <label class="text-sm font-medium text-gray-700 block mb-1">Chapter</label>
                            <select id="physicsChapter" class="w-full">
                                <option value="">Select Chapter (Optional)</option>
                            </select>
                        </div>
                        <div class="optional-field" id="physicsTopicsContainer" style="display: none;">
                            <label class="text-sm font-medium text-gray-700 block mb-1">Topics Covered</label>
                            <div id="physicsTopics" class="topic-checklist"></div>
                        </div>
                        <div class="optional-field">
                            <label class="text-sm font-medium text-gray-700 block mb-1">Study Type</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="flex items-center gap-1">
                                    <input type="checkbox" id="physicsTheory"> Theory
                                </label>
                                <label class="flex items-center gap-1">
                                    <input type="checkbox" id="physicsMcqs"> MCQs
                                </label>
                                <label class="flex items-center gap-1">
                                    <input type="checkbox" id="physicsRevision"> Revision
                                </label>
                                <label class="flex items-center gap-1">
                                    <input type="checkbox" id="physicsNotes"> Notes
                                </label>
                            </div>
                        </div>
                        <div class="optional-field">
                            <label class="text-sm font-medium text-gray-700 block mb-1">MCQs from Selected Book</label>
                            <input type="number" id="physicsMcqCount" class="w-full" placeholder="0">
                        </div>
                        <div class="optional-field">
                            <label class="text-sm font-medium text-gray-700 block mb-1">Manual MCQ Source & Count</label>
                            <div class="flex gap-2">
                                <input type="text" id="physicsMcqManualSource" class="flex-1" placeholder="Source name">
                                <input type="number" id="physicsMcqManualCount" class="w-20" placeholder="0">
                            </div>
                        </div>
                        <div class="optional-field">
                            <label class="text-sm font-medium text-gray-700 block mb-1">Time Spent</label>
                            <input type="text" id="physicsTime" class="w-full" placeholder="e.g., 1h 30min">
                        </div>
                        <div class="optional-field">
                            <label class="text-sm font-medium text-gray-700 block mb-1">Comments/Notes</label>
                            <textarea id="physicsComments" class="w-full h-20" placeholder="Optional notes..."></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Chemistry Section -->
                <div class="form-section">
                    <h3 class="text-lg font-semibold text-green-600 mb-3">🧪 Chemistry</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="optional-field">
                            <label class="text-sm font-medium text-gray-700 block mb-1">Book/Source</label>
                            <select id="chemistryBook" class="w-full">
                                <option value="">Select Book (Optional)</option>
                                <option value="bb_classes_module">BB Classes Module</option>
                                <option value="disha">Disha</option>
                                <option value="mtg">MTG</option>
                                <option value="cengage">Cengage</option>
                                <option value="errorless">Errorless</option>
                                <option value="ncert_questions">NCERT Questions</option>
                                <option value="jee_mains_pyqs">JEE-Mains PYQs</option>
                            </select>
                        </div>
                        <div class="optional-field">
                            <label class="text-sm font-medium text-gray-700 block mb-1">Chapter</label>
                            <select id="chemistryChapter" class="w-full">
                                <option value="">Select Chapter (Optional)</option>
                            </select>
                        </div>
                        <div class="optional-field" id="chemistryTopicsContainer" style="display: none;">
                            <label class="text-sm font-medium text-gray-700 block mb-1">Topics Covered</label>
                            <div id="chemistryTopics" class="topic-checklist"></div>
                        </div>
                        <div class="optional-field">
                            <label class="text-sm font-medium text-gray-700 block mb-1">Study Type</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="flex items-center gap-1">
                                    <input type="checkbox" id="chemistryTheory"> Theory
                                </label>
                                <label class="flex items-center gap-1">
                                    <input type="checkbox" id="chemistryMcqs"> MCQs
                                </label>
                                <label class="flex items-center gap-1">
                                    <input type="checkbox" id="chemistryRevision"> Revision
                                </label>
                                <label class="flex items-center gap-1">
                                    <input type="checkbox" id="chemistryNotes"> Notes
                                </label>
                            </div>
                        </div>
                        <div class="optional-field">
                            <label class="text-sm font-medium text-gray-700 block mb-1">MCQs from Selected Book</label>
                            <input type="number" id="chemistryMcqCount" class="w-full" placeholder="0">
                        </div>
                        <div class="optional-field">
                            <label class="text-sm font-medium text-gray-700 block mb-1">Manual MCQ Source & Count</label>
                            <div class="flex gap-2">
                                <input type="text" id="chemistryMcqManualSource" class="flex-1" placeholder="Source name">
                                <input type="number" id="chemistryMcqManualCount" class="w-20" placeholder="0">
                            </div>
                        </div>
                        <div class="optional-field">
                            <label class="text-sm font-medium text-gray-700 block mb-1">Time Spent</label>
                            <input type="text" id="chemistryTime" class="w-full" placeholder="e.g., 1h 30min">
                        </div>
                        <div class="optional-field">
                            <label class="text-sm font-medium text-gray-700 block mb-1">Comments/Notes</label>
                            <textarea id="chemistryComments" class="w-full h-20" placeholder="Optional notes..."></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Biology Section -->
                <div class="form-section">
                    <h3 class="text-lg font-semibold text-yellow-600 mb-3">🧬 Biology</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="optional-field">
                            <label class="text-sm font-medium text-gray-700 block mb-1">Book/Source</label>
                            <select id="biologyBook" class="w-full">
                                <option value="">Select Book (Optional)</option>
                                <option value="mission_neet_module">Mission NEET Module</option>
                                <option value="ncert_fingertips">NCERT Fingertips</option>
                                <option value="neetprep">NEETprep</option>
                            </select>
                        </div>
                        <div class="optional-field">
                            <label class="text-sm font-medium text-gray-700 block mb-1">Chapter</label>
                            <select id="biologyChapter" class="w-full">
                                <option value="">Select Chapter (Optional)</option>
                            </select>
                        </div>
                        <div class="optional-field">
                            <label class="text-sm font-medium text-gray-700 block mb-1">Study Type</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="flex items-center gap-1">
                                    <input type="checkbox" id="biologyTheory"> Theory
                                </label>
                                <label class="flex items-center gap-1">
                                    <input type="checkbox" id="biologyMcqs"> MCQs
                                </label>
                                <label class="flex items-center gap-1">
                                    <input type="checkbox" id="biologyRevision"> Revision
                                </label>
                                <label class="flex items-center gap-1">
                                    <input type="checkbox" id="biologyNotes"> Notes
                                </label>
                            </div>
                        </div>
                        <div class="optional-field">
                            <label class="text-sm font-medium text-gray-700 block mb-1">MCQs from Selected Book</label>
                            <input type="number" id="biologyMcqCount" class="w-full" placeholder="0">
                        </div>
                        <div class="optional-field">
                            <label class="text-sm font-medium text-gray-700 block mb-1">Manual MCQ Source & Count</label>
                            <div class="flex gap-2">
                                <input type="text" id="biologyMcqManualSource" class="flex-1" placeholder="Source name">
                                <input type="number" id="biologyMcqManualCount" class="w-20" placeholder="0">
                            </div>
                        </div>
                        <div class="optional-field">
                            <label class="text-sm font-medium text-gray-700 block mb-1">Time Spent</label>
                            <input type="text" id="biologyTime" class="w-full" placeholder="e.g., 1h 30min">
                        </div>
                        <div class="optional-field">
                            <label class="text-sm font-medium text-gray-700 block mb-1">Comments/Notes</label>
                            <textarea id="biologyComments" class="w-full h-20" placeholder="Optional notes..."></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-4 mb-6">
                    <button id="saveTodayLogButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                        💾 Save Today's Log
                    </button>
                    <button id="getAIProductivityInsightsButton" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75">
                        Get Productivity Insights ✨
                    </button>
                </div>
                
                <!-- Today's Entries Table -->
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-800 mb-3">Today's Study Entries</h4>
                    <div id="todayEntriesTable" class="overflow-x-auto">
                        <p class="text-gray-500 text-center py-4">No entries for today yet.</p>
                    </div>
                </div>
            </div>
            
            <!-- Upcoming Plans Tab Content -->
            <div id="dailyContentUpcoming" class="daily-tab-content">
                <h3 class="text-xl font-bold text-gray-800 mb-4">📅 Upcoming Study Plans</h3>
                
                <div class="form-section">
                    <h4 class="font-semibold text-gray-700 mb-3">Plan Ahead</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="required-field">
                            <label class="text-sm font-medium text-gray-700 block mb-1">Date</label>
                            <input type="date" id="upcomingDate" class="w-full">
                        </div>
                        <div class="required-field">
                            <label class="text-sm font-medium text-gray-700 block mb-1">Subject</label>
                            <select id="upcomingSubject" class="w-full">
                                <option value="">Select Subject</option>
                                <option value="Physics">Physics</option>
                                <option value="Chemistry">Chemistry</option>
                                <option value="Biology">Biology</option>
                            </select>
                        </div>
                        <div class="required-field">
                            <label class="text-sm font-medium text-gray-700 block mb-1">Chapter</label>
                            <input type="text" id="upcomingChapter" class="w-full" placeholder="Chapter name">
                        </div>
                        <div class="optional-field">
                            <label class="text-sm font-medium text-gray-700 block mb-1">Study Type</label>
                            <select id="upcomingStudyType" class="w-full">
                                <option value="">Select Type</option>
                                <option value="Theory">Theory</option>
                                <option value="MCQs">MCQs</option>
                                <option value="Revision">Revision</option>
                                <option value="Notes">Notes</option>
                            </select>
                        </div>
                        <div class="optional-field">
                            <label class="text-sm font-medium text-gray-700 block mb-1">Estimated Time</label>
                            <input type="text" id="upcomingTime" class="w-full" placeholder="e.g., 2h 30min">
                        </div>
                    </div>
                    <button id="saveUpcomingPlanButton" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg mt-4">
                        📝 Add to Plans
                    </button>
                </div>
                
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-800 mb-3">Upcoming Plans</h4>
                    <div id="upcomingPlansTable" class="overflow-x-auto">
                        <p class="text-gray-500 text-center py-4">No upcoming plans yet.</p>
                    </div>
                </div>
            </div>
            
            <!-- Backlogs Tab Content -->
            <div id="dailyContentBacklogs" class="daily-tab-content">
                <h3 class="text-xl font-bold text-gray-800 mb-4">⏳ Study Backlogs</h3>
                
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                    <h4 class="font-semibold text-red-800 mb-2">Backlog Summary</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div><span class="font-medium">Total Backlogs:</span> <span id="totalBacklogs">0</span></div>
                        <div><span class="font-medium">This Week:</span> <span id="weekBacklogs">0</span></div>
                        <div><span class="font-medium">Oldest:</span> <span id="oldestBacklog">-</span></div>
                    </div>
                </div>
                
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-800 mb-3">Backlog Items</h4>
                    <div id="backlogsTable" class="overflow-x-auto">
                        <p class="text-gray-500 text-center py-4">No backlogs detected. Great job! 🎉</p>
                    </div>
                </div>
            </div>
            
            <!-- Completed Tab Content -->
            <div id="dailyContentCompleted" class="daily-tab-content">
                <h3 class="text-xl font-bold text-gray-800 mb-4">✅ Completed Studies</h3>
                
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                    <h4 class="font-semibold text-green-800 mb-2">Completion Stats</h4>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                        <div><span class="font-medium">This Week:</span> <span id="weekCompleted">0</span></div>
                        <div><span class="font-medium">This Month:</span> <span id="monthCompleted">0</span></div>
                        <div><span class="font-medium">Total Chapters:</span> <span id="totalCompleted">0</span></div>
                        <div><span class="font-medium">Success Rate:</span> <span id="successRate">0%</span></div>
                    </div>
                </div>
                
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-800 mb-3">Completed Studies</h4>
                    <div id="completedTable" class="overflow-x-auto">
                        <p class="text-gray-500 text-center py-4">No completed studies yet.</p>
                    </div>
                </div>
            </div>
            
            <div class="flex flex-col gap-2 mt-6">
                <h3 class="text-lg font-semibold text-gray-800">AI Productivity Analysis:</h3>
                <div id="aiProductivityAnalysisDisplay" class="data-display text-gray-700">
                    AI analysis of your daily logs will appear here.
                </div>
            </div>
        </div>

        <div id="contentTests" class="tab-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">My Tests Data</h2>

            <!-- Test Sub-Tab Navigation -->
            <div class="flex justify-start gap-3 mb-6 flex-wrap">
                <button id="testEntrySubTabUT" class="sub-tab-button active">Unit Tests</button>
                <button id="testEntrySubTabBBCTS" class="sub-tab-button">BB Classes Test Series</button>
                <button id="testEntrySubTabQuarterly" class="sub-tab-button">Quarterly Tests</button>
                <button id="testEntrySubTabMissionNeet" class="sub-tab-button">Mission NEET Tests</button>
            </div>

            <!-- Unit Tests Sub-Tab Content -->
            <div id="testEntrySubContentUT" class="sub-tab-content active">
                <p class="text-gray-600 mb-4">Enter your Unit Test data using the fields below:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="flex flex-col">
                        <label for="utDate" class="text-lg font-medium text-gray-700">Date:</label>
                        <input type="date" id="utDate" class="w-full">
                    </div>
                    <div class="flex flex-col">
                        <label for="utSyllabus" class="text-lg font-medium text-gray-700">Syllabus:</label>
                        <input type="text" id="utSyllabus" class="w-full" placeholder="e.g., Vectors, Basic Maths">
                    </div>
                    <div class="flex flex-col">
                        <label for="utFullMarks" class="text-lg font-medium text-gray-700">Full Marks:</label>
                        <input type="number" id="utFullMarks" class="w-full" placeholder="e.g., 320">
                    </div>
                    <div class="flex flex-col">
                        <label for="utPhysicsScore" class="text-lg font-medium text-gray-700">Physics Score:</label>
                        <input type="number" id="utPhysicsScore" class="w-full" placeholder="e.g., 32">
                    </div>
                    <div class="flex flex-col">
                        <label for="utChemistryScore" class="text-lg font-medium text-gray-700">Chemistry Score:</label>
                        <input type="number" id="utChemistryScore" class="w-full" placeholder="e.g., 30">
                    </div>
                    <div class="flex flex-col">
                        <label for="utBiologyScore" class="text-lg font-medium text-gray-700">Biology Score:</label>
                        <input type="number" id="utBiologyScore" class="w-full" placeholder="e.g., 105">
                    </div>
                    <div class="flex flex-col">
                        <label for="utMyMarks" class="text-lg font-medium text-gray-700">My Marks (Total):</label>
                        <input type="number" id="utMyMarks" class="w-full" placeholder="e.g., 167">
                    </div>
                </div>
                <button id="saveUTButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 mt-4">
                    Save Unit Test Data
                </button>
                <div class="flex flex-col gap-2 mt-6">
                    <h3 class="text-lg font-semibold text-gray-800">Stored Unit Test Data:</h3>
                    <div id="testsDataDisplay" class="data-display text-gray-700">
                        No Unit Test data stored yet.
                    </div>
                </div>
            </div>

            <!-- BB Classes Test Series Sub-Tab Content -->
            <div id="testEntrySubContentBBCTS" class="sub-tab-content">
                <p class="text-gray-600 mb-4">Enter your BB Classes Test Series data using the fields below:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="flex flex-col">
                        <label for="bbctsDate" class="text-lg font-medium text-gray-700">Date:</label>
                        <input type="date" id="bbctsDate" class="w-full">
                    </div>
                    <div class="flex flex-col">
                        <label for="bbctsSyllabus" class="text-lg font-medium text-gray-700">Syllabus:</label>
                        <input type="text" id="bbctsSyllabus" class="w-full" placeholder="e.g., BBCTS Test 1 Syllabus">
                    </div>
                    <div class="flex flex-col">
                        <label for="bbctsFullMarks" class="text-lg font-medium text-gray-700">Full Marks:</label>
                        <input type="number" id="bbctsFullMarks" class="w-full" placeholder="e.g., 360">
                    </div>
                    <div class="flex flex-col">
                        <label for="bbctsPhysicsScore" class="text-lg font-medium text-gray-700">Physics Score:</label>
                        <input type="number" id="bbctsPhysicsScore" class="w-full" placeholder="e.g., 60">
                    </div>
                    <div class="flex flex-col">
                        <label for="bbctsChemistryScore" class="text-lg font-medium text-gray-700">Chemistry Score:</label>
                        <input type="number" id="bbctsChemistryScore" class="w-full" placeholder="e.g., 70">
                    </div>
                    <div class="flex flex-col">
                        <label for="bbctsBiologyScore" class="text-lg font-medium text-gray-700">Biology Score:</label>
                        <input type="number" id="bbctsBiologyScore" class="w-full" placeholder="e.g., 150">
                    </div>
                    <div class="flex flex-col">
                        <label for="bbctsMyMarks" class="text-lg font-medium text-gray-700">My Marks (Total):</label>
                        <input type="number" id="bbctsMyMarks" class="w-full" placeholder="e.g., 280">
                    </div>
                </div>
                <button id="saveBBCTSButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 mt-4">
                    Save BB Classes Test Series Data
                </button>
                <div class="flex flex-col gap-2 mt-6">
                    <h3 class="text-lg font-semibold text-gray-800">Stored BB Classes Test Series Data:</h3>
                    <div id="bbctsDataDisplay" class="data-display text-gray-700">
                        No BB Classes Test Series data stored yet.
                    </div>
                </div>
            </div>

            <!-- Quarterly Tests Sub-Tab Content -->
            <div id="testEntrySubContentQuarterly" class="sub-tab-content">
                <p class="text-gray-600 mb-4">Enter your Quarterly Test data using the fields below:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="flex flex-col">
                        <label for="qtDate" class="text-lg font-medium text-gray-700">Date:</label>
                        <input type="date" id="qtDate" class="w-full">
                    </div>
                    <div class="flex flex-col">
                        <label for="qtSyllabus" class="text-lg font-medium text-gray-700">Syllabus:</label>
                        <input type="text" id="qtSyllabus" class="w-full" placeholder="e.g., Quarterly Test 1 Syllabus">
                    </div>
                    <div class="flex flex-col">
                        <label for="qtFullMarks" class="text-lg font-medium text-gray-700">Full Marks:</label>
                        <input type="number" id="qtFullMarks" class="w-full" placeholder="e.g., 720">
                    </div>
                    <div class="flex flex-col">
                        <label for="qtPhysicsScore" class="text-lg font-medium text-gray-700">Physics Score:</label>
                        <input type="number" id="qtPhysicsScore" class="w-full" placeholder="e.g., 120">
                    </div>
                    <div class="flex flex-col">
                        <label for="qtChemistryScore" class="text-lg font-medium text-gray-700">Chemistry Score:</label>
                        <input type="number" id="qtChemistryScore" class="w-full" placeholder="e.g., 130">
                    </div>
                    <div class="flex flex-col">
                        <label for="qtBiologyScore" class="text-lg font-medium text-gray-700">Biology Score:</label>
                        <input type="number" id="qtBiologyScore" class="w-full" placeholder="e.g., 280">
                    </div>
                    <div class="flex flex-col">
                        <label for="qtMyMarks" class="text-lg font-medium text-gray-700">My Marks (Total):</label>
                        <input type="number" id="qtMyMarks" class="w-full" placeholder="e.g., 530">
                    </div>
                </div>
                <button id="saveQuarterlyButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 mt-4">
                    Save Quarterly Data
                </button>
                <div class="flex flex-col gap-2 mt-6">
                    <h3 class="text-lg font-semibold text-gray-800">Stored Quarterly Data:</h3>
                    <div id="quarterlyDataDisplay" class="data-display text-gray-700">
                        No Quarterly data stored yet.
                    </div>
                </div>
            </div>

            <!-- Mission NEET Tests Sub-Tab Content -->
            <div id="testEntrySubContentMissionNeet" class="sub-tab-content">
                <p class="text-gray-600 mb-4">Enter your Mission NEET data using the fields below:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="flex flex-col">
                        <label for="mnDate" class="text-lg font-medium text-gray-700">Date:</label>
                        <input type="date" id="mnDate" class="w-full">
                    </div>
                    <div class="flex flex-col">
                        <label for="mnSyllabus" class="text-lg font-medium text-gray-700">Syllabus:</label>
                        <input type="text" id="mnSyllabus" class="w-full" placeholder="e.g., Cell Cycle and Cell Division">
                    </div>
                    <div class="flex flex-col">
                        <label for="mnFullMarks" class="text-lg font-medium text-gray-700">Full Marks:</label>
                        <input type="number" id="mnFullMarks" class="w-full" placeholder="e.g., 200">
                    </div>
                    <div class="flex flex-col">
                        <label for="mnScore" class="text-lg font-medium text-gray-700">Score:</label>
                        <input type="number" id="mnScore" class="w-full" placeholder="e.g., 180">
                    </div>
                </div>
                <button id="saveMissionNeetButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 mt-4">
                    Save Mission NEET Data
                </button>
                <div class="flex flex-col gap-2 mt-6">
                    <h3 class="text-lg font-semibold text-gray-800">Stored Mission NEET Data:</h3>
                    <div id="missionNeetDataDisplay" class="data-display text-gray-700">
                        No Mission NEET data stored yet.
                    </div>
                </div>
            </div>
        </div>

        <div id="contentAnalytics" class="tab-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Analytics & Graphs</h2>
            <p class="text-gray-600 mb-4">Visualize your test performance and syllabus progression here. Graphs update automatically when data is saved.</p>

            <div class="flex flex-wrap gap-4 mb-6">
                <button id="getAIPerformanceInsightsButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75">
                    Get AI Performance Insights ✨
                </button>
            </div>

            <!-- Analytics Sub-Tab Navigation -->
            <div class="flex justify-center gap-2 mb-6 flex-wrap">
                <button id="subTabUT" class="sub-tab-button active">Unit Tests</button>
                <button id="subTabBBCTS" class="sub-tab-button">BB Classes Test Series</button>
                <button id="subTabQuarterly" class="sub-tab-button">Quarterly Tests</button>
                <button id="subTabMissionNeetAnalytics" class="sub-tab-button">Mission NEET Tests</button>
                <button id="subTabSyllabusProgression" class="sub-tab-button">Syllabus Progression</button> <!-- New Syllabus Progression Graph Tab -->
            </div>

            <!-- Analytics Sub-Tab Content Areas -->
            <div id="subContentUT" class="sub-tab-content active">
                <div id="chartsContainerUT" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="chart-container">
                        <canvas id="physicsChartUT"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="chemistryChartUT"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="biologyChartUT"></canvas>
                    </div>
                </div>
            </div>

            <div id="subContentBBCTS" class="sub-tab-content">
                <div id="chartsContainerBBCTS" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div class="chart-container">
                        <canvas id="physicsChartBBCTS"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="chemistryChartBBCTS"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="biologyChartBBCTS"></canvas>
                    </div>
                </div>
            </div>

            <div id="subContentQuarterly" class="sub-tab-content">
                <div id="chartsContainerQuarterly" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div class="chart-container">
                        <canvas id="physicsChartQuarterly"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="chemistryChartQuarterly"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="biologyChartQuarterly"></canvas>
                    </div>
                </div>
            </div>

            <div id="subContentMissionNeetAnalytics" class="sub-tab-content">
                <div id="chartsContainerMissionNeet" class="grid grid-cols-1 md:grid-cols-1 gap-6">
                    <div class="chart-container">
                        <canvas id="missionNeetChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- New Syllabus Progression Graph Content -->
            <div id="subContentSyllabusProgression" class="sub-tab-content">
                <div class="chart-container">
                    <canvas id="syllabusProgressionChart"></canvas>
                </div>
            </div>

            <div class="flex flex-col gap-2 mt-6">
                <h3 class="text-lg font-semibold text-gray-800">AI Performance Analysis:</h3>
                <div id="aiPerformanceAnalysisDisplay" class="data-display text-gray-700">
                    AI analysis will appear here after clicking "Get AI Performance Insights ✨".
                </div>
            </div>
        </div>

        <!-- NEW GOALS TAB (Renamed from Syllabus) -->
        <div id="contentGoals" class="tab-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">My Study Goals</h2>
            <p class="text-gray-600 mb-4">Mark chapters as completed to track your progress towards NEET UG 2026!</p>

            <!-- Goals Sub-Tab Navigation (Physics, Chemistry, Biology) -->
            <div class="flex justify-start gap-3 mb-6 flex-wrap">
                <button id="goalsSubTabPhysics" class="sub-tab-button active">Physics Goals</button>
                <button id="goalsSubTabChemistry" class="sub-tab-button">Chemistry Goals</button>
                <button id="goalsSubTabBiology" class="sub-tab-button">Biology Goals</button>
            </div>

            <!-- Sub-category Visibility Controls -->
            <div id="subcategory-controls" class="bg-gray-100 p-4 rounded-lg mb-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Select Study Levels to Display:</h3>
                <div id="physicsChemistrySubcategoryCheckboxes" class="flex flex-wrap gap-x-6 gap-y-2 mb-4">
                    <!-- Checkboxes will be dynamically generated here -->
                </div>
                <div id="biologySubcategoryCheckboxes" class="flex flex-wrap gap-x-6 gap-y-2 hidden">
                    <!-- Checkboxes will be dynamically generated here -->
                </div>
            </div>

            <!-- Physics Goals Content -->
            <div id="goalsSubContentPhysics" class="sub-tab-content active">
                <h3 class="text-xl font-semibold text-gray-800 mb-3">Physics Chapters:</h3>
                <div id="physicsGoalsDisplay" class="data-display text-gray-700">
                    <!-- Physics chapters will be dynamically loaded here -->
                </div>
            </div>

            <!-- Chemistry Goals Content -->
            <div id="goalsSubContentChemistry" class="sub-tab-content">
                <h3 class="text-xl font-semibold text-gray-800 mb-3">Chemistry Chapters:</h3>
                <div id="chemistryGoalsDisplay" class="data-display text-gray-700">
                    <!-- Chemistry chapters will be dynamically loaded here -->
                </div>
            </div>

            <!-- Biology Goals Content -->
            <div id="goalsSubContentBiology" class="sub-tab-content">
                <h3 class="text-xl font-semibold text-gray-800 mb-3">Biology Chapters:</h3>
                <div id="biologyGoalsDisplay" class="data-display text-gray-700">
                    <!-- Biology chapters will be dynamically loaded here -->
                </div>
            </div>

            <div class="flex flex-col gap-2 mt-6">
                <h3 class="text-lg font-semibold text-gray-800">AI Progress Insights:</h3>
                <button id="getAIGoalsInsightsButton" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-75">
                    Get My Progress Insights ✨
                </button>
                <div id="aiGoalsAnalysisDisplay" class="data-display text-gray-700">
                    AI analysis of your syllabus progress will appear here.
                </div>
            </div>
        </div>

        <div id="contentAISuggestions" class="tab-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">AI Suggestions</h2>
            <div class="flex flex-col gap-2 mb-4">
                <label for="aiPromptInput" class="text-lg font-medium text-gray-700">Ask for general suggestions (e.g., "Summarize my daily routine", "Suggest next steps for my tests"):</label>
                <textarea id="aiPromptInput" class="w-full" placeholder="Type your query here..."></textarea>
            </div>
            <button id="getAISuggestionButton" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">
                Get General Suggestion ✨
            </button>
            <div class="flex flex-col gap-2 mt-6">
                <h3 class="text-lg font-semibold text-gray-800">AI General Suggestion:</h3>
                <div id="aiResponseDisplay" class="data-display text-gray-700">
                    AI suggestions will appear here.
                </div>
            </div>

            <hr class="my-8 border-t-2 border-gray-200"> <!-- Separator -->

            <h2 class="text-2xl font-bold text-gray-800 mb-4">Next Study Plan ✨</h2>
            <p class="text-gray-600 mb-4">Get AI-powered recommendations for your next topic, MCQs, and study time based on your progress and topper advice.</p>
            <button id="getNextStudyPlanButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                Generate Next Study Plan ✨
            </button>
            <div class="flex flex-col gap-2 mt-6">
                <h3 class="text-lg font-semibold text-gray-800">AI Study Plan:</h3>
                <div id="nextStudyPlanDisplay" class="data-display text-gray-700">
                    Your personalized study plan will appear here.
                </div>
            </div>

            <hr class="my-8 border-t-2 border-gray-200"> <!-- Separator -->

            <h2 class="text-2xl font-bold text-gray-800 mb-4">Concept Explanation ✨</h2>
            <div class="flex flex-col gap-2 mb-4">
                <label for="conceptInput" class="text-lg font-medium text-gray-700">Enter a concept or doubt you want explained:</label>
                <textarea id="conceptInput" class="w-full" placeholder="e.g., Explain glycolysis, What is osmosis?"></textarea>
            </div>
            <button id="explainConceptButton" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75">
                Explain Concept ✨
            </button>
            <div class="flex flex-col gap-2 mt-6">
                <h3 class="text-lg font-semibold text-gray-800">AI Explanation:</h3>
                <div id="conceptExplanationDisplay" class="data-display text-gray-700">
                    Your AI-powered concept explanation will appear here.
                </div>
            </div>

            <hr class="my-8 border-t-2 border-gray-200"> <!-- Separator -->

            <h2 class="text-2xl font-bold text-gray-800 mb-4">Revision Topic Suggester ✨</h2>
            <p class="text-gray-600 mb-4">Get AI-powered suggestions for topics you should revise based on your performance and study logs.</p>
            <button id="suggestRevisionTopicsButton" class="bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-opacity-75">
                Suggest Revision Topics ✨
            </button>
            <div class="flex flex-col gap-2 mt-6">
                <h3 class="text-lg font-semibold text-gray-800">AI Revision Suggestions:</h3>
                <div id="revisionSuggestionsDisplay" class="data-display text-gray-700">
                    AI revision suggestions will appear here.
                </div>
            </div>

            <hr class="my-8 border-t-2 border-gray-200"> <!-- Separator -->

            <h2 class="text-2xl font-bold text-gray-800 mb-4">Mock Test Question Generator ✨</h2>
            <p class="text-gray-600 mb-4">Generate practice MCQs for specific subjects and topics.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="flex flex-col">
                    <label for="questionSubject" class="text-lg font-medium text-gray-700">Subject:</label>
                    <select id="questionSubject" class="w-full">
                        <option value="">Select Subject</option>
                        <option value="Physics">Physics</option>
                        <option value="Chemistry">Chemistry</option>
                        <option value="Biology">Biology</option>
                    </select>
                </div>
                <div class="flex flex-col">
                    <label for="questionTopic" class="text-lg font-medium text-gray-700">Topic (e.g., "Thermodynamics", "Human Reproduction"):</label>
                    <input type="text" id="questionTopic" class="w-full" placeholder="Enter topic">
                </div>
            </div>
            <button id="generateQuestionsButton" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75">
                Generate Practice Questions ✨
            </button>
            <div class="flex flex-col gap-2 mt-6">
                <h3 class="text-lg font-semibold text-gray-800">Generated Questions:</h3>
                <div id="generatedQuestionsDisplay" class="data-display text-gray-700">
                    Generated MCQs will appear here.
                </div>
            </div>

            <hr class="my-8 border-t-2 border-gray-200"> <!-- Separator -->

            <h2 class="text-2xl font-bold text-gray-800 mb-4">Weakness Identification & Targeted Practice ✨</h2>
            <p class="text-gray-600 mb-4">Get AI-powered analysis of your weak areas and specific suggestions for improving them.</p>
            <button id="identifyWeaknessesButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75">
                Identify Weaknesses & Practice Tips ✨
            </button>
            <div class="flex flex-col gap-2 mt-6">
                <h3 class="text-lg font-semibold text-gray-800">AI Weakness Analysis:</h3>
                <div id="weaknessAnalysisDisplay" class="data-display text-gray-700">
                    AI analysis of your weak areas and practice tips will appear here.
                </div>
            </div>

        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances and user ID
        let app;
        let db;
        let auth;
        let userId = 'loading'; // Default until authenticated
        let userEmail = 'Not Logged In'; // To display user's email

        // Global variables to store fetched data
        let utTestData = [];
        let bbctsData = [];
        let quarterlyData = [];
        let missionNeetData = [];
        let regularDataLogs = []; // Array to store multiple daily logs
        let chapterStatus = {};

        // Parsed CSV data
        let physicsGoalsData = [];
        let chemistryGoalsData = [];
        let biologyGoalsData = [];

        // Chart instances
        let physicsChartUTInstance = null;
        let chemistryChartUTInstance = null;
        let biologyChartUTInstance = null;

        let physicsChartBBCTSInstance = null;
        let chemistryChartBBCTSInstance = null;
        let biologyChartBBCTSInstance = null;

        let physicsChartQuarterlyInstance = null;
        let chemistryChartQuarterlyInstance = null;
        let biologyChartQuarterlyInstance = null;

        let missionNeetChartInstance = null;
        let syllabusProgressionChartInstance = null;

        // Motivational quotes for login page and general use
        const motivationalQuotes = [
            "The only way to do great work is to love what you do. - Steve Jobs",
            "Believe you can and you're halfway there. - Theodore Roosevelt",
            "The future belongs to those who believe in the beauty of their dreams. - Eleanor Roosevelt",
            "Don't watch the clock; do what it does. Keep going. - Sam Levenson",
            "The harder you work for something, the greater you'll feel when you achieve it.",
            "Success is not final, failure is not fatal: It is the courage to continue that counts. - Winston Churchill",
            "Your time is limited, don't waste it living someone else's life. - Steve Jobs",
            "The best way to predict the future is to create it. - Peter Drucker",
            "It always seems impossible until it's done. - Nelson Mandela",
            "Strive for progress, not perfection.",
            "Dream big, work hard, stay focused, and surround yourself with good people. - Unknown",
            "The expert in anything was once a beginner. - Helen Hayes",
            "Push yourself, because no one else is going to do it for you. - Unknown",
            "Success is the sum of small efforts repeated day in and day out. - Robert Collier",
            "It's not about perfect. It's about effort. And when you bring that effort every single day, that's where transformation happens. That's how change occurs. - Jillian Michaels"
        ];

        // Define sub-categories for each subject with their fixed order and levels
        // Levels 0-7 for color gradient (Beginner to Master)
        const physicsChemistrySubCategoriesOrdered = [
            { key: 'bb_classes_module', name: 'BB Classes Module', level: 0 }, // Beginner
            { key: 'disha', name: 'Disha', level: 2 },
            { key: 'mtg', name: 'MTG', level: 3 },
            { key: 'cengage', name: 'Cengage', level: 5 },
            { key: 'errorless', name: 'Errorless', level: 7 }, // Master
            { key: 'ncert_questions', name: 'NCERT Questions', level: 1 }, // Can be flexible
            { key: 'jee_mains_pyqs', name: 'JEE-Mains PYQs', level: 4 }
        ];

        const biologySubCategoriesOrdered = [
            { key: 'mission_neet_module', name: 'Mission NEET Module', level: 0 }, // Beginner
            { key: 'ncert_fingertips', name: 'NCERT Fingertips', level: 3 },
            { key: 'neetprep', name: 'NEETprep', level: 6 }
        ];

        // Default selected sub-categories (all visible initially)
        let selectedPhysicsChemistrySubcategories = physicsChemistrySubCategoriesOrdered.map(cat => cat.key);
        let selectedBiologySubcategories = biologySubCategoriesOrdered.map(cat => cat.key);

        // Enhanced Daily Routine variables
        let dailyLogs = []; // Store all daily logs
        let upcomingPlans = []; // Store upcoming study plans  
        let backlogs = []; // Store backlog items
        let completedItems = []; // Store completed items
        let currentCalendarDate = new Date();
        let dailyQuotas = {
            physics: 100,
            chemistry: 100, 
            biology: 150
        };
        let todayQuotaProgress = {
            physics: 0,
            chemistry: 0,
            biology: 0
        };

        // Physics chapters and topics from the prompt
        const physicsChaptersTopics = {
            "Units and Measurements": [
                "SI units (fundamental & derived)",
                "Least count",
                "Significant figures", 
                "Errors in measurement",
                "Dimensions & dimensional analysis"
            ],
            "Motion in a Straight Line": [
                "Frame of reference",
                "Position–time & velocity–time graphs",
                "Speed, velocity, acceleration (uniform & non-uniform)",
                "Average vs instantaneous velocity",
                "Equations of motion under uniform acceleration"
            ],
            "Motion in a Plane": [
                "Scalars vs vectors",
                "Vector operations (addition, subtraction, dot & cross products)",
                "Unit vectors, resolution of vectors",
                "Relative velocity",
                "Projectile motion",
                "Uniform circular motion"
            ],
            "Laws of Motion": [
                "Force, inertia, Newton's 3 laws",
                "Momentum, impulse & conservation of momentum",
                "Equilibrium of forces",
                "Friction (static, kinetic, rolling)",
                "Dynamics of circular motion (centripetal force; banked roads)"
            ],
            "Work, Energy and Power": [
                "Work by constant & variable forces",
                "Kinetic & potential energy",
                "Work–energy theorem",
                "Power",
                "Mechanical energy conservation",
                "Conservative vs non-conservative forces",
                "Motion in vertical circles",
                "Elastic & inelastic collisions"
            ],
            "System of Particles and Rotational Motion": [
                "Centre of mass (two-particle & rigid bodies)",
                "Torque & moment of force",
                "Moment of inertia, radius of gyration",
                "Angular momentum & its conservation",
                "Parallel & perpendicular axis theorems",
                "Dynamics & equilibrium of rigid bodies"
            ],
            "Gravitation": [
                "Newton's universal law",
                "Acceleration due to gravity (variation)",
                "Kepler's laws",
                "Gravitational potential & energy",
                "Escape velocity",
                "Satellite motion (orbital velocity, period, energy)"
            ],
            "Mechanical Properties of Solids": [
                "Elastic behaviour, stress–strain",
                "Hooke's law",
                "Young's, shear & bulk moduli"
            ],
            "Mechanical Properties of Fluids": [
                "Pressure in fluids, buoyancy",
                "Equation of continuity",
                "Bernoulli's theorem",
                "Viscosity",
                "Surface tension"
            ],
            "Thermal Properties of Matter": [
                "Thermal expansion",
                "Specific heat capacity, calorimetry",
                "Latent heat",
                "Heat transfer: conduction, convection, radiation"
            ],
            "Thermodynamics": [
                "Zeroth, first & second laws",
                "Internal energy & work",
                "Processes: isothermal, adiabatic, cyclic",
                "Carnot cycle & engine"
            ],
            "Kinetic Theory": [
                "Ideal gas equation",
                "RMS speed & Maxwell's distribution",
                "Degrees of freedom & equipartition theorem"
            ],
            "Oscillations": [
                "Simple harmonic motion (SHM): definition, equation",
                "Energy in SHM"
            ],
            "Waves": [
                "Wave parameters (wavelength, frequency, speed)",
                "Transverse & longitudinal waves",
                "Wave propagation & interaction"
            ],
            "Electric Charges and Fields": [
                "Coulomb's law & system of charges",
                "Electric field (lines, flux)",
                "Gauss's law & applications",
                "Electric dipole in field"
            ],
            "Electrostatic Potential and Capacitance": [
                "Electric potential & potential energy",
                "Equipotential surfaces",
                "Capacitors (parallel plate), combinations",
                "Energy stored in capacitors"
            ],
            "Current Electricity": [
                "Ohm's law & resistivity",
                "Series & parallel circuits",
                "Kirchhoff's laws",
                "Electrical energy and power"
            ],
            "Moving Charges and Magnetism": [
                "Magnetic force on moving charges & currents",
                "Biot–Savart law, Ampère's law"
            ],
            "Magnetism and Matter": [
                "Magnetic dipole & dipole moment",
                "Torque on dipole in magnetic field",
                "Magnetic properties of materials"
            ],
            "Electromagnetic Induction": [
                "Faraday's law & Lenz's law",
                "Induced emf & current",
                "Self and mutual inductance"
            ],
            "Alternating Current": [
                "AC voltage & current in pure resistive, inductive, and capacitive circuits",
                "LC oscillation",
                "Resonance in LCR circuits"
            ],
            "Electromagnetic Waves": [
                "Maxwell's equations (qualitative)",
                "Electromagnetic spectrum & properties"
            ],
            "Ray Optics and Optical Instruments": [
                "Reflection, refraction, lenses, mirrors, magnification",
                "Human eye (defects & correction)",
                "Microscopes & telescopes"
            ],
            "Wave Optics": [
                "Huygens' principle",
                "Interference, diffraction",
                "Young's double slit experiment"
            ],
            "Dual Nature of Radiation and Matter": [
                "Photoelectric effect",
                "de Broglie wavelength",
                "Matter waves"
            ],
            "Atoms": [
                "Rutherford & Bohr models",
                "Energy levels, spectra, transitions"
            ],
            "Nuclei": [
                "Composition & size of nucleus",
                "Radioactivity (α, β, γ); decay law",
                "Nuclear binding energy & fission/fusion"
            ],
            "Semiconductor Electronics": [
                "Intrinsic & extrinsic semiconductors",
                "p‑n junction diode operation & characteristics",
                "Diode as rectifier; Zener diode",
                "Logic Gates"
            ]
        };

        // Chemistry chapters and topics from the prompt  
        const chemistryChaptersTopics = {
            "Some Basic Concepts of Chemistry": [
                "Matter and its nature",
                "Laws of chemical combination",
                "Dalton's atomic theory",
                "Atoms, molecules, elements, compounds",
                "Atomic and molecular masses",
                "Mole concept, molar mass",
                "Percentage composition",
                "Empirical and molecular formulas",
                "Chemical equations and stoichiometry"
            ],
            "Structure of Atom": [
                "Subatomic particles (electron, proton, neutron)",
                "Atomic number, mass number, isotopes & isobars",
                "Bohr's model of the atom",
                "Dual nature of matter & radiation",
                "Quantum mechanical model: quantum numbers, orbitals",
                "Electronic configuration"
            ],
            "Classification of Elements & Periodicity in Properties": [
                "Modern periodic table & periodic law",
                "Periodic trends: atomic/ionic radii, ionization enthalpy, electron gain enthalpy, electronegativity, valency"
            ],
            "Chemical Bonding & Molecular Structure": [
                "Valence electrons & bond types (ionic, covalent)",
                "Lewis structures & resonance",
                "VSEPR theory — molecular geometry",
                "Hybridization (sp, sp², sp³, dsp², d²sp³)",
                "Valence bond theory & concept of electronegativity",
                "Hydrogen bonding"
            ],
            "Thermodynamics": [
                "System and surroundings, types of systems",
                "State and path functions, internal energy (ΔU), enthalpy (ΔH)",
                "First law: P–V work, heat capacity, Hess's law",
                "Second law: entropy & spontaneity",
                "Gibbs free energy"
            ],
            "Equilibrium": [
                "Physical and chemical equilibrium",
                "Law of mass action & equilibrium constant",
                "Le Chatelier's principle",
                "Ionic equilibrium: pH, buffer solutions, solubility product & common-ion effect"
            ],
            "Redox Reactions": [
                "Oxidation states and balancing redox reactions",
                "Electrochemical cells (galvanic) – concept & applications"
            ],
            "Some p‑Block Elements": [
                "General introduction & electronic configuration",
                "Physical and chemical properties of group‑13 to group‑18",
                "Unique behaviour of first elements of each group"
            ],
            "Organic Chemistry – Some Basic Principles & Techniques": [
                "IUPAC nomenclature",
                "Electronic displacement effects (inductive, resonance)",
                "Isomerism (structural & stereoisomerism)",
                "Reaction intermediates (carbocation, carbene)",
                "Hybridization in organic compounds"
            ],
            "Hydrocarbons": [
                "Alkanes, alkenes, alkynes, aromatic hydrocarbons",
                "Conformations & isomerism",
                "Electrophilic addition & substitution reactions"
            ],
            "Solutions": [
                "Types of solutions, concentration terms",
                "Colligative properties"
            ],
            "Electrochemistry": [
                "Electrochemical cell, electrode potential",
                "Nernst equation, conductance, electrolysis"
            ],
            "Chemical Kinetics": [
                "Rate of reaction, order & molecularity",
                "Rate laws and factors affecting reaction rate"
            ],
            "The d‑ & f‑Block Elements": [
                "Electronic configuration of transition and inner-transition metals",
                "Oxidation states, color, magnetic properties, catalytic behavior",
                "Preparation and properties of K₂Cr₂O₇ and KMnO₄"
            ],
            "Coordination Compounds": [
                "Werner's theory & terminology",
                "Ligands, coordination numbers, chelation",
                "IUPAC nomenclature & isomerism",
                "Bonding theories: VBT & basics of CFT",
                "Color, magnetic properties, biological/industrial importance"
            ],
            "Haloalkanes and Haloarenes": [
                "Structure & nomenclature",
                "Preparation and substitution mechanisms",
                "Environmental effects"
            ],
            "Alcohols, Phenols and Ethers": [
                "Structure, preparation, classification",
                "Physical properties & acidic behavior (phenols)",
                "Reactions: dehydration, electrophilic substitution in phenols"
            ],
            "Aldehydes, Ketones and Carboxylic Acids": [
                "Structure & nomenclature",
                "Reactivity of carbonyl group, mechanism of addition",
                "Oxidation & reduction, aldol condensation, Cannizzaro, haloform tests"
            ],
            "Amines": [
                "Structure, classification (primary/secondary/tertiary)",
                "Basicity and identification tests",
                "Diazonium salts and their synthetic importance"
            ],
            "Biomolecules": [
                "Carbohydrates: mono-/oligosaccharides",
                "Proteins: amino acids, peptide bonds, structure levels, denaturation, enzymes",
                "Vitamins: classification & functions",
                "Nucleic acids (DNA/RNA): structure & biological function",
                "Hormones (introductory)"
            ]
        };

        // Biology chapters (no topics needed as per requirement)
        const biologyChapters = [
            "The Living World", "Biological Classification", "Plant Kingdom", "Animal Kingdom",
            "Morphology of Flowering Plants", "Anatomy of Flowering Plants", "Structural Organisation in Animals",
            "Cell - The Unit of Life", "Biomolecules", "Cell Cycle and Cell Division", "Photosynthesis in Higher Plants",
            "Respiration in Plants", "Plant Growth and Development", "Breathing and Exchange of Gases",
            "Body Fluids and Circulation", "Excretory Products and Their Elimination", "Locomotion and Movement",
            "Neural Control and Coordination", "Chemical Coordination and Integration", "Sexual Reproduction in Flowering Plants",
            "Human Reproduction", "Reproductive Health", "Principles of Inheritance and Variation",
            "Molecular Basis of Inheritance", "Evolution", "Human Health and Disease", "Microbes in Human Welfare",
            "Biotechnology - Principles and Processes", "Biotechnology and Its Applications", "Organisms and Populations",
            "Ecosystem", "Biodiversity and Conservation"
        ];

        // Tuition schedule for calendar marking
        const tuitionSchedule = {
            1: 'Biology', // Monday
            3: 'Chemistry & Physics', // Wednesday  
            4: 'Biology', // Thursday
            6: 'Physics & Chemistry' // Saturday
        };

        // Encouragement messages for quota completion
        const quotaMessages = {
            complete: [
                "🎉 Great job! You've reached your daily target!",
                "💪 Excellent work! Consistency is key to success!",
                "⭐ Fantastic! You're building great study habits!",
                "🚀 Well done! You're on track for NEET success!"
            ],
            exceeded: [
                "🔥 Outstanding! You've exceeded your daily target!",
                "👑 Superb effort! You're going above and beyond!",
                "✨ Incredible dedication! Keep up the amazing work!",
                "🏆 Phenomenal! You're setting new standards!"
            ]
        };

        // Your actual Firebase configuration (replace with your copied config from Firebase console)
        const firebaseConfig = {
          apiKey: "AIzaSyA29MM64OLCgKRfnl8tr-I39IIoBE-RLFM",
          authDomain: "my-neet-tracker-app.firebaseapp.com",
          projectId: "my-neet-tracker-app",
          storageBucket: "my-neet-tracker-app.firebasestorage.app",
          messagingSenderId: "931350823768",
          appId: "1:931350823768:web:b01f2325b8292d7dbd5b2d",
          measurementId: "G-3WEYVYQRYE" // Include if provided by Firebase
        };

        // Use your Firebase project ID as the appId for Firestore paths
        const appId = firebaseConfig.projectId;

        // DOM Elements
        const loginPage = document.getElementById('login-page');
        const mainAppContent = document.getElementById('main-app-content');
        const loginQuoteDisplay = document.getElementById('login-quote');
        const googleSignInButton = document.getElementById('google-signin-button');

        const tabButtons = {
            regularData: document.getElementById('tabRegularData'),
            tests: document.getElementById('tabTests'),
            analytics: document.getElementById('tabAnalytics'),
            goals: document.getElementById('tabGoals'),
            aiSuggestions: document.getElementById('tabAISuggestions')
        };
        const tabContents = {
            regularData: document.getElementById('contentRegularData'),
            tests: document.getElementById('contentTests'),
            analytics: document.getElementById('contentAnalytics'),
            goals: document.getElementById('contentGoals'),
            aiSuggestions: document.getElementById('contentAISuggestions')
        };

        const testEntrySubTabButtons = {
            ut: document.getElementById('testEntrySubTabUT'),
            bbcts: document.getElementById('testEntrySubTabBBCTS'),
            quarterly: document.getElementById('testEntrySubTabQuarterly'),
            missionNeet: document.getElementById('testEntrySubTabMissionNeet')
        };
        const testEntrySubTabContents = {
            ut: document.getElementById('testEntrySubContentUT'),
            bbcts: document.getElementById('testEntrySubContentBBCTS'),
            quarterly: document.getElementById('testEntrySubContentQuarterly'),
            missionNeet: document.getElementById('testEntrySubContentMissionNeet')
        };

        const analyticsSubTabButtons = {
            ut: document.getElementById('subTabUT'),
            bbcts: document.getElementById('subTabBBCTS'),
            quarterly: document.getElementById('subTabQuarterly'),
            missionNeetAnalytics: document.getElementById('subTabMissionNeetAnalytics'),
            syllabusProgression: document.getElementById('subTabSyllabusProgression')
        };
        const analyticsSubTabContents = {
            ut: document.getElementById('subContentUT'),
            bbcts: document.getElementById('subContentBBCTS'),
            quarterly: document.getElementById('subContentQuarterly'),
            missionNeetAnalytics: document.getElementById('subContentMissionNeetAnalytics'),
            syllabusProgression: document.getElementById('subContentSyllabusProgression')
        };

        // Goals Sub-Tab Elements
        const goalsSubTabButtons = {
            physics: document.getElementById('goalsSubTabPhysics'),
            chemistry: document.getElementById('goalsSubTabChemistry'),
            biology: document.getElementById('goalsSubTabBiology')
        };
        const goalsSubTabContents = {
            physics: document.getElementById('goalsSubContentPhysics'),
            chemistry: document.getElementById('goalsSubContentChemistry'),
            biology: document.getElementById('goalsSubContentBiology')
        };
        const physicsGoalsDisplay = document.getElementById('physicsGoalsDisplay');
        const chemistryGoalsDisplay = document.getElementById('chemistryGoalsDisplay');
        const biologyGoalsDisplay = document.getElementById('biologyGoalsDisplay');
        const getAIGoalsInsightsButton = document.getElementById('getAIGoalsInsightsButton');
        const aiGoalsAnalysisDisplay = document.getElementById('aiGoalsAnalysisDisplay');
        const subcategoryControls = document.getElementById('subcategory-controls');
        const physicsChemistrySubcategoryCheckboxes = document.getElementById('physicsChemistrySubcategoryCheckboxes');
        const biologySubcategoryCheckboxes = document.getElementById('biologySubcategoryCheckboxes');


        // UT Test Entry Fields
        const utDateInput = document.getElementById('utDate');
        const utSyllabusInput = document.getElementById('utSyllabus');
        const utFullMarksInput = document.getElementById('utFullMarks');
        const utPhysicsScoreInput = document.getElementById('utPhysicsScore');
        const utChemistryScoreInput = document.getElementById('utChemistryScore');
        const utBiologyScoreInput = document.getElementById('utBiologyScore');
        const utMyMarksInput = document.getElementById('utMyMarks');
        const saveUTButton = document.getElementById('saveUTButton');
        const testsDataDisplay = document.getElementById('testsDataDisplay');

        // BBCTS Test Entry Fields
        const bbctsDateInput = document.getElementById('bbctsDate');
        const bbctsSyllabusInput = document.getElementById('bbctsSyllabus');
        const bbctsFullMarksInput = document.getElementById('bbctsFullMarks');
        const bbctsPhysicsScoreInput = document.getElementById('bbctsPhysicsScore');
        const bbctsChemistryScoreInput = document.getElementById('bbctsChemistryScore');
        const bbctsBiologyScoreInput = document.getElementById('bbctsBiologyScore');
        const bbctsMyMarksInput = document.getElementById('bbctsMyMarks');
        const saveBBCTSButton = document.getElementById('saveBBCTSButton');
        const bbctsDataDisplay = document.getElementById('bbctsDataDisplay');

        // Quarterly Test Entry Fields
        const qtDateInput = document.getElementById('qtDate');
        const qtSyllabusInput = document.getElementById('qtSyllabus');
        const qtFullMarksInput = document.getElementById('qtFullMarks');
        const qtPhysicsScoreInput = document.getElementById('qtPhysicsScore');
        const qtChemistryScoreInput = document.getElementById('qtChemistryScore');
        const qtBiologyScoreInput = document.getElementById('qtBiologyScore');
        const qtMyMarksInput = document.getElementById('qtMyMarks');
        const saveQuarterlyButton = document.getElementById('saveQuarterlyButton');
        const quarterlyDataDisplay = document.getElementById('quarterlyDataDisplay');

        // Mission NEET Test Entry Fields
        const mnDateInput = document.getElementById('mnDate');
        const mnSyllabusInput = document.getElementById('mnSyllabus');
        const mnFullMarksInput = document.getElementById('mnFullMarks');
        const mnScoreInput = document.getElementById('mnScore');
        const saveMissionNeetButton = document.getElementById('saveMissionNeetButton');
        const missionNeetDataDisplay = document.getElementById('missionNeetDataDisplay');

        // Regular Data Entry Fields
        const logDateInput = document.getElementById('logDate');
        const logPhysicsTopicInput = document.getElementById('logPhysicsTopic');
        const logChemistryTopicInput = document.getElementById('logChemistryTopic');
        const logBiologyTopicInput = document.getElementById('logBiologyTopic');
        const logPhysicsMCQsInput = document.getElementById('logPhysicsMCQs');
        const logChemistryMCQsInput = document.getElementById('logChemistryMCQs');
        const logBiologyMCQsInput = document.getElementById('logBiologyMCQs');
        const logBacklogsInput = document.getElementById('logBacklogs');
        const saveRegularDataButton = document.getElementById('saveRegularDataButton');
        const regularDataDisplay = document.getElementById('regularDataDisplay');
        const getAIProductivityInsightsButton = document.getElementById('getAIProductivityInsightsButton');
        const aiProductivityAnalysisDisplay = document.getElementById('aiProductivityAnalysisDisplay');


        const analyticsCanvasPhysicsUT = document.getElementById('physicsChartUT');
        const analyticsCanvasChemistryUT = document.getElementById('chemistryChartUT');
        const analyticsCanvasBiologyUT = document.getElementById('biologyChartUT');

        const analyticsCanvasPhysicsBBCTS = document.getElementById('physicsChartBBCTS');
        const analyticsCanvasChemistryBBCTS = document.getElementById('chemistryChartBBCTS');
        const analyticsCanvasBiologyBBCTS = document.getElementById('biologyChartBBCTS');

        const analyticsCanvasPhysicsQuarterly = document.getElementById('physicsChartQuarterly');
        const analyticsCanvasChemistryQuarterly = document.getElementById('chemistryChartQuarterly');
        const analyticsCanvasBiologyQuarterly = document.getElementById('biologyChartQuarterly');

        const analyticsCanvasMissionNeet = document.getElementById('missionNeetChart');
        const syllabusProgressionCanvas = document.getElementById('syllabusProgressionChart');

        // Enhanced Daily Routine DOM Elements
        const dailyTabButtons = {
            today: document.getElementById('dailyTabToday'),
            upcoming: document.getElementById('dailyTabUpcoming'),
            backlogs: document.getElementById('dailyTabBacklogs'),
            completed: document.getElementById('dailyTabCompleted')
        };
        const dailyTabContents = {
            today: document.getElementById('dailyContentToday'),
            upcoming: document.getElementById('dailyContentUpcoming'),
            backlogs: document.getElementById('dailyContentBacklogs'),
            completed: document.getElementById('dailyContentCompleted')
        };

        // Calendar elements
        const calendarGrid = document.getElementById('calendarGrid');
        const currentMonthSpan = document.getElementById('currentMonth');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');

        // MCQ Quota elements
        const physicsQuotaCircle = document.getElementById('physicsQuota');
        const chemistryQuotaCircle = document.getElementById('chemistryQuota');
        const biologyQuotaCircle = document.getElementById('biologyQuota');
        const physicsQuotaText = document.getElementById('physicsQuotaText');
        const chemistryQuotaText = document.getElementById('chemistryQuotaText');
        const biologyQuotaText = document.getElementById('biologyQuotaText');

        // Today's form elements
        const physicsBookSelect = document.getElementById('physicsBook');
        const physicsChapterSelect = document.getElementById('physicsChapter');
        const physicsTopicsDiv = document.getElementById('physicsTopics');
        const physicsTopicsContainer = document.getElementById('physicsTopicsContainer');
        const chemistryBookSelect = document.getElementById('chemistryBook');
        const chemistryChapterSelect = document.getElementById('chemistryChapter');
        const chemistryTopicsDiv = document.getElementById('chemistryTopics');
        const chemistryTopicsContainer = document.getElementById('chemistryTopicsContainer');
        const biologyBookSelect = document.getElementById('biologyBook');
        const biologyChapterSelect = document.getElementById('biologyChapter');
        
        // MCQ inputs
        const physicsMcqCount = document.getElementById('physicsMcqCount');
        const physicsMcqManualSource = document.getElementById('physicsMcqManualSource');
        const physicsMcqManualCount = document.getElementById('physicsMcqManualCount');
        const chemistryMcqCount = document.getElementById('chemistryMcqCount');
        const chemistryMcqManualSource = document.getElementById('chemistryMcqManualSource');
        const chemistryMcqManualCount = document.getElementById('chemistryMcqManualCount');
        const biologyMcqCount = document.getElementById('biologyMcqCount');
        const biologyMcqManualSource = document.getElementById('biologyMcqManualSource');
        const biologyMcqManualCount = document.getElementById('biologyMcqManualCount');

        // Time and comments
        const physicsTime = document.getElementById('physicsTime');
        const physicsComments = document.getElementById('physicsComments');
        const chemistryTime = document.getElementById('chemistryTime');
        const chemistryComments = document.getElementById('chemistryComments');
        const biologyTime = document.getElementById('biologyTime');
        const biologyComments = document.getElementById('biologyComments');

        // Study type checkboxes
        const physicsTheory = document.getElementById('physicsTheory');
        const physicsMcqs = document.getElementById('physicsMcqs');
        const physicsRevision = document.getElementById('physicsRevision');
        const physicsNotes = document.getElementById('physicsNotes');
        const chemistryTheory = document.getElementById('chemistryTheory');
        const chemistryMcqsCheck = document.getElementById('chemistryMcqs');
        const chemistryRevision = document.getElementById('chemistryRevision');
        const chemistryNotes = document.getElementById('chemistryNotes');
        const biologyTheory = document.getElementById('biologyTheory');
        const biologyMcqsCheck = document.getElementById('biologyMcqs');
        const biologyRevision = document.getElementById('biologyRevision');
        const biologyNotes = document.getElementById('biologyNotes');

        // Action buttons
        const saveTodayLogButton = document.getElementById('saveTodayLogButton');
        const saveUpcomingPlanButton = document.getElementById('saveUpcomingPlanButton');

        // Summary displays
        const todayChapters = document.getElementById('todayChapters');
        const todayTime = document.getElementById('todayTime');
        const todayMcqs = document.getElementById('todayMcqs');
        const todayCompletion = document.getElementById('todayCompletion');

        // Table displays
        const todayEntriesTable = document.getElementById('todayEntriesTable');
        const upcomingPlansTable = document.getElementById('upcomingPlansTable');
        const backlogsTable = document.getElementById('backlogsTable');
        const completedTable = document.getElementById('completedTable');

        // Upcoming plans form
        const upcomingDate = document.getElementById('upcomingDate');
        const upcomingSubject = document.getElementById('upcomingSubject');
        const upcomingChapter = document.getElementById('upcomingChapter');
        const upcomingStudyType = document.getElementById('upcomingStudyType');
        const upcomingTime = document.getElementById('upcomingTime');

        // Backlog summary
        const totalBacklogs = document.getElementById('totalBacklogs');
        const weekBacklogs = document.getElementById('weekBacklogs');
        const oldestBacklog = document.getElementById('oldestBacklog');

        // Completion stats
        const weekCompleted = document.getElementById('weekCompleted');
        const monthCompleted = document.getElementById('monthCompleted');
        const totalCompleted = document.getElementById('totalCompleted');
        const successRate = document.getElementById('successRate');


        const getAIPerformanceInsightsButton = document.getElementById('getAIPerformanceInsightsButton');
        const aiPerformanceAnalysisDisplay = document.getElementById('aiPerformanceAnalysisDisplay');


        const getAISuggestionButton = document.getElementById('getAISuggestionButton');
        const aiPromptInput = document.getElementById('aiPromptInput');
        const aiResponseDisplay = document.getElementById('aiResponseDisplay');

        // Next Study Plan elements
        const getNextStudyPlanButton = document.getElementById('getNextStudyPlanButton');
        const nextStudyPlanDisplay = document.getElementById('nextStudyPlanDisplay');

        // Concept Explainer
        const conceptInput = document.getElementById('conceptInput');
        const explainConceptButton = document.getElementById('explainConceptButton');
        const conceptExplanationDisplay = document.getElementById('conceptExplanationDisplay');

        // Revision Topic Suggester
        const suggestRevisionTopicsButton = document.getElementById('suggestRevisionTopicsButton');
        const revisionSuggestionsDisplay = document.getElementById('revisionSuggestionsDisplay');

        // Mock Test Question Generator
        const questionSubjectSelect = document.getElementById('questionSubject');
        const questionTopicInput = document.getElementById('questionTopic');
        const generateQuestionsButton = document.getElementById('generateQuestionsButton');
        const generatedQuestionsDisplay = document.getElementById('generatedQuestionsDisplay');

        // NEW: Weakness Identification & Targeted Practice
        const identifyWeaknessesButton = document.getElementById('identifyWeaknessesButton');
        const weaknessAnalysisDisplay = document.getElementById('weaknessAnalysisDisplay');


        const userIdDisplay = document.getElementById('userIdDisplay');
        const countdownTimerDisplay = document.getElementById('countdown-timer');
        const motivationalQuoteDisplay = document.getElementById('motivational-quote');

        // Auth elements
        const signOutButton = document.getElementById('signOutButton');


        // --- Utility Functions ---

        /**
         * Displays a temporary status message to the user.
         * @param {string} message - The message to display.
         * @param {'success'|'error'|'info'} type - The type of message (for styling).
         */
        function showStatusMessage(message, type) {
            let statusDiv = document.querySelector('.status-message');
            if (!statusDiv) {
                statusDiv = document.createElement('div');
                statusDiv.classList.add('status-message');
                document.body.appendChild(statusDiv);
            }

            // Clear previous classes and set new ones
            statusDiv.className = 'status-message'; // Reset classes
            statusDiv.classList.add(type);
            statusDiv.textContent = message;

            // Show the message
            statusDiv.classList.add('show');

            // Hide after 3 seconds
            setTimeout(() => {
                statusDiv.classList.remove('show');
            }, 3000);
        }

        /**
         * Parses CSV text into an array of objects.
         * Assumes the first row is the header.
         * @param {string} csvText - The CSV data as a string.
         * @returns {Array<Object>} - An array of objects, where each object represents a row.
         */
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length === 0) return [];

            const headers = lines[0].split(',').map(header => header.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(value => value.trim());
                if (values.length !== headers.length) {
                    console.warn(`Skipping malformed row: ${lines[i]}`);
                    continue;
                }
                const rowObject = {};
                headers.forEach((header, index) => {
                    rowObject[header] = values[index];
                });
                data.push(rowObject);
            }
            return data;
        }

        // --- Firebase Initialization and Authentication ---

        /**
         * Handles user sign-out.
         */
        async function handleSignOut() {
            showStatusMessage("Signing out...", 'info');
            try {
                await signOut(auth);
                showStatusMessage("Signed out successfully!", 'success');
            } catch (error) {
                console.error("Error during sign out:", error);
                showStatusMessage("Sign out failed: " + error.message, 'error');
            }
        }

        /**
         * Handles Google Sign-In.
         */
        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            showStatusMessage("Signing in with Google...", 'info');
            try {
                await signInWithPopup(auth, provider);
                showStatusMessage("Google Sign-in successful!", 'success');
            } catch (error) {
                console.error("Error during Google sign-in:", error.code, error.message);
                let errorMessage = "Google Sign-in failed.";
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = "Sign-in window closed.";
                } else if (error.code === 'auth/cancelled-popup-request') {
                    errorMessage = "Sign-in already in progress.";
                }
                showStatusMessage(errorMessage, 'error');
            }
        }

        /**
         * Initializes Firebase and sets up authentication listener.
         */
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Listen for auth state changes to manage user ID and UI visibility
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // User is signed in.
                        userId = user.uid;
                        userEmail = user.email || 'N/A'; // Get email or set N/A
                        if (userIdDisplay) userIdDisplay.textContent = userEmail;

                        // Hide login page, show main app content
                        if (loginPage) loginPage.classList.add('hidden');
                        if (mainAppContent) mainAppContent.classList.remove('hidden');

                        console.log("User authenticated:", userId, userEmail);
                        setupDataListeners(); // Setup listeners only when a user is confirmed
                        displayRandomQuoteAndSave(); // Update main app quote
                    } else {
                        // User is signed out.
                        userId = 'not-authenticated';
                        userEmail = 'Not Logged In';
                        if (userIdDisplay) userIdDisplay.textContent = userEmail;

                        // Show login page, hide main app content
                        if (loginPage) loginPage.classList.remove('hidden');
                        if (mainAppContent) mainAppContent.classList.add('hidden');

                        console.log("No user signed in.");
                        // Clear data displays and charts if user logs out
                        if (regularDataDisplay) regularDataDisplay.textContent = "Please log in to view your data.";
                        if (testsDataDisplay) testsDataDisplay.textContent = "Please log in to view your data.";
                        if (bbctsDataDisplay) bbctsDataDisplay.textContent = "Please log in to view your data.";
                        if (quarterlyDataDisplay) quarterlyDataDisplay.textContent = "Please log in to view your data.";
                        if (missionNeetDataDisplay) missionNeetDataDisplay.textContent = "Please log in to view your data.";
                        if (aiProductivityAnalysisDisplay) aiProductivityAnalysisDisplay.textContent = "Please log in to view AI analysis.";
                        if (aiPerformanceAnalysisDisplay) aiPerformanceAnalysisDisplay.textContent = "Please log in to view AI analysis.";
                        if (aiGoalsAnalysisDisplay) aiGoalsAnalysisDisplay.textContent = "Please log in to view AI analysis.";
                        if (aiResponseDisplay) aiResponseDisplay.textContent = "Please log in to get AI suggestions.";
                        if (nextStudyPlanDisplay) nextStudyPlanDisplay.textContent = "Please log in to get your next study plan.";
                        if (conceptExplanationDisplay) conceptExplanationDisplay.textContent = "Please log in to get concept explanations.";
                        if (revisionSuggestionsDisplay) revisionSuggestionsDisplay.textContent = "Please log in to get revision suggestions.";
                        if (generatedQuestionsDisplay) generatedQuestionsDisplay.textContent = "Please log in to generate questions.";
                        if (weaknessAnalysisDisplay) weaknessAnalysisDisplay.textContent = "Please log in to get weakness analysis.";


                        destroyChart(physicsChartUTInstance);
                        destroyChart(chemistryChartUTInstance);
                        destroyChart(biologyChartUTInstance);
                        destroyChart(physicsChartBBCTSInstance);
                        destroyChart(chemistryChartBBCTSInstance);
                        destroyChart(biologyChartBBCTSInstance);
                        destroyChart(physicsChartQuarterlyInstance);
                        destroyChart(chemistryChartQuarterlyInstance);
                        destroyChart(biologyChartQuarterlyInstance);
                        destroyChart(missionNeetChartInstance);
                        destroyChart(syllabusProgressionChartInstance);

                        // Set a random quote for the login page
                        displayRandomLoginQuote();
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showStatusMessage("Error loading app. Please check console for details.", 'error');
                if (userIdDisplay) userIdDisplay.textContent = "Error";
                // Still show login page even if Firebase init fails, but with error message
                if (loginPage) loginPage.classList.remove('hidden');
                if (mainAppContent) mainAppContent.classList.add('hidden');
            }
        }

        /**
         * Sets up real-time listeners for different data types in Firestore.
         */
        function setupDataListeners() {
            if (!db || !userId || userId === 'loading' || userId === 'not-authenticated') {
                console.warn("Firestore not initialized or user not authenticated. Cannot set up data listeners.");
                return;
            }

            // Listener for Regular Data Logs
            const regularDocRef = doc(db, `artifacts/${appId}/users/${userId}/regularDataLogs`, 'myDailyLogs');
            onSnapshot(regularDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    try {
                        regularDataLogs = JSON.parse(data.content || "[]");
                        if (regularDataDisplay) regularDataDisplay.textContent = JSON.stringify(regularDataLogs, null, 2); // Pretty print JSON
                    } catch (e) {
                        console.error("Error parsing regular data logs from Firestore:", e);
                        if (regularDataDisplay) regularDataDisplay.textContent = "Error: Stored regular data is not valid JSON.";
                        regularDataLogs = [];
                    }
                    console.log("Regular data logs loaded from Firestore:", regularDataLogs);
                } else {
                    regularDataLogs = [];
                    if (regularDataDisplay) regularDataDisplay.textContent = "No daily logs stored yet.";
                    console.log("No regular data logs document found.");
                }
            }, (error) => {
                console.error("Error listening to regular data logs document:", error);
                if (regularDataDisplay) regularDataDisplay.textContent = "Error loading regular data. Please check console.";
            });


            // Listener for Tests Data (UT)
            const testsDocRef = doc(db, `artifacts/${appId}/users/${userId}/testData`, 'myTestDocument');
            onSnapshot(testsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    try {
                        utTestData = JSON.parse(data.content || "[]");
                        if (testsDataDisplay) testsDataDisplay.textContent = JSON.stringify(utTestData, null, 2); // Pretty print JSON
                    } catch (e) {
                        console.error("Error parsing UT test data from Firestore:", e);
                        if (testsDataDisplay) testsDataDisplay.textContent = "Error: Stored UT data is not valid JSON.";
                        utTestData = []; // Reset to empty array on parse error
                    }
                    console.log("Tests data loaded from Firestore:", utTestData);
                    // Automatically update graphs if analytics tab is active and UT sub-tab is active
                    if (tabContents.analytics && tabContents.analytics.classList.contains('active') && analyticsSubTabContents.ut && analyticsSubTabContents.ut.classList.contains('active')) {
                        drawAllCharts();
                    }
                } else {
                    utTestData = [];
                    if (testsDataDisplay) testsDataDisplay.textContent = "No Unit Tests data stored yet.";
                    console.log("No tests data document found.");
                }
            }, (error) => {
                console.error("Error listening to tests data document:", error);
                if (testsDataDisplay) testsDataDisplay.textContent = "Error loading tests data. Please check console.";
            });

            // Listener for BBCTS Data
            const bbctsDocRef = doc(db, `artifacts/${appId}/users/${userId}/bbctsData`, 'myBBCTSDocument');
            onSnapshot(bbctsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    try {
                        bbctsData = JSON.parse(data.content || "[]");
                        if (bbctsDataDisplay) bbctsDataDisplay.textContent = JSON.stringify(bbctsData, null, 2);
                    } catch (e) {
                        console.error("Error parsing BBCTS data from Firestore:", e);
                        if (bbctsDataDisplay) bbctsDataDisplay.textContent = "Error: Stored BBCTS data is not valid JSON.";
                        bbctsData = [];
                    }
                    console.log("BBCTS data loaded from Firestore:", bbctsData);
                    // Automatically update graphs if analytics tab is active and BBCTS sub-tab is active
                    if (tabContents.analytics && tabContents.analytics.classList.contains('active') && analyticsSubTabContents.bbcts && analyticsSubTabContents.bbcts.classList.contains('active')) {
                        drawAllCharts();
                    }
                } else {
                    bbctsData = [];
                    if (bbctsDataDisplay) bbctsDataDisplay.textContent = "No BB Classes Test Series data stored yet.";
                    console.log("No BBCTS data document found.");
                }
            }, (error) => {
                console.error("Error listening to BBCTS data document:", error);
                if (bbctsDataDisplay) bbctsDataDisplay.textContent = "Error loading BBCTS data. Please check console.";
            });

            // Listener for Quarterly Data
            const quarterlyDocRef = doc(db, `artifacts/${appId}/users/${userId}/quarterlyData`, 'myQuarterlyDocument');
            onSnapshot(quarterlyDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    try {
                        quarterlyData = JSON.parse(data.content || "[]");
                        if (quarterlyDataDisplay) quarterlyDataDisplay.textContent = JSON.stringify(quarterlyData, null, 2);
                    } catch (e) {
                        console.error("Error parsing Quarterly data from Firestore:", e);
                        if (quarterlyDataDisplay) quarterlyDataDisplay.textContent = "Error: Stored Quarterly data is not valid JSON.";
                        quarterlyData = [];
                    }
                    console.log("Quarterly data loaded from Firestore:", quarterlyData);
                    // Automatically update graphs if analytics tab is active and Quarterly sub-tab is active
                    if (tabContents.analytics && tabContents.analytics.classList.contains('active') && analyticsSubTabContents.quarterly && analyticsSubTabContents.quarterly.classList.contains('active')) {
                        drawAllCharts();
                    }
                } else {
                    quarterlyData = [];
                    if (quarterlyDataDisplay) quarterlyDataDisplay.textContent = "No Quarterly Tests data stored yet.";
                    console.log("No Quarterly data document found.");
                }
            }, (error) => {
                console.error("Error listening to Quarterly data document:", error);
                if (quarterlyDataDisplay) quarterlyDataDisplay.textContent = "Error loading Quarterly data. Please check console.";
            });

            // Listener for Mission NEET Data
            const missionNeetDocRef = doc(db, `artifacts/${appId}/users/${userId}/missionNeetData`, 'myMissionNeetDocument');
            onSnapshot(missionNeetDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    try {
                        missionNeetData = JSON.parse(data.content || "[]");
                        if (missionNeetDataDisplay) missionNeetDataDisplay.textContent = JSON.stringify(missionNeetData, null, 2); // Pretty print JSON
                    } catch (e) {
                        console.error("Error parsing Mission NEET data from Firestore:", e);
                        if (missionNeetDataDisplay) missionNeetDataDisplay.textContent = "Error: Stored Mission NEET data is not valid JSON.";
                        missionNeetData = []; // Reset to empty array on parse error
                    }
                    console.log("Mission NEET data loaded from Firestore:", missionNeetData);
                    // Automatically update graphs if analytics tab is active and Mission NEET sub-tab is active
                    if (tabContents.analytics && tabContents.analytics.classList.contains('active') && analyticsSubTabContents.missionNeetAnalytics && analyticsSubTabContents.missionNeetAnalytics.classList.contains('active')) {
                        drawAllCharts();
                    }
                } else {
                    missionNeetData = [];
                    if (missionNeetDataDisplay) missionNeetDataDisplay.textContent = "No Mission NEET Tests data stored yet.";
                    console.log("No Mission NEET data document found.");
                }
            }, (error) => {
                console.error("Error listening to Mission NEET data document:", error);
                if (missionNeetDataDisplay) missionNeetDataDisplay.textContent = "Error loading Mission NEET data. Please check console.";
            });

            // Listener for Quote State (to persist daily quote)
            const quoteStateDocRef = doc(db, `artifacts/${appId}/users/${userId}/appState`, 'quoteState');
            onSnapshot(quoteStateDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const today = new Date().toISOString().split('T')[0];
                    if (data.lastQuoteDate === today) {
                        if (motivationalQuoteDisplay) motivationalQuoteDisplay.textContent = `"${motivationalQuotes[data.lastQuoteIndex]}"`;
                    } else {
                        // If date is different, pick a new quote and update Firestore
                        displayRandomQuoteAndSave();
                    }
                } else {
                    // No quote state found, set initial quote
                    displayRandomQuoteAndSave();
                }
            }, (error) => {
                console.error("Error listening to quote state document:", error);
                // Fallback to random quote without persistence
                displayRandomQuoteAndSave();
            });

            // Listener for Chapter Status (isCompleted)
            const chapterStatusDocRef = doc(db, `artifacts/${appId}/users/${userId}/appState`, 'chapterStatus');
            onSnapshot(chapterStatusDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    try {
                        chapterStatus = JSON.parse(data.content || "{}");
                        // Re-render goals chapters to reflect updated status
                        renderGoalsChapters('physics');
                        renderGoalsChapters('chemistry');
                        renderGoalsChapters('biology');
                        // Redraw syllabus progression chart
                        if (tabContents.analytics && tabContents.analytics.classList.contains('active') && analyticsSubTabContents.syllabusProgression && analyticsSubTabContents.syllabusProgression.classList.contains('active')) {
                            drawSyllabusProgressionChart();
                        }
                    } catch (e) {
                        console.error("Error parsing chapter status from Firestore:", e);
                        chapterStatus = {};
                    }
                    console.log("Chapter status loaded from Firestore:", chapterStatus);
                } else {
                    chapterStatus = {};
                    console.log("No chapter status document found.");
                }
            }, (error) => {
                console.error("Error listening to chapter status document:", error);
            });
        }

        // --- Data Saving Functions ---

        /**
         * Saves the regular data from the input fields to Firestore.
         */
        async function saveRegularData() {
            if (userId === 'not-authenticated') {
                showStatusMessage("Please sign in to save your daily log data.", 'error');
                return;
            }

            const newLogEntry = {
                date: logDateInput.value,
                physicsTopic: logPhysicsTopicInput.value,
                chemistryTopic: logChemistryTopicInput.value,
                biologyTopic: logBiologyTopicInput.value,
                physicsMCQs: logPhysicsMCQsInput.value,
                chemistryMCQs: logChemistryMCQsInput.value,
                biologyMCQs: logBiologyMCQsInput.value,
                backlogs: logBacklogsInput.value
            };

            // Add the new entry to the existing logs
            const updatedLogs = [...regularDataLogs, newLogEntry];

            const docRef = doc(db, `artifacts/${appId}/users/${userId}/regularDataLogs`, 'myDailyLogs');

            try {
                // Store the stringified JSON array
                await setDoc(docRef, { content: JSON.stringify(updatedLogs) });
                console.log("Daily log successfully saved!");
                showStatusMessage("Daily log saved successfully!", 'success');
                // Clear input fields after saving
                if (logPhysicsTopicInput) logPhysicsTopicInput.value = '';
                if (logChemistryTopicInput) logChemistryTopicInput.value = '';
                if (logBiologyTopicInput) logBiologyTopicInput.value = '';
                if (logPhysicsMCQsInput) logPhysicsMCQsInput.value = '';
                if (logChemistryMCQsInput) logChemistryMCQsInput.value = '';
                if (logBiologyMCQsInput) logBiologyMCQsInput.value = '';
                if (logBacklogsInput) logBacklogsInput.value = '';
                // Set date back to today's date
                if (logDateInput) logDateInput.value = new Date().toISOString().split('T')[0];

                // Update quote if data is logged for a new day
                const today = new Date().toISOString().split('T')[0];
                const quoteStateDocRef = doc(db, `artifacts/${appId}/users/${userId}/appState`, 'quoteState');
                const docSnap = await getDoc(quoteStateDocRef); // Get current state
                if (!docSnap.exists() || docSnap.data().lastQuoteDate !== today) {
                    displayRandomQuoteAndSave();
                }

            } catch (error) {
                console.error("Error saving daily log:", error);
                showStatusMessage("Error saving daily log. Please try again.", 'error');
            }
        }

        /**
         * Saves the Unit Test data from the input fields to Firestore.
         */
        async function saveUTData() {
            if (userId === 'not-authenticated') {
                showStatusMessage("Please sign in to save your Unit Test data.", 'error');
                return;
            }

            const newUTEntry = {
                date: utDateInput.value,
                syllabus: utSyllabusInput.value,
                fullMarks: parseFloat(utFullMarksInput.value),
                physicsScore: parseFloat(utPhysicsScoreInput.value),
                chemistryScore: parseFloat(utChemistryScoreInput.value),
                biologyScore: parseFloat(utBiologyScoreInput.value),
                myMarks: parseFloat(utMyMarksInput.value)
            };

            // Basic validation
            if (!newUTEntry.date || !newUTEntry.syllabus || isNaN(newUTEntry.fullMarks) || isNaN(newUTEntry.physicsScore) ||
                isNaN(newUTEntry.chemistryScore) || isNaN(newUTEntry.biologyScore) || isNaN(newUTEntry.myMarks)) {
                showStatusMessage("Please fill all Unit Test fields with valid data.", 'error');
                return;
            }

            const updatedUTData = [...utTestData, newUTEntry];
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/testData`, 'myTestDocument');

            try {
                await setDoc(docRef, { content: JSON.stringify(updatedUTData) });
                console.log("Unit Test data successfully saved!");
                showStatusMessage("Unit Test data saved successfully!", 'success');
                // Clear input fields
                if (utDateInput) utDateInput.value = new Date().toISOString().split('T')[0];
                if (utSyllabusInput) utSyllabusInput.value = '';
                if (utFullMarksInput) utFullMarksInput.value = '';
                if (utPhysicsScoreInput) utPhysicsScoreInput.value = '';
                if (utChemistryScoreInput) utChemistryScoreInput.value = '';
                if (utBiologyScoreInput) utBiologyScoreInput.value = '';
                if (utMyMarksInput) utMyMarksInput.value = '';
            } catch (error) {
                console.error("Error saving Unit Test data:", error);
                showStatusMessage("Error saving Unit Test data. Please try again.", 'error');
            }
        }

        // --- Enhanced Daily Routine Functions ---

        /**
         * Initialize chapter dropdowns based on selected book
         */
        function initializeChapterDropdowns() {
            // Physics chapter dropdown
            physicsChapterSelect.innerHTML = '<option value="">Select Chapter (Optional)</option>';
            Object.keys(physicsChaptersTopics).forEach(chapter => {
                const option = document.createElement('option');
                option.value = chapter;
                option.textContent = chapter;
                physicsChapterSelect.appendChild(option);
            });

            // Chemistry chapter dropdown
            chemistryChapterSelect.innerHTML = '<option value="">Select Chapter (Optional)</option>';
            Object.keys(chemistryChaptersTopics).forEach(chapter => {
                const option = document.createElement('option');
                option.value = chapter;
                option.textContent = chapter;
                chemistryChapterSelect.appendChild(option);
            });

            // Biology chapter dropdown  
            biologyChapterSelect.innerHTML = '<option value="">Select Chapter (Optional)</option>';
            biologyChapters.forEach(chapter => {
                const option = document.createElement('option');
                option.value = chapter;
                option.textContent = chapter;
                biologyChapterSelect.appendChild(option);
            });
        }

        /**
         * Populate topics based on selected chapter
         */
        function populateTopics(subject, chapter) {
            if (subject === 'physics' && physicsChaptersTopics[chapter]) {
                physicsTopicsContainer.style.display = 'block';
                physicsTopicsDiv.innerHTML = '';
                physicsChaptersTopics[chapter].forEach(topic => {
                    const div = document.createElement('div');
                    div.className = 'topic-item';
                    div.innerHTML = `
                        <input type="checkbox" id="physics_${topic.replace(/[^a-zA-Z0-9]/g, '_')}" value="${topic}">
                        <label for="physics_${topic.replace(/[^a-zA-Z0-9]/g, '_')}" class="text-sm">${topic}</label>
                    `;
                    physicsTopicsDiv.appendChild(div);
                });
            } else if (subject === 'chemistry' && chemistryChaptersTopics[chapter]) {
                chemistryTopicsContainer.style.display = 'block';
                chemistryTopicsDiv.innerHTML = '';
                chemistryChaptersTopics[chapter].forEach(topic => {
                    const div = document.createElement('div');
                    div.className = 'topic-item';
                    div.innerHTML = `
                        <input type="checkbox" id="chemistry_${topic.replace(/[^a-zA-Z0-9]/g, '_')}" value="${topic}">
                        <label for="chemistry_${topic.replace(/[^a-zA-Z0-9]/g, '_')}" class="text-sm">${topic}</label>
                    `;
                    chemistryTopicsDiv.appendChild(div);
                });
            } else {
                if (subject === 'physics') physicsTopicsContainer.style.display = 'none';
                if (subject === 'chemistry') chemistryTopicsContainer.style.display = 'none';
            }
        }

        /**
         * Update MCQ quota progress circles
         */
        function updateQuotaProgress() {
            const physicsProgress = Math.min(todayQuotaProgress.physics / dailyQuotas.physics * 360, 360);
            const chemistryProgress = Math.min(todayQuotaProgress.chemistry / dailyQuotas.chemistry * 360, 360);
            const biologyProgress = Math.min(todayQuotaProgress.biology / dailyQuotas.biology * 360, 360);

            physicsQuotaCircle.style.setProperty('--progress', `${physicsProgress}deg`);
            chemistryQuotaCircle.style.setProperty('--progress', `${chemistryProgress}deg`);
            biologyQuotaCircle.style.setProperty('--progress', `${biologyProgress}deg`);

            physicsQuotaText.textContent = `${todayQuotaProgress.physics}/${dailyQuotas.physics}`;
            chemistryQuotaText.textContent = `${todayQuotaProgress.chemistry}/${dailyQuotas.chemistry}`;
            biologyQuotaText.textContent = `${todayQuotaProgress.biology}/${dailyQuotas.biology}`;

            // Check for quota completion and show encouragement
            checkQuotaCompletion();
        }

        /**
         * Check quota completion and show encouragement messages
         */
        function checkQuotaCompletion() {
            ['physics', 'chemistry', 'biology'].forEach(subject => {
                const progress = todayQuotaProgress[subject];
                const target = dailyQuotas[subject];
                
                if (progress >= target && progress > 0) {
                    const messages = progress > target ? quotaMessages.exceeded : quotaMessages.complete;
                    const message = messages[Math.floor(Math.random() * messages.length)];
                    showStatusMessage(`${subject.charAt(0).toUpperCase() + subject.slice(1)}: ${message}`, 'success');
                }
            });
        }

        /**
         * Generate calendar for current month
         */
        function generateCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            currentMonthSpan.textContent = `${currentCalendarDate.toLocaleString('default', { month: 'long' })} ${year}`;
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            calendarGrid.innerHTML = '';
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day';
                calendarGrid.appendChild(emptyCell);
            }
            
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                dayCell.textContent = day;
                
                const currentDate = new Date(year, month, day);
                const today = new Date();
                const dayOfWeek = currentDate.getDay();
                
                // Mark today
                if (currentDate.toDateString() === today.toDateString()) {
                    dayCell.classList.add('today');
                }
                
                // Mark tuition days
                if (tuitionSchedule[dayOfWeek]) {
                    dayCell.classList.add('has-tuition');
                    dayCell.title = `Tuition: ${tuitionSchedule[dayOfWeek]}`;
                }
                
                // Check for backlogs and quota status (you would implement this based on your data)
                // dayCell.classList.add('has-backlog'); // if backlog exists for this day
                // dayCell.classList.add('quota-complete'); // if quota was completed
                // dayCell.classList.add('quota-exceeded'); // if quota was exceeded
                
                calendarGrid.appendChild(dayCell);
            }
        }

        /**
         * Save today's study log
         */
        async function saveTodayLog() {
            if (userId === 'not-authenticated') {
                showStatusMessage("Please sign in to save your study log.", 'error');
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            
            // Collect data for each subject
            const logEntry = {
                date: today,
                timestamp: new Date().toISOString(),
                physics: {
                    book: physicsBookSelect.value,
                    chapter: physicsChapterSelect.value,
                    topics: getSelectedTopics('physics'),
                    studyTypes: getSelectedStudyTypes('physics'),
                    mcqCount: parseInt(physicsMcqCount.value) || 0,
                    mcqManualSource: physicsMcqManualSource.value,
                    mcqManualCount: parseInt(physicsMcqManualCount.value) || 0,
                    timeSpent: physicsTime.value,
                    comments: physicsComments.value
                },
                chemistry: {
                    book: chemistryBookSelect.value,
                    chapter: chemistryChapterSelect.value,
                    topics: getSelectedTopics('chemistry'),
                    studyTypes: getSelectedStudyTypes('chemistry'),
                    mcqCount: parseInt(chemistryMcqCount.value) || 0,
                    mcqManualSource: chemistryMcqManualSource.value,
                    mcqManualCount: parseInt(chemistryMcqManualCount.value) || 0,
                    timeSpent: chemistryTime.value,
                    comments: chemistryComments.value
                },
                biology: {
                    book: biologyBookSelect.value,
                    chapter: biologyChapterSelect.value,
                    studyTypes: getSelectedStudyTypes('biology'),
                    mcqCount: parseInt(biologyMcqCount.value) || 0,
                    mcqManualSource: biologyMcqManualSource.value,
                    mcqManualCount: parseInt(biologyMcqManualCount.value) || 0,
                    timeSpent: biologyTime.value,
                    comments: biologyComments.value
                }
            };

            // Update today's quota progress
            todayQuotaProgress.physics = logEntry.physics.mcqCount + logEntry.physics.mcqManualCount;
            todayQuotaProgress.chemistry = logEntry.chemistry.mcqCount + logEntry.chemistry.mcqManualCount;
            todayQuotaProgress.biology = logEntry.biology.mcqCount + logEntry.biology.mcqManualCount;
            
            updateQuotaProgress();

            // Add to daily logs
            const existingIndex = dailyLogs.findIndex(log => log.date === today);
            if (existingIndex >= 0) {
                dailyLogs[existingIndex] = logEntry;
            } else {
                dailyLogs.push(logEntry);
            }

            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/dailyLogs`, 'enhancedDailyLogs');
                await setDoc(docRef, { content: JSON.stringify(dailyLogs) });
                showStatusMessage("Today's study log saved successfully!", 'success');
                
                // Update displays
                updateTodaysSummary();
                renderTodaysEntries();
                
                // Clear non-essential fields (keep selections for easy re-entry)
                clearOptionalFields();
                
            } catch (error) {
                console.error("Error saving today's log:", error);
                showStatusMessage("Error saving study log. Please try again.", 'error');
            }
        }

        /**
         * Get selected topics for a subject
         */
        function getSelectedTopics(subject) {
            const container = subject === 'physics' ? physicsTopicsDiv : chemistryTopicsDiv;
            const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(checkbox => checkbox.value);
        }

        /**
         * Get selected study types for a subject
         */
        function getSelectedStudyTypes(subject) {
            const types = [];
            if (subject === 'physics') {
                if (physicsTheory.checked) types.push('Theory');
                if (physicsMcqs.checked) types.push('MCQs');
                if (physicsRevision.checked) types.push('Revision');
                if (physicsNotes.checked) types.push('Notes');
            } else if (subject === 'chemistry') {
                if (chemistryTheory.checked) types.push('Theory');
                if (chemistryMcqsCheck.checked) types.push('MCQs');
                if (chemistryRevision.checked) types.push('Revision');
                if (chemistryNotes.checked) types.push('Notes');
            } else if (subject === 'biology') {
                if (biologyTheory.checked) types.push('Theory');
                if (biologyMcqsCheck.checked) types.push('MCQs');
                if (biologyRevision.checked) types.push('Revision');
                if (biologyNotes.checked) types.push('Notes');
            }
            return types;
        }

        /**
         * Clear optional fields after saving
         */
        function clearOptionalFields() {
            // Clear MCQ counts
            physicsMcqCount.value = '';
            physicsMcqManualSource.value = '';
            physicsMcqManualCount.value = '';
            chemistryMcqCount.value = '';
            chemistryMcqManualSource.value = '';
            chemistryMcqManualCount.value = '';
            biologyMcqCount.value = '';
            biologyMcqManualSource.value = '';
            biologyMcqManualCount.value = '';
            
            // Clear time and comments
            physicsTime.value = '';
            physicsComments.value = '';
            chemistryTime.value = '';
            chemistryComments.value = '';
            biologyTime.value = '';
            biologyComments.value = '';
            
            // Uncheck study types
            [physicsTheory, physicsMcqs, physicsRevision, physicsNotes,
             chemistryTheory, chemistryMcqsCheck, chemistryRevision, chemistryNotes,
             biologyTheory, biologyMcqsCheck, biologyRevision, biologyNotes].forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        /**
         * Update today's summary
         */
        function updateTodaysSummary() {
            const today = new Date().toISOString().split('T')[0];
            const todaysLog = dailyLogs.find(log => log.date === today);
            
            if (todaysLog) {
                let chapters = 0;
                let totalTime = 0;
                let totalMcqs = 0;
                
                [todaysLog.physics, todaysLog.chemistry, todaysLog.biology].forEach(subject => {
                    if (subject.chapter) chapters++;
                    totalMcqs += subject.mcqCount + subject.mcqManualCount;
                    // You could parse time strings here for accurate calculation
                });
                
                todayChapters.textContent = chapters;
                todayMcqs.textContent = totalMcqs;
                // Calculate completion percentage based on some criteria
                const targetMcqs = dailyQuotas.physics + dailyQuotas.chemistry + dailyQuotas.biology;
                const completion = Math.min(Math.round(totalMcqs / targetMcqs * 100), 100);
                todayCompletion.textContent = `${completion}%`;
            }
        }

        /**
         * Render today's entries table
         */
        function renderTodaysEntries() {
            const today = new Date().toISOString().split('T')[0];
            const todaysLogs = dailyLogs.filter(log => log.date === today);
            
            if (todaysLogs.length === 0) {
                todayEntriesTable.innerHTML = '<p class="text-gray-500 text-center py-4">No entries for today yet.</p>';
                return;
            }
            
            let tableHTML = `
                <table class="w-full text-sm border-collapse">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="border p-2 text-left">Subject</th>
                            <th class="border p-2 text-left">Chapter</th>
                            <th class="border p-2 text-left">MCQs</th>
                            <th class="border p-2 text-left">Time</th>
                            <th class="border p-2 text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            todaysLogs.forEach((log, index) => {
                ['physics', 'chemistry', 'biology'].forEach(subject => {
                    const subjectData = log[subject];
                    if (subjectData.chapter || subjectData.mcqCount > 0 || subjectData.mcqManualCount > 0) {
                        tableHTML += `
                            <tr>
                                <td class="border p-2 capitalize">${subject}</td>
                                <td class="border p-2">${subjectData.chapter || '-'}</td>
                                <td class="border p-2">${subjectData.mcqCount + subjectData.mcqManualCount}</td>
                                <td class="border p-2">${subjectData.timeSpent || '-'}</td>
                                <td class="border p-2">
                                    <button onclick="editEntry('${log.date}', '${subject}')" class="text-blue-600 hover:underline mr-2">Edit</button>
                                    <button onclick="markCompleted('${log.date}', '${subject}')" class="text-green-600 hover:underline">✓</button>
                                </td>
                            </tr>
                        `;
                    }
                });
            });
            
            tableHTML += '</tbody></table>';
            todayEntriesTable.innerHTML = tableHTML;
        }

        /**
         * Activate daily routine sub-tab
         */
        function activateDailyTab(tabName) {
            // Remove active class from all buttons and contents
            Object.values(dailyTabButtons).forEach(btn => btn.classList.remove('active'));
            Object.values(dailyTabContents).forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab
            dailyTabButtons[tabName].classList.add('active');
            dailyTabContents[tabName].classList.add('active');
            
            // Load data for the specific tab
            switch(tabName) {
                case 'today':
                    updateTodaysSummary();
                    renderTodaysEntries();
                    break;
                case 'upcoming':
                    renderUpcomingPlans();
                    break;
                case 'backlogs':
                    renderBacklogs();
                    break;
                case 'completed':
                    renderCompleted();
                    break;
            }
        }

        /**
         * Placeholder functions for other tabs
         */
        function renderUpcomingPlans() {
            upcomingPlansTable.innerHTML = '<p class="text-gray-500 text-center py-4">No upcoming plans yet.</p>';
        }
        
        function renderBacklogs() {
            backlogsTable.innerHTML = '<p class="text-gray-500 text-center py-4">No backlogs detected. Great job! 🎉</p>';
        }
        
        function renderCompleted() {
            completedTable.innerHTML = '<p class="text-gray-500 text-center py-4">No completed studies yet.</p>';
        }

        // --- Goals Functions (Missing Functions) ---

        /**
         * Render subcategory checkboxes for Physics/Chemistry or Biology
         */
        function renderSubcategoryCheckboxes(subject) {
            // This function would render checkboxes for goals section
            // For now, just log that it's being called
            console.log(`Rendering subcategory checkboxes for ${subject}`);
        }

        /**
         * Render goals chapters for the specified subject
         */
        function renderGoalsChapters(subject) {
            // This function would render the chapters for the goals section
            // For now, just log that it's being called
            console.log(`Rendering goals chapters for ${subject}`);
        }

        /**
         * Load goals data and initialize the goals section
         */
        function loadGoalsData() {
            showStatusMessage("Loading syllabus data...", 'info');
            try {
                // Initialize the goals data arrays (these are already defined above)
                chemistryGoalsData = [
                    { 'Chapter Name': 'Some Basic Concepts of Chemistry' }, 
                    { 'Chapter Name': 'Structure of Atom' },
                    { 'Chapter Name': 'Classification of Elements and Periodicity in Properties' }, 
                    { 'Chapter Name': 'Chemical Bonding and Molecular Structure' },
                    { 'Chapter Name': 'Thermodynamics' }, 
                    { 'Chapter Name': 'Equilibrium' }, 
                    { 'Chapter Name': 'Redox Reactions' },
                    { 'Chapter Name': 'Some p-Block Elements' }, 
                    { 'Chapter Name': 'Organic Chemistry - Some Basic Principles and Techniques' },
                    { 'Chapter Name': 'Hydrocarbons' }, 
                    { 'Chapter Name': 'Solutions' }, 
                    { 'Chapter Name': 'Electrochemistry' },
                    { 'Chapter Name': 'Chemical Kinetics' }, 
                    { 'Chapter Name': 'The p-Block Element' }, 
                    { 'Chapter Name': 'The d- and f-Block Elements' },
                    { 'Chapter Name': 'Coordination Compounds' }, 
                    { 'Chapter Name': 'Haloalkanes and Haloarenes' },
                    { 'Chapter Name': 'Alcohols, Phenols and Ethers' }, 
                    { 'Chapter Name': 'Aldehydes, Ketones and Carboxylic Acids' },
                    { 'Chapter Name': 'Amines' }, 
                    { 'Chapter Name': 'Biomolecules' }
                ];

                physicsGoalsData = [
                    { 'Chapter Name': 'Units and Measurements' }, 
                    { 'Chapter Name': 'Motion in a Straight Line' },
                    { 'Chapter Name': 'Motion in a Plane' }, 
                    { 'Chapter Name': 'Laws of Motion' },
                    { 'Chapter Name': 'Work, Energy and Power' }, 
                    { 'Chapter Name': 'System of Particles and Rotational Motion' },
                    { 'Chapter Name': 'Gravitation' }, 
                    { 'Chapter Name': 'Mechanical Properties of Solids' },
                    { 'Chapter Name': 'Mechanical Properties of Fluids' }, 
                    { 'Chapter Name': 'Thermal Properties of Matter' },
                    { 'Chapter Name': 'Thermodynamics' }, 
                    { 'Chapter Name': 'Kinetic Theory' }, 
                    { 'Chapter Name': 'Oscillations' },
                    { 'Chapter Name': 'Waves' }, 
                    { 'Chapter Name': 'Electric Charges and Fields' },
                    { 'Chapter Name': 'Electrostatic Potential and Capacitance' }, 
                    { 'Chapter Name': 'Current Electricity' },
                    { 'Chapter Name': 'Moving Charges and Magnetism' }, 
                    { 'Chapter Name': 'Magnetism and Matter' },
                    { 'Chapter Name': 'Electromagnetic Induction' }, 
                    { 'Chapter Name': 'Alternating Current' },
                    { 'Chapter Name': 'Electromagnetic Waves' }, 
                    { 'Chapter Name': 'Ray Optics and Optical Instruments' },
                    { 'Chapter Name': 'Wave Optics' }, 
                    { 'Chapter Name': 'Dual Nature of Radiation and Matter' },
                    { 'Chapter Name': 'Atoms' }, 
                    { 'Chapter Name': 'Nuclei' },
                    { 'Chapter Name': 'Semiconductor Electronics: Materials, Devices and Simple Circuits' }
                ];

                biologyGoalsData = [
                    { 'Chapter Name': 'The Living World' }, 
                    { 'Chapter Name': 'Biological Classification' },
                    { 'Chapter Name': 'Plant Kingdom' }, 
                    { 'Chapter Name': 'Animal Kingdom' },
                    { 'Chapter Name': 'Morphology of Flowering Plants' }, 
                    { 'Chapter Name': 'Anatomy of Flowering Plants' },
                    { 'Chapter Name': 'Structural Organisation in Animals' }, 
                    { 'Chapter Name': 'Cell - The Unit of Life' },
                    { 'Chapter Name': 'Biomolecules' }, 
                    { 'Chapter Name': 'Cell Cycle and Cell Division' },
                    { 'Chapter Name': 'Photosynthesis in Higher Plants' }, 
                    { 'Chapter Name': 'Respiration in Plants' },
                    { 'Chapter Name': 'Plant Growth and Development' }, 
                    { 'Chapter Name': 'Breathing and Exchange of Gases' },
                    { 'Chapter Name': 'Body Fluids and Circulation' }, 
                    { 'Chapter Name': 'Excretory Products and Their Elimination' },
                    { 'Chapter Name': 'Locomotion and Movement' }, 
                    { 'Chapter Name': 'Neural Control and Coordination' },
                    { 'Chapter Name': 'Chemical Coordination and Integration' }, 
                    { 'Chapter Name': 'Sexual Reproduction in Flowering Plants' },
                    { 'Chapter Name': 'Human Reproduction' }, 
                    { 'Chapter Name': 'Reproductive Health' },
                    { 'Chapter Name': 'Principles of Inheritance and Variation' }, 
                    { 'Chapter Name': 'Molecular Basis of Inheritance' },
                    { 'Chapter Name': 'Evolution' }, 
                    { 'Chapter Name': 'Human Health and Disease' },
                    { 'Chapter Name': 'Microbes in Human Welfare' }, 
                    { 'Chapter Name': 'Biotechnology - Principles and Processes' },
                    { 'Chapter Name': 'Biotechnology and Its Applications' }, 
                    { 'Chapter Name': 'Organisms and Populations' },
                    { 'Chapter Name': 'Ecosystem' }, 
                    { 'Chapter Name': 'Biodiversity and Conservation' }
                ];

                renderSubcategoryCheckboxes('physics'); // Render initial checkboxes
                renderSubcategoryCheckboxes('biology'); // Render initial checkboxes for biology (hidden)

                console.log("Physics Goals Data:", physicsGoalsData);
                console.log("Chemistry Goals Data:", chemistryGoalsData);
                console.log("Biology Goals Data:", biologyGoalsData);

                renderGoalsChapters('physics');

                showStatusMessage("Syllabus data loaded successfully!", 'success');
            } catch (error) {
                console.error("Error loading or parsing syllabus data:", error);
                showStatusMessage("Error loading syllabus data. Check console.", 'error');
            }
        }

        // Global functions for table actions (needed for onclick handlers)
        window.editEntry = function(date, subject) {
            showStatusMessage(`Edit functionality for ${subject} on ${date} coming soon!`, 'info');
        };

        window.markCompleted = function(date, subject) {
            showStatusMessage(`Mark as completed functionality for ${subject} on ${date} coming soon!`, 'info');
        };


        /**
         * Saves the BBCTS data from the input fields to Firestore.
         */
        async function saveBBCTSData() {
            if (userId === 'not-authenticated') {
                showStatusMessage("Please sign in to save your BB Classes Test Series data.", 'error');
                return;
            }

            const newBBCTSEntry = {
                date: bbctsDateInput.value,
                syllabus: bbctsSyllabusInput.value,
                fullMarks: parseFloat(bbctsFullMarksInput.value),
                physicsScore: parseFloat(bbctsPhysicsScoreInput.value),
                chemistryScore: parseFloat(bbctsChemistryScoreInput.value),
                biologyScore: parseFloat(bbctsBiologyScoreInput.value),
                myMarks: parseFloat(bbctsMyMarksInput.value)
            };

            // Basic validation
            if (!newBBCTSEntry.date || !newBBCTSEntry.syllabus || isNaN(newBBCTSEntry.fullMarks) || isNaN(newBBCTSEntry.physicsScore) ||
                isNaN(newBBCTSEntry.chemistryScore) || isNaN(newBBCTSEntry.biologyScore) || isNaN(newBBCTSEntry.myMarks)) {
                showStatusMessage("Please fill all BB Classes Test Series fields with valid data.", 'error');
                return;
            }

            const updatedBBCTSData = [...bbctsData, newBBCTSEntry];
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/bbctsData`, 'myBBCTSDocument');

            try {
                await setDoc(docRef, { content: JSON.stringify(updatedBBCTSData) });
                console.log("BBCTS data successfully saved!");
                showStatusMessage("BB Classes Test Series data saved successfully!", 'success');
                // Clear input fields
                if (bbctsDateInput) bbctsDateInput.value = new Date().toISOString().split('T')[0];
                if (bbctsSyllabusInput) bbctsSyllabusInput.value = '';
                if (bbctsFullMarksInput) bbctsFullMarksInput.value = '';
                if (bbctsPhysicsScoreInput) bbctsPhysicsScoreInput.value = '';
                if (bbctsChemistryScoreInput) bbctsChemistryScoreInput.value = '';
                if (bbctsBiologyScoreInput) bbctsBiologyScoreInput.value = '';
                if (bbctsMyMarksInput) bbctsMyMarksInput.value = '';
            } catch (error) {
                console.error("Error saving BBCTS data:", error);
                showStatusMessage("Error saving BB Classes Test Series data. Please try again.", 'error');
            }
        }

        /**
         * Saves the Quarterly data from the input fields to Firestore.
         */
        async function saveQuarterlyData() {
            if (userId === 'not-authenticated') {
                showStatusMessage("Please sign in to save your Quarterly Test data.", 'error');
                return;
            }

            const newQTEntry = {
                date: qtDateInput.value,
                syllabus: qtSyllabusInput.value,
                fullMarks: parseFloat(qtFullMarksInput.value),
                physicsScore: parseFloat(qtPhysicsScoreInput.value),
                chemistryScore: parseFloat(qtChemistryScoreInput.value),
                biologyScore: parseFloat(qtBiologyScoreInput.value),
                myMarks: parseFloat(qtMyMarksInput.value)
            };

            // Basic validation
            if (!newQTEntry.date || !newQTEntry.syllabus || isNaN(newQTEntry.fullMarks) || isNaN(newQTEntry.physicsScore) ||
                isNaN(newQTEntry.chemistryScore) || isNaN(newQTEntry.biologyScore) || isNaN(newQTEntry.myMarks)) {
                showStatusMessage("Please fill all Quarterly Tests fields with valid data.", 'error');
                return;
            }

            const updatedQTData = [...quarterlyData, newQTEntry];
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/quarterlyData`, 'myQuarterlyDocument');

            try {
                await setDoc(docRef, { content: JSON.stringify(updatedQTData) });
                console.log("Quarterly data successfully saved!");
                showStatusMessage("Quarterly Tests data saved successfully!", 'success');
                // Clear input fields
                if (qtDateInput) qtDateInput.value = new Date().toISOString().split('T')[0];
                if (qtSyllabusInput) qtSyllabusInput.value = '';
                if (qtFullMarksInput) qtFullMarksInput.value = '';
                if (qtPhysicsScoreInput) qtPhysicsScoreInput.value = '';
                if (qtChemistryScoreInput) qtChemistryScoreInput.value = '';
                if (qtBiologyScoreInput) qtBiologyScoreInput.value = '';
                if (qtMyMarksInput) qtMyMarksInput.value = '';
            } catch (error) {
                console.error("Error saving Quarterly data:", error);
                showStatusMessage("Error saving Quarterly Tests data. Please try again.", 'error');
            }
        }

        /**
         * Saves the Mission NEET data from the input fields to Firestore.
         */
        async function saveMissionNeetData() {
            if (userId === 'not-authenticated') {
                showStatusMessage("Please sign in to save your Mission NEET data.", 'error');
                return;
            }

            const newMNEntry = {
                date: mnDateInput.value,
                syllabus: mnSyllabusInput.value,
                fullMarks: parseFloat(mnFullMarksInput.value),
                score: parseFloat(mnScoreInput.value)
            };

            // Basic validation
            if (!newMNEntry.date || !newMNEntry.syllabus || isNaN(newMNEntry.fullMarks) || isNaN(newMNEntry.score)) {
                showStatusMessage("Please fill all Mission NEET Tests fields with valid data.", 'error');
                return;
            }

            const updatedMNData = [...missionNeetData, newMNEntry];
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/missionNeetData`, 'myMissionNeetDocument');

            try {
                // Store the stringified JSON
                await setDoc(docRef, { content: JSON.stringify(updatedMNData) });
                console.log("Mission NEET data successfully saved!");
                showStatusMessage("Mission NEET Tests data saved successfully!", 'success');
                // Clear input fields
                if (mnDateInput) mnDateInput.value = new Date().toISOString().split('T')[0];
                if (mnSyllabusInput) mnSyllabusInput.value = '';
                if (mnFullMarksInput) mnFullMarksInput.value = '';
                if (mnScoreInput) mnScoreInput.value = '';
            } catch (error) {
                console.error("Error saving Mission NEET data:", error);
                showStatusMessage("Error saving Mission NEET Tests data. Please try again.", 'error');
            }
        }

        /**
         * Saves the chapter status (isCompleted) to Firestore.
         */
        async function saveChapterStatus() {
            if (userId === 'not-authenticated') {
                showStatusMessage("Please sign in to save your chapter progress.", 'error');
                return;
            }
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/appState`, 'chapterStatus');
            try {
                await setDoc(docRef, { content: JSON.stringify(chapterStatus) });
                console.log("Chapter status saved to Firestore.");
                showStatusMessage("Chapter status updated!", 'success');
                // Re-draw syllabus progression chart after status update
                if (tabContents.analytics && tabContents.analytics.classList.contains('active') && analyticsSubTabContents.syllabusProgression && analyticsSubTabContents.syllabusProgression.classList.contains('active')) {
                    drawSyllabusProgressionChart();
                }
            } catch (error) {
                console.error("Error saving chapter status:", error);
                showStatusMessage("Error saving chapter status. Please try again.", 'error');
            }
        }

        // --- Tab Switching Logic ---

        /**
         * Activates the selected main tab and deactivates others.
         * @param {string} tabName - The name of the tab to activate (e.g., 'tests', 'regularData').
         */
        function activateMainTab(tabName) {
            // Deactivate all main tab buttons and content
            for (const key in tabButtons) {
                if (tabButtons[key]) {
                    tabButtons[key].classList.remove('active');
                }
            }
            for (const key in tabContents) {
                if (tabContents[key]) {
                    tabContents[key].classList.remove('active');
                }
            }

            // Activate the selected main tab button and content
            if (tabButtons[tabName]) {
                tabButtons[tabName].classList.add('active');
            }
            if (tabContents[tabName]) {
                tabContents[tabName].classList.add('active');
            }

            // Specific actions based on tab
            if (tabName === 'tests') {
                activateTestEntrySubTab('ut');
            } else if (tabName === 'analytics') {
                activateAnalyticsSubTab('ut'); // Default to Unit Test analytics
            } else if (tabName === 'goals') {
                activateGoalsSubTab('physics'); // Default to Physics goals
            }
        }

        /**
         * Activates the selected test sub-tab and deactivates others.
         * @param {string} subTabName - The name of the sub-tab to activate (e.g., 'ut', 'bbcts').
         */
        function activateTestEntrySubTab(subTabName) {
            for (const key in testEntrySubTabButtons) {
                if (testEntrySubTabButtons[key]) testEntrySubTabButtons[key].classList.remove('active');
            }
            for (const key in testEntrySubTabContents) {
                if (testEntrySubTabContents[key]) testEntrySubTabContents[key].classList.remove('active');
            }

            if (testEntrySubTabButtons[subTabName]) testEntrySubTabButtons[subTabName].classList.add('active');
            if (testEntrySubTabContents[subTabName]) testEntrySubTabContents[subTabName].classList.add('active');

            const today = new Date().toISOString().split('T')[0];
            if (subTabName === 'ut') { if (utDateInput) utDateInput.value = today; }
            else if (subTabName === 'bbcts') { if (bbctsDateInput) bbctsDateInput.value = today; }
            else if (subTabName === 'quarterly') { if (qtDateInput) qtDateInput.value = today; }
            else if (subTabName === 'missionNeet') { if (mnDateInput) mnDateInput.value = today; }
        }

        /**
         * Activates the selected analytics sub-tab and deactivates others.
         * @param {string} subTabName - The name of the sub-tab to activate (e.g., 'ut', 'bbcts').
         */
        function activateAnalyticsSubTab(subTabName) {
            for (const key in analyticsSubTabButtons) {
                if (analyticsSubTabButtons[key]) analyticsSubTabButtons[key].classList.remove('active');
            }
            for (const key in analyticsSubTabContents) {
                if (analyticsSubTabContents[key]) analyticsSubTabContents[key].classList.remove('active');
            }

            if (analyticsSubTabButtons[subTabName]) analyticsSubTabButtons[subTabName].classList.add('active');
            if (analyticsSubTabContents[subTabName]) analyticsSubTabContents[subTabName].classList.add('active');

            if (subTabName === 'syllabusProgression') {
                drawSyllabusProgressionChart();
            } else {
                drawAllCharts();
            }
        }

        /**
         * Activates the selected goals sub-tab and renders chapters.
         * @param {string} subTabName - 'physics', 'chemistry', or 'biology'.
         */
        function activateGoalsSubTab(subTabName) {
            for (const key in goalsSubTabButtons) {
                if (goalsSubTabButtons[key]) goalsSubTabButtons[key].classList.remove('active');
            }
            for (const key in goalsSubTabContents) {
                if (goalsSubTabContents[key]) goalsSubTabContents[key].classList.remove('active');
            }

            if (goalsSubTabButtons[subTabName]) goalsSubTabButtons[subTabName].classList.add('active');
            if (goalsSubTabContents[subTabName]) goalsSubTabContents[subTabName].classList.add('active');

            // Show/hide subcategory checkboxes based on subject
            if (subTabName === 'biology') {
                physicsChemistrySubcategoryCheckboxes.classList.add('hidden');
                biologySubcategoryCheckboxes.classList.remove('hidden');
            } else {
                physicsChemistrySubcategoryCheckboxes.classList.remove('hidden');
                biologySubcategoryCheckboxes.classList.add('hidden');
            }

            renderGoalsChapters(subTabName);
        }

        /**
         * Renders the chapters for the given subject into the appropriate display div,
         * dynamically adjusting columns based on selected sub-categories.
         * @param {string} subject - 'physics', 'chemistry', or 'biology'.
         */
        function renderGoalsChapters(subject) {
            let chaptersData = [];
            let displayElement;
            let allSubCategories = [];
            let selectedSubcategoriesKeys = [];

            if (subject === 'physics') {
                chaptersData = physicsGoalsData;
                displayElement = physicsGoalsDisplay;
                allSubCategories = physicsChemistrySubCategoriesOrdered;
                selectedSubcategoriesKeys = selectedPhysicsChemistrySubcategories;
            } else if (subject === 'chemistry') {
                chaptersData = chemistryGoalsData;
                displayElement = chemistryGoalsDisplay;
                allSubCategories = physicsChemistrySubCategoriesOrdered;
                selectedSubcategoriesKeys = selectedChemistrySubcategories;
            } else if (subject === 'biology') {
                chaptersData = biologyGoalsData;
                displayElement = biologyGoalsDisplay;
                allSubCategories = biologySubCategoriesOrdered;
                selectedSubcategoriesKeys = selectedBiologySubcategories;
            } else {
                return; // Invalid subject
            }

            if (!displayElement) {
                console.error(`Display element for ${subject} goals not found.`);
                return;
            }

            displayElement.innerHTML = ''; // Clear previous content

            if (chaptersData.length === 0) {
                displayElement.textContent = `No ${subject} chapters loaded.`;
                return;
            }

            // Filter and sort selected sub-categories based on their predefined order
            const visibleSubcategories = allSubCategories.filter(cat => selectedSubcategoriesKeys.includes(cat.key));
            visibleSubcategories.sort((a, b) => {
                // Custom sort order for levels (Beginner to Master)
                const order = {
                    'bb_classes_module': 0, 'ncert_questions': 1, 'disha': 2, 'mtg': 3,
                    'jee_mains_pyqs': 4, 'cengage': 5, 'errorless': 6,
                    'mission_neet_module': 0, 'ncert_fingertips': 1, 'neetprep': 2
                };
                return order[a.key] - order[b.key];
            });


            // Dynamic grid template columns
            const gridTemplateColumns = `1fr repeat(${visibleSubcategories.length}, minmax(0, 1fr))`;
            displayElement.style.gridTemplateColumns = gridTemplateColumns; // Apply to parent

            // Display headers
            const headerRow = document.createElement('div');
            headerRow.classList.add('chapter-header');
            headerRow.style.gridTemplateColumns = gridTemplateColumns; // Apply to header row
            const chapterNameHeader = document.createElement('div');
            chapterNameHeader.textContent = "Chapter Name";
            headerRow.appendChild(chapterNameHeader);

            visibleSubcategories.forEach(cat => {
                const catHeader = document.createElement('div');
                catHeader.textContent = cat.name;
                headerRow.appendChild(catHeader);
            });
            displayElement.appendChild(headerRow);


            chaptersData.forEach(chapterObj => {
                const chapterName = chapterObj['Chapter Name'];
                const chapterKey = `${subject}-${chapterName.replace(/\s|\(|\)/g, '_').replace(/_+/g, '_').toLowerCase()}`;

                if (!chapterStatus[chapterKey]) {
                    chapterStatus[chapterKey] = {};
                    allSubCategories.forEach(cat => { // Initialize all, even if not visible
                        chapterStatus[chapterKey][cat.key] = { isCompleted: false, completionDate: null, aiMessage: '' };
                    });
                }

                const chapterRow = document.createElement('div');
                chapterRow.classList.add('chapter-row');
                chapterRow.style.gridTemplateColumns = gridTemplateColumns; // Apply to chapter row

                const chapterNameCol = document.createElement('div');
                chapterNameCol.textContent = chapterName;
                chapterRow.appendChild(chapterNameCol);

                visibleSubcategories.forEach((cat, index) => {
                    const buttonContainer = document.createElement('div');
                    const completionButton = document.createElement('button');
                    completionButton.classList.add('chapter-button');

                    const subCategoryStatus = chapterStatus[chapterKey][cat.key] || { isCompleted: false, completionDate: null, aiMessage: '' };

                    if (subCategoryStatus.isCompleted) {
                        // Apply color based on its level in the *visible* categories
                        const colorClass = `color-level-${cat.level}`;
                        completionButton.classList.add('completed', colorClass);
                        completionButton.textContent = subCategoryStatus.aiMessage || '✔';
                    } else {
                        completionButton.textContent = 'Mark Done';
                    }

                    completionButton.dataset.chapterKey = chapterKey;
                    completionButton.dataset.subCategoryKey = cat.key;
                    completionButton.dataset.chapterName = chapterName;
                    completionButton.dataset.subCategoryName = cat.name;

                    completionButton.addEventListener('click', async (event) => {
                        if (userId === 'not-authenticated') {
                            showStatusMessage("Please sign in to mark chapters.", 'error');
                            return;
                        }

                        const btn = event.target;
                        const currentChapterKey = btn.dataset.chapterKey;
                        const currentSubCategoryKey = btn.dataset.subCategoryKey;
                        const currentChapterName = btn.dataset.chapterName;
                        const currentSubCategoryName = btn.dataset.subCategoryName;
                        const currentSubCategoryLevel = allSubCategories.find(c => c.key === currentSubCategoryKey)?.level || 0;


                        if (!chapterStatus[currentChapterKey]) chapterStatus[currentChapterKey] = {};
                        if (!chapterStatus[currentChapterKey][currentSubCategoryKey]) {
                            chapterStatus[currentChapterKey][currentSubCategoryKey] = { isCompleted: false, completionDate: null, aiMessage: '' };
                        }

                        const currentStatus = chapterStatus[currentChapterKey][currentSubCategoryKey];

                        if (!currentStatus.isCompleted) {
                            showStatusMessage("Marking as done...", 'info');
                            btn.disabled = true;

                            try {
                                const prompt = `Generate a very short, encouraging 'done' message (max 10 words) with a celebratory emoji for completing the "${currentSubCategoryName}" part of the chapter "${currentChapterName}". Example: "Awesome work! ${currentSubCategoryName} for ${currentChapterName} mastered! 🎉"`;
                                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                                const payload = { contents: chatHistory };
                                const apiKey = ""; // Canvas will provide this in runtime
                                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                                const response = await fetch(apiUrl, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(payload)
                                });
                                const result = await response.json();
                                let aiMessage = '✔';
                                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                                    aiMessage = result.candidates[0].content.parts[0].text;
                                }

                                chapterStatus[currentChapterKey][currentSubCategoryKey] = {
                                    isCompleted: true,
                                    completionDate: new Date().toISOString().split('T')[0],
                                    aiMessage: aiMessage
                                };
                                btn.classList.add('completed', `color-level-${currentSubCategoryLevel}`); // Add level color
                                btn.textContent = aiMessage;
                                showStatusMessage("Task completed!", 'success');
                            } catch (error) {
                                console.error("Error generating AI message for chapter completion:", error);
                                chapterStatus[currentChapterKey][currentSubCategoryKey] = {
                                    isCompleted: true,
                                    completionDate: new Date().toISOString().split('T')[0],
                                    aiMessage: '✔'
                                };
                                btn.classList.add('completed', `color-level-${currentSubCategoryLevel}`); // Fallback with color
                                btn.textContent = '✔';
                                showStatusMessage("Task completed (AI message failed).", 'error');
                            } finally {
                                btn.disabled = false;
                                saveChapterStatus();
                            }
                        } else {
                            // If already completed, allow unmarking
                            chapterStatus[currentChapterKey][currentSubCategoryKey] = {
                                isCompleted: false,
                                completionDate: null,
                                aiMessage: ''
                            };
                            btn.classList.remove('completed', `color-level-${currentSubCategoryLevel}`); // Remove color
                            btn.textContent = 'Mark Done';
                            showStatusMessage("Task unmarked.", 'info');
                            saveChapterStatus();
                        }
                    });
                    buttonContainer.appendChild(completionButton);
                    chapterRow.appendChild(buttonContainer);
                });
                displayElement.appendChild(chapterRow);
            });
        }

        /**
         * Renders the subcategory checkboxes for the given subject.
         * @param {string} subject - 'physics', 'chemistry', or 'biology'.
         */
        function renderSubcategoryCheckboxes(subject) {
            let container;
            let subCategories;
            let selectedKeys;

            if (subject === 'physics' || subject === 'chemistry') {
                container = physicsChemistrySubcategoryCheckboxes;
                subCategories = physicsChemistrySubCategoriesOrdered;
                selectedKeys = selectedPhysicsChemistrySubcategories;
            } else if (subject === 'biology') {
                container = biologySubcategoryCheckboxes;
                subCategories = biologySubCategoriesOrdered;
                selectedKeys = selectedBiologySubcategories;
            } else {
                return;
            }

            container.innerHTML = ''; // Clear existing checkboxes

            subCategories.forEach(cat => {
                const div = document.createElement('div');
                div.classList.add('flex', 'items-center', 'mr-4');
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = `checkbox-${subject}-${cat.key}`;
                input.classList.add('mr-2', 'form-checkbox', 'h-4', 'w-4', 'text-blue-600', 'rounded');
                input.checked = selectedKeys.includes(cat.key);
                input.dataset.subject = subject;
                input.dataset.key = cat.key;

                input.addEventListener('change', (event) => {
                    const changedSubject = event.target.dataset.subject;
                    const changedKey = event.target.dataset.key;

                    if (changedSubject === 'physics' || changedSubject === 'chemistry') {
                        if (event.target.checked) {
                            if (!selectedPhysicsChemistrySubcategories.includes(changedKey)) {
                                selectedPhysicsChemistrySubcategories.push(changedKey);
                            }
                        } else {
                            selectedPhysicsChemistrySubcategories = selectedPhysicsChemistrySubcategories.filter(k => k !== changedKey);
                        }
                        // Re-render both physics and chemistry goals to ensure consistent column display
                        renderGoalsChapters('physics');
                        renderGoalsChapters('chemistry');
                    } else if (changedSubject === 'biology') {
                        if (event.target.checked) {
                            if (!selectedBiologySubcategories.includes(changedKey)) {
                                selectedBiologySubcategories.push(changedKey);
                            }
                        } else {
                            selectedBiologySubcategories = selectedBiologySubcategories.filter(k => k !== changedKey);
                        }
                        renderGoalsChapters('biology');
                    }
                });

                const label = document.createElement('label');
                label.htmlFor = `checkbox-${subject}-${cat.key}`;
                label.classList.add('text-gray-700', 'text-sm', 'font-medium');
                label.textContent = cat.name;

                div.appendChild(input);
                div.appendChild(label);
                container.appendChild(div);
            });
        }


        // Attach event listeners for main tab buttons
        if (tabButtons.regularData) tabButtons.regularData.addEventListener('click', () => activateMainTab('regularData'));
        if (tabButtons.tests) tabButtons.tests.addEventListener('click', () => activateMainTab('tests'));
        if (tabButtons.analytics) tabButtons.analytics.addEventListener('click', () => activateMainTab('analytics'));
        if (tabButtons.goals) tabButtons.goals.addEventListener('click', () => activateMainTab('goals'));
        if (tabButtons.aiSuggestions) tabButtons.aiSuggestions.addEventListener('click', () => activateMainTab('aiSuggestions'));

        // Attach event listeners for test sub-tab buttons
        if (testEntrySubTabButtons.ut) testEntrySubTabButtons.ut.addEventListener('click', () => activateTestEntrySubTab('ut'));
        if (testEntrySubTabButtons.bbcts) testEntrySubTabButtons.bbcts.addEventListener('click', () => activateTestEntrySubTab('bbcts'));
        if (testEntrySubTabButtons.quarterly) testEntrySubTabButtons.quarterly.addEventListener('click', () => activateTestEntrySubTab('quarterly'));
        if (testEntrySubTabButtons.missionNeet) testEntrySubTabButtons.missionNeet.addEventListener('click', () => activateTestEntrySubTab('missionNeet'));

        // Attach event listeners for analytics sub-tab buttons
        if (analyticsSubTabButtons.ut) analyticsSubTabButtons.ut.addEventListener('click', () => activateAnalyticsSubTab('ut'));
        if (analyticsSubTabButtons.bbcts) analyticsSubTabButtons.bbcts.addEventListener('click', () => activateAnalyticsSubTab('bbcts'));
        if (analyticsSubTabButtons.quarterly) analyticsSubTabButtons.quarterly.addEventListener('click', () => activateAnalyticsSubTab('quarterly'));
        if (analyticsSubTabButtons.missionNeetAnalytics) analyticsSubTabButtons.missionNeetAnalytics.addEventListener('click', () => activateAnalyticsSubTab('missionNeetAnalytics'));
        if (analyticsSubTabButtons.syllabusProgression) analyticsSubTabButtons.syllabusProgression.addEventListener('click', () => activateAnalyticsSubTab('syllabusProgression'));

        // Attach event listeners for goals sub-tab buttons
        if (goalsSubTabButtons.physics) goalsSubTabButtons.physics.addEventListener('click', () => activateGoalsSubTab('physics'));
        if (goalsSubTabButtons.chemistry) goalsSubTabButtons.chemistry.addEventListener('click', () => activateGoalsSubTab('chemistry'));
        if (goalsSubTabButtons.biology) goalsSubTabButtons.biology.addEventListener('click', () => activateGoalsSubTab('biology'));

        // --- Analytics (Chart.js Graphs) ---

        /**
         * Destroys an existing chart instance if it exists.
         * @param {Chart} chartInstance - The Chart.js instance to destroy.
         * @returns {null} - Returns null after destruction.
         */
        function destroyChart(chartInstance) {
            if (chartInstance) {
                chartInstance.destroy();
            }
            return null;
        }

        /**
         * Draws a line chart for a given subject/data type using raw marks or percentages.
         * @param {HTMLCanvasElement} canvas - The canvas element for the chart.
         * @param {string} title - The title of the chart.
         * @param {Array<Object>} data - The raw data array.
         * @param {string} scoreKey - The key for the score (e.g., 'physicsScore', 'score').
         * @param {string} fullMarksKey - The key for full marks (e.g., 'fullMarks').
         * @param {Chart} existingInstance - The global variable holding the chart instance for this specific chart.
         * @param {boolean} isPercentage - If true, calculate score as percentage of full marks.
         * @returns {Chart} - The new Chart.js instance.
         */
        function drawLineChart(canvas, title, data, scoreKey, fullMarksKey, existingInstance, isPercentage = false) {
            const labels = data.map(item => item.date);
            let scores = data.map(item => item[scoreKey]);
            let fullMarks = data.map(item => item[fullMarksKey]);

            if (isPercentage) {
                scores = data.map(item => (item[scoreKey] / item[fullMarksKey]) * 100);
                fullMarks = data.map(() => 100); // Full marks is 100% for percentage graph
            }

            const ctx = canvas.getContext('2d');

            // Destroy existing chart instance if it exists
            if (existingInstance) {
                existingInstance = destroyChart(existingInstance);
            }

            const yAxisLabel = isPercentage ? 'Percentage (%)' : 'Marks';

            const newChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'My Score',
                        data: scores,
                        borderColor: '#4f46e5', /* Indigo */
                        backgroundColor: 'rgba(79, 70, 229, 0.2)',
                        tension: 0.3,
                        fill: false,
                        pointBackgroundColor: '#4f46e5',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#4f46e5',
                        pointRadius: 5,
                        pointHoverRadius: 7
                    },
                    {
                        label: 'Full Marks',
                        data: fullMarks,
                        borderColor: '#10b981', /* Green */
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        tension: 0.3,
                        fill: false,
                        pointBackgroundColor: '#10b981',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#10b981',
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: title,
                            font: {
                                size: 18,
                                weight: 'bold'
                            },
                            color: '#333'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = `${context.dataset.label}: ${context.raw}`;
                                    if (isPercentage) {
                                        label += '%';
                                    }
                                    return label;
                                }
                            }
                        },
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date',
                                color: '#555'
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: yAxisLabel,
                                color: '#555'
                            },
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return isPercentage ? value + '%' : value;
                                }
                            }
                        }
                    }
                }
            });
            return newChartInstance;
        }


        /**
         * Draws all relevant charts based on the fetched data and active sub-tab.
         */
        function drawAllCharts() {
            // Destroy all existing charts first to prevent overlaps
            physicsChartUTInstance = destroyChart(physicsChartUTInstance);
            chemistryChartUTInstance = destroyChart(chemistryChartUTInstance);
            biologyChartUTInstance = destroyChart(biologyChartUTInstance);
            physicsChartBBCTSInstance = destroyChart(physicsChartBBCTSInstance);
            chemistryChartBBCTSInstance = destroyChart(chemistryChartBBCTSInstance);
            biologyChartBBCTSInstance = destroyChart(biologyChartBBCTSInstance);
            physicsChartQuarterlyInstance = destroyChart(physicsChartQuarterlyInstance);
            chemistryChartQuarterlyInstance = destroyChart(chemistryChartQuarterlyInstance);
            biologyChartQuarterlyInstance = destroyChart(biologyChartQuarterlyInstance);
            missionNeetChartInstance = destroyChart(missionNeetChartInstance);
            syllabusProgressionChartInstance = destroyChart(syllabusProgressionChartInstance);

            if (userId === 'not-authenticated') {
                // Charts should already be cleared by onAuthStateChanged
                return;
            }

            // Determine which sub-tab is active and draw charts accordingly
            if (analyticsSubTabContents.ut && analyticsSubTabContents.ut.classList.contains('active')) {
                utTestData.sort((a, b) => new Date(a.date) - new Date(b.date));
                if (utTestData.length > 0) {
                    if (analyticsCanvasPhysicsUT) physicsChartUTInstance = drawLineChart(analyticsCanvasPhysicsUT, 'Physics Scores (Unit Tests)', utTestData, 'physicsScore', 'fullMarks', physicsChartUTInstance);
                    if (analyticsCanvasChemistryUT) chemistryChartUTInstance = drawLineChart(analyticsCanvasChemistryUT, 'Chemistry Scores (Unit Tests)', utTestData, 'chemistryScore', 'fullMarks', chemistryChartUTInstance);
                    if (analyticsCanvasBiologyUT) biologyChartUTInstance = drawLineChart(analyticsCanvasBiologyUT, 'Biology Scores (Unit Tests)', utTestData, 'biologyScore', 'fullMarks', biologyChartUTInstance);
                } else {
                    if (analyticsCanvasPhysicsUT) analyticsCanvasPhysicsUT.getContext('2d').clearRect(0, 0, analyticsCanvasPhysicsUT.width, analyticsCanvasPhysicsUT.height);
                    if (analyticsCanvasChemistryUT) analyticsCanvasChemistryUT.getContext('2d').clearRect(0, 0, analyticsCanvasChemistryUT.width, analyticsCanvasChemistryUT.height);
                    if (analyticsCanvasBiologyUT) analyticsCanvasBiologyUT.getContext('2d').clearRect(0, 0, analyticsCanvasBiologyUT.width, analyticsCanvasBiologyUT.height);
                    showStatusMessage("No Unit Tests data available to draw graphs.", 'info');
                }
            } else if (analyticsSubTabContents.bbcts && analyticsSubTabContents.bbcts.classList.contains('active')) {
                bbctsData.sort((a, b) => new Date(a.date) - new Date(b.date));
                if (bbctsData.length > 0) {
                    if (analyticsCanvasPhysicsBBCTS) physicsChartBBCTSInstance = drawLineChart(analyticsCanvasPhysicsBBCTS, 'Physics Scores (BB Classes Test Series)', bbctsData, 'physicsScore', 'fullMarks', physicsChartBBCTSInstance);
                    if (analyticsCanvasChemistryBBCTS) chemistryChartBBCTSInstance = drawLineChart(analyticsCanvasChemistryBBCTS, 'Chemistry Scores (BB Classes Test Series)', bbctsData, 'chemistryScore', 'fullMarks', chemistryChartBBCTSInstance);
                    if (analyticsCanvasBiologyBBCTS) biologyChartBBCTSInstance = drawLineChart(analyticsCanvasBiologyBBCTS, 'Biology Scores (BB Classes Test Series)', bbctsData, 'biologyScore', 'fullMarks', biologyChartBBCTSInstance);
                } else {
                    if (analyticsCanvasPhysicsBBCTS) analyticsCanvasPhysicsBBCTS.getContext('2d').clearRect(0, 0, analyticsCanvasPhysicsBBCTS.width, analyticsCanvasPhysicsBBCTS.height);
                    if (analyticsCanvasChemistryBBCTS) analyticsCanvasChemistryBBCTS.getContext('2d').clearRect(0, 0, analyticsCanvasChemistryBBCTS.width, analyticsCanvasChemistryBBCTS.height);
                    if (analyticsCanvasBiologyBBCTS) analyticsCanvasBiologyBBCTS.getContext('2d').clearRect(0, 0, analyticsCanvasBiologyBBCTS.width, analyticsCanvasBiologyBBCTS.height);
                    showStatusMessage("No BB Classes Test Series data available to draw graphs.", 'info');
                }
            } else if (analyticsSubTabContents.quarterly && analyticsSubTabContents.quarterly.classList.contains('active')) {
                quarterlyData.sort((a, b) => new Date(a.date) - new Date(b.date));
                if (quarterlyData.length > 0) {
                    if (analyticsCanvasPhysicsQuarterly) physicsChartQuarterlyInstance = drawLineChart(analyticsCanvasPhysicsQuarterly, 'Physics Scores (Quarterly Tests)', quarterlyData, 'physicsScore', 'fullMarks', physicsChartQuarterlyInstance);
                    if (analyticsCanvasChemistryQuarterly) chemistryChartQuarterlyInstance = drawLineChart(analyticsCanvasChemistryQuarterly, 'Chemistry Scores (Quarterly Tests)', quarterlyData, 'chemistryScore', 'fullMarks', chemistryChartQuarterlyInstance);
                    if (analyticsCanvasBiologyQuarterly) biologyChartQuarterlyInstance = drawLineChart(analyticsCanvasBiologyQuarterly, 'Biology Scores (Quarterly Tests)', quarterlyData, 'biologyScore', 'fullMarks', biologyChartQuarterlyInstance);
                } else {
                    if (analyticsCanvasPhysicsQuarterly) analyticsCanvasPhysicsQuarterly.getContext('2d').clearRect(0, 0, analyticsCanvasPhysicsQuarterly.width, analyticsCanvasPhysicsQuarterly.height);
                    if (analyticsCanvasChemistryQuarterly) analyticsCanvasChemistryQuarterly.getContext('2d').clearRect(0, 0, analyticsCanvasChemistryQuarterly.width, analyticsCanvasChemistryQuarterly.height);
                    if (analyticsCanvasBiologyQuarterly) analyticsCanvasBiologyQuarterly.getContext('2d').clearRect(0, 0, analyticsCanvasBiologyQuarterly.width, analyticsCanvasBiologyQuarterly.height);
                    showStatusMessage("No Quarterly Tests data available to draw graphs.", 'info');
                }
            } else if (analyticsSubTabContents.missionNeetAnalytics && analyticsSubTabContents.missionNeetAnalytics.classList.contains('active')) {
                missionNeetData.sort((a, b) => new Date(a.date) - new Date(b.date));
                if (missionNeetData.length > 0) {
                    if (analyticsCanvasMissionNeet) missionNeetChartInstance = drawLineChart(analyticsCanvasMissionNeet, 'Mission NEET Tests Scores (Percentage)', missionNeetData, 'score', 'fullMarks', missionNeetChartInstance, true);
                } else {
                    if (analyticsCanvasMissionNeet) analyticsCanvasMissionNeet.getContext('2d').clearRect(0, 0, analyticsCanvasMissionNeet.width, analyticsCanvasMissionNeet.height);
                    showStatusMessage("No Mission NEET Tests data available to draw graphs.", 'info');
                }
            }
        }

        /**
         * Draws the Syllabus Progression Chart.
         */
        function drawSyllabusProgressionChart() {
            syllabusProgressionChartInstance = destroyChart(syllabusProgressionChartInstance);

            if (userId === 'not-authenticated') {
                // Chart should already be cleared by onAuthStateChanged
                return;
            }

            const allChapters = [...physicsGoalsData, ...chemistryGoalsData, ...biologyGoalsData];
            const completionDates = {};

            for (const chapterKey in chapterStatus) {
                for (const subCategoryKey in chapterStatus[chapterKey]) {
                    if (chapterStatus[chapterKey][subCategoryKey].isCompleted && chapterStatus[chapterKey][subCategoryKey].completionDate) {
                        const date = chapterStatus[chapterKey][subCategoryKey].completionDate;
                        completionDates[date] = (completionDates[date] || 0) + 1;
                    }
                }
            }

            const sortedDates = Object.keys(completionDates).sort();
            const cumulativeCompleted = [];
            let currentCumulative = 0;

            sortedDates.forEach(date => {
                currentCumulative += completionDates[date];
                cumulativeCompleted.push(currentCumulative);
            });

            const ctx = syllabusProgressionCanvas.getContext('2d');

            syllabusProgressionChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Tasks Completed',
                        data: cumulativeCompleted,
                        borderColor: '#059669',
                        backgroundColor: 'rgba(5, 150, 105, 0.2)',
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: '#059669',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#059669',
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Syllabus Progression Over Time (Tasks Completed)',
                            font: {
                                size: 18,
                                weight: 'bold'
                            },
                            color: '#333'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.raw} Tasks Completed`;
                                }
                            }
                        },
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date',
                                color: '#555'
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Number of Tasks',
                                color: '#555'
                            },
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }


        // --- AI Performance Insights ---

        async function getAIPerformanceInsights() {
            if (userId === 'not-authenticated') {
                showStatusMessage("Please sign in to get AI performance insights.", 'error');
                if (aiPerformanceAnalysisDisplay) aiPerformanceAnalysisDisplay.textContent = "Please sign in to get AI performance insights.";
                return;
            }
            if (utTestData.length === 0 && bbctsData.length === 0 && quarterlyData.length === 0 && missionNeetData.length === 0) {
                showStatusMessage("No test data available for AI analysis. Please enter some data.", 'error');
                if (aiPerformanceAnalysisDisplay) aiPerformanceAnalysisDisplay.textContent = "No test data available for AI analysis.";
                return;
            }

            if (aiPerformanceAnalysisDisplay) aiPerformanceAnalysisDisplay.textContent = "Generating AI performance analysis...";
            if (getAIPerformanceInsightsButton) getAIPerformanceInsightsButton.disabled = true;
            showStatusMessage("Getting AI performance insights...", 'info');

            try {
                let prompt = `Analyze the following NEET UG test performance data. Identify strengths, weaknesses, and suggest actionable areas for improvement. Provide a concise summary and specific recommendations. Focus on subject-wise performance and overall trends.\n\n`;
                prompt += `--- Unit Test Data ---\n${JSON.stringify(utTestData, null, 2)}\n\n`;
                prompt += `--- BBCTS Data ---\n${JSON.stringify(bbctsData, null, 2)}\n\n`;
                prompt += `--- Quarterly Test Data ---\n${JSON.stringify(quarterlyData, null, 2)}\n\n`;
                prompt += `--- Mission NEET Data ---\n${JSON.stringify(missionNeetData, null, 2)}\n\n`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                const apiKey = "";

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    if (aiPerformanceAnalysisDisplay) aiPerformanceAnalysisDisplay.textContent = text;
                    showStatusMessage("AI performance analysis received!", 'success');
                } else {
                    if (aiPerformanceAnalysisDisplay) aiPerformanceAnalysisDisplay.textContent = "Could not get AI performance analysis. Please try again.";
                    console.error("Unexpected AI response structure for performance analysis:", result);
                    showStatusMessage("Failed to get AI performance analysis.", 'error');
                }
            } catch (error) {
                console.error("Error fetching AI performance analysis:", error);
                if (aiPerformanceAnalysisDisplay) aiPerformanceAnalysisDisplay.textContent = "An error occurred while fetching AI performance analysis.";
                showStatusMessage("Error fetching AI performance analysis.", 'error');
            } finally {
                if (getAIPerformanceInsightsButton) getAIPerformanceInsightsButton.disabled = false;
            }
        }

        // Event listener for AI Performance Insights button
        if (getAIPerformanceInsightsButton) getAIPerformanceInsightsButton.addEventListener('click', getAIPerformanceInsights);

        // --- AI Productivity Insights ---
        async function getAIProductivityInsights() {
            if (userId === 'not-authenticated') {
                showStatusMessage("Please sign in to get AI productivity insights.", 'error');
                if (aiProductivityAnalysisDisplay) aiProductivityAnalysisDisplay.textContent = "Please sign in to get AI productivity insights.";
                return;
            }
            if (regularDataLogs.length === 0) {
                showStatusMessage("No daily log data available for AI analysis. Please enter some logs.", 'error');
                if (aiProductivityAnalysisDisplay) aiProductivityAnalysisDisplay.textContent = "No daily log data available for AI analysis.";
                return;
            }

            if (aiProductivityAnalysisDisplay) aiProductivityAnalysisDisplay.textContent = "Generating AI productivity analysis...";
            if (getAIProductivityInsightsButton) getAIProductivityInsightsButton.disabled = true;
            showStatusMessage("Getting AI productivity insights...", 'info');

            try {
                let prompt = `Analyze the following daily log entries for a NEET UG aspirant. Identify patterns in study topics, time spent, and backlogs. Provide insights on productivity, highlight areas for improvement, and suggest actionable tips for better time management and topic coverage. Incorporate advice that NEET UG toppers often give, such as consistent revision, mock test analysis, and balancing subjects.`;
                prompt += `--- Daily Log Entries ---\n${JSON.stringify(regularDataLogs, null, 2)}\n\n`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                const apiKey = "";

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    if (aiProductivityAnalysisDisplay) aiProductivityAnalysisDisplay.textContent = text;
                    showStatusMessage("AI productivity analysis received!", 'success');
                } else {
                    if (aiProductivityAnalysisDisplay) aiProductivityAnalysisDisplay.textContent = "Could not get AI productivity analysis. Please try again.";
                    console.error("Unexpected AI response structure for productivity analysis:", result);
                    showStatusMessage("Failed to get AI productivity analysis.", 'error');
                }
            } catch (error) {
                console.error("Error fetching AI productivity analysis:", error);
                if (aiProductivityAnalysisDisplay) aiProductivityAnalysisDisplay.textContent = "An error occurred while fetching AI productivity analysis.";
                showStatusMessage("Error fetching AI productivity analysis.", 'error');
            } finally {
                if (getAIProductivityInsightsButton) getAIProductivityInsightsButton.disabled = false;
            }
        }

        // Event listener for AI Productivity Insights button
        if (getAIProductivityInsightsButton) getAIProductivityInsightsButton.addEventListener('click', getAIProductivityInsights);


        // --- AI General Suggestions ---

        /**
         * Fetches general AI suggestions from the Gemini API.
         */
        async function getAISuggestion() {
            if (userId === 'not-authenticated') {
                showStatusMessage("Please sign in to get general AI suggestions.", 'error');
                if (aiResponseDisplay) aiResponseDisplay.textContent = "Please sign in to get general AI suggestions.";
                return;
            }
            const prompt = aiPromptInput.value.trim();
            if (aiResponseDisplay) aiResponseDisplay.textContent = "Generating AI suggestions...";
            showStatusMessage("Getting AI suggestion...", 'info');

            try {
                let fullPrompt = `Based on the following data, please provide a suggestion for: "${prompt || 'general study advice'}". Incorporate advice from NEET UG toppers where relevant.\n\n`;
                fullPrompt += `--- Regular Daily Logs ---\n${JSON.stringify(regularDataLogs, null, 2) || "No regular data available."}\n\n`;
                fullPrompt += `--- Unit Test Data ---\n${JSON.stringify(utTestData, null, 2) || "No UT test data available."}\n\n`;
                fullPrompt += `--- BBCTS Data ---\n${JSON.stringify(bbctsData, null, 2) || "No BBCTS test data available."}\n\n`;
                fullPrompt += `--- Quarterly Test Data ---\n${JSON.stringify(quarterlyData, null, 2) || "No Quarterly test data available."}\n\n`;
                fullPrompt += `--- Mission NEET Data ---\n${JSON.stringify(missionNeetData, null, 2) || "No Mission NEET data available."}\n\n`;
                fullPrompt += `--- Syllabus Completion Status ---\n${JSON.stringify(chapterStatus, null, 2) || "No chapter completion data."}\n\n`;


                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: fullPrompt }] });

                const payload = { contents: chatHistory };
                const apiKey = "";

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    if (aiResponseDisplay) aiResponseDisplay.textContent = text;
                    showStatusMessage("AI suggestion received!", 'success');
                } else {
                    if (aiResponseDisplay) aiResponseDisplay.textContent = "Could not get a suggestion. Please try again.";
                    console.error("Unexpected AI response structure:", result);
                    showStatusMessage("Failed to get AI suggestion.", 'error');
                }
            } catch (error) {
                console.error("Error fetching AI suggestion:", error);
                if (aiResponseDisplay) aiResponseDisplay.textContent = "An error occurred while fetching AI suggestions.";
                showStatusMessage("Error fetching AI suggestion.", 'error');
            }
        }
        if (getAISuggestionButton) getAISuggestionButton.addEventListener('click', getAISuggestion);

        // --- NEW: Next Study Plan Feature ---
        async function getNextStudyPlan() {
            if (userId === 'not-authenticated') {
                showStatusMessage("Please sign in to get your next study plan.", 'error');
                if (nextStudyPlanDisplay) nextStudyPlanDisplay.textContent = "Please sign in to get your next study plan.";
                return;
            }

            if (nextStudyPlanDisplay) nextStudyPlanDisplay.textContent = "Generating your next study plan...";
            if (getNextStudyPlanButton) getNextStudyPlanButton.disabled = true;
            showStatusMessage("Generating next study plan...", 'info');

            try {
                let prompt = `As a NEET UG study assistant, analyze the user's current study data and suggest the *next best topic* to study. For the suggested topic, also recommend a *number of MCQs* to solve and a *time duration* for study. Incorporate advice from successful NEET UG toppers on effective study strategies (e.g., balancing weak areas, consistent practice, active recall). Prioritize topics that are either incomplete, have low scores in tests, or haven't been reviewed recently.

                --- User's Current Data ---
                Daily Logs: ${JSON.stringify(regularDataLogs.slice(-7), null, 2)} (last 7 days)
                Unit Test Scores: ${JSON.stringify(utTestData.slice(-3), null, 2)} (last 3 tests)
                BBCTS Scores: ${JSON.stringify(bbctsData.slice(-3), null, 2)} (last 3 tests)
                Quarterly Scores: ${JSON.stringify(quarterlyData.slice(-2), null, 2)} (last 2 tests)
                Mission NEET Scores: ${JSON.stringify(missionNeetData.slice(-5), null, 2)} (last 5 tests)
                Syllabus Completion Status: ${JSON.stringify(chapterStatus, null, 2)}

                Based on this data, what's the optimal next study topic, how many MCQs, and for how long? Provide a concise, actionable plan.`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                const apiKey = "";

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    if (nextStudyPlanDisplay) nextStudyPlanDisplay.textContent = text;
                    showStatusMessage("Next study plan generated!", 'success');
                } else {
                    if (nextStudyPlanDisplay) nextStudyPlanDisplay.textContent = "Could not generate a study plan. Please try again or add more data.";
                    console.error("Unexpected AI response structure for next study plan:", result);
                    showStatusMessage("Failed to generate study plan.", 'error');
                }
            } catch (error) {
                console.error("Error fetching next study plan:", error);
                if (nextStudyPlanDisplay) nextStudyPlanDisplay.textContent = "An error occurred while fetching the study plan.";
                showStatusMessage("Error fetching next study plan.", 'error');
            } finally {
                if (getNextStudyPlanButton) getNextStudyPlanButton.disabled = false;
            }
        }
        if (getNextStudyPlanButton) getNextStudyPlanButton.addEventListener('click', getNextStudyPlan);


        // --- Concept Explainer Function ---
        async function explainConcept() {
            if (userId === 'not-authenticated') {
                showStatusMessage("Please sign in to use the Concept Explainer.", 'error');
                if (conceptExplanationDisplay) conceptExplanationDisplay.textContent = "Please sign in to use the Concept Explainer.";
                return;
            }
            const concept = conceptInput.value.trim();
            if (!concept) {
                showStatusMessage("Please enter a concept or doubt to explain.", 'error');
                if (conceptExplanationDisplay) conceptExplanationDisplay.textContent = "Please enter a concept or doubt to explain.";
                return;
            }

            if (conceptExplanationDisplay) conceptExplanationDisplay.textContent = "Generating explanation...";
            if (explainConceptButton) explainConceptButton.disabled = true;
            showStatusMessage("Getting concept explanation...", 'info');

            try {
                const prompt = `Explain the concept of "${concept}" in detail, as if you are teaching a NEET UG aspirant. Focus on clarity, accuracy, and include any relevant examples, diagrams (describe them), or common misconceptions. Keep the explanation concise but comprehensive.`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                const apiKey = "";

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    if (conceptExplanationDisplay) conceptExplanationDisplay.textContent = text;
                    showStatusMessage("Concept explained!", 'success');
                } else {
                    if (conceptExplanationDisplay) conceptExplanationDisplay.textContent = "Could not explain the concept. Please try again.";
                    console.error("Unexpected AI response structure for concept explanation:", result);
                    showStatusMessage("Failed to explain concept.", 'error');
                }
            } catch (error) {
                console.error("Error fetching concept explanation:", error);
                if (conceptExplanationDisplay) conceptExplanationDisplay.textContent = "An error occurred while fetching the explanation.";
                showStatusMessage("Error fetching concept explanation.", 'error');
            } finally {
                if (explainConceptButton) explainConceptButton.disabled = false;
            }
        }
        if (explainConceptButton) explainConceptButton.addEventListener('click', explainConcept);


        // --- Revision Topic Suggester Function ---
        async function suggestRevisionTopics() {
            if (userId === 'not-authenticated') {
                showStatusMessage("Please sign in to get revision suggestions.", 'error');
                if (revisionSuggestionsDisplay) revisionSuggestionsDisplay.textContent = "Please sign in to get revision suggestions.";
                return;
            }
            if (revisionSuggestionsDisplay) revisionSuggestionsDisplay.textContent = "Analyzing your data and generating revision suggestions...";
            if (suggestRevisionTopicsButton) suggestRevisionTopicsButton.disabled = true;
            showStatusMessage("Generating revision topics...", 'info');

            try {
                let prompt = `Based on the following NEET UG study data, suggest 3-5 specific topics or chapters for revision. Explain briefly why each topic is suggested (e.g., low scores, not reviewed recently). Prioritize topics that appear to be weak areas or have been neglected. Incorporate advice from NEET UG toppers on effective revision strategies.

                --- Your Unit Test Data ---\n${JSON.stringify(utTestData, null, 2) || "No Unit Test data."}\n\n
                --- Your BB Classes Test Series Data ---\n${JSON.stringify(bbctsData, null, 2) || "No BBCTS data."}\n\n
                --- Your Quarterly Test Data ---\n${JSON.stringify(quarterlyData, null, 2) || "No Quarterly Test data."}\n\n
                --- Your Mission NEET Test Data ---\n${JSON.stringify(missionNeetData, null, 2) || "No Mission NEET data."}\n\n
                --- Your Daily Log Entries (recent topics studied/backlogs) ---\n${JSON.stringify(regularDataLogs.slice(-5), null, 2) || "No recent daily logs."} (showing last 5 entries)\n\n
                --- Your Syllabus Completion Status (completed tasks by chapter) ---\n${JSON.stringify(chapterStatus, null, 2) || "No chapter completion data."}\n\n
                `;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                const apiKey = "";

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    if (revisionSuggestionsDisplay) revisionSuggestionsDisplay.textContent = text;
                    showStatusMessage("Revision suggestions received!", 'success');
                } else {
                    if (revisionSuggestionsDisplay) revisionSuggestionsDisplay.textContent = "Could not generate revision suggestions. Please try again or add more data.";
                    console.error("Unexpected AI response structure for revision suggestions:", result);
                    showStatusMessage("Failed to get revision suggestions.", 'error');
                }
            } catch (error) {
                console.error("Error fetching revision suggestions:", error);
                if (revisionSuggestionsDisplay) revisionSuggestionsDisplay.textContent = "An error occurred while fetching revision suggestions.";
                showStatusMessage("Error fetching revision suggestions.", 'error');
            } finally {
                if (suggestRevisionTopicsButton) suggestRevisionTopicsButton.disabled = false;
            }
        }
        if (suggestRevisionTopicsButton) suggestRevisionTopicsButton.addEventListener('click', suggestRevisionTopics);

        // --- Mock Test Question Generator Function ---
        async function generatePracticeQuestions() {
            if (userId === 'not-authenticated') {
                showStatusMessage("Please sign in to generate practice questions.", 'error');
                if (generatedQuestionsDisplay) generatedQuestionsDisplay.textContent = "Please sign in to generate practice questions.";
                return;
            }
            const subject = questionSubjectSelect.value;
            const topic = questionTopicInput.value.trim();

            if (!subject || !topic) {
                showStatusMessage("Please select a subject and enter a topic to generate questions.", 'error');
                if (generatedQuestionsDisplay) generatedQuestionsDisplay.textContent = "Please select a subject and enter a topic.";
                return;
            }

            if (generatedQuestionsDisplay) generatedQuestionsDisplay.textContent = "Generating practice questions...";
            if (generateQuestionsButton) generateQuestionsButton.disabled = true;
            showStatusMessage("Generating questions...", 'info');

            try {
                const prompt = `Generate 3 multiple-choice questions (MCQs) for NEET UG aspirants on the topic of "${topic}" in "${subject}". For each question, provide 4 options (A, B, C, D), indicate the correct answer, and give a brief explanation for the correct answer. Format the output clearly with Q1, Q2, Q3, then options, then Answer: [Correct Option], and then Explanation: [Explanation].`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                const apiKey = "";

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    if (generatedQuestionsDisplay) generatedQuestionsDisplay.textContent = text;
                    showStatusMessage("Questions generated!", 'success');
                } else {
                    if (generatedQuestionsDisplay) generatedQuestionsDisplay.textContent = "Could not generate questions. Please try again.";
                    console.error("Unexpected AI response structure for question generation:", result);
                    showStatusMessage("Failed to generate questions.", 'error');
                }
            } catch (error) {
                console.error("Error fetching questions:", error);
                if (generatedQuestionsDisplay) generatedQuestionsDisplay.textContent = "An error occurred while generating questions.";
                showStatusMessage("Error generating questions.", 'error');
            } finally {
                if (generateQuestionsButton) generateQuestionsButton.disabled = false;
            }
        }
        if (generateQuestionsButton) generateQuestionsButton.addEventListener('click', generatePracticeQuestions);

        // --- NEW: Weakness Identification & Targeted Practice Function ---
        async function identifyWeaknessesAndSuggestPractice() {
            if (userId === 'not-authenticated') {
                showStatusMessage("Please sign in to identify weaknesses and get practice tips.", 'error');
                if (weaknessAnalysisDisplay) weaknessAnalysisDisplay.textContent = "Please sign in to identify weaknesses.";
                return;
            }

            if (utTestData.length === 0 && bbctsData.length === 0 && quarterlyData.length === 0 && missionNeetData.length === 0 && regularDataLogs.length === 0 && Object.keys(chapterStatus).length === 0) {
                showStatusMessage("No study data available for weakness analysis. Please enter some data.", 'error');
                if (weaknessAnalysisDisplay) weaknessAnalysisDisplay.textContent = "No study data available for weakness analysis. Please enter some data in Daily Routine, My Tests, and Goals tabs.";
                return;
            }

            if (weaknessAnalysisDisplay) weaknessAnalysisDisplay.textContent = "Analyzing your data to identify weaknesses and suggest practice tips...";
            if (identifyWeaknessesButton) identifyWeaknessesButton.disabled = true;
            showStatusMessage("Identifying weaknesses...", 'info');

            try {
                let prompt = `As a NEET UG study assistant, analyze the user's comprehensive study data to identify specific weak areas (topics/chapters) across Physics, Chemistry, and Biology. For each identified weakness, provide targeted, actionable practice suggestions. These suggestions should include:
                - Specific topics/concepts to revisit.
                - Recommended types of practice (e.g., MCQs, theory revision, numerical problems).
                - Potential resources (e.g., "re-read NCERT for X," "solve more questions from Y book/module").
                - A suggested time allocation for addressing this weakness.
                
                Prioritize weaknesses based on low test scores, frequent backlogs in daily logs, or incomplete/struggled syllabus topics. Structure your response clearly with identified weaknesses and corresponding practice tips. Incorporate advice from NEET UG toppers on how to overcome weak areas.

                --- User's Current Data ---
                Daily Logs (recent 7 entries): ${JSON.stringify(regularDataLogs.slice(-7), null, 2) || "No recent daily logs."}
                Unit Test Scores (recent 3 tests): ${JSON.stringify(utTestData.slice(-3), null, 2) || "No UT test data."}
                BBCTS Scores (recent 3 tests): ${JSON.stringify(bbctsData.slice(-3), null, 2) || "No BBCTS test data."}
                Quarterly Scores (recent 2 tests): ${JSON.stringify(quarterlyData.slice(-2), null, 2) || "No Quarterly test data."}
                Mission NEET Scores (recent 5 tests): ${JSON.stringify(missionNeetData.slice(-5), null, 2) || "No Mission NEET data."}
                Syllabus Completion Status: ${JSON.stringify(chapterStatus, null, 2) || "No chapter completion data."}

                Provide a detailed, actionable analysis.`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                const apiKey = "";

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    if (weaknessAnalysisDisplay) weaknessAnalysisDisplay.textContent = text;
                    showStatusMessage("Weakness analysis received!", 'success');
                } else {
                    if (weaknessAnalysisDisplay) weaknessAnalysisDisplay.textContent = "Could not identify weaknesses. Please try again.";
                    console.error("Unexpected AI response structure for weakness analysis:", result);
                    showStatusMessage("Failed to identify weaknesses.", 'error');
                }
            } catch (error) {
                console.error("Error fetching weakness analysis:", error);
                if (weaknessAnalysisDisplay) weaknessAnalysisDisplay.textContent = "An error occurred while fetching weakness analysis.";
                showStatusMessage("Error fetching weakness analysis.", 'error');
            } finally {
                if (identifyWeaknessesButton) identifyWeaknessesButton.disabled = false;
            }
        }
        if (identifyWeaknessesButton) identifyWeaknessesButton.addEventListener('click', identifyWeaknessesAndSuggestPractice);


        // --- NEET Countdown Logic ---
        function getNeetUGDate() {
            const year = 2026;
            const month = 4; // May is 4 (0-indexed)
            let date = new Date(year, month, 1);
            // Find the first Sunday of May
            while (date.getDay() !== 0) { // 0 is Sunday
                date.setDate(date.getDate() + 1);
            }
            return date;
        }

        const neetUGDate = getNeetUGDate();

        function updateCountdown() {
            const now = new Date().getTime();
            const distance = neetUGDate.getTime() - now;

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            if (distance < 0) {
                if (countdownTimerDisplay) countdownTimerDisplay.textContent = "NEET UG 2026 has begun!";
                clearInterval(countdownInterval);
            } else {
                if (countdownTimerDisplay) countdownTimerDisplay.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
            }
        }

        let countdownInterval = setInterval(updateCountdown, 1000);

        // --- Motivational Quote Logic ---
        async function displayRandomQuoteAndSave() {
            const randomIndex = Math.floor(Math.random() * motivationalQuotes.length);
            const selectedQuote = motivationalQuotes[randomIndex];
            if (motivationalQuoteDisplay) {
                motivationalQuoteDisplay.textContent = `"${selectedQuote}"`;
            }

            if (userId && userId !== 'loading' && userId !== 'not-authenticated') {
                const today = new Date().toISOString().split('T')[0];
                const quoteStateDocRef = doc(db, `artifacts/${appId}/users/${userId}/appState`, 'quoteState');
                try {
                    await setDoc(quoteStateDocRef, {
                        lastQuoteDate: today,
                        lastQuoteIndex: randomIndex
                    });
                    console.log("Quote state saved to Firestore.");
                } catch (error) {
                    console.error("Error saving quote state:", error);
                }
            }
        }

        function displayRandomLoginQuote() {
            const randomIndex = Math.floor(Math.random() * motivationalQuotes.length);
            const selectedQuote = motivationalQuotes[randomIndex];
            if (loginQuoteDisplay) {
                loginQuoteDisplay.textContent = `"${selectedQuote}"`;
            }
        }

        // --- AI Goals Insights ---
        async function getAIGoalsInsights() {
            if (userId === 'not-authenticated') {
                showStatusMessage("Please sign in to get AI progress insights.", 'error');
                if (aiGoalsAnalysisDisplay) aiGoalsAnalysisDisplay.textContent = "Please sign in to get AI progress insights.";
                return;
            }

            let totalTasks = 0;
            let completedTasks = 0;

            [physicsGoalsData, chemistryGoalsData, biologyGoalsData].forEach(subjectData => {
                subjectData.forEach(chapterObj => {
                    const chapterName = chapterObj['Chapter Name'];
                    const subject = subjectData === physicsGoalsData ? 'physics' : (subjectData === chemistryGoalsData ? 'chemistry' : 'biology');
                    const chapterKey = `${subject}-${chapterName.replace(/\s|\(|\)/g, '_').replace(/_+/g, '_').toLowerCase()}`;

                    const subCategoriesForSubject = subject === 'physics' || subject === 'chemistry' ? physicsChemistrySubCategoriesOrdered : biologySubCategoriesOrdered;

                    subCategoriesForSubject.forEach(cat => {
                        totalTasks++;
                        if (chapterStatus[chapterKey] && chapterStatus[chapterKey][cat.key] && chapterStatus[chapterKey][cat.key].isCompleted) {
                            completedTasks++;
                        }
                    });
                });
            });


            if (totalTasks === 0) {
                if (aiGoalsAnalysisDisplay) aiGoalsAnalysisDisplay.textContent = "No syllabus data loaded to analyze. Please ensure chapters are loaded.";
                showStatusMessage("No syllabus data loaded.", 'error');
                return;
            }

            if (aiGoalsAnalysisDisplay) aiGoalsAnalysisDisplay.textContent = "Generating AI progress insights...";
            if (getAIGoalsInsightsButton) getAIGoalsInsightsButton.disabled = true;
            showStatusMessage("Getting AI progress insights...", 'info');

            try {
                const completionPercentage = (completedTasks / totalTasks) * 100;
                const remainingTasks = totalTasks - completedTasks;

                const targetDate = new Date('2026-03-07');
                const now = new Date();
                const daysRemainingUntilTarget = Math.ceil((targetDate - now) / (1000 * 60 * 60 * 24));

                let paceMessage = "";
                if (daysRemainingUntilTarget > 0 && remainingTasks > 0) {
                    const tasksPerDayNeeded = remainingTasks / daysRemainingUntilTarget;
                    paceMessage = `To complete the remaining ${remainingTasks} tasks by March 7, 2026, you need to cover approximately ${tasksPerDayNeeded.toFixed(2)} tasks per day.`;
                } else if (remainingTasks === 0) {
                    paceMessage = "You've completed all tasks! Excellent work!";
                } else {
                    paceMessage = "Keep up the great work!";
                }


                let prompt = `I have completed ${completedTasks} out of ${totalTasks} syllabus tasks (chapters + sub-categories) for NEET UG 2026. This is ${completionPercentage.toFixed(2)}% of the syllabus tasks. I have ${remainingTasks} tasks left. ${paceMessage} Provide an encouraging message about my progress and how much farther I have until completion. Incorporate advice from NEET UG toppers on staying motivated and consistent. Keep it concise and motivating.`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                const apiKey = "";

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    if (aiGoalsAnalysisDisplay) aiGoalsAnalysisDisplay.textContent = text;
                    showStatusMessage("AI progress insights received!", 'success');
                } else {
                    if (aiGoalsAnalysisDisplay) aiGoalsAnalysisDisplay.textContent = "Could not get AI progress insights. Please try again.";
                    console.error("Unexpected AI response structure for goals analysis:", result);
                    showStatusMessage("Failed to get AI progress insights.", 'error');
                }
            } catch (error) {
                console.error("Error fetching AI progress insights:", error);
                if (aiGoalsAnalysisDisplay) aiGoalsAnalysisDisplay.textContent = "An error occurred while fetching AI progress insights.";
                showStatusMessage("Error fetching AI progress insights.", 'error');
            } finally {
                if (getAIGoalsInsightsButton) getAIGoalsInsightsButton.disabled = false;
            }
        }


        // --- Event Listeners and Initial Setup ---

        // Event listeners for save buttons
        if (saveRegularDataButton) saveRegularDataButton.addEventListener('click', saveRegularData);
        if (saveUTButton) saveUTButton.addEventListener('click', saveUTData);
        if (saveBBCTSButton) saveBBCTSButton.addEventListener('click', saveBBCTSData);
        if (saveQuarterlyButton) saveQuarterlyButton.addEventListener('click', saveQuarterlyData);
        if (saveMissionNeetButton) saveMissionNeetButton.addEventListener('click', saveMissionNeetData);
        if (getAIGoalsInsightsButton) getAIGoalsInsightsButton.addEventListener('click', getAIGoalsInsights);

        // Auth button listeners
        if (googleSignInButton) googleSignInButton.addEventListener('click', handleGoogleSignIn);
        if (signOutButton) signOutButton.addEventListener('click', handleSignOut);


        // Function to load goals data (now hardcoded for Chemistry, and will be for Physics/Biology)
        async function loadGoalsData() {
            showStatusMessage("Loading syllabus data...", 'info');
            try {
                chemistryGoalsData = [
                    { 'Chapter Name': 'Some Basic Concepts of Chemistry' }, { 'Chapter Name': 'Structure of Atom' },
                    { 'Chapter Name': 'Classification of Elements and Periodicity in Properties' }, { 'Chapter Name': 'Chemical Bonding and Molecular Structure' },
                    { 'Chapter Name': 'Thermodynamics' }, { 'Chapter Name': 'Equilibrium' }, { 'Chapter Name': 'Redox Reactions' },
                    { 'Chapter Name': 'Some p-Block Elements' }, { 'Chapter Name': 'Organic Chemistry - Some Basic Principles and Techniques' },
                    { 'Chapter Name': 'Hydrocarbons' }, { 'Chapter Name': 'Solutions' }, { 'Chapter Name': 'Electrochemistry' },
                    { 'Chapter Name': 'Chemical Kinetics' }, { 'Chapter Name': 'The p-Block Element' }, { 'Chapter Name': 'The d- and f-Block Elements' },
                    { 'Chapter Name': 'Coordination Compounds' }, { 'Chapter Name': 'Haloalkanes and Haloarenes' },
                    { 'Chapter Name': 'Alcohols, Phenols and Ethers' }, { 'Chapter Name': 'Aldehydes, Ketones and Carboxylic Acids' },
                    { 'Chapter Name': 'Amines' }, { 'Chapter Name': 'Biomolecules' }
                ];

                physicsGoalsData = [
                    { 'Chapter Name': 'Units and Measurements' }, { 'Chapter Name': 'Motion in a Straight Line' },
                    { 'Chapter Name': 'Motion in a Plane' }, { 'Chapter Name': 'Laws of Motion' },
                    { 'Chapter Name': 'Work, Energy and Power' }, { 'Chapter Name': 'System of Particles and Rotational Motion' },
                    { 'Chapter Name': 'Gravitation' }, { 'Chapter Name': 'Mechanical Properties of Solids' },
                    { 'Chapter Name': 'Mechanical Properties of Fluids' }, { 'Chapter Name': 'Thermal Properties of Matter' },
                    { 'Chapter Name': 'Thermodynamics' }, { 'Chapter Name': 'Kinetic Theory' }, { 'Chapter Name': 'Oscillations' },
                    { 'Chapter Name': 'Waves' }, { 'Chapter Name': 'Electric Charges and Fields' },
                    { 'Chapter Name': 'Electrostatic Potential and Capacitance' }, { 'Chapter Name': 'Current Electricity' },
                    { 'Chapter Name': 'Moving Charges and Magnetism' }, { 'Chapter Name': 'Magnetism and Matter' },
                    { 'Chapter Name': 'Electromagnetic Induction' }, { 'Chapter Name': 'Alternating Current' },
                    { 'Chapter Name': 'Electromagnetic Waves' }, { 'Chapter Name': 'Ray Optics and Optical Instruments' },
                    { 'Chapter Name': 'Wave Optics' }, { 'Chapter Name': 'Dual Nature of Radiation and Matter' },
                    { 'Chapter Name': 'Atoms' }, { 'Chapter Name': 'Nuclei' },
                    { 'Chapter Name': 'Semiconductor Electronics: Materials, Devices and Simple Circuits' }
                ];

                biologyGoalsData = [
                    { 'Chapter Name': 'The Living World' }, { 'Chapter Name': 'Biological Classification' },
                    { 'Chapter Name': 'Plant Kingdom' }, { 'Chapter Name': 'Animal Kingdom' },
                    { 'Chapter Name': 'Morphology of Flowering Plants' }, { 'Chapter Name': 'Anatomy of Flowering Plants' },
                    { 'Chapter Name': 'Structural Organisation in Animals' }, { 'Chapter Name': 'Cell - The Unit of Life' },
                    { 'Chapter Name': 'Biomolecules' }, { 'Chapter Name': 'Cell Cycle and Cell Division' },
                    { 'Chapter Name': 'Photosynthesis in Higher Plants' }, { 'Chapter Name': 'Respiration in Plants' },
                    { 'Chapter Name': 'Plant Growth and Development' }, { 'Chapter Name': 'Breathing and Exchange of Gases' },
                    { 'Chapter Name': 'Body Fluids and Circulation' }, { 'Chapter Name': 'Excretory Products and Their Elimination' },
                    { 'Chapter Name': 'Locomotion and Movement' }, { 'Chapter Name': 'Neural Control and Coordination' },
                    { 'Chapter Name': 'Chemical Coordination and Integration' }, { 'Chapter Name': 'Sexual Reproduction in Flowering Plants' },
                    { 'Chapter Name': 'Human Reproduction' }, { 'Chapter Name': 'Reproductive Health' },
                    { 'Chapter Name': 'Principles of Inheritance and Variation' }, { 'Chapter Name': 'Molecular Basis of Inheritance' },
                    { 'Chapter Name': 'Evolution' }, { 'Chapter Name': 'Human Health and Disease' },
                    { 'Chapter Name': 'Microbes in Human Welfare' }, { 'Chapter Name': 'Biotechnology - Principles and Processes' },
                    { 'Chapter Name': 'Biotechnology and Its Applications' }, { 'Chapter Name': 'Organisms and Populations' },
                    { 'Chapter Name': 'Ecosystem' }, { 'Chapter Name': 'Biodiversity and Conservation' }
                ];

                renderSubcategoryCheckboxes('physics'); // Render initial checkboxes
                renderSubcategoryCheckboxes('biology'); // Render initial checkboxes for biology (hidden)

                console.log("Physics Goals Data:", physicsGoalsData);
                console.log("Chemistry Goals Data:", chemistryGoalsData);
                console.log("Biology Goals Data:", biologyGoalsData);

                renderGoalsChapters('physics');

                showStatusMessage("Syllabus data loaded successfully!", 'success');
            } catch (error) {
                console.error("Error loading or parsing syllabus data:", error);
                showStatusMessage("Error loading syllabus data. Check console.", 'error');
            }
        }


        // Initialize Firebase and set default tab when the window loads
        window.onload = () => {
            initializeFirebase();
            loadGoalsData(); // Load chapter data and render checkboxes
            activateMainTab('regularData'); // Set 'Daily Routine' as the default active main tab
            
            // Initialize Enhanced Daily Routine
            initializeChapterDropdowns();
            generateCalendar();
            updateQuotaProgress();
            activateDailyTab('today'); // Set 'Today' as default daily tab
            
            // Set today's date as default for daily log and all test entries
            const today = new Date().toISOString().split('T')[0];
            if (logDateInput) logDateInput.value = today;
            if (utDateInput) utDateInput.value = today;
            if (bbctsDateInput) bbctsDateInput.value = today;
            if (qtDateInput) qtDateInput.value = today;
            if (mnDateInput) mnDateInput.value = today;
            if (upcomingDate) upcomingDate.value = today;

            // Enhanced Daily Routine Event Listeners
            
            // Daily tab navigation
            if (dailyTabButtons.today) dailyTabButtons.today.addEventListener('click', () => activateDailyTab('today'));
            if (dailyTabButtons.upcoming) dailyTabButtons.upcoming.addEventListener('click', () => activateDailyTab('upcoming'));
            if (dailyTabButtons.backlogs) dailyTabButtons.backlogs.addEventListener('click', () => activateDailyTab('backlogs'));
            if (dailyTabButtons.completed) dailyTabButtons.completed.addEventListener('click', () => activateDailyTab('completed'));

            // Calendar navigation
            if (prevMonthBtn) prevMonthBtn.addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                generateCalendar();
            });
            if (nextMonthBtn) nextMonthBtn.addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                generateCalendar();
            });

            // Chapter selection for topics
            if (physicsChapterSelect) physicsChapterSelect.addEventListener('change', (e) => {
                populateTopics('physics', e.target.value);
            });
            if (chemistryChapterSelect) chemistryChapterSelect.addEventListener('change', (e) => {
                populateTopics('chemistry', e.target.value);
            });

            // Save buttons
            if (saveTodayLogButton) saveTodayLogButton.addEventListener('click', saveTodayLog);
            if (saveUpcomingPlanButton) saveUpcomingPlanButton.addEventListener('click', () => {
                showStatusMessage("Upcoming plans feature coming soon!", 'info');
            });

            // MCQ input change listeners for real-time quota updates
            [physicsMcqCount, physicsMcqManualCount, chemistryMcqCount, chemistryMcqManualCount, 
             biologyMcqCount, biologyMcqManualCount].forEach(input => {
                if (input) {
                    input.addEventListener('input', () => {
                        // Update quota progress in real-time
                        todayQuotaProgress.physics = (parseInt(physicsMcqCount.value) || 0) + (parseInt(physicsMcqManualCount.value) || 0);
                        todayQuotaProgress.chemistry = (parseInt(chemistryMcqCount.value) || 0) + (parseInt(chemistryMcqManualCount.value) || 0);
                        todayQuotaProgress.biology = (parseInt(biologyMcqCount.value) || 0) + (parseInt(biologyMcqManualCount.value) || 0);
                        updateQuotaProgress();
                    });
                }
            });

            // Initial countdown update
            updateCountdown();
            displayRandomLoginQuote(); // Set initial quote for login page
        };

        // Adjust canvas size on window resize to make it responsive
        window.addEventListener('resize', () => {
            if (tabContents.analytics && tabContents.analytics.classList.contains('active')) {
                if (analyticsSubTabContents.syllabusProgression && analyticsSubTabContents.syllabusProgression.classList.contains('active')) {
                    drawSyllabusProgressionChart();
                } else {
                    drawAllCharts();
                }
            }
        });
    </script>
</body>
</html>
