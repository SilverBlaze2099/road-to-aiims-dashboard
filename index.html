        /**
         * NEW: Marks a chapter/topic as completed in the global `chapterStatus` and saves to Firestore.
         * This is called automatically when a daily log is saved.
         * @param {string} baseChapterKey - The unique key for the chapter.
         * @param {string} fullTopicKey - The unique key for the topic.
         * @param {string} subjectName - Name of the subject.
         * @param {string} chapterName - Name of the chapter.
         * @param {string|null} topicName - Name of the topic, or null for biology chapters.
         * @param {string} bookKey - The key for the book/module being updated.
         */
        async function markChapterTopicAsCompleted(baseChapterKey, fullTopicKey, subjectName, chapterName, topicName, bookKey) {
            if (!chapterStatus[baseChapterKey]) chapterStatus[baseChapterKey] = {};
            if (!chapterStatus[baseChapterKey][bookKey]) chapterStatus[baseChapterKey][bookKey] = {};
            if (!chapterStatus[baseChapterKey][bookKey][fullTopicKey]) {
                chapterStatus[baseChapterKey][bookKey][fullTopicKey] = { isCompleted: false, completionDate: null, aiMessage: '' };
            }

            if (chapterStatus[baseChapterKey][bookKey][fullTopicKey].isCompleted) {
                console.log(`Topic/Chapter ${fullTopicKey} for ${bookKey} already marked as completed.`);
                return; // Already completed, no need to do anything
            }

            const allSubCategories = (subjectName === 'Physics' || subjectName === 'Chemistry') ? physicsChemistrySubCategoriesOrdered : biologySubCategoriesOrdered;
            const subCategoryLevel = allSubCategories.find(c => c.key === bookKey)?.level || 0;

            try {
                // For automatic updates, we can skip the AI message generation to speed things up.
                // A simple checkmark is sufficient.
                const aiMessage = '✔ (Auto)';

                chapterStatus[baseChapterKey][bookKey][fullTopicKey] = {
                    isCompleted: true,
                    completionDate: new Date().toISOString().split('T')[0],
                    aiMessage: aiMessage
                };
                showStatusMessage(`'${topicName || chapterName}' progress updated!`, 'success');
            } catch (error) {
                console.error("Error during automatic goal update:", error);
                chapterStatus[baseChapterKey][bookKey][fullTopicKey] = {
                    isCompleted: true,
                    completionDate: new Date().toISOString().split('T')[0],
                    aiMessage: '✔'
                };
                showStatusMessage("Syllabus progress updated (with fallback).", 'error');
            } finally {
                await saveChapterStatus(); // Save the updated status to Firestore
                // Re-render the currently active goals tab to show the change immediately
                const activeGoalsTab = document.querySelector('#contentGoals .sub-tab-button.active');
                if (activeGoalsTab) {
                    renderGoalsChapters(activeGoalsTab.id.replace('goalsSubTab', '').toLowerCase());
                }
            }
        }
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Road to AIIMS</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            /* Static vibrant and complex gradient for the background - no dynamic image generation */
            background: linear-gradient(to bottom right, #e0f7fa, #bbdefb, #e3f2fd);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem;
            box-sizing: border-box;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        .container {
            background-color: rgba(255, 255, 255, 0.95); /* Slightly transparent white for content */
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            padding: 2.5rem;
            width: 100%;
            max-width: 1100px;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        textarea {
            min-height: 150px;
            resize: vertical;
        }
        input[type="text"], input[type="number"], input[type="date"], textarea, select { /* Added select */
            background-color: #f8fafc;
            border: 1px solid #cbd5e1;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
        }
        input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, textarea:focus, select:focus { /* Added select */
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        .data-display {
            background-color: #f0f4f7;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1.25rem;
            min-height: 120px;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-y: auto;
            max-height: 350px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            color: #334155;
        }
        .tab-button {
            padding: 0.85rem 1.8rem;
            border-radius: 0.75rem;
            font-weight: 700;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 2px solid transparent;
            background-color: #e2e8f0;
            color: #475569;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .tab-button.active {
            background: linear-gradient(to right, #60a5fa, #3b82f6);
            color: #ffffff;
            border-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(59, 130, 246, 0.3);
        }
        .tab-button:not(.active):hover {
            background-color: #d1d5db;
            color: #1e293b;
            transform: translateY(-1px);
        }
        .sub-tab-button {
            padding: 0.6rem 1.2rem;
            border-radius: 0.6rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 1px solid transparent;
            font-size: 0.95rem;
            background-color: #e0f2f7;
            color: #0d9488;
        }
        .sub-tab-button.active {
            background: linear-gradient(to right, #2dd4bf, #14b8a6);
            color: #ffffff;
            border-color: #0f766e;
            box-shadow: 0 3px 6px rgba(45, 212, 191, 0.3);
        }
        .sub-tab-button:not(.active):hover {
            background-color: #a7f3d0;
            color: #064e3b;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .sub-tab-content {
            display: none;
        }
        .sub-tab-content.active {
            display: block;
        }
        .status-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .status-message.show {
            opacity: 1;
        }
        .status-message.success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status-message.error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .status-message.info {
            background-color: #e0f2fe;
            color: #1e40af;
        }
        .chart-container {
            width: 100%;
            max-width: 700px;
            height: 350px;
            margin: 1rem auto;
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            box-sizing: border-box;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        #countdown-container {
            background: rgba(255, 255, 255, 0.7); /* Semi-transparent white for glass effect */
            backdrop-filter: blur(10px); /* Glassmorphism blur */
            border: 1px solid rgba(255, 255, 255, 0.3); /* Subtle border */
            padding: 1.5rem;
            border-radius: 1rem;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); /* Stronger, more vibrant shadow */
            color: #1a202c; /* Darker text for contrast */
            position: relative; /* For potential pseudo-elements */
            overflow: hidden; /* Ensure content stays within bounds */
        }
        #countdown-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.0) 100%);
            pointer-events: none;
            z-index: -1;
        }
        #countdown-timer {
            font-size: 2.5rem; /* text-5xl, slightly larger */
            font-weight: 800; /* Extra bold */
            color: #00796b; /* Dark teal for timer */
            margin-top: 0.5rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        #motivational-quote {
            font-style: italic;
            margin-top: 1rem;
            font-size: 1.25rem; /* text-xl, larger */
            color: #4a5568; /* Darker gray text */
            line-height: 1.5;
        }
        .chapter-button {
            display: block;
            width: 100%;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-align: left;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            background-color: #e2e8f0;
            color: #475569;
            border: 1px solid #cbd5e1;
            white-space: nowrap; /* Prevent text wrapping */
            overflow: hidden; /* Hide overflow */
            text-overflow: ellipsis; /* Show ellipsis for overflow */
        }
        .chapter-button:hover:not(.completed) {
            background-color: #d1d5db;
            transform: translateY(-1px);
        }
        .chapter-button.completed {
            color: #ffffff;
            border-color: #16a34a;
            box-shadow: 0 2px 5px rgba(34, 197, 94, 0.3);
            transform: translateY(-1px);
        }
        .chapter-button.completed:hover {
            opacity: 0.9;
        }
        /* Gradient colors for chapter buttons based on level */
        .color-level-0 { background: linear-gradient(to right, #22c55e, #10b981); } /* Beginner - Green */
        .color-level-1 { background: linear-gradient(to right, #34d399, #10b981); }
        .color-level-2 { background: linear-gradient(to right, #6ee7b7, #34d399); }
        .color-level-3 { background: linear-gradient(to right, #a7f3d0, #6ee7b7); }
        .color-level-4 { background: linear-gradient(to right, #facc15, #eab308); } /* Intermediate - Yellow */
        .color-level-5 { background: linear-gradient(to right, #fbbf24, #f59e0b); }
        .color-level-6 { background: linear-gradient(to right, #f97316, #ea580c); } /* Advanced - Orange */
        .color-level-7 { background: linear-gradient(to right, #ef4444, #dc2626); } /* Master - Red */

        .chapter-header {
            font-weight: 700;
            color: #1e293b;
            padding: 0.5rem 0;
            border-bottom: 2px solid #cbd5e1;
            margin-bottom: 1rem;
            display: grid;
            gap: 0.5rem; /* Reduced gap */
            align-items: center;
        }
        .chapter-row {
            display: grid;
            gap: 0.5rem; /* Reduced gap */
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #e2e8f0;
        }
        .chapter-row:last-child {
            border-bottom: none;
        }
        .chapter-row > div {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chapter-name-col {
            font-weight: 500;
            color: #334155;
        }
        /* Dynamic grid template columns will be set by JS */

        /* Full-screen login page styling */
        #login-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://placehold.co/1920x1080/60a5fa/ffffff?text=NEET+Success+Journey') no-repeat center center/cover; /* Placeholder image */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease-in-out;
            opacity: 1;
        }
        #login-page.hidden {
            opacity: 0;
            pointer-events: none; /* Disable interactions when hidden */
        }
        #login-card {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border-radius: 1.5rem;
            padding: 2.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            text-align: center;
            width: 90%;
            max-width: 500px;
            animation: fadeInScale 0.7s ease-out forwards;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        #login-quote {
            font-style: italic;
            margin-bottom: 1.5rem;
            color: #4a5568;
            font-size: 1.1rem;
            line-height: 1.5;
        }
        #google-signin-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            background-color: #4285F4; /* Google Blue */
            color: white;
            font-weight: 600;
            padding: 0.85rem 1.5rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            font-size: 1.1rem;
            width: 100%; /* Full width */
        }
        #google-signin-button:hover {
            background-color: #357ae8;
            transform: translateY(-2px);
        }
        #google-signin-button svg {
            width: 1.5rem;
            height: 1.5rem;
        }
        /* Styles for the new calendar */
        #calendar-container {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        #calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            color: #334155;
        }
        #calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            text-align: center;
        }
        .day-name {
            font-weight: bold;
            color: #475569;
            padding: 0.5rem;
        }
        .date-cell {
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: #f8fafc;
            border: 1px solid #cbd5e1;
            min-height: 100px; /* Ensure enough space for content */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            position: relative; /* For overlays/dots */
            overflow: hidden; /* Hide overflow content for small cells */
            font-size: 0.85rem;
            color: #334155;
        }
        .date-number {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
            color: #1e293b;
        }
        .date-cell.today {
            background-color: #e0f2fe;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        .date-cell.past-day {
            background-color: #f1f5f9;
            color: #94a3b8;
        }
        .date-cell .event-marker {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            position: absolute;
            bottom: 5px;
        }
        .event-marker.upcoming {
            background-color: #fbbf24; /* Yellow */
            left: 5px;
        }
        .event-marker.backlog {
            background-color: #ef4444; /* Red */
            left: 20px;
        }
        .event-marker.mcq-missed {
            background-color: #a855f7; /* Purple */
            left: 35px;
        }
        .event-marker.mcq-exceeded {
            background-color: #22c55e; /* Green */
            left: 50px;
        }
        .tuition-slot {
            background-color: rgba(59, 130, 246, 0.1); /* Light blue background for tuition */
            border-left: 3px solid #3b82f6;
            padding: 0.2rem 0.4rem;
            border-radius: 0.3rem;
            font-size: 0.75rem;
            margin-top: 0.25rem;
            text-align: left;
            width: 100%;
        }
        .tuition-slot.bio {
            background-color: rgba(16, 185, 129, 0.1);
            border-left-color: #10b981;
        }
        .tuition-slot.phychem {
            background-color: rgba(249, 115, 22, 0.1);
            border-left-color: #f97316;
        }
        .daily-log-item {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            font-size: 0.9rem;
            color: #334155;
        }
        .daily-log-item.completed {
            border-left: 5px solid #10b981;
            background-color: #f0fdf4;
        }
        .daily-log-item strong {
            color: #1e293b;
        }
        .daily-log-item .action-buttons {
            margin-top: 0.75rem;
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }
        /* Circular progress chart styles */
        .mcq-quota-container {
            display: flex;
            justify-content: space-around;
            gap: 1rem;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        .mcq-quota-chart {
            width: 100px;
            height: 100px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: conic-gradient(#3b82f6 0%, #e5e7eb 0%); /* Default background */
            font-weight: bold;
            color: #1e293b;
            font-size: 0.9rem;
            box-shadow: inset 0 0 0 5px rgba(0,0,0,0.05);
        }
        .mcq-quota-chart span {
            position: absolute;
            z-index: 1;
        }
        .mcq-quota-chart::after {
            content: '';
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            background: white;
            border-radius: 50%;
            z-index: 0;
        }
        .mcq-quota-label {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: #475569;
        }
        /* Styling for multi-select topics */
        .topic-checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            background-color: #f8fafc;
            border: 1px solid #cbd5e1;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
        }
        .topic-checkbox-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.2rem 0.5rem;
            border-radius: 0.3rem;
            background-color: #eff6ff;
            color: #1e40af;
            font-size: 0.85rem;
            transition: background-color 0.2s ease;
        }
        .topic-checkbox-group label:hover {
            background-color: #dbeafe;
        }
        .topic-checkbox-group input[type="checkbox"] {
            margin-right: 0.5rem;
        }
        .topic-checkbox-group input[type="checkbox"]:checked + span {
            font-weight: 600;
            color: #065f46;
        }
        .ai-emotion-message {
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: #dcfce7;
            color: #16a34a;
            border-left: 4px solid #22c55e;
            border-radius: 0.5rem;
            font-style: italic;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- Full-screen Login Page -->
    <div id="login-page">
        <div id="login-card">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-4">Road to AIIMS</h1>
            <p id="login-quote" class="text-lg"></p>
            <p class="text-gray-700 mb-6 text-xl font-semibold">Sign in to continue your journey!</p>

            <button id="google-signin-button">
                <svg viewBox="0 0 48 48" width="24px" height="24px">
                    <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.62-6.62C34.7 2.5 29.79 0 24 0 14.28 0 6.27 5.79 2.45 14.07l7.55 5.86C12.44 13.9 17.84 9.5 24 9.5z"/>
                    <path fill="#4285F4" d="M46.72 24c0-1.57-.13-3.07-.38-4.57H24v9.15h12.47c-.61 3.39-2.5 6.22-5.32 8.16l6.62 6.62c3.8-3.53 6.01-8.54 6.01-14.16z"/>
                    <path fill="#FBBC04" d="M9.98 29.69c-.71-2.19-.71-4.49 0-6.68L2.45 17.14C-.82 20.57-.82 27.43 2.45 30.86l7.53-5.86z"/>
                    <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.9-5.79l-6.62-6.62c-2.82 1.94-6.71 3.05-9.28 3.05-6.16 0-11.56-4.4-14.07-10.79l-7.55 5.86C6.27 42.21 14.28 48 24 48z"/>
                    <path fill="none" d="M0 0h48v48H0z"/>
                </svg>
                Sign in with Google
            </button>

            <!-- Removed Email/Password section -->
        </div>
    </div>

    <!-- Main App Content (Hidden until logged in) -->
    <div id="main-app-content" class="container hidden">
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-6">Road to AIIMS</h1>

        <!-- NEET Countdown & Motivational Quote -->
        <div id="countdown-container">
            <p class="text-2xl font-semibold text-gray-700">Welcome, Future Doctor!</p>
            <p class="text-xl font-medium text-gray-600 mb-2">Time until NEET UG 2026:</p>
            <div id="countdown-timer" class="font-mono"></div>
            <p id="motivational-quote"></p>
        </div>

        <!-- NEW CALENDAR SECTION -->
        <div id="calendar-container">
            <div id="calendar-header">
                <button id="prevMonth" class="px-3 py-1 rounded-lg bg-gray-200 hover:bg-gray-300 transition">&lt;</button>
                <h2 id="currentMonthYear" class="text-xl font-bold"></h2>
                <button id="nextMonth" class="px-3 py-1 rounded-lg bg-gray-200 hover:bg-gray-300 transition">&gt;</button>
            </div>
            <div id="calendar-grid">
                <!-- Day names will be dynamically added here -->
            </div>
        </div>


        <!-- Main Tab Navigation -->
        <div class="flex justify-center gap-4 mb-8 flex-wrap">
            <button id="tabRegularData" class="tab-button active">Daily Routine</button>
            <button id="tabTests" class="tab-button">My Tests</button>
            <button id="tabAnalytics" class="tab-button">Analytics & Graphs</button>
            <button id="tabGoals" class="tab-button">Goals</button> <!-- Renamed from Syllabus -->
            <button id="tabAISuggestions" class="tab-button">AI Suggestions</button>
        </div>

        <div class="text-sm text-gray-500 mt-4 text-center">
            Logged in as: <span id="userIdDisplay" class="font-mono text-gray-600">Not Logged In</span>
            <button id="signOutButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75 ml-4">
                Sign Out
            </button>
        </div>

        <!-- Tab Content Areas -->
        <!-- Renamed and restructured contentRegularData -->
        <div id="contentRegularData" class="tab-content active">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Daily Study Routine</h2>

            <!-- Sub-tab Navigation for Daily Routine -->
            <div class="flex justify-start gap-3 mb-6 flex-wrap">
                <button id="dailyRoutineSubTabToday" class="sub-tab-button active">Today</button>
                <button id="dailyRoutineSubTabUpcoming" class="sub-tab-button">Upcoming Plans</button>
                <button id="dailyRoutineSubTabBacklogs" class="sub-tab-button">Backlogs</button>
                <button id="dailyRoutineSubTabCompleted" class="sub-tab-button">Completed</button>
            </div>

            <!-- Summary Block for Daily Routine Tabs -->
            <div class="bg-blue-50 border-l-4 border-blue-400 text-blue-800 p-4 mb-6" role="alert">
                <p class="font-bold">Daily Summary:</p>
                <div id="dailySummaryBlock" class="text-sm">
                    <!-- Dynamic content will go here -->
                </div>
            </div>

            <!-- "Today" Sub-Tab Content (Daily Log Input) -->
            <div id="dailyRoutineSubContentToday" class="sub-tab-content active">
                <p class="text-gray-600 mb-4">Log your study details for today:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="flex flex-col">
                        <label for="logDate" class="text-lg font-medium text-gray-700">Date:</label>
                        <input type="date" id="logDate" class="w-full">
                    </div>
                    <div class="flex flex-col">
                        <label for="logSubject" class="text-lg font-medium text-gray-700">Subject:</label>
                        <select id="logSubject" class="w-full">
                            <option value="">Select Subject</option>
                            <option value="Physics">Physics</option>
                            <option value="Chemistry">Chemistry</option>
                            <option value="Biology">Biology</option>
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label for="logBook" class="text-lg font-medium text-gray-700">Book/Module:</label>
                        <select id="logBook" class="w-full" disabled>
                            <option value="">Select Book/Module</option>
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label for="logChapter" class="text-lg font-medium text-gray-700">Chapter:</label>
                        <select id="logChapter" class="w-full" disabled>
                            <option value="">Select Chapter</option>
                        </select>
                    </div>
                    <div class="flex flex-col md:col-span-2">
                        <label for="logTopics" class="text-lg font-medium text-gray-700">Topics Covered (Tick all that apply):</label>
                        <div id="logTopics" class="topic-checkbox-group hidden">
                            <!-- Topics will be dynamically loaded here -->
                        </div>
                        <p id="biologyTopicNote" class="text-sm text-gray-500 mt-1 hidden">Topics are not applicable for Biology.</p>
                    </div>

                    <div class="flex flex-col md:col-span-2">
                        <label class="text-lg font-medium text-gray-700 mb-2">Type of Study:</label>
                        <div class="flex flex-wrap gap-4">
                            <label class="inline-flex items-center">
                                <input type="checkbox" class="form-checkbox text-blue-600 rounded" value="Theory" id="studyTypeTheory">
                                <span class="ml-2 text-gray-700">Theory</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" class="form-checkbox text-blue-600 rounded" value="MCQs" id="studyTypeMCQs">
                                <span class="ml-2 text-gray-700">MCQs</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" class="form-checkbox text-blue-600 rounded" value="Revision" id="studyTypeRevision">
                                <span class="ml-2 text-gray-700">Revision</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" class="form-checkbox text-blue-600 rounded" value="Notes" id="studyTypeNotes">
                                <span class="ml-2 text-gray-700">Notes</span>
                            </label>
                        </div>
                    </div>

                    <div class="flex flex-col">
                        <label for="logMCQsCount" class="text-lg font-medium text-gray-700">MCQs Practised (Count):</label>
                        <input type="number" id="logMCQsCount" class="w-full" placeholder="e.g., 50">
                    </div>
                    <div class="flex flex-col">
                        <label for="logMCQSource" class="text-lg font-medium text-gray-700">MCQs Source:</label>
                        <select id="logMCQSource" class="w-full">
                            <option value="">Select Source (Optional)</option>
                            <!-- Books from Goals tab will be populated here -->
                            <option value="Custom">Other/Manual Entry</option>
                        </select>
                    </div>
                    <div class="flex flex-col" id="manualMCQSourceSection" style="display: none;">
                        <label for="logManualMCQSourceName" class="text-lg font-medium text-gray-700">Custom Source Name:</label>
                        <input type="text" id="logManualMCQSourceName" class="w-full" placeholder="e.g., Previous Year Paper">
                    </div>
                    <div class="flex flex-col" id="manualMCQTimeSection" style="display: none;">
                        <label for="logManualMCQTime" class="text-lg font-medium text-gray-700">Time for Custom MCQs (e.g., 1h 30m):</label>
                        <input type="text" id="logManualMCQTime" class="w-full" placeholder="e.g., 1h 30m">
                    </div>
                    <div class="flex flex-col">
                        <label for="logTimeSpent" class="text-lg font-medium text-gray-700">Time Spent (e.g., 2h 45m):</label>
                        <input type="text" id="logTimeSpent" class="w-full" placeholder="e.g., 2h 45m">
                    </div>
                    <div class="flex flex-col md:col-span-2">
                        <label for="logComments" class="text-lg font-medium text-gray-700">Comments/Notes:</label>
                        <textarea id="logComments" class="w-full" placeholder="Any thoughts or challenges..."></textarea>
                    </div>
                </div>
                <button id="saveDailyLogButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                    Save Daily Log
                </button>

                <!-- Daily MCQ Quota Progress Charts -->
                <h3 class="text-xl font-bold text-gray-800 mt-8 mb-4">Daily MCQ Quota Progress</h3>
                <div class="mcq-quota-container">
                    <div class="flex flex-col items-center">
                        <div id="physicsMCQQuotaChart" class="mcq-quota-chart">
                            <canvas></canvas>
                            <span id="physicsMCQQuotaValue">0/0</span>
                        </div>
                        <div class="mcq-quota-label">Physics MCQs</div>
                    </div>
                    <div class="flex flex-col items-center">
                        <div id="chemistryMCQQuotaChart" class="mcq-quota-chart">
                            <canvas></canvas>
                            <span id="chemistryMCQQuotaValue">0/0</span>
                        </div>
                        <div class="mcq-quota-label">Chemistry MCQs</div>
                    </div>
                    <div class="flex flex-col items-center">
                        <div id="biologyMCQQuotaChart" class="mcq-quota-chart">
                            <canvas></canvas>
                            <span id="biologyMCQQuotaValue">0/0</span>
                        </div>
                        <div class="mcq-quota-label">Biology MCQs</div>
                    </div>
                </div>
                    <div class="flex flex-col items-center">
                        <div class="mcq-quota-chart" id="physicsMCQQuotaChart">
                            <span id="physicsMCQQuotaValue">0/100</span>
                        </div>
                        <span class="mcq-quota-label">Physics</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <div class="mcq-quota-chart" id="chemistryMCQQuotaChart">
                            <span id="chemistryMCQQuotaValue">0/100</span>
                        </div>
                        <span class="mcq-quota-label">Chemistry</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <div class="mcq-quota-chart" id="biologyMCQQuotaChart">
                            <span id="biologyMCQQuotaValue">0/150</span>
                        </div>
                        <span class="mcq-quota-label">Biology</span>
                    </div>
                </div>
                <div id="aiMCQEmotionMessage" class="ai-emotion-message hidden"></div>

                <div class="flex flex-col gap-2 mt-6">
                    <h3 class="text-lg font-semibold text-gray-800">Today's Log Entries:</h3>
                    <div id="dailyLogDisplay" class="data-display text-gray-700">
                        No entries for today.
                    </div>
                </div>
            </div>

            <!-- "Upcoming Plans" Sub-Tab Content -->
            <div id="dailyRoutineSubContentUpcoming" class="sub-tab-content">
                <h3 class="text-xl font-semibold text-gray-800 mb-3">Plan Ahead:</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="flex flex-col">
                        <label for="planDate" class="text-lg font-medium text-gray-700">Scheduled Date:</label>
                        <input type="date" id="planDate" class="w-full">
                    </div>
                    <div class="flex flex-col">
                        <label for="planSubject" class="text-lg font-medium text-gray-700">Subject:</label>
                        <select id="planSubject" class="w-full">
                            <option value="">Select Subject</option>
                            <option value="Physics">Physics</option>
                            <option value="Chemistry">Chemistry</option>
                            <option value="Biology">Biology</option>
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label for="planChapter" class="text-lg font-medium text-gray-700">Chapter/Topic:</label>
                        <input type="text" id="planChapter" class="w-full" placeholder="e.g., Chemical Bonding or Redox Reactions MCQs">
                    </div>
                    <div class="flex flex-col">
                        <label for="planStudyType" class="text-lg font-medium text-gray-700">Study Type:</label>
                        <input type="text" id="planStudyType" class="w-full" placeholder="e.g., Theory, MCQs, Revision">
                    </div>
                    <div class="flex flex-col">
                        <label for="planEstimatedTime" class="text-lg font-medium text-gray-700">Estimated Time (optional):</label>
                        <input type="text" id="planEstimatedTime" class="w-full" placeholder="e.g., 2h 30m">
                    </div>
                </div>
                <button id="savePlanButton" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75">
                    Add to Plans
                </button>
                <div class="flex flex-col gap-2 mt-6">
                    <h3 class="text-lg font-semibold text-gray-800">Your Upcoming Plans:</h3>
                    <div id="upcomingPlansDisplay" class="data-display text-gray-700">
                        No upcoming plans.
                    </div>
                </div>
            </div>

            <!-- "Backlogs" Sub-Tab Content -->
            <div id="dailyRoutineSubContentBacklogs" class="sub-tab-content">
                <h3 class="text-xl font-semibold text-gray-800 mb-3">Pending Backlogs:</h3>
                <div id="backlogsDisplay" class="data-display text-gray-700">
                    No pending backlogs.
                </div>
            </div>

            <!-- "Completed" Sub-Tab Content -->
            <div id="dailyRoutineSubContentCompleted" class="sub-tab-content">
                <h3 class="text-xl font-semibold text-gray-800 mb-3">All Completed Tasks:</h3>
                <div id="completedTasksDisplay" class="data-display text-gray-700">
                    No completed tasks yet.
                </div>
            </div>
            
            <div class="flex flex-col gap-2 mt-6">
                <h3 class="text-lg font-semibold text-gray-800">AI Productivity Analysis:</h3>
                <button id="getAIProductivityInsightsButton" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75">
                    Get Productivity Insights ✨
                </button>
                <div id="aiProductivityAnalysisDisplay" class="data-display text-gray-700">
                    AI analysis of your daily logs will appear here.
                </div>
            </div>
        </div>

        <div id="contentTests" class="tab-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">My Tests Data</h2>

            <!-- Test Sub-Tab Navigation -->
            <div class="flex justify-start gap-3 mb-6 flex-wrap">
                <button id="testEntrySubTabUT" class="sub-tab-button active">Unit Tests</button>
                <button id="testEntrySubTabBBCTS" class="sub-tab-button">BB Classes Test Series</button>
                <button id="testEntrySubTabQuarterly" class="sub-tab-button">Quarterly Tests</button>
                <button id="testEntrySubTabMissionNeet" class="sub-tab-button">Mission NEET Tests</button>
            </div>

            <!-- Unit Tests Sub-Tab Content -->
            <div id="testEntrySubContentUT" class="sub-tab-content active">
                <p class="text-gray-600 mb-4">Enter your Unit Test data using the fields below:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="flex flex-col">
                        <label for="utDate" class="text-lg font-medium text-gray-700">Date:</label>
                        <input type="date" id="utDate" class="w-full">
                    </div>
                    <div class="flex flex-col">
                        <label for="utSyllabus" class="text-lg font-medium text-gray-700">Syllabus:</label>
                        <input type="text" id="utSyllabus" class="w-full" placeholder="e.g., Vectors, Basic Maths">
                    </div>
                    <div class="flex flex-col">
                        <label for="utFullMarks" class="text-lg font-medium text-gray-700">Full Marks:</label>
                        <input type="number" id="utFullMarks" class="w-full" placeholder="e.g., 320">
                    </div>
                    <div class="flex flex-col">
                        <label for="utPhysicsScore" class="text-lg font-medium text-gray-700">Physics Score:</label>
                        <input type="number" id="utPhysicsScore" class="w-full" placeholder="e.g., 32">
                    </div>
                    <div class="flex flex-col">
                        <label for="utChemistryScore" class="text-lg font-medium text-gray-700">Chemistry Score:</label>
                        <input type="number" id="utChemistryScore" class="w-full" placeholder="e.g., 30">
                    </div>
                    <div class="flex flex-col">
                        <label for="utBiologyScore" class="text-lg font-medium text-gray-700">Biology Score:</label>
                        <input type="number" id="utBiologyScore" class="w-full" placeholder="e.g., 105">
                    </div>
                    <div class="flex flex-col">
                        <label for="utMyMarks" class="text-lg font-medium text-gray-700">My Marks (Total):</label>
                        <input type="number" id="utMyMarks" class="w-full" placeholder="e.g., 167">
                    </div>
                </div>
                <button id="saveUTButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 mt-4">
                    Save Unit Test Data
                </button>
                <div class="flex flex-col gap-2 mt-6">
                    <h3 class="text-lg font-semibold text-gray-800">Stored Unit Test Data:</h3>
                    <div id="testsDataDisplay" class="data-display text-gray-700">
                        No Unit Test data stored yet.
                    </div>
                </div>
            </div>

            <!-- BB Classes Test Series Sub-Tab Content -->
            <div id="testEntrySubContentBBCTS" class="sub-tab-content">
                <p class="text-gray-600 mb-4">Enter your BB Classes Test Series data using the fields below:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="flex flex-col">
                        <label for="bbctsDate" class="text-lg font-medium text-gray-700">Date:</label>
                        <input type="date" id="bbctsDate" class="w-full">
                    </div>
                    <div class="flex flex-col">
                        <label for="bbctsSyllabus" class="text-lg font-medium text-gray-700">Syllabus:</label>
                        <input type="text" id="bbctsSyllabus" class="w-full" placeholder="e.g., BBCTS Test 1 Syllabus">
                    </div>
                    <div class="flex flex-col">
                        <label for="bbctsFullMarks" class="text-lg font-medium text-gray-700">Full Marks:</label>
                        <input type="number" id="bbctsFullMarks" class="w-full" placeholder="e.g., 360">
                    </div>
                    <div class="flex flex-col">
                        <label for="bbctsPhysicsScore" class="text-lg font-medium text-gray-700">Physics Score:</label>
                        <input type="number" id="bbctsPhysicsScore" class="w-full" placeholder="e.g., 60">
                    </div>
                    <div class="flex flex-col">
                        <label for="bbctsChemistryScore" class="text-lg font-medium text-gray-700">Chemistry Score:</label>
                        <input type="number" id="bbctsChemistryScore" class="w-full" placeholder="e.g., 70">
                    </div>
                    <div class="flex flex-col">
                        <label for="bbctsBiologyScore" class="text-lg font-medium text-gray-700">Biology Score:</label>
                        <input type="number" id="bbctsBiologyScore" class="w-full" placeholder="e.g., 150">
                    </div>
                    <div class="flex flex-col">
                        <label for="bbctsMyMarks" class="text-lg font-medium text-gray-700">My Marks (Total):</label>
                        <input type="number" id="bbctsMyMarks" class="w-full" placeholder="e.g., 280">
                    </div>
                </div>
                <button id="saveBBCTSButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 mt-4">
                    Save BB Classes Test Series Data
                </button>
                <div class="flex flex-col gap-2 mt-6">
                    <h3 class="text-lg font-semibold text-gray-800">Stored BB Classes Test Series Data:</h3>
                    <div id="bbctsDataDisplay" class="data-display text-gray-700">
                        No BB Classes Test Series data stored yet.
                    </div>
                </div>
            </div>

            <!-- Quarterly Tests Sub-Tab Content -->
            <div id="testEntrySubContentQuarterly" class="sub-tab-content">
                <p class="text-gray-600 mb-4">Enter your Quarterly Test data using the fields below:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="flex flex-col">
                        <label for="qtDate" class="text-lg font-medium text-gray-700">Date:</label>
                        <input type="date" id="qtDate" class="w-full">
                    </div>
                    <div class="flex flex-col">
                        <label for="qtSyllabus" class="text-lg font-medium text-gray-700">Syllabus:</label>
                        <input type="text" id="qtSyllabus" class="w-full" placeholder="e.g., Quarterly Test 1 Syllabus">
                    </div>
                    <div class="flex flex-col">
                        <label for="qtFullMarks" class="text-lg font-medium text-gray-700">Full Marks:</label>
                        <input type="number" id="qtFullMarks" class="w-full" placeholder="e.g., 720">
                    </div>
                    <div class="flex flex-col">
                        <label for="qtPhysicsScore" class="text-lg font-medium text-gray-700">Physics Score:</label>
                        <input type="number" id="qtPhysicsScore" class="w-full" placeholder="e.g., 120">
                    </div>
                    <div class="flex flex-col">
                        <label for="qtChemistryScore" class="text-lg font-medium text-gray-700">Chemistry Score:</label>
                        <input type="number" id="qtChemistryScore" class="w-full" placeholder="e.g., 130">
                    </div>
                    <div class="flex flex-col">
                        <label for="qtBiologyScore" class="text-lg font-medium text-gray-700">Biology Score:</label>
                        <input type="number" id="qtBiologyScore" class="w-full" placeholder="e.g., 280">
                    </div>
                    <div class="flex flex-col">
                        <label for="qtMyMarks" class="text-lg font-medium text-gray-700">My Marks (Total):</label>
                        <input type="number" id="qtMyMarks" class="w-full" placeholder="e.g., 530">
                    </div>
                </div>
                <button id="saveQuarterlyButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 mt-4">
                    Save Quarterly Data
                </button>
                <div class="flex flex-col gap-2 mt-6">
                    <h3 class="text-lg font-semibold text-gray-800">Stored Quarterly Data:</h3>
                    <div id="quarterlyDataDisplay" class="data-display text-gray-700">
                        No Quarterly data stored yet.
                    </div>
                </div>
            </div>

            <!-- Mission NEET Tests Sub-Tab Content -->
            <div id="testEntrySubContentMissionNeet" class="sub-tab-content">
                <p class="text-gray-600 mb-4">Enter your Mission NEET data using the fields below:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="flex flex-col">
                        <label for="mnDate" class="text-lg font-medium text-gray-700">Date:</label>
                        <input type="date" id="mnDate" class="w-full">
                    </div>
                    <div class="flex flex-col">
                        <label for="mnSyllabus" class="text-lg font-medium text-gray-700">Syllabus:</label>
                        <input type="text" id="mnSyllabus" class="w-full" placeholder="e.g., Cell Cycle and Cell Division">
                    </div>
                    <div class="flex flex-col">
                        <label for="mnFullMarks" class="text-lg font-medium text-gray-700">Full Marks:</label>
                        <input type="number" id="mnFullMarks" class="w-full" placeholder="e.g., 200">
                    </div>
                    <div class="flex flex-col">
                        <label for="mnScore" class="text-lg font-medium text-gray-700">Score:</label>
                        <input type="number" id="mnScore" class="w-full" placeholder="e.g., 180">
                    </div>
                </div>
                <button id="saveMissionNeetButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 mt-4">
                    Save Mission NEET Data
                </button>
                <div class="flex flex-col gap-2 mt-6">
                    <h3 class="text-lg font-semibold text-gray-800">Stored Mission NEET Data:</h3>
                    <div id="missionNeetDataDisplay" class="data-display text-gray-700">
                        No Mission NEET data stored yet.
                    </div>
                </div>
            </div>
        </div>

        <div id="contentAnalytics" class="tab-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Analytics & Graphs</h2>
            <p class="text-gray-600 mb-4">Visualize your test performance and syllabus progression here. Graphs update automatically when data is saved.</p>

            <div class="flex flex-wrap gap-4 mb-6">
                <button id="getAIPerformanceInsightsButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75">
                    Get AI Performance Insights ✨
                </button>
            </div>

            <!-- Analytics Sub-Tab Navigation -->
            <div class="flex justify-center gap-2 mb-6 flex-wrap">
                <button id="subTabUT" class="sub-tab-button active">Unit Tests</button>
                <button id="subTabBBCTS" class="sub-tab-button">BB Classes Test Series</button>
                <button id="subTabQuarterly" class="sub-tab-button">Quarterly Tests</button>
                <button id="subTabMissionNeetAnalytics" class="sub-tab-button">Mission NEET Tests</button>
                <button id="subTabSyllabusProgression" class="sub-tab-button">Syllabus Progression</button> <!-- New Syllabus Progression Graph Tab -->
            </div>

            <!-- Analytics Sub-Tab Content Areas -->
            <div id="subContentUT" class="sub-tab-content active">
                <div id="chartsContainerUT" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="chart-container">
                        <canvas id="physicsChartUT"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="chemistryChartUT"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="biologyChartUT"></canvas>
                    </div>
                </div>
            </div>

            <div id="subContentBBCTS" class="sub-tab-content">
                <div id="chartsContainerBBCTS" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div class="chart-container">
                        <canvas id="physicsChartBBCTS"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="chemistryChartBBCTS"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="biologyChartBBCTS"></canvas>
                    </div>
                </div>
            </div>

            <div id="subContentQuarterly" class="sub-tab-content">
                <div id="chartsContainerQuarterly" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div class="chart-container">
                        <canvas id="physicsChartQuarterly"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="chemistryChartQuarterly"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="biologyChartQuarterly"></canvas>
                    </div>
                </div>
            </div>

            <div id="subContentMissionNeetAnalytics" class="sub-tab-content">
                <div id="chartsContainerMissionNeet" class="grid grid-cols-1 md:grid-cols-1 gap-6">
                    <div class="chart-container">
                        <canvas id="missionNeetChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- New Syllabus Progression Graph Content -->
            <div id="subContentSyllabusProgression" class="sub-tab-content">
                <div class="chart-container">
                    <canvas id="syllabusProgressionChart"></canvas>
                </div>
            </div>

            <div class="flex flex-col gap-2 mt-6">
                <h3 class="text-lg font-semibold text-gray-800">AI Performance Analysis:</h3>
                <div id="aiPerformanceAnalysisDisplay" class="data-display text-gray-700">
                    AI analysis will appear here after clicking "Get AI Performance Insights ✨".
                </div>
            </div>
        </div>

        <!-- NEW GOALS TAB (Renamed from Syllabus) -->
        <div id="contentGoals" class="tab-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">My Study Goals</h2>
            <p class="text-gray-600 mb-4">Mark chapters as completed to track your progress towards NEET UG 2026!</p>

            <!-- Goals Sub-Tab Navigation (Physics, Chemistry, Biology) -->
            <div class="flex justify-start gap-3 mb-6 flex-wrap">
                <button id="goalsSubTabPhysics" class="sub-tab-button active">Physics Goals</button>
                <button id="goalsSubTabChemistry" class="sub-tab-button">Chemistry Goals</button>
                <button id="goalsSubTabBiology" class="sub-tab-button">Biology Goals</button>
            </div>

            <!-- Sub-category Visibility Controls -->
            <div id="subcategory-controls" class="bg-gray-100 p-4 rounded-lg mb-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Select Study Levels to Display:</h3>
                <div id="physicsChemistrySubcategoryCheckboxes" class="flex flex-wrap gap-x-6 gap-y-2 mb-4">
                    <!-- Checkboxes will be dynamically generated here -->
                </div>
                <div id="biologySubcategoryCheckboxes" class="flex flex-wrap gap-x-6 gap-y-2 hidden">
                    <!-- Checkboxes will be dynamically generated here -->
                </div>
            </div>

            <!-- Physics Goals Content -->
            <div id="goalsSubContentPhysics" class="sub-tab-content active">
                <h3 class="text-xl font-semibold text-gray-800 mb-3">Physics Chapters:</h3>
                <div id="physicsGoalsDisplay" class="data-display text-gray-700">
                    <!-- Physics chapters will be dynamically loaded here -->
                </div>
            </div>

            <!-- Chemistry Goals Content -->
            <div id="goalsSubContentChemistry" class="sub-tab-content">
                <h3 class="text-xl font-semibold text-gray-800 mb-3">Chemistry Chapters:</h3>
                <div id="chemistryGoalsDisplay" class="data-display text-gray-700">
                    <!-- Chemistry chapters will be dynamically loaded here -->
                </div>
            </div>

            <!-- Biology Goals Content -->
            <div id="goalsSubContentBiology" class="sub-tab-content">
                <h3 class="text-xl font-semibold text-gray-800 mb-3">Biology Chapters:</h3>
                <div id="biologyGoalsDisplay" class="data-display text-gray-700">
                    <!-- Biology chapters will be dynamically loaded here -->
                </div>
            </div>

            <div class="flex flex-col gap-2 mt-6">
                <h3 class="text-lg font-semibold text-gray-800">AI Progress Insights:</h3>
                <button id="getAIGoalsInsightsButton" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-75">
                    Get My Progress Insights ✨
                </button>
                <div id="aiGoalsAnalysisDisplay" class="data-display text-gray-700">
                    AI analysis of your syllabus progress will appear here.
                </div>
            </div>
        </div>

        <div id="contentAISuggestions" class="tab-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">AI Suggestions</h2>
            <div class="flex flex-col gap-2 mb-4">
                <label for="aiPromptInput" class="text-lg font-medium text-gray-700">Ask for general suggestions (e.g., "Summarize my daily routine", "Suggest next steps for my tests"):</label>
                <textarea id="aiPromptInput" class="w-full" placeholder="Type your query here..."></textarea>
            </div>
            <button id="getAISuggestionButton" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">
                Get General Suggestion ✨
            </button>
            <div class="flex flex-col gap-2 mt-6">
                <h3 class="text-lg font-semibold text-gray-800">AI General Suggestion:</h3>
                <div id="aiResponseDisplay" class="data-display text-gray-700">
                    AI suggestions will appear here.
                </div>
            </div>

            <hr class="my-8 border-t-2 border-gray-200"> <!-- Separator -->

            <h2 class="text-2xl font-bold text-gray-800 mb-4">Next Study Plan ✨</h2>
            <p class="text-gray-600 mb-4">Get AI-powered recommendations for your next topic, MCQs, and study time based on your progress and topper advice.</p>
            <button id="getNextStudyPlanButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                Generate Next Study Plan ✨
            </button>
            <div class="flex flex-col gap-2 mt-6">
                <h3 class="text-lg font-semibold text-gray-800">AI Study Plan:</h3>
                <div id="nextStudyPlanDisplay" class="data-display text-gray-700">
                    Your personalized study plan will appear here.
                </div>
            </div>

            <hr class="my-8 border-t-2 border-gray-200"> <!-- Separator -->

            <h2 class="text-2xl font-bold text-gray-800 mb-4">Concept Explanation ✨</h2>
            <div class="flex flex-col gap-2 mb-4">
                <label for="conceptInput" class="text-lg font-medium text-gray-700">Enter a concept or doubt you want explained:</label>
                <textarea id="conceptInput" class="w-full" placeholder="e.g., Explain glycolysis, What is osmosis?"></textarea>
            </div>
            <button id="explainConceptButton" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75">
                Explain Concept ✨
            </button>
            <div class="flex flex-col gap-2 mt-6">
                <h3 class="text-lg font-semibold text-gray-800">AI Explanation:</h3>
                <div id="conceptExplanationDisplay" class="data-display text-gray-700">
                    Your AI-powered concept explanation will appear here.
                </div>
            </div>

            <hr class="my-8 border-t-2 border-gray-200"> <!-- Separator -->

            <h2 class="text-2xl font-bold text-gray-800 mb-4">Revision Topic Suggester ✨</h2>
            <p class="text-gray-600 mb-4">Get AI-powered suggestions for topics you should revise based on your performance and study logs.</p>
            <button id="suggestRevisionTopicsButton" class="bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-opacity-75">
                Suggest Revision Topics ✨
            </button>
            <div class="flex flex-col gap-2 mt-6">
                <h3 class="text-lg font-semibold text-gray-800">AI Revision Suggestions:</h3>
                <div id="revisionSuggestionsDisplay" class="data-display text-gray-700">
                    AI revision suggestions will appear here.
                </div>
            </div>

            <hr class="my-8 border-t-2 border-gray-200"> <!-- Separator -->

            <h2 class="text-2xl font-bold text-gray-800 mb-4">Mock Test Question Generator ✨</h2>
            <p class="text-gray-600 mb-4">Generate practice MCQs for specific subjects and topics.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="flex flex-col">
                    <label for="questionSubject" class="text-lg font-medium text-gray-700">Subject:</label>
                    <select id="questionSubject" class="w-full">
                        <option value="">Select Subject</option>
                        <option value="Physics">Physics</option>
                        <option value="Chemistry">Chemistry</option>
                        <option value="Biology">Biology</option>
                    </select>
                </div>
                <div class="flex flex-col">
                    <label for="questionTopic" class="text-lg font-medium text-gray-700">Topic (e.g., "Thermodynamics", "Human Reproduction"):</label>
                    <input type="text" id="questionTopic" class="w-full" placeholder="Enter topic">
                </div>
            </div>
            <button id="generateQuestionsButton" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75">
                Generate Practice Questions ✨
            </button>
            <div class="flex flex-col gap-2 mt-6">
                <h3 class="text-lg font-semibold text-gray-800">Generated Questions:</h3>
                <div id="generatedQuestionsDisplay" class="data-display text-gray-700">
                    Generated MCQs will appear here.
                </div>
            </div>

            <hr class="my-8 border-t-2 border-gray-200"> <!-- Separator -->

            <h2 class="text-2xl font-bold text-gray-800 mb-4">Weakness Identification & Targeted Practice ✨</h2>
            <p class="text-gray-600 mb-4">Get AI-powered analysis of your weak areas and specific suggestions for improving them.</p>
            <button id="identifyWeaknessesButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75">
                Identify Weaknesses & Practice Tips ✨
            </button>
            <div class="flex flex-col gap-2 mt-6">
                <h3 class="text-lg font-semibold text-gray-800">AI Weakness Analysis:</h3>
                <div id="weaknessAnalysisDisplay" class="data-display text-gray-700">
                    AI analysis of your weak areas and practice tips will appear here.
                </div>
            </div>

        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances and user ID
        let app;
        let db;
        let auth;
        let userId = 'loading'; // Default until authenticated
        let userEmail = 'Not Logged In'; // To display user's email

        // Global variables to store fetched data
        let utTestData = [];
        let bbctsData = [];
        
        // Chart variables
        let mcqChartInstances = {
            physics: null,
            chemistry: null,
            biology: null
        };
        
        // Chart canvas elements
        let chartCanvases = {
            physics: null,
            chemistry: null,
            biology: null
        };
        let quarterlyData = [];
        let missionNeetData = [];
        let regularDataLogs = []; // Array to store multiple daily logs
        let upcomingPlans = []; // NEW: Array for upcoming plans
        let completedTasks = []; // NEW: Array for completed tasks
        let chapterStatus = {}; // Tracks completion status for each chapter/topic
        let dailyMCQCount = { Physics: 0, Chemistry: 0, Biology: 0 }; // NEW: For daily MCQ quota tracking
        let aiMCQEmotionMessageTimeout; // Timeout for AI emotion message

        // Parsed Syllabus Data for Goals and Daily Routine
        let physicsGoalsData = [];
        let chemistryGoalsData = [];
        let biologyGoalsData = [];

        // Tuition Schedule
        const tuitionSchedule = {
            Monday: [{ subject: 'Biology', time: '9:00 AM - 12:00 PM' }],
            Tuesday: [],
            Wednesday: [
                { subject: 'Chemistry', time: '9:00 AM - 12:00 PM' },
                { subject: 'Physics', time: '12:30 PM - 3:30 PM' }
            ],
            Thursday: [{ subject: 'Biology', time: '9:00 AM - 12:00 PM' }],
            Friday: [],
            Saturday: [
                { subject: 'Physics', time: '9:00 AM - 12:00 PM' },
                { subject: 'Chemistry', time: '12:30 PM - 3:30 PM' }
            ],
            Sunday: []
        };

        // NEW: Syllabus Data with Topics
        const syllabusData = {
            Physics: [
                { 'Chapter Name': 'Units and Measurements', Topics: ['SI units (fundamental & derived)', 'Least count', 'Significant figures', 'Errors in measurement', 'Dimensions & dimensional analysis'] },
                { 'Chapter Name': 'Motion in a Straight Line', Topics: ['Frame of reference', 'Position–time & velocity–time graphs', 'Speed, velocity, acceleration (uniform & non-uniform)', 'Average vs instantaneous velocity', 'Equations of motion under uniform acceleration'] },
                { 'Chapter Name': 'Motion in a Plane', Topics: ['Scalars vs vectors', 'Vector operations (addition, subtraction, dot & cross products)', 'Unit vectors, resolution of vectors', 'Relative velocity', 'Projectile motion', 'Uniform circular motion'] },
                { 'Chapter Name': 'Laws of Motion', Topics: ['Force, inertia, Newton’s 3 laws', 'Momentum, impulse & conservation of momentum', 'Equilibrium of forces', 'Friction (static, kinetic, rolling)', 'Dynamics of circular motion (centripetal force; banked roads)'] },
                { 'Chapter Name': 'Work, Energy and Power', Topics: ['Work by constant & variable forces', 'Kinetic & potential energy', 'Work–energy theorem', 'Power', 'Mechanical energy conservation', 'Conservative vs non-conservative forces', 'Motion in vertical circles', 'Elastic & inelastic collisions'] },
                { 'Chapter Name': 'System of Particles and Rotational Motion', Topics: ['Centre of mass (two-particle & rigid bodies)', 'Torque & moment of force', 'Moment of inertia, radius of gyration', 'Angular momentum & its conservation', 'Parallel & perpendicular axis theorems', 'Dynamics & equilibrium of rigid bodies'] },
                { 'Chapter Name': 'Gravitation', Topics: ['Newton’s universal law', 'Acceleration due to gravity (variation)', 'Kepler’s laws', 'Gravitational potential & energy', 'Escape velocity', 'Satellite motion (orbital velocity, period, energy)'] },
                { 'Chapter Name': 'Mechanical Properties of Solids', Topics: ['Elastic behaviour, stress–strain', 'Hooke’s law', 'Young’s, shear & bulk moduli'] },
                { 'Chapter Name': 'Mechanical Properties of Fluids', Topics: ['Pressure in fluids, buoyancy', 'Equation of continuity', 'Bernoulli’s theorem', 'Viscosity', 'Surface tension'] },
                { 'Chapter Name': 'Thermal Properties of Matter', Topics: ['Thermal expansion', 'Specific heat capacity, calorimetry', 'Latent heat', 'Heat transfer: conduction, convection, radiation'] },
                { 'Chapter Name': 'Thermodynamics', Topics: ['Zeroth, first & second laws', 'Internal energy & work', 'Processes: isothermal, adiabatic, cyclic', 'Carnot cycle & engine'] },
                { 'Chapter Name': 'Kinetic Theory', Topics: ['Ideal gas equation', 'RMS speed & Maxwell’s distribution', 'Degrees of freedom & equipartition theorem'] },
                { 'Chapter Name': 'Oscillations', Topics: ['Simple harmonic motion (SHM): definition, equation', 'Energy in SHM'] },
                { 'Chapter Name': 'Waves', Topics: ['Wave parameters (wavelength, frequency, speed)', 'Transverse & longitudinal waves', 'Wave propagation & interaction'] },
                { 'Chapter Name': 'Electric Charges and Fields', Topics: ['Coulomb’s law & system of charges', 'Electric field (lines, flux)', 'Gauss’s law & applications', 'Electric dipole in field'] },
                { 'Chapter Name': 'Electrostatic Potential and Capacitance', Topics: ['Electric potential & potential energy', 'Equipotential surfaces', 'Capacitors (parallel plate), combinations', 'Energy stored in capacitors'] },
                { 'Chapter Name': 'Current Electricity', Topics: ['Ohm’s law & resistivity', 'Series & parallel circuits', 'Kirchhoff’s laws', 'Electrical energy and power'] },
                { 'Chapter Name': 'Moving Charges and Magnetism', Topics: ['Magnetic force on moving charges & currents', 'Biot–Savart law, Ampère’s law'] },
                { 'Chapter Name': 'Magnetism and Matter', Topics: ['Magnetic dipole & dipole moment', 'Torque on dipole in magnetic field', 'Magnetic properties of materials'] },
                { 'Chapter Name': 'Electromagnetic Induction', Topics: ['Faraday’s law & Lenz’s law', 'Induced emf & current', 'Self and mutual inductance'] },
                { 'Chapter Name': 'Alternating Current', Topics: ['AC voltage & current in pure resistive, inductive, and capacitive circuits', 'LC oscillation', 'Resonance in LCR circuits'] },
                { 'Chapter Name': 'Electromagnetic Waves', Topics: ['Maxwell’s equations (qualitative)', 'Electromagnetic spectrum & properties'] },
                { 'Chapter Name': 'Ray Optics and Optical Instruments', Topics: ['Reflection, refraction, lenses, mirrors, magnification', 'Human eye (defects & correction)', 'Microscopes & telescopes'] },
                { 'Chapter Name': 'Wave Optics', Topics: ['Huygens’ principle', 'Interference, diffraction', 'Young’s double slit experiment'] },
                { 'Chapter Name': 'Dual Nature of Radiation and Matter', Topics: ['Photoelectric effect', 'de Broglie wavelength', 'Matter waves'] },
                { 'Chapter Name': 'Atoms', Topics: ['Rutherford & Bohr models', 'Energy levels, spectra, transitions'] },
                { 'Chapter Name': 'Nuclei', Topics: ['Composition & size of nucleus', 'Radioactivity (α, β, γ); decay law', 'Nuclear binding energy & fission/fusion'] },
                { 'Chapter Name': 'Semiconductor Electronics', Topics: ['Intrinsic & extrinsic semiconductors', 'p‑n junction diode operation & characteristics', 'Diode as rectifier; Zener diode', 'Logic Gates'] }
            ],
            Chemistry: [
                { 'Chapter Name': 'Some Basic Concepts of Chemistry', Topics: ['Matter and its nature', 'Laws of chemical combination', 'Law of Conservation of Mass', 'Law of Definite Proportions', 'Law of Multiple Proportions', 'Dalton’s atomic theory', 'Atoms, molecules, elements, compounds', 'Atomic and molecular masses', 'Mole concept, molar mass', 'Percentage composition', 'Empirical and molecular formulas', 'Chemical equations and stoichiometry', 'Reacting masses', 'Concentration terms'] },
                { 'Chapter Name': 'Structure of Atom', Topics: ['Subatomic particles: electron, proton, neutron', 'Atomic number, mass number, isotopes & isobars', 'Bohr’s model: postulates, hydrogen spectrum, limitations', 'Dual nature: photoelectric effect, de Broglie relation', 'Quantum mechanical model', 'Quantum numbers, orbitals (s, p, d), shapes', 'Electronic configuration: Aufbau, Pauli exclusion, Hund’s rule'] },
                { 'Chapter Name': 'Classification of Elements & Periodicity in Properties', Topics: ['Modern periodic law and periodic table', 'Periodic trends: Atomic/ionic radii', 'Ionization enthalpy', 'Electron gain enthalpy', 'Electronegativity', 'Valency'] },
                { 'Chapter Name': 'Chemical Bonding and Molecular Structure', Topics: ['Valence electrons, ionic & covalent bonding', 'Lewis structures and resonance', 'VSEPR theory: geometry of simple molecules', 'Hybridization (sp, sp², sp³, dsp², d²sp³)', 'Valence Bond Theory', 'Hydrogen bonding'] },
                { 'Chapter Name': 'Thermodynamics', Topics: ['System and surroundings, types of systems', 'State & path functions, internal energy (ΔU), enthalpy (ΔH)', 'First law: P–V work, heat capacity, Hess’s law', 'Second law: entropy & spontaneity', 'Gibbs free energy', 'Third law'] },
                { 'Chapter Name': 'Equilibrium', Topics: ['Physical and chemical equilibrium', 'Law of mass action & equilibrium constant', 'Le Chatelier’s principle', 'Ionic equilibrium: pH', 'Buffer solutions', 'Solubility product', 'Common-ion effect'] },
                { 'Chapter Name': 'Redox Reactions', Topics: ['Oxidation states and balancing redox equations', 'Electrochemical cells (galvanic): concepts & applications'] },
                { 'Chapter Name': 'Some p-Block Elements', Topics: ['General electronic configuration', 'Physical & chemical properties of groups 13–18', 'Anomalous behavior of first elements of each group'] },
                { 'Chapter Name': 'Organic Chemistry – Some Basic Principles & Techniques', Topics: ['IUPAC nomenclature', 'Electronic displacements: inductive & resonance effects', 'Isomerism (structural, geometrical)', 'Reaction intermediates: carbocations, carbenes', 'Hybridization in organic compounds'] },
                { 'Chapter Name': 'Hydrocarbons', Topics: ['Alkanes, alkenes, alkynes, and aromatic hydrocarbons', 'Conformations and isomerism', 'Electrophilic addition & substitution reactions'] },
                { 'Chapter Name': 'Solutions', Topics: ['Types of solutions', 'Concentration terms', 'Colligative properties and their applications'] },
                { 'Chapter Name': 'Electrochemistry', Topics: ['Electrochemical cells and electrode potential', 'Nernst equation', 'Conductance of electrolytic solutions', 'Electrolysis'] },
                { 'Chapter Name': 'Chemical Kinetics', Topics: ['Rate of reaction', 'Order and molecularity', 'Rate laws', 'Factors affecting rate'] },
                { 'Chapter Name': 'The d- and f-Block Elements', Topics: ['Electronic configurations', 'Oxidation states, color, magnetic properties, catalytic behavior', 'Preparation & properties of K₂Cr₂O₇ and KMnO₄'] },
                { 'Chapter Name': 'Coordination Compounds', Topics: ['Werner’s theory', 'Ligands, coordination number, chelation', 'IUPAC nomenclature', 'Isomerism (geometrical, optical)', 'VBT & basics of CFT', 'Color, magnetism, biological/industrial importance'] },
                { 'Chapter Name': 'Haloalkanes and Haloarenes', Topics: ['Nomenclature and structure', 'Preparation methods', 'Substitution reactions (mechanism)', 'Environmental effects'] },
                { 'Chapter Name': 'Alcohols, Phenols and Ethers', Topics: ['Preparation, classification, and properties', 'Acidity of phenols', 'Reactions: dehydration, Reimer–Tiemann, electrophilic substitution'] },
                { 'Chapter Name': 'Aldehydes, Ketones and Carboxylic Acids', Topics: ['Nomenclature and structure', 'Reactivity of carbonyl group', 'Mechanisms: nucleophilic addition, Grignard reagent', 'Reactions: Oxidation & reduction', 'Aldol condensation', 'Cannizzaro', 'Haloform test'] },
                { 'Chapter Name': 'Amines', Topics: ['Structure and classification', 'Basicity and tests', 'Diazonium salts and their synthetic applications'] },
                { 'Chapter Name': 'Biomolecules', Topics: ['Carbohydrates: glucose, fructose, sucrose, lactose', 'Proteins: amino acids, peptides, structure, enzymes', 'Vitamins: types & functions', 'Nucleic acids: DNA/RNA structure & function', 'Hormones (introductory only)'] }
            ],
            Biology: [
                { 'Chapter Name': 'The Living World' }, { 'Chapter Name': 'Biological Classification' },
                { 'Chapter Name': 'Plant Kingdom' }, { 'Chapter Name': 'Animal Kingdom' },
                { 'Chapter Name': 'Morphology of Flowering Plants' }, { 'Chapter Name': 'Anatomy of Flowering Plants' },
                { 'Chapter Name': 'Structural Organisation in Animals' }, { 'Chapter Name': 'Cell - The Unit of Life' },
                { 'Chapter Name': 'Biomolecules' }, { 'Chapter Name': 'Cell Cycle and Cell Division' },
                { 'Chapter Name': 'Photosynthesis in Higher Plants' }, { 'Chapter Name': 'Respiration in Plants' },
                { 'Chapter Name': 'Plant Growth and Development' }, { 'Chapter Name': 'Breathing and Exchange of Gases' },
                { 'Chapter Name': 'Body Fluids and Circulation' }, { 'Chapter Name': 'Excretory Products and Their Elimination' },
                { 'Chapter Name': 'Locomotion and Movement' }, { 'Chapter Name': 'Neural Control and Coordination' },
                { 'Chapter Name': 'Chemical Coordination and Integration' }, { 'Chapter Name': 'Sexual Reproduction in Flowering Plants' },
                { 'Chapter Name': 'Human Reproduction' }, { 'Chapter Name': 'Reproductive Health' },
                { 'Chapter Name': 'Principles of Inheritance and Variation' }, { 'Chapter Name': 'Molecular Basis of Inheritance' },
                { 'Chapter Name': 'Evolution' }, { 'Chapter Name': 'Human Health and Disease' },
                { 'Chapter Name': 'Microbes in Human Welfare' }, { 'Chapter Name': 'Biotechnology - Principles and Processes' },
                { 'Chapter Name': 'Biotechnology and Its Applications' }, { 'Chapter Name': 'Organisms and Populations' },
                { 'Chapter Name': 'Ecosystem' }, { 'Chapter Name': 'Biodiversity and Conservation' }
            ]
        };

        // Daily MCQ Quotas
        const mcqQuotas = {
            Physics: 100,
            Chemistry: 100,
            Biology: 150
        };

        // Chart instances
        let physicsChartUTInstance = null;
        let chemistryChartUTInstance = null;
        let biologyChartUTInstance = null;

        let physicsChartBBCTSInstance = null;
        let chemistryChartBBCTSInstance = null;
        let biologyChartBBCTSInstance = null;

        let physicsChartQuarterlyInstance = null;
        let chemistryChartQuarterlyInstance = null;
        let biologyChartQuarterlyInstance = null;

        let missionNeetChartInstance = null;
        let syllabusProgressionChartInstance = null;

        // NEW: MCQ Quota Chart Instances
        let physicsMCQChartInstance = null;
        let chemistryMCQChartInstance = null;
        let biologyMCQChartInstance = null;

        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let currentDate = new Date().toISOString().split('T')[0];

        // Motivational quotes for login page and general use
        const motivationalQuotes = [
            "The only way to do great work is to love what you do. - Steve Jobs",
            "Believe you can and you're halfway there. - Theodore Roosevelt",
            "The future belongs to those who believe in the beauty of their dreams. - Eleanor Roosevelt",
            "Don't watch the clock; do what it does. Keep going. - Sam Levenson",
            "The harder you work for something, the greater you'll feel when you achieve it.",
            "Success is not final, failure is not fatal: It is the courage to continue that counts. - Winston Churchill",
            "Your time is limited, don't waste it living someone else's life. - Steve Jobs",
            "The best way to predict the future is to create it. - Peter Drucker",
            "It always seems impossible until it's done. - Nelson Mandela",
            "Strive for progress, not perfection.",
            "Dream big, work hard, stay focused, and surround yourself with good people. - Unknown",
            "The expert in anything was once a beginner. - Helen Hayes",
            "Push yourself, because no one else is going to do it for you. - Unknown",
            "Success is the sum of small efforts repeated day in and day out. - Robert Collier",
            "It's not about perfect. It's about effort. And when you bring that effort every single day, that's where transformation happens. That's how change occurs. - Jillian Michaels"
        ];

        // Define sub-categories for each subject with their fixed order and levels
        // Levels 0-7 for color gradient (Beginner to Master)
        const physicsChemistrySubCategoriesOrdered = [
            { key: 'bb_classes_module', name: 'BB Classes Module', level: 0 }, // Beginner
            { key: 'disha', name: 'Disha', level: 2 },
            { key: 'mtg', name: 'MTG', level: 3 },
            { key: 'cengage', name: 'Cengage', level: 5 },
            { key: 'errorless', name: 'Errorless', level: 7 }, // Master
            { key: 'ncert_questions', name: 'NCERT Questions', level: 1 }, // Can be flexible
            { key: 'jee_mains_pyqs', name: 'JEE-Mains PYQs', level: 4 }
        ];

        const biologySubCategoriesOrdered = [
            { key: 'mission_neet_module', name: 'Mission NEET Module', level: 0 }, // Beginner
            { key: 'ncert_fingertips', name: 'NCERT Fingertips', level: 3 },
            { key: 'neetprep', name: 'NEETprep', level: 6 }
        ];

        // Default selected sub-categories (all visible initially)
        let selectedPhysicsChemistrySubcategories = physicsChemistrySubCategoriesOrdered.map(cat => cat.key);
        let selectedChemistrySubcategories = physicsChemistrySubCategoriesOrdered.map(cat => cat.key);
        let selectedBiologySubcategories = biologySubCategoriesOrdered.map(cat => cat.key);

        // Your actual Firebase configuration (replace with your copied config from Firebase console)
        const firebaseConfig = {
          apiKey: "AIzaSyA29MM64OLCgKRfnl8tr-I39IIoBE-RLFM",
          authDomain: "my-neet-tracker-app.firebaseapp.com",
          projectId: "my-neet-tracker-app",
          storageBucket: "my-neet-tracker-app.firebasestorage.app",
          messagingSenderId: "931350823768",
          appId: "1:931350823768:web:b01f2325b8292d7dbd5b2d",
          measurementId: "G-3WEYVYQRYE", // Include if provided by Firebase
          experimentalForceLongPolling: true, // Add this line
          experimentalAutoDetectLongPolling: true // Add this line
        };

        // Use your Firebase project ID as the appId for Firestore paths
        const appId = firebaseConfig.projectId;

        // DOM Elements
        const loginPage = document.getElementById('login-page');
        const mainAppContent = document.getElementById('main-app-content');
        const loginQuoteDisplay = document.getElementById('login-quote');
        const googleSignInButton = document.getElementById('google-signin-button');

        const tabButtons = {
            regularData: document.getElementById('tabRegularData'),
            tests: document.getElementById('tabTests'),
            analytics: document.getElementById('tabAnalytics'),
            goals: document.getElementById('tabGoals'),
            aiSuggestions: document.getElementById('tabAISuggestions')
        };
        const tabContents = {
            regularData: document.getElementById('contentRegularData'),
            tests: document.getElementById('contentTests'),
            analytics: document.getElementById('contentAnalytics'),
            goals: document.getElementById('contentGoals'),
            aiSuggestions: document.getElementById('contentAISuggestions')
        };

        // NEW: Daily Routine Sub-tab Elements
        const dailyRoutineSubTabButtons = {
            today: document.getElementById('dailyRoutineSubTabToday'),
            upcoming: document.getElementById('dailyRoutineSubTabUpcoming'),
            backlogs: document.getElementById('dailyRoutineSubTabBacklogs'),
            completed: document.getElementById('dailyRoutineSubTabCompleted')
        };
        const dailyRoutineSubTabContents = {
            today: document.getElementById('dailyRoutineSubContentToday'),
            upcoming: document.getElementById('dailyRoutineSubContentUpcoming'),
            backlogs: document.getElementById('dailyRoutineSubContentBacklogs'),
            completed: document.getElementById('dailyRoutineSubContentCompleted')
        };
        const dailySummaryBlock = document.getElementById('dailySummaryBlock');
        const dailyLogDisplay = document.getElementById('dailyLogDisplay'); // For today's entries
        const upcomingPlansDisplay = document.getElementById('upcomingPlansDisplay');
        const backlogsDisplay = document.getElementById('backlogsDisplay');
        const completedTasksDisplay = document.getElementById('completedTasksDisplay');


        const testEntrySubTabButtons = {
            ut: document.getElementById('testEntrySubTabUT'),
            bbcts: document.getElementById('testEntrySubTabBBCTS'),
            quarterly: document.getElementById('testEntrySubTabQuarterly'),
            missionNeet: document.getElementById('testEntrySubTabMissionNeet')
        };
        const testEntrySubTabContents = {
            ut: document.getElementById('testEntrySubContentUT'),
            bbcts: document.getElementById('testEntrySubContentBBCTS'),
            quarterly: document.getElementById('testEntrySubContentQuarterly'),
            missionNeet: document.getElementById('testEntrySubContentMissionNeet')
        };

        const analyticsSubTabButtons = {
            ut: document.getElementById('subTabUT'),
            bbcts: document.getElementById('subTabBBCTS'),
            quarterly: document.getElementById('subTabQuarterly'),
            missionNeetAnalytics: document.getElementById('subTabMissionNeetAnalytics'),
            syllabusProgression: document.getElementById('subTabSyllabusProgression')
        };
        const analyticsSubTabContents = {
            ut: document.getElementById('subContentUT'),
            bbcts: document.getElementById('subContentBBCTS'),
            quarterly: document.getElementById('subContentQuarterly'),
            missionNeetAnalytics: document.getElementById('subContentMissionNeetAnalytics'),
            syllabusProgression: document.getElementById('subContentSyllabusProgression')
        };

        // Goals Sub-Tab Elements
        const goalsSubTabButtons = {
            physics: document.getElementById('goalsSubTabPhysics'),
            chemistry: document.getElementById('goalsSubTabChemistry'),
            biology: document.getElementById('goalsSubTabBiology')
        };
        const goalsSubTabContents = {
            physics: document.getElementById('goalsSubContentPhysics'),
            chemistry: document.getElementById('goalsSubContentChemistry'),
            biology: document.getElementById('goalsSubContentBiology')
        };
        const physicsGoalsDisplay = document.getElementById('physicsGoalsDisplay');
        const chemistryGoalsDisplay = document.getElementById('chemistryGoalsDisplay');
        const biologyGoalsDisplay = document.getElementById('biologyGoalsDisplay');
        const getAIGoalsInsightsButton = document.getElementById('getAIGoalsInsightsButton');
        const aiGoalsAnalysisDisplay = document.getElementById('aiGoalsAnalysisDisplay');
        const subcategoryControls = document.getElementById('subcategory-controls');
        const physicsChemistrySubcategoryCheckboxes = document.getElementById('physicsChemistrySubcategoryCheckboxes');
        const biologySubcategoryCheckboxes = document.getElementById('biologySubcategoryCheckboxes');


        // UT Test Entry Fields
        const utDateInput = document.getElementById('utDate');
        const utSyllabusInput = document.getElementById('utSyllabus');
        const utFullMarksInput = document.getElementById('utFullMarks');
        const utPhysicsScoreInput = document.getElementById('utPhysicsScore');
        const utChemistryScoreInput = document.getElementById('utChemistryScore');
        const utBiologyScoreInput = document.getElementById('utBiologyScore');
        const utMyMarksInput = document.getElementById('utMyMarks');
        const saveUTButton = document.getElementById('saveUTButton');
        const testsDataDisplay = document.getElementById('testsDataDisplay');

        // BBCTS Test Entry Fields
        const bbctsDateInput = document.getElementById('bbctsDate');
        const bbctsSyllabusInput = document.getElementById('bbctsSyllabus');
        const bbctsFullMarksInput = document.getElementById('bbctsFullMarks');
        const bbctsPhysicsScoreInput = document.getElementById('bbctsPhysicsScore');
        const bbctsChemistryScoreInput = document.getElementById('bbctsChemistryScore');
        const bbctsBiologyScoreInput = document.getElementById('bbctsBiologyScore');
        const bbctsMyMarksInput = document.getElementById('bbctsMyMarks');
        const saveBBCTSButton = document.getElementById('saveBBCTSButton');
        const bbctsDataDisplay = document.getElementById('bbctsDataDisplay');

        // Quarterly Test Entry Fields
        const qtDateInput = document.getElementById('qtDate');
        const qtSyllabusInput = document.getElementById('qtSyllabus');
        const qtFullMarksInput = document.getElementById('qtFullMarks');
        const qtPhysicsScoreInput = document.getElementById('qtPhysicsScore');
        const qtChemistryScoreInput = document.getElementById('qtChemistryScore');
        const qtBiologyScoreInput = document.getElementById('qtBiologyScore');
        const qtMyMarksInput = document.getElementById('qtMyMarks');
        const saveQuarterlyButton = document.getElementById('saveQuarterlyButton');
        const quarterlyDataDisplay = document.getElementById('quarterlyDataDisplay');

        // Mission NEET Test Entry Fields
        const mnDateInput = document.getElementById('mnDate');
        const mnSyllabusInput = document.getElementById('mnSyllabus');
        const mnFullMarksInput = document.getElementById('mnFullMarks');
        const mnScoreInput = document.getElementById('mnScore');
        const saveMissionNeetButton = document.getElementById('saveMissionNeetButton');
        const missionNeetDataDisplay = document.getElementById('missionNeetDataDisplay');

        // NEW: Daily Routine Input Fields
        const logDateInput = document.getElementById('logDate');
        const logSubjectSelect = document.getElementById('logSubject');
        const logBookSelect = document.getElementById('logBook');
        const logChapterSelect = document.getElementById('logChapter');
        const logTopicsContainer = document.getElementById('logTopics');
        const biologyTopicNote = document.getElementById('biologyTopicNote');
        const studyTypeTheory = document.getElementById('studyTypeTheory');
        const studyTypeMCQs = document.getElementById('studyTypeMCQs');
        const studyTypeRevision = document.getElementById('studyTypeRevision');
        const studyTypeNotes = document.getElementById('studyTypeNotes');
        const logMCQsCountInput = document.getElementById('logMCQsCount');
        const logMCQSourceSelect = document.getElementById('logMCQSource');
        const manualMCQSourceSection = document.getElementById('manualMCQSourceSection');
        const logManualMCQSourceNameInput = document.getElementById('logManualMCQSourceName');
        const manualMCQTimeSection = document.getElementById('manualMCQTimeSection');
        const logManualMCQTimeInput = document.getElementById('logManualMCQTime');
        const logTimeSpentInput = document.getElementById('logTimeSpent');
        const logCommentsInput = document.getElementById('logComments');
        const saveDailyLogButton = document.getElementById('saveDailyLogButton'); // Renamed from saveRegularDataButton

        // NEW: MCQ Quota Elements
        const physicsMCQQuotaChart = document.getElementById('physicsMCQQuotaChart');
        const chemistryMCQQuotaChart = document.getElementById('chemistryMCQQuotaChart');
        const biologyMCQQuotaChart = document.getElementById('biologyMCQQuotaChart');
        const physicsMCQQuotaValue = document.getElementById('physicsMCQQuotaValue');
        const chemistryMCQQuotaValue = document.getElementById('chemistryMCQQuotaValue');
        const biologyMCQQuotaValue = document.getElementById('biologyMCQQuotaValue');
        const aiMCQEmotionMessage = document.getElementById('aiMCQEmotionMessage');


        const getAIProductivityInsightsButton = document.getElementById('getAIProductivityInsightsButton');
        const aiProductivityAnalysisDisplay = document.getElementById('aiProductivityAnalysisDisplay');


        const analyticsCanvasPhysicsUT = document.getElementById('physicsChartUT');
        const analyticsCanvasChemistryUT = document.getElementById('chemistryChartUT');
        const analyticsCanvasBiologyUT = document.getElementById('biologyChartUT');

        const analyticsCanvasPhysicsBBCTS = document.getElementById('physicsChartBBCTS');
        const analyticsCanvasChemistryBBCTS = document.getElementById('chemistryChartBBCTS');
        const analyticsCanvasBiologyBBCTS = document.getElementById('biologyChartBBCTS');

        const analyticsCanvasPhysicsQuarterly = document.getElementById('physicsChartQuarterly');
        const analyticsCanvasChemistryQuarterly = document.getElementById('chemistryChartQuarterly');
        const analyticsCanvasBiologyQuarterly = document.getElementById('biologyChartBiologyQuarterly');

        const analyticsCanvasMissionNeet = document.getElementById('missionNeetChart');
        const syllabusProgressionCanvas = document.getElementById('syllabusProgressionChart');


        const getAIPerformanceInsightsButton = document.getElementById('getAIPerformanceInsightsButton');
        const aiPerformanceAnalysisDisplay = document.getElementById('aiPerformanceAnalysisDisplay');


        const getAISuggestionButton = document.getElementById('getAISuggestionButton');
        const aiPromptInput = document.getElementById('aiPromptInput');
        const aiResponseDisplay = document.getElementById('aiResponseDisplay');

        // Next Study Plan elements
        const getNextStudyPlanButton = document.getElementById('getNextStudyPlanButton');
        const nextStudyPlanDisplay = document.getElementById('nextStudyPlanDisplay');

        // Concept Explainer
        const conceptInput = document.getElementById('conceptInput');
        const explainConceptButton = document.getElementById('explainConceptButton');
        const conceptExplanationDisplay = document.getElementById('conceptExplanationDisplay');

        // Revision Topic Suggester
        const suggestRevisionTopicsButton = document.getElementById('suggestRevisionTopicsButton');
        const revisionSuggestionsDisplay = document.getElementById('revisionSuggestionsDisplay');

        // Mock Test Question Generator
        const questionSubjectSelect = document.getElementById('questionSubject');
        const questionTopicInput = document.getElementById('questionTopic');
        const generateQuestionsButton = document.getElementById('generateQuestionsButton');
        const generatedQuestionsDisplay = document.getElementById('generatedQuestionsDisplay');

        // NEW: Weakness Identification & Targeted Practice
        const identifyWeaknessesButton = document.getElementById('identifyWeaknessesButton');
        const weaknessAnalysisDisplay = document.getElementById('weaknessAnalysisDisplay');


        const userIdDisplay = document.getElementById('userIdDisplay');
        const countdownTimerDisplay = document.getElementById('countdown-timer');
        const motivationalQuoteDisplay = document.getElementById('motivational-quote');

        // Auth elements
        const signOutButton = document.getElementById('signOutButton');

        // NEW: Calendar Elements
        const calendarContainer = document.getElementById('calendar-container');
        const currentMonthYearDisplay = document.getElementById('currentMonthYear');
        const calendarGrid = document.getElementById('calendar-grid');
        const prevMonthButton = document.getElementById('prevMonth');
        const nextMonthButton = document.getElementById('nextMonth');

        // NEW: Upcoming Plans Elements
        const planDateInput = document.getElementById('planDate');
        const planSubjectSelect = document.getElementById('planSubject');
        const planChapterInput = document.getElementById('planChapter');
        const planStudyTypeInput = document.getElementById('planStudyType');
        const planEstimatedTimeInput = document.getElementById('planEstimatedTime');
        const savePlanButton = document.getElementById('savePlanButton');


        // --- Utility Functions ---

        /**
         * Displays a temporary status message to the user.
         * @param {string} message - The message to display.
         * @param {'success'|'error'|'info'} type - The type of message (for styling).
         */
        function showStatusMessage(message, type) {
            let statusDiv = document.querySelector('.status-message');
            if (!statusDiv) {
                statusDiv = document.createElement('div');
                statusDiv.classList.add('status-message');
                document.body.appendChild(statusDiv);
            }

            // Clear previous classes and set new ones
            statusDiv.className = 'status-message'; // Reset classes
            statusDiv.classList.add(type);
            statusDiv.textContent = message;

            // Show the message
            statusDiv.classList.add('show');

            // Hide after 3 seconds
            setTimeout(() => {
                statusDiv.classList.remove('show');
            }, 3000);
        }

        /**
         * Parses CSV text into an array of objects.
         * Assumes the first row is the header.
         * @param {string} csvText - The CSV data as a string.
         * @returns {Array<Object>} - An array of objects, where each object represents a row.
         */
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length === 0) return [];

            const headers = lines[0].split(',').map(header => header.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(value => value.trim());
                if (values.length !== headers.length) {
                    console.warn(`Skipping malformed row: ${lines[i]}`);
                    continue;
                }
                const rowObject = {};
                headers.forEach((header, index) => {
                    rowObject[header] = values[index];
                });
                data.push(rowObject);
            }
            return data;
        }

        /**
         * Generates a unique ID for log entries.
         */
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        // --- Firebase Initialization and Authentication ---

        /**
         * Handles user sign-out.
         */
        async function handleSignOut() {
            showStatusMessage("Signing out...", 'info');
            try {
                await signOut(auth);
                showStatusMessage("Signed out successfully!", 'success');
            } catch (error) {
                console.error("Error during sign out:", error);
                showStatusMessage("Sign out failed: " + error.message, 'error');
            }
        }

        /**
         * Handles Google Sign-In.
         */
        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            showStatusMessage("Signing in with Google...", 'info');
            try {
                await signInWithPopup(auth, provider);
                showStatusMessage("Google Sign-in successful!", 'success');
            } catch (error) {
                console.error("Error during Google sign-in:", error.code, error.message);
                let errorMessage = "Google Sign-in failed.";
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = "Sign-in cancelled. Please try again.";
                }
                showStatusMessage(errorMessage, 'error');
            }
                    errorMessage = "Sign-in window closed.";
                } else if (error.code === 'auth/cancelled-popup-request') {
                    errorMessage = "Sign-in already in progress.";
                }
                showStatusMessage(errorMessage, 'error');
            }
        }

        /**
         * Initializes Firebase and sets up authentication listener.
         */
        function initializeQuotaCharts() {
            // Clear any existing chart instances
            Object.values(mcqChartInstances).forEach(destroyChart);
            
            // Reset chart instances
            mcqChartInstances = {
                physics: null,
                chemistry: null,
                biology: null
            };

            // Initialize canvases
            ['physics', 'chemistry', 'biology'].forEach(subject => {
                const container = document.getElementById(`${subject}MCQQuotaChart`);
                if (container) {
                    // Remove any existing canvas
                    const existingCanvas = container.querySelector('canvas');
                    if (existingCanvas) {
                        container.removeChild(existingCanvas);
                    }
                    
                    // Create new canvas
                    const canvas = document.createElement('canvas');
                    canvas.id = `${subject}MCQQuotaCanvas`;
                    container.insertBefore(canvas, container.firstChild);
                    chartCanvases[subject] = canvas;
                }
            });
        }

        function destroyChart(chartInstance) {
            if (chartInstance && typeof chartInstance.destroy === 'function') {
                chartInstance.destroy();
            }
        }

        function drawCircularProgressChart(canvasElement, current, target, labelText, color, chartInstance) {
            if (!canvasElement) {
                console.warn('Canvas element not found');
                return null;
            }

            // Get the existing canvas or create a new one
            let canvas = canvasElement.querySelector('canvas');
            if (!canvas) {
                canvas = document.createElement('canvas');
                canvasElement.appendChild(canvas);
            }

            // Destroy existing chart instance if it exists
            destroyChart(chartInstance);
            
            const ctx = canvas.getContext('2d');

            const percentage = target > 0 ? (current / target) * 100 : 0;
            const dataValue = Math.min(percentage, 100);

            // Only try to update text if a valid label element was provided
            if (labelText) {
                const textElement = document.getElementById(labelText);
                if (textElement) {
                    textElement.textContent = `${current}/${target}`;
                }
            }

            const newChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [dataValue, 100 - dataValue],
                        backgroundColor: [color, '#e5e7eb'],
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '80%',
                    responsive: true,
                    maintainAspectRatio: true,
                    animation: {
                        duration: 1000
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                },
                plugins: [{
                    id: 'uniqueId',
                    beforeInit: (chart, args, options) => {
                        chart.id = `mcq-${labelText.toLowerCase()}`; // Set unique ID for each chart
                    }
                }]
            });

            // Update the text display if element exists
            const textElement = canvasElement.nextElementSibling;
            if (textElement) {
                textElement.textContent = `${current}/${target}`;
            }

            return newChartInstance;
        }

        function updateMCQQuotaCharts() {
            // Initialize charts if they haven't been initialized
            if (!chartCanvases.physics || !chartCanvases.chemistry || !chartCanvases.biology) {
                initializeQuotaCharts();
            }

            const today = currentDate;
            const todayLogs = regularDataLogs.filter(log => log.date === today);

            // Reset daily counts
            dailyMCQCount = {
                Physics: 0,
                Chemistry: 0,
                Biology: 0
            };

            // Calculate MCQ counts from today's logs
            todayLogs.forEach(log => {
                if (log.mcqCount && log.subject) {
                    dailyMCQCount[log.subject] += parseInt(log.mcqCount) || 0;
                }
            });

            // Update charts
            mcqChartInstances.physics = drawCircularProgressChart(
                chartCanvases.physics,
                dailyMCQCount.Physics,
                mcqQuotas.Physics,
                'Physics',
                '#3b82f6',
                mcqChartInstances.physics
            );

            mcqChartInstances.chemistry = drawCircularProgressChart(
                chartCanvases.chemistry,
                dailyMCQCount.Chemistry,
                mcqQuotas.Chemistry,
                'Chemistry',
                '#10b981',
                mcqChartInstances.chemistry
            );

            mcqChartInstances.biology = drawCircularProgressChart(
                chartCanvases.biology,
                dailyMCQCount.Biology,
                mcqQuotas.Biology,
                'Biology',
                '#f59e0b',
                mcqChartInstances.biology
            );

            updateAIMCQEmotionMessage();
        }

        window.addEventListener('load', () => {
            // Initialize selected categories
            selectedPhysicsChemistrySubcategories = physicsChemistrySubCategoriesOrdered.map(cat => cat.key);
            selectedChemistrySubcategories = physicsChemistrySubCategoriesOrdered.map(cat => cat.key);
            selectedBiologySubcategories = biologySubCategoriesOrdered.map(cat => cat.key);

            initializeFirebase();
            initializeQuotaCharts();
            loadSyllabusData();
            populateLogBookDropdown();
            populateLogChapterDropdown();
            populateLogMCQSourceDropdown();
            activateMainTab('regularData');
            updateMCQQuotaCharts();
        });

        async function initializeFirebase() {
            try {
                // Initialize Firebase with your config
                const firebaseConfig = {
                    apiKey: "AIzaSyA29MM64OLCgKRfnl8tr-I39IIoBE-RLFM",
                    authDomain: "my-neet-tracker-app.firebaseapp.com",
                    projectId: "my-neet-tracker-app",
                    storageBucket: "my-neet-tracker-app.appspot.com",
                    messagingSenderId: "931350823768",
                    appId: "1:931350823768:web:b01f2325b8292d7dbd5b2d"
                };

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Setup authentication state observer
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userEmail = user.email;
                        userIdDisplay.textContent = userEmail;
                        loginPage.style.display = 'none';
                        mainAppContent.style.display = 'block';
                        setupDataListeners();
                    } else {
                        userId = null;
                        userEmail = 'Not Logged In';
                        userIdDisplay.textContent = userEmail;
                        loginPage.style.display = 'flex';
                        mainAppContent.style.display = 'none';
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showStatusMessage("Failed to initialize Firebase: " + error.message, 'error');
                throw error; // Re-throw to handle at a higher level if needed
            }

                // Set up auth state listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userEmail = user.email;
                        userIdDisplay.textContent = userEmail;
                        loginPage.classList.add('hidden');
                        mainAppContent.classList.remove('hidden');
                        setupDataListeners();
                    } else {
                        userId = 'not-authenticated';
                        userEmail = 'Not Logged In';
                        userIdDisplay.textContent = userEmail;
                        loginPage.classList.remove('hidden');
                        mainAppContent.classList.add('hidden');
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showStatusMessage("Failed to initialize Firebase: " + error.message, 'error');
                throw error;
            }
                    if (user) {
                        // User is signed in.
                        userId = user.uid;
                        userEmail = user.email || 'N/A'; // Get email or set N/A
                        if (userIdDisplay) userIdDisplay.textContent = userEmail;

                        // Hide login page, show main app content
                        if (loginPage) loginPage.classList.add('hidden');
                        if (mainAppContent) mainAppContent.classList.remove('hidden');

                        console.log("User authenticated:", userId, userEmail);
                        setupDataListeners(); // Setup listeners only when a user is confirmed
                        displayRandomQuoteAndSave(); // Update main app quote
                        renderCalendar(); // Initial calendar render
                    } else {
                        // User is signed out.
                        userId = 'not-authenticated';
                        userEmail = 'Not Logged In';
                        if (userIdDisplay) userIdDisplay.textContent = userEmail;

                        // Show login page, hide main app content
                        if (loginPage) loginPage.classList.remove('hidden');
                        if (mainAppContent) mainAppContent.classList.add('hidden');

                        console.log("No user signed in.");
                        // Clear data displays and charts if user logs out
                        if (dailyLogDisplay) dailyLogDisplay.textContent = "Please log in to view your data.";
                        if (upcomingPlansDisplay) upcomingPlansDisplay.textContent = "Please log in to view your data.";
                        if (backlogsDisplay) backlogsDisplay.textContent = "Please log in to view your data.";
                        if (completedTasksDisplay) completedTasksDisplay.textContent = "Please log in to view your data.";
                        if (testsDataDisplay) testsDataDisplay.textContent = "Please log in to view your data.";
                        if (bbctsDataDisplay) bbctsDataDisplay.textContent = "Please log in to view your data.";
                        if (quarterlyDataDisplay) quarterlyDataDisplay.textContent = "Please log in to view your data.";
                        if (missionNeetDataDisplay) missionNeetDataDisplay.textContent = "Please log in to view your data.";
                        if (aiProductivityAnalysisDisplay) aiProductivityAnalysisDisplay.textContent = "Please log in to view AI analysis.";
                        if (aiPerformanceAnalysisDisplay) aiPerformanceAnalysisDisplay.textContent = "Please log in to view AI analysis.";
                        if (aiGoalsAnalysisDisplay) aiGoalsAnalysisDisplay.textContent = "Please log in to view AI analysis.";
                        if (aiResponseDisplay) aiResponseDisplay.textContent = "Please log in to get AI suggestions.";
                        if (nextStudyPlanDisplay) nextStudyPlanDisplay.textContent = "Please log in to get your next study plan.";
                        if (conceptExplanationDisplay) conceptExplanationDisplay.textContent = "Please log in to get concept explanations.";
                        if (revisionSuggestionsDisplay) revisionSuggestionsDisplay.textContent = "Please log in to get revision suggestions.";
                        if (generatedQuestionsDisplay) generatedQuestionsDisplay.textContent = "Please log in to generate questions.";
                        if (weaknessAnalysisDisplay) weaknessAnalysisDisplay.textContent = "Please log in to get weakness analysis.";

                        destroyChart(physicsChartUTInstance);
                        destroyChart(chemistryChartUTInstance);
                        destroyChart(biologyChartUTInstance);
                        destroyChart(physicsChartBBCTSInstance);
                        destroyChart(chemistryChartBBCTSInstance);
                        destroyChart(biologyChartBBCTSInstance);
                        destroyChart(physicsChartQuarterlyInstance);
                        destroyChart(chemistryChartQuarterlyInstance);
                        destroyChart(biologyChartQuarterlyInstance);
                        destroyChart(missionNeetChartInstance);
                        destroyChart(syllabusProgressionChartInstance);
                        destroyChart(physicsMCQChartInstance); // NEW
                        destroyChart(chemistryMCQChartInstance); // NEW
                        destroyChart(biologyMCQChartInstance); // NEW

                        // Set a random quote for the login page
                        displayRandomLoginQuote();
                        renderCalendar(); // Render calendar without user data
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showStatusMessage("Error loading app. Please check console for details.", 'error');
                if (userIdDisplay) userIdDisplay.textContent = "Error";
                // Still show login page even if Firebase init fails, but with error message
                if (loginPage) loginPage.classList.remove('hidden');
                if (mainAppContent) mainAppContent.classList.add('hidden');
            }
        }

        /**
         * Sets up real-time listeners for different data types in Firestore.
         */
        function setupDataListeners() {
            if (!db || !userId || userId === 'loading' || userId === 'not-authenticated') {
                console.warn("Waiting for authentication...");
                return;
            }

            // Initialize selected categories
            if (typeof selectedPhysicsChemistrySubcategories === 'undefined') {
                selectedPhysicsChemistrySubcategories = physicsChemistrySubCategoriesOrdered.map(cat => cat.key);
            }
            if (typeof selectedChemistrySubcategories === 'undefined') {
                selectedChemistrySubcategories = physicsChemistrySubCategoriesOrdered.map(cat => cat.key);
            }
            if (typeof selectedBiologySubcategories === 'undefined') {
                selectedBiologySubcategories = biologySubCategoriesOrdered.map(cat => cat.key);
            }

            // Initialize empty arrays for all data types
            regularDataLogs = [];
            upcomingPlans = [];
            completedTasks = [];
            utTestData = [];
            bbctsData = [];
            quarterlyData = [];
            missionNeetData = [];
            chapterStatus = {};

            // Initialize selected categories
            selectedPhysicsChemistrySubcategories = physicsChemistrySubCategoriesOrdered.map(cat => cat.key);
            selectedChemistrySubcategories = physicsChemistrySubCategoriesOrdered.map(cat => cat.key);
            selectedBiologySubcategories = biologySubCategoriesOrdered.map(cat => cat.key);
                console.warn("Firestore not initialized or user not authenticated. Cannot set up data listeners.");
                return;
            }

            // Listener for Regular Daily Logs
            const regularDocRef = doc(db, `artifacts/${appId}/users/${userId}/dailyRoutine`, 'dailyLogs');
            onSnapshot(regularDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    try {
                        regularDataLogs = JSON.parse(data.content || "[]");
                        // Filter and display logs for "Today" tab
                        displayDailyLogsForDate(currentDate);
                        updateDailySummary();
                        updateMCQQuotaCharts();
                        renderCalendar(); // Update calendar with latest log data
                    } catch (e) {
                        console.error("Error parsing regular daily logs from Firestore:", e);
                        if (dailyLogDisplay) dailyLogDisplay.textContent = "Error: Stored regular data is not valid JSON.";
                        regularDataLogs = [];
                    }
                    console.log("Regular daily logs loaded from Firestore:", regularDataLogs);
                } else {
                    regularDataLogs = [];
                    displayDailyLogsForDate(currentDate);
                    updateDailySummary();
                    updateMCQQuotaCharts();
                    renderCalendar(); // Update calendar
                    console.log("No regular daily logs document found.");
                }
            }, (error) => {
                console.error("Error listening to regular daily logs document:", error);
                if (dailyLogDisplay) dailyLogDisplay.textContent = "Error loading regular data. Please check console.";
            });

            // NEW: Listener for Upcoming Plans
            const upcomingDocRef = doc(db, `artifacts/${appId}/users/${userId}/dailyRoutine`, 'upcomingPlans');
            onSnapshot(upcomingDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    try {
                        upcomingPlans = JSON.parse(data.content || "[]");
                        renderUpcomingPlans();
                        updateBacklogs(); // Recalculate backlogs when upcoming plans change
                        updateDailySummary();
                        renderCalendar(); // Update calendar with upcoming plans
                    } catch (e) {
                        console.error("Error parsing upcoming plans from Firestore:", e);
                        if (upcomingPlansDisplay) upcomingPlansDisplay.textContent = "Error: Stored upcoming plans are not valid JSON.";
                        upcomingPlans = [];
                    }
                    console.log("Upcoming plans loaded from Firestore:", upcomingPlans);
                } else {
                    upcomingPlans = [];
                    renderUpcomingPlans();
                    updateBacklogs();
                    updateDailySummary();
                    renderCalendar();
                    console.log("No upcoming plans document found.");
                }
            }, (error) => {
                console.error("Error listening to upcoming plans document:", error);
                if (upcomingPlansDisplay) upcomingPlansDisplay.textContent = "Error loading upcoming plans. Please check console.";
            });

            // NEW: Listener for Completed Tasks
            const completedDocRef = doc(db, `artifacts/${appId}/users/${userId}/dailyRoutine`, 'completedTasks');
            onSnapshot(completedDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    try {
                        completedTasks = JSON.parse(data.content || "[]");
                        renderCompletedTasks();
                        updateDailySummary();
                        renderCalendar(); // Update calendar for completed tasks
                    } catch (e) {
                        console.error("Error parsing completed tasks from Firestore:", e);
                        if (completedTasksDisplay) completedTasksDisplay.textContent = "Error: Stored completed tasks are not valid JSON.";
                        completedTasks = [];
                    }
                    console.log("Completed tasks loaded from Firestore:", completedTasks);
                } else {
                    completedTasks = [];
                    renderCompletedTasks();
                    updateDailySummary();
                    renderCalendar();
                    console.log("No completed tasks document found.");
                }
            }, (error) => {
                console.error("Error listening to completed tasks document:", error);
                if (completedTasksDisplay) completedTasksDisplay.textContent = "Error loading completed tasks. Please check console.";
            });


            // Listener for Tests Data (UT)
            const testsDocRef = doc(db, `artifacts/${appId}/users/${userId}/testData`, 'myTestDocument');
            onSnapshot(testsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    try {
                        utTestData = JSON.parse(data.content || "[]");
                        if (testsDataDisplay) testsDataDisplay.textContent = JSON.stringify(utTestData, null, 2); // Pretty print JSON
                    } catch (e) {
                        console.error("Error parsing UT test data from Firestore:", e);
                        if (testsDataDisplay) testsDataDisplay.textContent = "Error: Stored UT data is not valid JSON.";
                        utTestData = []; // Reset to empty array on parse error
                    }
                    console.log("Tests data loaded from Firestore:", utTestData);
                    // Automatically update graphs if analytics tab is active and UT sub-tab is active
                    if (tabContents.analytics && tabContents.analytics.classList.contains('active') && analyticsSubTabContents.ut && analyticsSubTabContents.ut.classList.contains('active')) {
                        drawAllCharts();
                    }
                } else {
                    utTestData = [];
                    if (testsDataDisplay) testsDataDisplay.textContent = "No Unit Tests data stored yet.";
                    console.log("No tests data document found.");
                }
            }, (error) => {
                console.error("Error listening to tests data document:", error);
                if (testsDataDisplay) testsDataDisplay.textContent = "Error loading tests data. Please check console.";
            });

            // Listener for BBCTS Data
            const bbctsDocRef = doc(db, `artifacts/${appId}/users/${userId}/bbctsData`, 'myBBCTSDocument');
            onSnapshot(bbctsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    try {
                        bbctsData = JSON.parse(data.content || "[]");
                        if (bbctsDataDisplay) bbctsDataDisplay.textContent = JSON.stringify(bbctsData, null, 2);
                    } catch (e) {
                        console.error("Error parsing BBCTS data from Firestore:", e);
                        if (bbctsDataDisplay) bbctsDataDisplay.textContent = "Error: Stored BBCTS data is not valid JSON.";
                        bbctsData = [];
                    }
                    console.log("BBCTS data loaded from Firestore:", bbctsData);
                    // Automatically update graphs if analytics tab is active and BBCTS sub-tab is active
                    if (tabContents.analytics && tabContents.analytics.classList.contains('active') && analyticsSubTabContents.bbcts && analyticsSubTabContents.bbcts.classList.contains('active')) {
                        drawAllCharts();
                    }
                } else {
                    bbctsData = [];
                    if (bbctsDataDisplay) bbctsDataDisplay.textContent = "No BB Classes Test Series data stored yet.";
                    console.log("No BBCTS data document found.");
                }
            }, (error) => {
                console.error("Error listening to BBCTS data document:", error);
                if (bbctsDataDisplay) bbctsDataDisplay.textContent = "Error loading BBCTS data. Please check console.";
            });

            // Listener for Quarterly Data
            const quarterlyDocRef = doc(db, `artifacts/${appId}/users/${userId}/quarterlyData`, 'myQuarterlyDocument');
            onSnapshot(quarterlyDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    try {
                        quarterlyData = JSON.parse(data.content || "[]");
                        if (quarterlyDataDisplay) quarterlyDataDisplay.textContent = JSON.stringify(quarterlyData, null, 2);
                    } catch (e) {
                        console.error("Error parsing Quarterly data from Firestore:", e);
                        if (quarterlyDataDisplay) quarterlyDataDisplay.textContent = "Error: Stored Quarterly data is not valid JSON.";
                        quarterlyData = [];
                    }
                    console.log("Quarterly data loaded from Firestore:", quarterlyData);
                    // Automatically update graphs if analytics tab is active and Quarterly sub-tab is active
                    if (tabContents.analytics && tabContents.analytics.classList.contains('active') && analyticsSubTabContents.quarterly && analyticsSubTabContents.quarterly.classList.contains('active')) {
                        drawAllCharts();
                    }
                } else {
                    quarterlyData = [];
                    if (quarterlyDataDisplay) quarterlyDataDisplay.textContent = "No Quarterly Tests data stored yet.";
                    console.log("No Quarterly data document found.");
                }
            }, (error) => {
                console.error("Error listening to Quarterly data document:", error);
                if (quarterlyDataDisplay) quarterlyDataDisplay.textContent = "Error loading Quarterly data. Please check console.";
            });

            // Listener for Mission NEET Data
            const missionNeetDocRef = doc(db, `artifacts/${appId}/users/${userId}/missionNeetData`, 'myMissionNeetDocument');
            onSnapshot(missionNeetDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    try {
                        missionNeetData = JSON.parse(data.content || "[]");
                        if (missionNeetDataDisplay) missionNeetDataDisplay.textContent = JSON.stringify(missionNeetData, null, 2); // Pretty print JSON
                    } catch (e) {
                        console.error("Error parsing Mission NEET data from Firestore:", e);
                        if (missionNeetDataDisplay) missionNeetDataDisplay.textContent = "Error: Stored Mission NEET data is not valid JSON.";
                        missionNeetData = []; // Reset to empty array on parse error
                    }
                    console.log("Mission NEET data loaded from Firestore:", missionNeetData);
                    // Automatically update graphs if analytics tab is active and Mission NEET sub-tab is active
                    if (tabContents.analytics && tabContents.analytics.classList.contains('active') && analyticsSubTabContents.missionNeetAnalytics && analyticsSubTabContents.missionNeetAnalytics.classList.contains('active')) {
                        drawAllCharts();
                    }
                } else {
                    missionNeetData = [];
                    if (missionNeetDataDisplay) missionNeetDataDisplay.textContent = "No Mission NEET Tests data stored yet.";
                    console.log("No Mission NEET data document found.");
                }
            }, (error) => {
                console.error("Error listening to Mission NEET data document:", error);
                if (missionNeetDataDisplay) missionNeetDataDisplay.textContent = "Error loading Mission NEET data. Please check console.";
            });

            // Listener for Quote State (to persist daily quote)
            const quoteStateDocRef = doc(db, `artifacts/${appId}/users/${userId}/appState`, 'quoteState');
            onSnapshot(quoteStateDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const today = new Date().toISOString().split('T')[0];
                    if (data.lastQuoteDate === today) {
                        if (motivationalQuoteDisplay) motivationalQuoteDisplay.textContent = `"${motivationalQuotes[data.lastQuoteIndex]}"`;
                    } else {
                        // If date is different, pick a new quote and update Firestore
                        displayRandomQuoteAndSave();
                    }
                } else {
                    // No quote state found, set initial quote
                    displayRandomQuoteAndSave();
                }
            }, (error) => {
                console.error("Error listening to quote state document:", error);
                // Fallback to random quote without persistence
                displayRandomQuoteAndSave();
            });

            // Listener for Chapter Status (isCompleted)
            const chapterStatusDocRef = doc(db, `artifacts/${appId}/users/${userId}/appState`, 'chapterStatus');
            onSnapshot(chapterStatusDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    try {
                        chapterStatus = JSON.parse(data.content || "{}");
                        // Re-render goals chapters to reflect updated status
                        renderGoalsChapters('physics');
                        renderGoalsChapters('chemistry');
                        renderGoalsChapters('biology');
                        // Redraw syllabus progression chart
                        if (tabContents.analytics && tabContents.analytics.classList.contains('active') && analyticsSubTabContents.syllabusProgression && analyticsSubTabContents.syllabusProgression.classList.contains('active')) {
                            drawSyllabusProgressionChart();
                        }
                    } catch (e) {
                        console.error("Error parsing chapter status from Firestore:", e);
                        chapterStatus = {};
                    }
                    console.log("Chapter status loaded from Firestore:", chapterStatus);
                } else {
                    chapterStatus = {};
                    console.log("No chapter status document found.");
                }
            }, (error) => {
                console.error("Error listening to chapter status document:", error);
            });
        }

        // --- Data Saving Functions ---

        /**
         * Saves a general data array to a specified Firestore path.
         * @param {string} collectionName - The name of the sub-collection (e.g., 'dailyRoutine').
         * @param {string} docName - The document ID (e.g., 'dailyLogs', 'upcomingPlans').
         * @param {Array<Object>} dataArray - The array of data to save.
         * @param {string} successMessage - Message on success.
         * @param {string} errorMessage - Message on error.
         */
        async function saveDataToFirestore(collectionName, docName, dataArray, successMessage, errorMessage) {
            if (userId === 'not-authenticated') {
                showStatusMessage("Please sign in to save your data.", 'error');
                return false;
            }
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/${collectionName}`, docName);
            try {
                await setDoc(docRef, { content: JSON.stringify(dataArray) });
                console.log(successMessage);
                showStatusMessage(successMessage, 'success');
                return true;
            } catch (error) {
                console.error(errorMessage, error);
                showStatusMessage(errorMessage, 'error');
                return false;
            }
        }


        /**
         * Saves the daily log entry to Firestore.
         */
        async function saveDailyLog() {
            if (userId === 'not-authenticated') {
                showStatusMessage("Please sign in to save your daily log data.", 'error');
                return;
            }

            const selectedStudyTypes = Array.from(document.querySelectorAll('#dailyRoutineSubContentToday input[type="checkbox"]:checked'))
                                         .map(checkbox => checkbox.value);

            const selectedTopics = Array.from(logTopicsContainer.querySelectorAll('input[type="checkbox"]:checked'))
                                       .map(checkbox => checkbox.value);

            let mcqSource = logMCQSourceSelect.value;
            let mcqSourceName = '';
            let mcqSourceTime = '';

            if (mcqSource === 'Custom') {
                mcqSourceName = logManualMCQSourceNameInput.value.trim();
                mcqSourceTime = logManualMCQTimeInput.value.trim();
            }

            const newLogEntry = {
                id: generateUniqueId(), // NEW: Unique ID for each log
                date: logDateInput.value || currentDate, // Use current date if not provided
                subject: logSubjectSelect.value || '',
                book: logBookSelect.value || '',
                chapter: logChapterSelect.value || '',
                topics: selectedTopics, // Array of selected topics
                studyTypes: selectedStudyTypes, // Array of selected study types
                mcqCount: parseInt(logMCQsCountInput.value) || 0,
                mcqSource: mcqSource,
                mcqSourceName: mcqSourceName,
                mcqSourceTime: mcqSourceTime,
                timeSpent: logTimeSpentInput.value.trim() || '',
                comments: logCommentsInput.value.trim() || '',
                isCompleted: true // Daily logs are assumed completed upon entry
            };

            // Don't save empty logs if no data is provided
            if (!newLogEntry.subject && !newLogEntry.chapter && newLogEntry.mcqCount === 0 && !newLogEntry.timeSpent && !newLogEntry.comments) {
                showStatusMessage("Please enter some study details before saving.", 'error');
                return;
            }

            const updatedLogs = [...regularDataLogs, newLogEntry];

            const success = await saveDataToFirestore(
                'dailyRoutine', 'dailyLogs', updatedLogs,
                "Daily log saved successfully!", "Error saving daily log."
            );

            if (success) {
                // Clear input fields after saving, except date
                logSubjectSelect.value = '';
                logBookSelect.value = '';
                logChapterSelect.value = '';
                logTopicsContainer.innerHTML = '';
                logTopicsContainer.classList.add('hidden');
                biologyTopicNote.classList.add('hidden');
                Array.from(document.querySelectorAll('#dailyRoutineSubContentToday input[type="checkbox"]:checked')).forEach(cb => cb.checked = false);
                logMCQsCountInput.value = '';
                logMCQSourceSelect.value = '';
                manualMCQSourceSection.style.display = 'none';
                logManualMCQSourceNameInput.value = '';
                manualMCQTimeSection.style.display = 'none';
                logManualMCQTimeInput.value = '';
                logTimeSpentInput.value = '';
                logCommentsInput.value = '';

                // Update date to today's date if it was cleared
                logDateInput.value = new Date().toISOString().split('T')[0];

                // Auto-mark topics/chapters in Goals tab
                if (newLogEntry.subject && newLogEntry.chapter && newLogEntry.book) {
                    const subjectKey = newLogEntry.subject.toLowerCase();
                    const baseChapterKey = `${subjectKey}-${newLogEntry.chapter.replace(/\s|\(|\)/g, '_').replace(/_+/g, '_').toLowerCase()}`;

                    if (newLogEntry.topics && newLogEntry.topics.length > 0) {
                        newLogEntry.topics.forEach(topic => {
                            const topicKey = `${baseChapterKey}-${topic.replace(/\s|\(|\)/g, '_').replace(/_+/g, '_').toLowerCase()}`;
                            markChapterTopicAsCompleted(baseChapterKey, topicKey, newLogEntry.subject, newLogEntry.chapter, topic, newLogEntry.book);
                        });
                    } else if (newLogEntry.subject === 'Biology') {
                        // For biology, the "topic" is the chapter itself
                        const chapterAsTopicKey = `${baseChapterKey}-${baseChapterKey}`;
                        markChapterTopicAsCompleted(baseChapterKey, chapterAsTopicKey, newLogEntry.subject, newLogEntry.chapter, null, newLogEntry.book);
                    }
                }
            }
        }

        async function markDailyLogEntryAsCompleted(logId) {
            const index = regularDataLogs.findIndex(log => log.id === logId);
            if (index !== -1) {
                if (regularDataLogs[index].isCompleted) {
                    showStatusMessage("Log entry is already marked as completed.", "info");
                    return;
                }
                regularDataLogs[index].isCompleted = true;
                const success = await saveDataToFirestore(
                    'dailyRoutine', 'dailyLogs', regularDataLogs,
                    "Daily log entry marked as completed!", "Error marking log entry as completed."
                );
                if (success) {
                    // Mark associated goals as completed
                    const logEntry = regularDataLogs[index];
                    if (logEntry.isCompleted && logEntry.subject && logEntry.chapter && logEntry.book) {
                        const baseChapterKey = `${logEntry.subject.toLowerCase()}-${logEntry.chapter.replace(/\s|\(|\)/g, '_').replace(/_+/g, '_').toLowerCase()}`;
                        if (logEntry.topics && logEntry.topics.length > 0) {
                            logEntry.topics.forEach(topic => {
                                const fullTopicKey = `${baseChapterKey}-${topic.replace(/\s|\(|\)/g, '_').replace(/_+/g, '_').toLowerCase()}`;
                                // Call the function to automatically update the goal
                                markChapterTopicAsCompleted(baseChapterKey, fullTopicKey, logEntry.subject, logEntry.chapter, topic, logEntry.book);
                            });
                        } else if (logEntry.subject === 'Biology') {
                            // For biology chapters (no topics), use the chapter itself as the topic
                            const fullTopicKey = baseChapterKey;
                            markChapterTopicAsCompleted(baseChapterKey, fullTopicKey, logEntry.subject, logEntry.chapter, null, logEntry.book);
                        }
                    }
                }
            }
        }

        async function deleteDailyLogEntry(logId) {
            const updatedLogs = regularDataLogs.filter(log => log.id !== logId);
            const success = await saveDataToFirestore(
                'dailyRoutine', 'dailyLogs', updatedLogs,
                "Daily log entry deleted!", "Error deleting log entry."
            );
            if (success) {
                // Update display and summary after deletion
                displayDailyLogsForDate(logDateInput.value || currentDate);
                updateDailySummary();
                updateMCQQuotaCharts();
                renderCalendar();
            }
        }


        /**
         * Saves the Unit Test data from the input fields to Firestore.
         */
        async function saveUTData() {
            const newUTEntry = {
                date: utDateInput.value || '',
                syllabus: utSyllabusInput.value || '',
                fullMarks: parseFloat(utFullMarksInput.value) || 0,
                physicsScore: parseFloat(utPhysicsScoreInput.value) || 0,
                chemistryScore: parseFloat(utChemistryScoreInput.value) || 0,
                biologyScore: parseFloat(utBiologyScoreInput.value) || 0,
                myMarks: parseFloat(utMyMarksInput.value) || 0
            };

            const updatedUTData = [...utTestData, newUTEntry];
            const success = await saveDataToFirestore(
                'testData', 'myTestDocument', updatedUTData,
                "Unit Test data saved successfully!", "Error saving Unit Test data."
            );
            if (success) {
                if (utDateInput) utDateInput.value = new Date().toISOString().split('T')[0];
                if (utSyllabusInput) utSyllabusInput.value = '';
                if (utFullMarksInput) utFullMarksInput.value = '';
                if (utPhysicsScoreInput) utPhysicsScoreInput.value = '';
                if (utChemistryScoreInput) utChemistryScoreInput.value = '';
                if (utBiologyScoreInput) utBiologyScoreInput.value = '';
                if (utMyMarksInput) utMyMarksInput.value = '';
            }
        }


        /**
         * Saves the BBCTS data from the input fields to Firestore.
         */
        async function saveBBCTSData() {
            const newBBCTSEntry = {
                date: bbctsDateInput.value || '',
                syllabus: bbctsSyllabusInput.value || '',
                fullMarks: parseFloat(bbctsFullMarksInput.value) || 0,
                physicsScore: parseFloat(bbctsPhysicsScoreInput.value) || 0,
                chemistryScore: parseFloat(bbctsChemistryScoreInput.value) || 0,
                biologyScore: parseFloat(bbctsBiologyScoreInput.value) || 0,
                myMarks: parseFloat(bbctsMyMarksInput.value) || 0
            };

            const updatedBBCTSData = [...bbctsData, newBBCTSEntry];
            const success = await saveDataToFirestore(
                'bbctsData', 'myBBCTSDocument', updatedBBCTSData,
                "BB Classes Test Series data saved successfully!", "Error saving BB Classes Test Series data."
            );
            if (success) {
                if (bbctsDateInput) bbctsDateInput.value = new Date().toISOString().split('T')[0];
                if (bbctsSyllabusInput) bbctsSyllabusInput.value = '';
                if (bbctsFullMarksInput) bbctsFullMarksInput.value = '';
                if (bbctsPhysicsScoreInput) bbctsPhysicsScoreInput.value = '';
                if (bbctsChemistryScoreInput) bbctsChemistryScoreInput.value = '';
                if (bbctsBiologyScoreInput) bbctsBiologyScoreInput.value = '';
                if (bbctsMyMarksInput) bbctsMyMarksInput.value = '';
            }
        }

        /**
         * Saves the Quarterly data from the input fields to Firestore.
         */
        async function saveQuarterlyData() {
            const newQTEntry = {
                date: qtDateInput.value || '',
                syllabus: qtSyllabusInput.value || '',
                fullMarks: parseFloat(qtFullMarksInput.value) || 0,
                physicsScore: parseFloat(qtPhysicsScoreInput.value) || 0,
                chemistryScore: parseFloat(qtChemistryScoreInput.value) || 0,
                biologyScore: parseFloat(qtBiologyScoreInput.value) || 0,
                myMarks: parseFloat(qtMyMarksInput.value) || 0
            };

            const updatedQTData = [...quarterlyData, newQTEntry];
            const success = await saveDataToFirestore(
                'quarterlyData', 'myQuarterlyDocument', updatedQTData,
                "Quarterly Tests data saved successfully!", "Error saving Quarterly Tests data."
            );
            if (success) {
                if (qtDateInput) qtDateInput.value = new Date().toISOString().split('T')[0];
                if (qtSyllabusInput) qtSyllabusInput.value = '';
                if (qtFullMarksInput) qtFullMarksInput.value = '';
                if (qtPhysicsScoreInput) qtPhysicsScoreInput.value = '';
                if (qtChemistryScoreInput) qtChemistryScoreInput.value = '';
                if (qtBiologyScoreInput) qtBiologyScoreInput.value = '';
                if (qtMyMarksInput) qtMyMarksInput.value = '';
            }
        }

        /**
         * Saves the Mission NEET data from the input fields to Firestore.
         */
        async function saveMissionNeetData() {
            const newMNEntry = {
                date: mnDateInput.value || '',
                syllabus: mnSyllabusInput.value || '',
                fullMarks: parseFloat(mnFullMarksInput.value) || 0,
                score: parseFloat(mnScoreInput.value) || 0
            };

            const updatedMNData = [...missionNeetData, newMNEntry];
            const success = await saveDataToFirestore(
                'missionNeetData', 'myMissionNeetDocument', updatedMNData,
                "Mission NEET Tests data saved successfully!", "Error saving Mission NEET Tests data."
            );
            if (success) {
                if (mnDateInput) mnDateInput.value = new Date().toISOString().split('T')[0];
                if (mnSyllabusInput) mnSyllabusInput.value = '';
                if (mnFullMarksInput) mnFullMarksInput.value = '';
                if (mnScoreInput) mnScoreInput.value = '';
            }
        }

        /**
         * Saves an upcoming plan to Firestore.
         */
        async function saveUpcomingPlan() {
            const newPlanEntry = {
                id: generateUniqueId(),
                date: planDateInput.value || '',
                subject: planSubjectSelect.value || '',
                chapter: planChapterInput.value.trim() || '',
                studyType: planStudyTypeInput.value.trim() || '',
                estimatedTime: planEstimatedTimeInput.value.trim() || '',
                isCompleted: false, // Plans start as not completed
                isBacklog: false // Initially not a backlog
            };

            if (!newPlanEntry.date || !newPlanEntry.subject || !newPlanEntry.chapter) {
                showStatusMessage("Please fill at least date, subject, and chapter/topic for your plan.", 'error');
                return;
            }

            const updatedPlans = [...upcomingPlans, newPlanEntry];
            const success = await saveDataToFirestore(
                'dailyRoutine', 'upcomingPlans', updatedPlans,
                "Upcoming plan saved successfully!", "Error saving upcoming plan."
            );
            if (success) {
                planDateInput.value = '';
                planSubjectSelect.value = '';
                planChapterInput.value = '';
                planStudyTypeInput.value = '';
                planEstimatedTimeInput.value = '';
            }
        }

        /**
         * Marks an upcoming plan as completed and moves it to completed tasks.
         * @param {string} planId
         */
        async function markUpcomingPlanCompleted(planId) {
            const index = upcomingPlans.findIndex(plan => plan.id === planId);
            if (index !== -1) {
                const completedPlan = { ...upcomingPlans[index], isCompleted: true, completionDate: currentDate };

                // Remove from upcoming plans
                const newUpcomingPlans = upcomingPlans.filter(plan => plan.id !== planId);
                const successUpcoming = await saveDataToFirestore(
                    'dailyRoutine', 'upcomingPlans', newUpcomingPlans,
                    "Plan marked completed!", "Error updating upcoming plans."
                );

                if (successUpcoming) {
                    // Add to completed tasks
                    const newCompletedTasks = [...completedTasks, completedPlan];
                    await saveDataToFirestore(
                        'dailyRoutine', 'completedTasks', newCompletedTasks,
                        "Task moved to completed!", "Error moving task to completed."
                    );
                }
            }
        }

        /**
         * Reschedules a backlog item to a new date.
         * @param {string} planId
         * @param {string} newDate
         * @param {string} comment
         */
        async function rescheduleBacklog(planId, newDate, comment) {
            const index = upcomingPlans.findIndex(plan => plan.id === planId);
            if (index !== -1) {
                upcomingPlans[index].date = newDate;
                upcomingPlans[index].comments = comment; // Add comment to the plan
                upcomingPlans[index].isBacklog = false; // Reset backlog status
                const success = await saveDataToFirestore(
                    'dailyRoutine', 'upcomingPlans', upcomingPlans,
                    "Backlog rescheduled!", "Error rescheduling backlog."
                );
                if (success) {
                    renderUpcomingPlans(); // Re-render to show updated plan
                    updateBacklogs(); // Recalculate and re-render backlogs
                    renderCalendar(); // Update calendar
                }
            }
        }


        /**
         * Saves the chapter status (isCompleted) to Firestore.
         */
        async function saveChapterStatus() {
            if (userId === 'not-authenticated') {
                showStatusMessage("Please sign in to save your chapter progress.", 'error');
                return;
            }
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/appState`, 'chapterStatus');
            try {
                await setDoc(docRef, { content: JSON.stringify(chapterStatus) });
                console.log("Chapter status saved to Firestore.");
                showStatusMessage("Chapter status updated!", 'success');
                // Re-draw syllabus progression chart after status update
                if (tabContents.analytics && tabContents.analytics.classList.contains('active') && analyticsSubTabContents.syllabusProgression && analyticsSubTabContents.syllabusProgression.classList.contains('active')) {
                    drawSyllabusProgressionChart();
                }
            } catch (error) {
                console.error("Error saving chapter status:", error);
                showStatusMessage("Error saving chapter status. Please try again.", 'error');
            }
        }

        /**
         * Marks a chapter/topic as completed in the global `chapterStatus` and saves to Firestore.
         * @param {string} chapterKey - The unique key for the chapter.
         * @param {string} topicKey - The unique key for the topic (can be same as chapterKey for Biology chapters).
         * @param {string} subjectName - Name of the subject.
         * @param {string} chapterName - Name of the chapter.
         * @param {string|null} topicName - Name of the topic, or null for biology chapters.
         */
        async function markChapterTopicAsCompleted(chapterKey, topicKey, subjectName, chapterName, topicName) {
            if (!chapterStatus[chapterKey]) chapterStatus[chapterKey] = {};
            if (!chapterStatus[chapterKey][topicKey]) {
                chapterStatus[chapterKey][topicKey] = { isCompleted: false, completionDate: null, aiMessage: '' };
            }

            if (chapterStatus[chapterKey][topicKey].isCompleted) {
                console.log(`Topic/Chapter ${topicKey} already marked as completed.`);
                return; // Already completed, no need to do anything
            }

            const currentSubCategoryLevel = (subjectName === 'Physics' || subjectName === 'Chemistry')
                                            ? physicsChemistrySubCategoriesOrdered.find(c => c.key === logBookSelect.value)?.level || 0
                                            : biologySubCategoriesOrdered.find(c => c.key === logBookSelect.value)?.level || 0;

            try {
                let prompt;
                if (topicName) {
                    prompt = `Generate a very short, encouraging 'done' message (max 10 words) with a celebratory emoji for completing the "${topicName}" topic within the chapter "${chapterName}" for "${subjectName}". Example: "Awesome work! ${topicName} mastered! 🎉"`;
                } else { // For Biology chapters (no topics)
                    prompt = `Generate a very short, encouraging 'done' message (max 10 words) with a celebratory emoji for completing the chapter "${chapterName}" for "${subjectName}". Example: "Fantastic! ${chapterName} done! 🚀"`;
                }

                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = firebaseConfig.apiKey; // Use your Firebase API key for Gemini

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                let aiMessage = '✔';
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    aiMessage = result.candidates[0].content.parts[0].text;
                }

                chapterStatus[chapterKey][topicKey] = {
                    isCompleted: true,
                    completionDate: new Date().toISOString().split('T')[0],
                    aiMessage: aiMessage
                };
                showStatusMessage("Syllabus progress updated!", 'success');
            } catch (error) {
                console.error("Error generating AI message for chapter completion:", error);
                chapterStatus[chapterKey][topicKey] = {
                    isCompleted: true,
                    completionDate: new Date().toISOString().split('T')[0],
                    aiMessage: '✔'
                };
                showStatusMessage("Syllabus progress updated (AI message failed).", 'error');
            } finally {
                saveChapterStatus(); // Save the updated status to Firestore
                renderGoalsChapters(subjectName.toLowerCase()); // Re-render the goals section
            }
        }


        // --- Tab Switching Logic ---

        /**
         * Activates the selected main tab and deactivates others.
         * @param {string} tabName - The name of the tab to activate (e.g., 'tests', 'regularData').
         */
        function activateMainTab(tabName) {
            // Deactivate all main tab buttons and content
            for (const key in tabButtons) {
                if (tabButtons[key]) {
                    tabButtons[key].classList.remove('active');
                }
            }
            for (const key in tabContents) {
                if (tabContents[key]) {
                    tabContents[key].classList.remove('active');
                }
            }

            // Activate the selected main tab button and content
            if (tabButtons[tabName]) {
                tabButtons[tabName].classList.add('active');
            }
            if (tabContents[tabName]) {
                tabContents[tabName].classList.add('active');
            }

            // Specific actions based on tab
            if (tabName === 'regularData') {
                activateDailyRoutineSubTab('today');
                updateDailySummary();
                updateMCQQuotaCharts();
            } else if (tabName === 'tests') {
                activateTestEntrySubTab('ut');
            } else if (tabName === 'analytics') {
                activateAnalyticsSubTab('ut'); // Default to Unit Test analytics
            } else if (tabName === 'goals') {
                activateGoalsSubTab('physics'); // Default to Physics goals
            }
        }

        /**
         * NEW: Activates the selected daily routine sub-tab and deactivates others.
         * @param {string} subTabName - The name of the sub-tab to activate (e.g., 'today', 'upcoming').
         */
        function activateDailyRoutineSubTab(subTabName) {
            for (const key in dailyRoutineSubTabButtons) {
                if (dailyRoutineSubTabButtons[key]) dailyRoutineSubTabButtons[key].classList.remove('active');
            }
            for (const key in dailyRoutineSubTabContents) {
                if (dailyRoutineSubTabContents[key]) dailyRoutineSubTabContents[key].classList.remove('active');
            }

            if (dailyRoutineSubTabButtons[subTabName]) dailyRoutineSubTabButtons[subTabName].classList.add('active');
            if (dailyRoutineSubTabContents[subTabName]) dailyRoutineSubTabContents[subTabName].classList.add('active');

            // Update content based on sub-tab
            if (subTabName === 'today') {
                displayDailyLogsForDate(logDateInput.value || currentDate);
                updateMCQQuotaCharts();
            } else if (subTabName === 'upcoming') {
                renderUpcomingPlans();
            } else if (subTabName === 'backlogs') {
                updateBacklogs();
            } else if (subTabName === 'completed') {
                renderCompletedTasks();
            }
            updateDailySummary();
        }


        /**
         * Activates the selected test sub-tab and deactivates others.
         * @param {string} subTabName - The name of the sub-tab to activate (e.g., 'ut', 'bbcts').
         */
        function activateTestEntrySubTab(subTabName) {
            for (const key in testEntrySubTabButtons) {
                if (testEntrySubTabButtons[key]) testEntrySubTabButtons[key].classList.remove('active');
            }
            for (const key in testEntrySubTabContents) {
                if (testEntrySubTabContents[key]) testEntrySubTabContents[key].classList.remove('active');
            }

            if (testEntrySubTabButtons[subTabName]) testEntrySubTabButtons[subTabName].classList.add('active');
            if (testEntrySubTabContents[subTabName]) testEntrySubTabContents[subTabName].classList.add('active');

            const today = new Date().toISOString().split('T')[0];
            if (subTabName === 'ut') { if (utDateInput) utDateInput.value = today; }
            else if (subTabName === 'bbcts') { if (bbctsDateInput) bbctsDateInput.value = today; }
            else if (subTabName === 'quarterly') { if (qtDateInput) qtDateInput.value = today; }
            else if (subTabName === 'missionNeet') { if (mnDateInput) mnDateInput.value = today; }
        }

        /**
         * Activates the selected analytics sub-tab and deactivates others.
         * @param {string} subTabName - The name of the sub-tab to activate (e.g., 'ut', 'bbcts').
         */
        function activateAnalyticsSubTab(subTabName) {
            for (const key in analyticsSubTabButtons) {
                if (analyticsSubTabButtons[key]) analyticsSubTabButtons[key].classList.remove('active');
            }
            for (const key in analyticsSubTabContents) {
                if (analyticsSubTabContents[key]) analyticsSubTabContents[key].classList.remove('active');
            }

            if (analyticsSubTabButtons[subTabName]) analyticsSubTabButtons[subTabName].classList.add('active');
            if (analyticsSubTabContents[subTabName]) analyticsSubTabContents[subTabName].classList.add('active');

            if (subTabName === 'syllabusProgression') {
                drawSyllabusProgressionChart();
            } else {
                drawAllCharts();
            }
        }

        /**
         * Activates the selected goals sub-tab and renders chapters.
         * @param {string} subTabName - 'physics', 'chemistry', or 'biology'.
         */
        function activateGoalsSubTab(subTabName) {
            for (const key in goalsSubTabButtons) {
                if (goalsSubTabButtons[key]) goalsSubTabButtons[key].classList.remove('active');
            }
            for (const key in goalsSubTabContents) {
                if (goalsSubTabContents[key]) goalsSubTabContents[key].classList.remove('active');
            }

            if (goalsSubTabButtons[subTabName]) goalsSubTabButtons[subTabName].classList.add('active');
            if (goalsSubTabContents[subTabName]) goalsSubTabContents[subTabName].classList.add('active');

            // Show/hide subcategory checkboxes based on subject
            if (subTabName === 'biology') {
                physicsChemistrySubcategoryCheckboxes.classList.add('hidden');
                biologySubcategoryCheckboxes.classList.remove('hidden');
            } else {
                physicsChemistrySubcategoryCheckboxes.classList.remove('hidden');
                biologySubcategoryCheckboxes.classList.add('hidden');
            }

            renderGoalsChapters(subTabName);
        }

        /**
         * Renders the chapters for the given subject into the appropriate display div,
         * dynamically adjusting columns based on selected sub-categories.
         * @param {string} subject - 'physics', 'chemistry', or 'biology'.
         */
        function renderGoalsChapters(subject) {
            let chaptersData = [];
            let displayElement;
            let allSubCategories = [];
            let selectedSubcategoriesKeys = [];
            let isBiology = false;

            if (subject === 'physics') {
                chaptersData = physicsGoalsData;
                displayElement = physicsGoalsDisplay;
                allSubCategories = physicsChemistrySubCategoriesOrdered;
                selectedSubcategoriesKeys = selectedPhysicsChemistrySubcategories;
            } else if (subject === 'chemistry') {
                chaptersData = chemistryGoalsData;
                displayElement = chemistryGoalsDisplay;
                allSubCategories = physicsChemistrySubCategoriesOrdered;
                selectedSubcategoriesKeys = selectedChemistrySubcategories;
            } else if (subject === 'biology') {
                chaptersData = biologyGoalsData;
                displayElement = biologyGoalsDisplay;
                allSubCategories = biologySubCategoriesOrdered;
                selectedSubcategoriesKeys = selectedBiologySubcategories;
                isBiology = true;
            } else {
                return; // Invalid subject
            }

            if (!displayElement) {
                console.error(`Display element for ${subject} goals not found.`);
                return;
            }

            displayElement.innerHTML = ''; // Clear previous content

            if (chaptersData.length === 0) {
                displayElement.textContent = `No ${subject} chapters loaded.`;
                return;
            }

            // Filter and sort selected sub-categories based on their predefined order
            const visibleSubcategories = allSubCategories.filter(cat => selectedSubcategoriesKeys.includes(cat.key));
            visibleSubcategories.sort((a, b) => {
                // Custom sort order for levels (Beginner to Master) based on their `level` property
                return a.level - b.level;
            });

            // Dynamic grid template columns
            const gridTemplateColumns = `minmax(150px, 1fr) repeat(${visibleSubcategories.length}, minmax(80px, 0.7fr))`;
            displayElement.style.display = 'grid'; // Ensure grid display
            displayElement.style.gridTemplateColumns = gridTemplateColumns; // Apply to parent

            // Display headers
            const headerRow = document.createElement('div');
            headerRow.classList.add('chapter-header');
            headerRow.style.gridTemplateColumns = gridTemplateColumns; // Apply to header row
            const chapterNameHeader = document.createElement('div');
            chapterNameHeader.textContent = isBiology ? "Chapter Name" : "Chapter / Topic";
            headerRow.appendChild(chapterNameHeader);

            visibleSubcategories.forEach(cat => {
                const catHeader = document.createElement('div');
                catHeader.textContent = cat.name;
                headerRow.appendChild(catHeader);
            });
            displayElement.appendChild(headerRow);

            chaptersData.forEach(chapterObj => {
                const chapterName = chapterObj['Chapter Name'];
                const baseChapterKey = `${subject}-${chapterName.replace(/\s|\(|\)/g, '_').replace(/_+/g, '_').toLowerCase()}`;

                const renderItem = (name, itemKey, isTopic = false) => {
                    const chapterRow = document.createElement('div');
                    chapterRow.classList.add('chapter-row');
                    chapterRow.style.gridTemplateColumns = gridTemplateColumns;

                    const nameCol = document.createElement('div');
                    nameCol.classList.add('chapter-name-col');
                    if (isTopic) {
                        nameCol.style.paddingLeft = '1rem'; // Indent topics
                        nameCol.textContent = `• ${name}`;
                    } else {
                        nameCol.textContent = name;
                    }
                    chapterRow.appendChild(nameCol);

                    visibleSubcategories.forEach(cat => {
                        const buttonContainer = document.createElement('div');
                        const completionButton = document.createElement('button');
                        completionButton.classList.add('chapter-button');

                    const bookKey = cat.key;
                    const topicKey = `${baseChapterKey}-${itemKey}`;

                    // Ensure data structure exists with book key
                    if (!chapterStatus[baseChapterKey]) chapterStatus[baseChapterKey] = {};
                    if (!chapterStatus[baseChapterKey][bookKey]) chapterStatus[baseChapterKey][bookKey] = {};
                    if (!chapterStatus[baseChapterKey][bookKey][topicKey]) {
                        chapterStatus[baseChapterKey][bookKey][topicKey] = { isCompleted: false, completionDate: null, aiMessage: '' };
                    }

                    const currentStatus = chapterStatus[baseChapterKey][bookKey][topicKey];

                        if (currentStatus.isCompleted) {
                            const colorClass = `color-level-${cat.level}`;
                            completionButton.classList.add('completed', colorClass);
                            completionButton.textContent = currentStatus.aiMessage || '✔';
                        } else {
                            completionButton.textContent = 'Mark Done';
                        }

                        completionButton.dataset.chapterKey = baseChapterKey;
                    completionButton.dataset.topicKey = topicKey; // Store the unique key for this item
                        completionButton.dataset.subjectName = subject;
                        completionButton.dataset.chapterName = chapterName;
                        completionButton.dataset.topicName = isTopic ? name : null; // Pass topic name if it's a topic
                        completionButton.dataset.subCategoryKey = cat.key; // Store subcategory key for consistent color

                        completionButton.addEventListener('click', async (event) => {
                            if (userId === 'not-authenticated') {
                                showStatusMessage("Please sign in to mark chapters.", 'error');
                                return;
                            }

                            const btn = event.target;
                            const currentChapterKey = btn.dataset.chapterKey;
                        const currentTopicKey = btn.dataset.topicKey; // This is the full topic key
                            const currentSubjectName = btn.dataset.subjectName;
                            const currentChapterName = btn.dataset.chapterName;
                            const currentTopicName = btn.dataset.topicName;
                            const currentSubCategoryKey = btn.dataset.subCategoryKey;
                            const currentSubCategoryLevel = allSubCategories.find(c => c.key === currentSubCategoryKey)?.level || 0;

                        // Use the correct nested structure for updating
                            if (!chapterStatus[currentChapterKey]) chapterStatus[currentChapterKey] = {};
                        if (!chapterStatus[currentChapterKey][currentSubCategoryKey]) chapterStatus[currentChapterKey][currentSubCategoryKey] = {};
                        if (!chapterStatus[currentChapterKey][currentSubCategoryKey][currentTopicKey]) {
                            chapterStatus[currentChapterKey][currentSubCategoryKey][currentTopicKey] = { isCompleted: false, completionDate: null, aiMessage: '' };
                            }

                        const currentStatus = chapterStatus[currentChapterKey][currentSubCategoryKey][currentTopicKey];

                            if (!currentStatus.isCompleted) {
                                showStatusMessage("Marking as done...", 'info');
                                btn.disabled = true;

                                try {
                                    let prompt;
                                    if (currentTopicName) {
                                        prompt = `Generate a very short, encouraging 'done' message (max 10 words) with a celebratory emoji for completing the "${currentTopicName}" topic within the chapter "${currentChapterName}" for "${currentSubjectName}". Example: "Awesome work! ${currentTopicName} mastered! 🎉"`;
                                    } else {
                                        prompt = `Generate a very short, encouraging 'done' message (max 10 words) with a celebratory emoji for completing the chapter "${currentChapterName}" for "${currentSubjectName}". Example: "Fantastic! ${currentChapterName} done! 🚀"`;
                                    }
                                    let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                                    const payload = { contents: chatHistory };
                                    const apiKey = firebaseConfig.apiKey; // Use your Firebase API key for Gemini
                                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                                    const response = await fetch(apiUrl, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify(payload)
                                    });
                                    const result = await response.json();
                                    let aiMessage = '✔';
                                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                                        aiMessage = result.candidates[0].content.parts[0].text;
                                    }

                                chapterStatus[currentChapterKey][currentSubCategoryKey][currentTopicKey] = {
                                        isCompleted: true,
                                        completionDate: new Date().toISOString().split('T')[0],
                                        aiMessage: aiMessage
                                    };
                                    btn.classList.add('completed', `color-level-${currentSubCategoryLevel}`); // Add level color
                                    btn.textContent = aiMessage;
                                    showStatusMessage("Task completed!", 'success');
                                } catch (error) {
                                    console.error("Error generating AI message for chapter completion:", error);
                                chapterStatus[currentChapterKey][currentSubCategoryKey][currentTopicKey] = {
                                        isCompleted: true,
                                        completionDate: new Date().toISOString().split('T')[0],
                                        aiMessage: '✔'
                                    };
                                    btn.classList.add('completed', `color-level-${currentSubCategoryLevel}`); // Fallback with color
                                    btn.textContent = '✔';
                                    showStatusMessage("Task completed (AI message failed).", 'error');
                                } finally {
                                    btn.disabled = false;
                                    saveChapterStatus();
                                }
                            } else {
                                // If already completed, allow unmarking
                            chapterStatus[currentChapterKey][currentSubCategoryKey][currentTopicKey] = {
                                    isCompleted: false,
                                    completionDate: null,
                                    aiMessage: ''
                                };
                                btn.classList.remove('completed');
                                // Remove all color-level classes
                                Array.from(btn.classList).filter(c => c.startsWith('color-level-')).forEach(c => btn.classList.remove(c));
                                btn.textContent = 'Mark Done';
                                showStatusMessage("Task unmarked.", 'info');
                                saveChapterStatus();
                            }
                        });
                        buttonContainer.appendChild(completionButton);
                        chapterRow.appendChild(buttonContainer);
                    });
                    displayElement.appendChild(chapterRow);
                };

                // Render main chapter row
                renderItem(chapterName, chapterName.replace(/\s|\(|\)/g, '_').replace(/_+/g, '_').toLowerCase());

                // If not biology and has topics, render topics
                if (!isBiology && chapterObj.Topics && chapterObj.Topics.length > 0) {
                    chapterObj.Topics.forEach(topic => {
                        renderItem(topic, topic.replace(/\s|\(|\)/g, '_').replace(/_+/g, '_').toLowerCase(), true);
                    });
                }
            });
        }


        /**
         * Renders the subcategory checkboxes for the given subject.
         * @param {string} subject - 'physics', 'chemistry', or 'biology'.
         */
        function renderSubcategoryCheckboxes(subject) {
            let container;
            let subCategories;
            let selectedKeys;

            if (subject === 'physics' || subject === 'chemistry') {
                container = physicsChemistrySubcategoryCheckboxes;
                subCategories = physicsChemistrySubCategoriesOrdered;
                selectedKeys = selectedPhysicsChemistrySubcategories;
            } else if (subject === 'biology') {
                container = biologySubcategoryCheckboxes;
                subCategories = biologySubCategoriesOrdered;
                selectedKeys = selectedBiologySubcategories;
            } else {
                return;
            }

            container.innerHTML = ''; // Clear existing checkboxes

            subCategories.forEach(cat => {
                const div = document.createElement('div');
                div.classList.add('flex', 'items-center', 'mr-4');
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = `checkbox-${subject}-${cat.key}`;
                input.classList.add('mr-2', 'form-checkbox', 'h-4', 'w-4', 'text-blue-600', 'rounded');
                input.checked = selectedKeys.includes(cat.key);
                input.dataset.subject = subject;
                input.dataset.key = cat.key;

                input.addEventListener('change', (event) => {
                    const changedSubject = event.target.dataset.subject;
                    const changedKey = event.target.dataset.key;

                    if (changedSubject === 'physics' || changedSubject === 'chemistry') {
                        if (event.target.checked) {
                            if (!selectedPhysicsChemistrySubcategories.includes(changedKey)) {
                                selectedPhysicsChemistrySubcategories.push(changedKey);
                            }
                        } else {
                            selectedPhysicsChemistrySubcategories = selectedPhysicsChemistrySubcategories.filter(k => k !== changedKey);
                        }
                        // Re-render both physics and chemistry goals to ensure consistent column display
                        renderGoalsChapters('physics');
                        renderGoalsChapters('chemistry');
                    } else if (changedSubject === 'biology') {
                        if (event.target.checked) {
                            if (!selectedBiologySubcategories.includes(changedKey)) {
                                selectedBiologySubcategories.push(changedKey);
                            }
                        } else {
                            selectedBiologySubcategories = selectedBiologySubcategories.filter(k => k !== changedKey);
                        }
                        renderGoalsChapters('biology');
                    }
                });

                const label = document.createElement('label');
                label.htmlFor = `checkbox-${subject}-${cat.key}`;
                label.classList.add('text-gray-700', 'text-sm', 'font-medium');
                label.textContent = cat.name;

                div.appendChild(input);
                div.appendChild(label);
                container.appendChild(div);
            });
        }


        // Attach event listeners for main tab buttons
        if (tabButtons.regularData) tabButtons.regularData.addEventListener('click', () => activateMainTab('regularData'));
        if (tabButtons.tests) tabButtons.tests.addEventListener('click', () => activateMainTab('tests'));
        if (tabButtons.analytics) tabButtons.analytics.addEventListener('click', () => activateMainTab('analytics'));
        if (tabButtons.goals) tabButtons.goals.addEventListener('click', () => activateMainTab('goals'));
        if (tabButtons.aiSuggestions) tabButtons.aiSuggestions.addEventListener('click', () => activateMainTab('aiSuggestions'));

        // NEW: Attach event listeners for Daily Routine sub-tab buttons
        if (dailyRoutineSubTabButtons.today) dailyRoutineSubTabButtons.today.addEventListener('click', () => activateDailyRoutineSubTab('today'));
        if (dailyRoutineSubTabButtons.upcoming) dailyRoutineSubTabButtons.upcoming.addEventListener('click', () => activateDailyRoutineSubTab('upcoming'));
        if (dailyRoutineSubTabButtons.backlogs) dailyRoutineSubTabButtons.backlogs.addEventListener('click', () => activateDailyRoutineSubTab('backlogs'));
        if (dailyRoutineSubTabButtons.completed) dailyRoutineSubTabButtons.completed.addEventListener('click', () => activateDailyRoutineSubTab('completed'));


        // Attach event listeners for test sub-tab buttons
        if (testEntrySubTabButtons.ut) testEntrySubTabButtons.ut.addEventListener('click', () => activateTestEntrySubTab('ut'));
        if (testEntrySubTabButtons.bbcts) testEntrySubTabButtons.bbcts.addEventListener('click', () => activateTestEntrySubTab('bbcts'));
        if (testEntrySubTabButtons.quarterly) testEntrySubTabButtons.quarterly.addEventListener('click', () => activateTestEntrySubTab('quarterly'));
        if (testEntrySubTabButtons.missionNeet) testEntrySubTabButtons.missionNeet.addEventListener('click', () => activateTestEntrySubTab('missionNeet'));

        // Attach event listeners for analytics sub-tab buttons
        if (analyticsSubTabButtons.ut) analyticsSubTabButtons.ut.addEventListener('click', () => activateAnalyticsSubTab('ut'));
        if (analyticsSubTabButtons.bbcts) analyticsSubTabButtons.bbcts.addEventListener('click', () => activateAnalyticsSubTab('bbcts'));
        if (analyticsSubTabButtons.quarterly) analyticsSubTabButtons.quarterly.addEventListener('click', () => activateAnalyticsSubTab('quarterly'));
        if (analyticsSubTabButtons.missionNeetAnalytics) analyticsSubTabButtons.missionNeetAnalytics.addEventListener('click', () => activateAnalyticsSubTab('missionNeetAnalytics'));
        if (analyticsSubTabButtons.syllabusProgression) analyticsSubTabButtons.syllabusProgression.addEventListener('click', () => activateAnalyticsSubTab('syllabusProgression'));

        // Attach event listeners for goals sub-tab buttons
        if (goalsSubTabButtons.physics) goalsSubTabButtons.physics.addEventListener('click', () => activateGoalsSubTab('physics'));
        if (goalsSubTabButtons.chemistry) goalsSubTabButtons.chemistry.addEventListener('click', () => activateGoalsSubTab('chemistry'));
        if (goalsSubTabButtons.biology) goalsSubTabButtons.biology.addEventListener('click', () => activateGoalsSubTab('biology'));

        // --- Analytics (Chart.js Graphs) ---

        /**
         * Destroys an existing chart instance if it exists.
         * @param {Chart} chartInstance - The Chart.js instance to destroy.
         * @returns {null} - Returns null after destruction.
         */
        function destroyChart(chartInstance) {
            if (chartInstance) {
                chartInstance.destroy();
            }
            return null;
        }

        /**
         * Draws a line chart for a given subject/data type using raw marks or percentages.
         * @param {HTMLCanvasElement} canvas - The canvas element for the chart.
         * @param {string} title - The title of the chart.
         * @param {Array<Object>} data - The raw data array.
         * @param {string} scoreKey - The key for the score (e.g., 'physicsScore', 'score').
         * @param {string} fullMarksKey - The key for full marks (e.g., 'fullMarks').
         * @param {Chart} existingInstance - The global variable holding the chart instance for this specific chart.
         * @param {boolean} isPercentage - If true, calculate score as percentage of full marks.
         * @returns {Chart} - The new Chart.js instance.
         */
        function drawLineChart(canvas, title, data, scoreKey, fullMarksKey, existingInstance, isPercentage = false) {
            const labels = data.map(item => item.date);
            let scores = data.map(item => item[scoreKey]);
            let fullMarks = data.map(item => item[fullMarksKey]);

            if (isPercentage) {
                scores = data.map(item => (item[scoreKey] / item[fullMarksKey]) * 100);
                fullMarks = data.map(() => 100); // Full marks is 100% for percentage graph
            }

            const ctx = canvas.getContext('2d');

            // Destroy existing chart instance if it exists
            if (existingInstance) {
                existingInstance = destroyChart(existingInstance);
            }

            const yAxisLabel = isPercentage ? 'Percentage (%)' : 'Marks';

            const newChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'My Score',
                        data: scores,
                        borderColor: '#4f46e5', /* Indigo */
                        backgroundColor: 'rgba(79, 70, 229, 0.2)',
                        tension: 0.3,
                        fill: false,
                        pointBackgroundColor: '#4f46e5',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#4f46e5',
                        pointRadius: 5,
                        pointHoverRadius: 7
                    },
                    {
                        label: 'Full Marks',
                        data: fullMarks,
                        borderColor: '#10b981', /* Green */
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        tension: 0.3,
                        fill: false,
                        pointBackgroundColor: '#10b981',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#10b981',
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: title,
                            font: {
                                size: 18,
                                weight: 'bold'
                            },
                            color: '#333'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = `${context.dataset.label}: ${context.raw}`;
                                    if (isPercentage) {
                                        label += '%';
                                    }
                                    return label;
                                }
                            }
                        },
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date',
                                color: '#555'
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: yAxisLabel,
                                color: '#555'
                            },
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return isPercentage ? value + '%' : value;
                                }
                            }
                        }
                    }
                }
            });
            return newChartInstance;
        }


        /**
         * Draws all relevant charts based on the fetched data and active sub-tab.
         */
        function drawAllCharts() {
            // Destroy all existing charts first to prevent overlaps
            physicsChartUTInstance = destroyChart(physicsChartUTInstance);
            chemistryChartUTInstance = destroyChart(chemistryChartUTInstance);
            biologyChartUTInstance = destroyChart(biologyChartUTInstance);
            physicsChartBBCTSInstance = destroyChart(physicsChartBBCTSInstance);
            chemistryChartBBCTSInstance = destroyChart(chemistryChartBBCTSInstance);
            biologyChartBBCTSInstance = destroyChart(biologyChartBBCTSInstance);
            physicsChartQuarterlyInstance = destroyChart(physicsChartQuarterlyInstance);
            chemistryChartQuarterlyInstance = destroyChart(chemistryChartQuarterlyInstance);
            biologyChartQuarterlyInstance = destroyChart(biologyChartQuarterlyInstance);
            missionNeetChartInstance = destroyChart(missionNeetChartInstance);
            syllabusProgressionChartInstance = destroyChart(syllabusProgressionChartInstance);

            if (userId === 'not-authenticated') {
                // Charts should already be cleared by onAuthStateChanged
                return;
            }

            // Determine which sub-tab is active and draw charts accordingly
            if (analyticsSubTabContents.ut && analyticsSubTabContents.ut.classList.contains('active')) {
                utTestData.sort((a, b) => new Date(a.date) - new Date(b.date));
                if (utTestData.length > 0) {
                    if (analyticsCanvasPhysicsUT) physicsChartUTInstance = drawLineChart(analyticsCanvasPhysicsUT, 'Physics Scores (Unit Tests)', utTestData, 'physicsScore', 'fullMarks', physicsChartUTInstance);
                    if (analyticsCanvasChemistryUT) chemistryChartUTInstance = drawLineChart(analyticsCanvasChemistryUT, 'Chemistry Scores (Unit Tests)', utTestData, 'chemistryScore', 'fullMarks', chemistryChartUTInstance);
                    if (analyticsCanvasBiologyUT) biologyChartUTInstance = drawLineChart(analyticsCanvasBiologyUT, 'Biology Scores (Unit Tests)', utTestData, 'biologyScore', 'fullMarks', biologyChartUTInstance);
                } else {
                    if (analyticsCanvasPhysicsUT) analyticsCanvasPhysicsUT.getContext('2d').clearRect(0, 0, analyticsCanvasPhysicsUT.width, analyticsCanvasPhysicsUT.height);
                    if (analyticsCanvasChemistryUT) analyticsCanvasChemistryUT.getContext('2d').clearRect(0, 0, analyticsCanvasChemistryUT.width, analyticsCanvasChemistryUT.height);
                    if (analyticsCanvasBiologyUT) analyticsCanvasBiologyUT.getContext('2d').clearRect(0, 0, analyticsCanvasBiologyUT.width, analyticsCanvasBiologyUT.height);
                    showStatusMessage("No Unit Tests data available to draw graphs.", 'info');
                }
            } else if (analyticsSubTabContents.bbcts && analyticsSubTabContents.bbcts.classList.contains('active')) {
                bbctsData.sort((a, b) => new Date(a.date) - new Date(b.date));
                if (bbctsData.length > 0) {
                    if (analyticsCanvasPhysicsBBCTS) physicsChartBBCTSInstance = drawLineChart(analyticsCanvasPhysicsBBCTS, 'Physics Scores (BB Classes Test Series)', bbctsData, 'physicsScore', 'fullMarks', physicsChartBBCTSInstance);
                    if (analyticsCanvasChemistryBBCTS) chemistryChartBBCTSInstance = drawLineChart(analyticsCanvasChemistryBBCTS, 'Chemistry Scores (BB Classes Test Series)', bbctsData, 'chemistryScore', 'fullMarks', chemistryChartBBCTSInstance);
                    if (analyticsCanvasBiologyBBCTS) biologyChartBBCTSInstance = drawLineChart(analyticsCanvasBiologyBBCTS, 'Biology Scores (BB Classes Test Series)', bbctsData, 'biologyScore', 'fullMarks', biologyChartBBCTSInstance);
                } else {
                    if (analyticsCanvasPhysicsBBCTS) analyticsCanvasPhysicsBBCTS.getContext('2d').clearRect(0, 0, analyticsCanvasPhysicsBBCTS.width, analyticsCanvasPhysicsBBCTS.height);
                    if (analyticsCanvasChemistryBBCTS) analyticsCanvasChemistryBBCTS.getContext('2d').clearRect(0, 0, analyticsCanvasChemistryBBCTS.width, analyticsCanvasChemistryBBCTS.height);
                    if (analyticsCanvasBiologyBBCTS) analyticsCanvasBiologyBBCTS.getContext('2d').clearRect(0, 0, analyticsCanvasBiologyBBCTS.width, analyticsCanvasBiologyBBCTS.height);
                    showStatusMessage("No BB Classes Test Series data available to draw graphs.", 'info');
                }
            } else if (analyticsSubTabContents.quarterly && analyticsSubTabContents.quarterly.classList.contains('active')) {
                quarterlyData.sort((a, b) => new Date(a.date) - new Date(b.date));
                if (quarterlyData.length > 0) {
                    if (analyticsCanvasPhysicsQuarterly) physicsChartQuarterlyInstance = drawLineChart(analyticsCanvasPhysicsQuarterly, 'Physics Scores (Quarterly Tests)', quarterlyData, 'physicsScore', 'fullMarks', physicsChartQuarterlyInstance);
                    if (analyticsCanvasChemistryQuarterly) chemistryChartQuarterlyInstance = drawLineChart(analyticsCanvasChemistryQuarterly, 'Chemistry Scores (Quarterly Tests)', quarterlyData, 'chemistryScore', 'fullMarks', chemistryChartQuarterlyInstance);
                    if (analyticsCanvasBiologyQuarterly) biologyChartQuarterlyInstance = drawLineChart(analyticsCanvasBiologyQuarterly, 'Biology Scores (Quarterly Tests)', quarterlyData, 'biologyScore', 'fullMarks', biologyChartQuarterlyInstance);
                } else {
                    if (analyticsCanvasPhysicsQuarterly) analyticsCanvasPhysicsQuarterly.getContext('2d').clearRect(0, 0, analyticsCanvasPhysicsQuarterly.width, analyticsCanvasPhysicsQuarterly.height);
                    if (analyticsCanvasChemistryQuarterly) analyticsCanvasChemistryQuarterly.getContext('2d').clearRect(0, 0, analyticsCanvasChemistryQuarterly.width, analyticsCanvasChemistryQuarterly.height);
                    if (analyticsCanvasBiologyQuarterly) analyticsCanvasBiologyQuarterly.getContext('2d').clearRect(0, 0, analyticsCanvasBiologyQuarterly.width, analyticsCanvasBiologyQuarterly.height);
                    showStatusMessage("No Quarterly Tests data available to draw graphs.", 'info');
                }
            } else if (analyticsSubTabContents.missionNeetAnalytics && analyticsSubTabContents.missionNeetAnalytics.classList.contains('active')) {
                missionNeetData.sort((a, b) => new Date(a.date) - new Date(b.date));
                if (missionNeetData.length > 0) {
                    if (analyticsCanvasMissionNeet) missionNeetChartInstance = drawLineChart(analyticsCanvasMissionNeet, 'Mission NEET Tests Scores (Percentage)', missionNeetData, 'score', 'fullMarks', missionNeetChartInstance, true);
                } else {
                    if (analyticsCanvasMissionNeet) analyticsCanvasMissionNeet.getContext('2d').clearRect(0, 0, analyticsCanvasMissionNeet.width, analyticsCanvasMissionNeet.height);
                    showStatusMessage("No Mission NEET Tests data available to draw graphs.", 'info');
                }
            }
        }

        /**
         * Draws the Syllabus Progression Chart.
         */
        function drawSyllabusProgressionChart() {
            syllabusProgressionChartInstance = destroyChart(syllabusProgressionChartInstance);

            if (userId === 'not-authenticated') {
                // Chart should already be cleared by onAuthStateChanged
                return;
            }

            const allChapters = [...physicsGoalsData, ...chemistryGoalsData, ...biologyGoalsData];
            const completionDates = {};

            for (const chapterKey in chapterStatus) {
                for (const subCategoryKey in chapterStatus[chapterKey]) {
                    if (chapterStatus[chapterKey][subCategoryKey].isCompleted && chapterStatus[chapterKey][subCategoryKey].completionDate) {
                        const date = chapterStatus[chapterKey][subCategoryKey].completionDate;
                        completionDates[date] = (completionDates[date] || 0) + 1;
                    }
                }
            }

            const sortedDates = Object.keys(completionDates).sort();
            const cumulativeCompleted = [];
            let currentCumulative = 0;

            sortedDates.forEach(date => {
                currentCumulative += completionDates[date];
                cumulativeCompleted.push(currentCumulative);
            });

            const ctx = syllabusProgressionCanvas.getContext('2d');

            syllabusProgressionChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Tasks Completed',
                        data: cumulativeCompleted,
                        borderColor: '#059669',
                        backgroundColor: 'rgba(5, 150, 105, 0.2)',
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: '#059669',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#059669',
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Syllabus Progression Over Time (Tasks Completed)',
                            font: {
                                size: 18,
                                weight: 'bold'
                            },
                            color: '#333'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.raw} Tasks Completed`;
                                }
                            }
                        },
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date',
                                color: '#555'
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Number of Tasks',
                                color: '#555'
                            },
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }


        // --- AI Performance Insights ---

        async function getAIPerformanceInsights() {
            if (userId === 'not-authenticated') {
                showStatusMessage("Please sign in to get AI performance insights.", 'error');
                if (aiPerformanceAnalysisDisplay) aiPerformanceAnalysisDisplay.textContent = "Please sign in to get AI performance insights.";
                return;
            }
            if (utTestData.length === 0 && bbctsData.length === 0 && quarterlyData.length === 0 && missionNeetData.length === 0) {
                showStatusMessage("No test data available for AI analysis. Please enter some data.", 'error');
                if (aiPerformanceAnalysisDisplay) aiPerformanceAnalysisDisplay.textContent = "No test data available for AI analysis.";
                return;
            }

            if (aiPerformanceAnalysisDisplay) aiPerformanceAnalysisDisplay.textContent = "Generating AI performance analysis...";
            if (getAIPerformanceInsightsButton) getAIPerformanceInsightsButton.disabled = true;
            showStatusMessage("Getting AI performance insights...", 'info');

            try {
                let prompt = `Analyze the following NEET UG test performance data. Identify strengths, weaknesses, and suggest actionable areas for improvement. Provide a concise summary and specific recommendations. Focus on subject-wise performance and overall trends.\n\n`;
                prompt += `--- Unit Test Data ---\n${JSON.stringify(utTestData, null, 2)}\n\n`;
                prompt += `--- BBCTS Data ---\n${JSON.stringify(bbctsData, null, 2)}\n\n`;
                prompt += `--- Quarterly Test Data ---\n${JSON.stringify(quarterlyData, null, 2)}\n\n`;
                prompt += `--- Mission NEET Data ---\n${JSON.stringify(missionNeetData, null, 2)}\n\n`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                const apiKey = firebaseConfig.apiKey;

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    if (aiPerformanceAnalysisDisplay) aiPerformanceAnalysisDisplay.textContent = text;
                    showStatusMessage("AI performance analysis received!", 'success');
                } else {
                    if (aiPerformanceAnalysisDisplay) aiPerformanceAnalysisDisplay.textContent = "Could not get AI performance analysis. Please try again.";
                    console.error("Unexpected AI response structure for performance analysis:", result);
                    showStatusMessage("Failed to get AI performance analysis.", 'error');
                }
            } catch (error) {
                console.error("Error fetching AI performance analysis:", error);
                if (aiPerformanceAnalysisDisplay) aiPerformanceAnalysisDisplay.textContent = "An error occurred while fetching AI performance analysis.";
                showStatusMessage("Error fetching AI performance analysis.", 'error');
            } finally {
                if (getAIPerformanceInsightsButton) getAIPerformanceInsightsButton.disabled = false;
            }
        }

        // Event listener for AI Performance Insights button
        if (getAIPerformanceInsightsButton) getAIPerformanceInsightsButton.addEventListener('click', getAIPerformanceInsights);

        // --- AI Productivity Insights ---
        async function getAIProductivityInsights() {
            if (userId === 'not-authenticated') {
                showStatusMessage("Please sign in to get AI productivity insights.", 'error');
                if (aiProductivityAnalysisDisplay) aiProductivityAnalysisDisplay.textContent = "Please sign in to get AI productivity insights.";
                return;
            }
            if (regularDataLogs.length === 0) {
                showStatusMessage("No daily log data available for AI analysis. Please enter some logs.", 'error');
                if (aiProductivityAnalysisDisplay) aiProductivityAnalysisDisplay.textContent = "No daily log data available for AI analysis.";
                return;
            }

            if (aiProductivityAnalysisDisplay) aiProductivityAnalysisDisplay.textContent = "Generating AI productivity analysis...";
            if (getAIProductivityInsightsButton) getAIProductivityInsightsButton.disabled = true;
            showStatusMessage("Getting AI productivity insights...", 'info');

            try {
                let prompt = `Analyze the following daily log entries for a NEET UG aspirant. Identify patterns in study topics, time spent, and backlogs. Provide insights on productivity, highlight areas for improvement, and suggest actionable tips for better time management and topic coverage. Incorporate advice that NEET UG toppers often give, such as consistent revision, mock test analysis, and balancing subjects.`;
                prompt += `--- Daily Log Entries ---\n${JSON.stringify(regularDataLogs, null, 2)}\n\n`;
                prompt += `--- Upcoming Plans ---\n${JSON.stringify(upcomingPlans, null, 2)}\n\n`; // Include upcoming plans
                prompt += `--- Completed Tasks ---\n${JSON.stringify(completedTasks, null, 2)}\n\n`; // Include completed tasks


                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                const apiKey = firebaseConfig.apiKey;

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    if (aiProductivityAnalysisDisplay) aiProductivityAnalysisDisplay.textContent = text;
                    showStatusMessage("AI productivity analysis received!", 'success');
                } else {
                    if (aiProductivityAnalysisDisplay) aiProductivityAnalysisDisplay.textContent = "Could not get AI productivity analysis. Please try again.";
                    console.error("Unexpected AI response structure for productivity analysis:", result);
                    showStatusMessage("Failed to get AI productivity analysis.", 'error');
                }
            } catch (error) {
                console.error("Error fetching AI productivity analysis:", error);
                if (aiProductivityAnalysisDisplay) aiProductivityAnalysisDisplay.textContent = "An error occurred while fetching AI productivity analysis.";
                showStatusMessage("Error fetching AI productivity analysis.", 'error');
            } finally {
                if (getAIProductivityInsightsButton) getAIProductivityInsightsButton.disabled = false;
            }
        }

        // Event listener for AI Productivity Insights button
        if (getAIProductivityInsightsButton) getAIProductivityInsightsButton.addEventListener('click', getAIProductivityInsights);


        // --- AI General Suggestions ---

        /**
         * Fetches general AI suggestions from the Gemini API.
         */
        async function getAISuggestion() {
            if (userId === 'not-authenticated') {
                showStatusMessage("Please sign in to get general AI suggestions.", 'error');
                if (aiResponseDisplay) aiResponseDisplay.textContent = "Please sign in to get general AI suggestions.";
                return;
            }
            const prompt = aiPromptInput.value.trim();
            if (aiResponseDisplay) aiResponseDisplay.textContent = "Generating AI suggestions...";
            showStatusMessage("Getting AI suggestion...", 'info');

            try {
                let fullPrompt = `Based on the following data, please provide a suggestion for: "${prompt || 'general study advice'}". Incorporate advice from NEET UG toppers where relevant.\n\n`;
                fullPrompt += `--- Regular Daily Logs ---\n${JSON.stringify(regularDataLogs, null, 2) || "No regular data available."}\n\n`;
                fullPrompt += `--- Unit Test Data ---\n${JSON.stringify(utTestData, null, 2) || "No UT test data available."}\n\n`;
                fullPrompt += `--- BBCTS Data ---\n${JSON.stringify(bbctsData, null, 2) || "No BBCTS test data available."}\n\n`;
                fullPrompt += `--- Quarterly Test Data ---\n${JSON.stringify(quarterlyData, null, 2) || "No Quarterly test data available."}\n\n`;
                fullPrompt += `--- Mission NEET Data ---\n${JSON.stringify(missionNeetData, null, 2) || "No Mission NEET data available."}\n\n`;
                fullPrompt += `--- Syllabus Completion Status ---\n${JSON.stringify(chapterStatus, null, 2) || "No chapter completion data."}\n\n`;
                fullPrompt += `--- Upcoming Plans ---\n${JSON.stringify(upcomingPlans, null, 2) || "No upcoming plans."}\n\n`;
                fullPrompt += `--- Completed Tasks ---\n${JSON.stringify(completedTasks, null, 2) || "No completed tasks."}\n\n`;


                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: fullPrompt }] });

                const payload = { contents: chatHistory };
                const apiKey = firebaseConfig.apiKey;

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    if (aiResponseDisplay) aiResponseDisplay.textContent = text;
                    showStatusMessage("AI suggestion received!", 'success');
                } else {
                    if (aiResponseDisplay) aiResponseDisplay.textContent = "Could not get a suggestion. Please try again.";
                    console.error("Unexpected AI response structure:", result);
                    showStatusMessage("Failed to get AI suggestion.", 'error');
                }
            } catch (error) {
                console.error("Error fetching AI suggestion:", error);
                if (aiResponseDisplay) aiResponseDisplay.textContent = "An error occurred while fetching AI suggestions.";
                showStatusMessage("Error fetching AI suggestion.", 'error');
            }
        }
        if (getAISuggestionButton) getAISuggestionButton.addEventListener('click', getAISuggestion);

        // --- NEW: Next Study Plan Feature ---
        async function getNextStudyPlan() {
            if (userId === 'not-authenticated') {
                showStatusMessage("Please sign in to get your next study plan.", 'error');
                if (nextStudyPlanDisplay) nextStudyPlanDisplay.textContent = "Please sign in to get your next study plan.";
                return;
            }

            if (nextStudyPlanDisplay) nextStudyPlanDisplay.textContent = "Generating your next study plan...";
            if (getNextStudyPlanButton) getNextStudyPlanButton.disabled = true;
            showStatusMessage("Generating next study plan...", 'info');

            try {
                let prompt = `As a NEET UG study assistant, analyze the user's current study data and suggest the *next best topic* to study. For the suggested topic, also recommend a *number of MCQs* to solve and a *time duration* for study. Incorporate advice from successful NEET UG toppers on effective study strategies (e.g., balancing weak areas, consistent practice, active recall). Prioritize topics that are either incomplete, have low scores in tests, or haven't been reviewed recently.

                --- User's Current Data ---
                Daily Logs: ${JSON.stringify(regularDataLogs.slice(-7), null, 2)} (last 7 days)
                Unit Test Scores: ${JSON.stringify(utTestData.slice(-3), null, 2)} (last 3 tests)
                BBCTS Scores: ${JSON.stringify(bbctsData.slice(-3), null, 2)} (last 3 tests)
                Quarterly Scores: ${JSON.stringify(quarterlyData.slice(-2), null, 2)} (last 2 tests)
                Mission NEET Scores: ${JSON.stringify(missionNeetData.slice(-5), null, 2)} (last 5 tests)
                Syllabus Completion Status: ${JSON.stringify(chapterStatus, null, 2)}
                Upcoming Plans: ${JSON.stringify(upcomingPlans, null, 2)}
                Completed Tasks: ${JSON.stringify(completedTasks, null, 2)}

                Based on this data, what's the optimal next study topic, how many MCQs, and for how long? Provide a concise, actionable plan.`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                const apiKey = firebaseConfig.apiKey;

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    if (nextStudyPlanDisplay) nextStudyPlanDisplay.textContent = text;
                    showStatusMessage("Next study plan generated!", 'success');
                } else {
                    if (nextStudyPlanDisplay) nextStudyPlanDisplay.textContent = "Could not generate a study plan. Please try again or add more data.";
                    console.error("Unexpected AI response structure for next study plan:", result);
                    showStatusMessage("Failed to generate study plan.", 'error');
                }
            } catch (error) {
                console.error("Error fetching next study plan:", error);
                if (nextStudyPlanDisplay) nextStudyPlanDisplay.textContent = "An error occurred while fetching the study plan.";
                showStatusMessage("Error fetching next study plan.", 'error');
            } finally {
                if (getNextStudyPlanButton) getNextStudyPlanButton.disabled = false;
            }
        }
        if (getNextStudyPlanButton) getNextStudyPlanButton.addEventListener('click', getNextStudyPlan);


        // --- Concept Explainer Function ---
        async function explainConcept() {
            if (userId === 'not-authenticated') {
                showStatusMessage("Please sign in to use the Concept Explainer.", 'error');
                if (conceptExplanationDisplay) conceptExplanationDisplay.textContent = "Please sign in to use the Concept Explainer.";
                return;
            }
            const concept = conceptInput.value.trim();
            if (!concept) {
                showStatusMessage("Please enter a concept or doubt to explain.", 'error');
                if (conceptExplanationDisplay) conceptExplanationDisplay.textContent = "Please enter a concept or doubt to explain.";
                return;
            }

            if (conceptExplanationDisplay) conceptExplanationDisplay.textContent = "Generating explanation...";
            if (explainConceptButton) explainConceptButton.disabled = true;
            showStatusMessage("Getting concept explanation...", 'info');

            try {
                const prompt = `Explain the concept of "${concept}" in detail, as if you are teaching a NEET UG aspirant. Focus on clarity, accuracy, and include any relevant examples, diagrams (describe them), or common misconceptions. Keep the explanation concise but comprehensive.`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                const apiKey = firebaseConfig.apiKey;

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    if (conceptExplanationDisplay) conceptExplanationDisplay.textContent = text;
                    showStatusMessage("Concept explained!", 'success');
                } else {
                    if (conceptExplanationDisplay) conceptExplanationDisplay.textContent = "Could not explain the concept. Please try again.";
                    console.error("Unexpected AI response structure for concept explanation:", result);
                    showStatusMessage("Failed to explain concept.", 'error');
                }
            } catch (error) {
                console.error("Error fetching concept explanation:", error);
                if (conceptExplanationDisplay) conceptExplanationDisplay.textContent = "An error occurred while fetching the explanation.";
                showStatusMessage("Error fetching concept explanation.", 'error');
            } finally {
                if (explainConceptButton) explainConceptButton.disabled = false;
            }
        }
        if (explainConceptButton) explainConceptButton.addEventListener('click', explainConcept);


        // --- Revision Topic Suggester Function ---
        async function suggestRevisionTopics() {
            if (userId === 'not-authenticated') {
                showStatusMessage("Please sign in to get revision suggestions.", 'error');
                if (revisionSuggestionsDisplay) revisionSuggestionsDisplay.textContent = "Please sign in to get revision suggestions.";
                return;
            }
            if (revisionSuggestionsDisplay) revisionSuggestionsDisplay.textContent = "Analyzing your data and generating revision suggestions...";
            if (suggestRevisionTopicsButton) suggestRevisionTopicsButton.disabled = true;
            showStatusMessage("Generating revision topics...", 'info');

            try {
                let prompt = `Based on the following NEET UG study data, suggest 3-5 specific topics or chapters for revision. Explain briefly why each topic is suggested (e.g., low scores, not reviewed recently). Prioritize topics that appear to be weak areas or have been neglected. Incorporate advice from NEET UG toppers on effective revision strategies.

                --- Your Unit Test Data ---\n${JSON.stringify(utTestData, null, 2) || "No Unit Test data."}\n\n
                --- Your BB Classes Test Series Data ---\n${JSON.stringify(bbctsData, null, 2) || "No BBCTS data."}\n\n
                --- Your Quarterly Test Data ---\n${JSON.stringify(quarterlyData, null, 2) || "No Quarterly Test data."}\n\n
                --- Your Mission NEET Test Data ---\n${JSON.stringify(missionNeetData, null, 2) || "No Mission NEET data."}\n\n
                --- Your Daily Log Entries (recent topics studied/backlogs) ---\n${JSON.stringify(regularDataLogs.slice(-5), null, 2) || "No recent daily logs."} (showing last 5 entries)\n\n
                --- Your Syllabus Completion Status (completed tasks by chapter) ---\n${JSON.stringify(chapterStatus, null, 2) || "No chapter completion data."}\n\n
                --- Upcoming Plans ---\n${JSON.stringify(upcomingPlans, null, 2) || "No upcoming plans."}\n\n
                --- Completed Tasks ---\n${JSON.stringify(completedTasks, null, 2) || "No completed tasks."}\n\n
                `;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                const apiKey = firebaseConfig.apiKey;

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    if (revisionSuggestionsDisplay) revisionSuggestionsDisplay.textContent = text;
                    showStatusMessage("Revision suggestions received!", 'success');
                } else {
                    if (revisionSuggestionsDisplay) revisionSuggestionsDisplay.textContent = "Could not generate revision suggestions. Please try again or add more data.";
                    console.error("Unexpected AI response structure for revision suggestions:", result);
                    showStatusMessage("Failed to get revision suggestions.", 'error');
                }
            } catch (error) {
                console.error("Error fetching revision suggestions:", error);
                if (revisionSuggestionsDisplay) revisionSuggestionsDisplay.textContent = "An error occurred while fetching revision suggestions.";
                showStatusMessage("Error fetching revision suggestions.", 'error');
            } finally {
                if (suggestRevisionTopicsButton) suggestRevisionTopicsButton.disabled = false;
            }
        }
        if (suggestRevisionTopicsButton) suggestRevisionTopicsButton.addEventListener('click', suggestRevisionTopics);

        // --- Mock Test Question Generator Function ---
        async function generatePracticeQuestions() {
            if (userId === 'not-authenticated') {
                showStatusMessage("Please sign in to generate practice questions.", 'error');
                if (generatedQuestionsDisplay) generatedQuestionsDisplay.textContent = "Please sign in to generate practice questions.";
                return;
            }
            const subject = questionSubjectSelect.value;
            const topic = questionTopicInput.value.trim();

            if (!subject || !topic) {
                showStatusMessage("Please select a subject and enter a topic to generate questions.", 'error');
                if (generatedQuestionsDisplay) generatedQuestionsDisplay.textContent = "Please select a subject and enter a topic.";
                return;
            }

            if (generatedQuestionsDisplay) generatedQuestionsDisplay.textContent = "Generating practice questions...";
            if (generateQuestionsButton) generateQuestionsButton.disabled = true;
            showStatusMessage("Generating questions...", 'info');

            try {
                const prompt = `Generate 3 multiple-choice questions (MCQs) for NEET UG aspirants on the topic of "${topic}" in "${subject}". For each question, provide 4 options (A, B, C, D), indicate the correct answer, and give a brief explanation for the correct answer. Format the output clearly with Q1, Q2, Q3, then options, then Answer: [Correct Option], and then Explanation: [Explanation].`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                const apiKey = firebaseConfig.apiKey;

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    if (generatedQuestionsDisplay) generatedQuestionsDisplay.textContent = text;
                    showStatusMessage("Questions generated!", 'success');
                } else {
                    if (generatedQuestionsDisplay) generatedQuestionsDisplay.textContent = "Could not generate questions. Please try again.";
                    console.error("Unexpected AI response structure for question generation:", result);
                    showStatusMessage("Failed to generate questions.", 'error');
                }
            } catch (error) {
                console.error("Error fetching questions:", error);
                if (generatedQuestionsDisplay) generatedQuestionsDisplay.textContent = "An error occurred while generating questions.";
                showStatusMessage("Error generating questions.", 'error');
            } finally {
                if (generateQuestionsButton) generateQuestionsButton.disabled = false;
            }
        }
        if (generateQuestionsButton) generateQuestionsButton.addEventListener('click', generatePracticeQuestions);

        // --- NEW: Weakness Identification & Targeted Practice Function ---
        async function identifyWeaknessesAndSuggestPractice() {
            if (userId === 'not-authenticated') {
                showStatusMessage("Please sign in to identify weaknesses and get practice tips.", 'error');
                if (weaknessAnalysisDisplay) weaknessAnalysisDisplay.textContent = "Please sign in to identify weaknesses.";
                return;
            }

            if (utTestData.length === 0 && bbctsData.length === 0 && quarterlyData.length === 0 && missionNeetData.length === 0 && regularDataLogs.length === 0 && Object.keys(chapterStatus).length === 0) {
                showStatusMessage("No study data available for weakness analysis. Please enter some data.", 'error');
                if (weaknessAnalysisDisplay) weaknessAnalysisDisplay.textContent = "No study data available for weakness analysis. Please enter some data in Daily Routine, My Tests, and Goals tabs.";
                return;
            }

            if (weaknessAnalysisDisplay) weaknessAnalysisDisplay.textContent = "Analyzing your data to identify weaknesses and suggest practice tips...";
            if (identifyWeaknessesButton) identifyWeaknessesButton.disabled = true;
            showStatusMessage("Identifying weaknesses...", 'info');

            try {
                let prompt = `As a NEET UG study assistant, analyze the user's comprehensive study data to identify specific weak areas (topics/chapters) across Physics, Chemistry, and Biology. For each identified weakness, provide targeted, actionable practice suggestions. These suggestions should include:
                - Specific topics/concepts to revisit.
                - Recommended types of practice (e.g., MCQs, theory revision, numerical problems).
                - Potential resources (e.g., "re-read NCERT for X," "solve more questions from Y book/module").
                - A suggested time allocation for addressing this weakness.
                
                Prioritize weaknesses based on low test scores, frequent backlogs in daily logs, or incomplete/struggled syllabus topics. Structure your response clearly with identified weaknesses and corresponding practice tips. Incorporate advice from NEET UG toppers on how to overcome weak areas.

                --- User's Current Data ---
                Daily Logs (recent 7 entries): ${JSON.stringify(regularDataLogs.slice(-7), null, 2) || "No recent daily logs."}
                Unit Test Scores (recent 3 tests): ${JSON.stringify(utTestData.slice(-3), null, 2) || "No UT test data."}
                BBCTS Scores (recent 3 tests): ${JSON.stringify(bbctsData.slice(-3), null, 2) || "No BBCTS test data."}
                Quarterly Scores (recent 2 tests): ${JSON.stringify(quarterlyData.slice(-2), null, 2) || "No Quarterly test data."}
                Mission NEET Scores (recent 5 tests): ${JSON.stringify(missionNeetData.slice(-5), null, 2) || "No Mission NEET data."}
                Syllabus Completion Status: ${JSON.stringify(chapterStatus, null, 2) || "No chapter completion data."}
                Upcoming Plans: ${JSON.stringify(upcomingPlans, null, 2)}
                Completed Tasks: ${JSON.stringify(completedTasks, null, 2)}

                Provide a detailed, actionable analysis.`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                const apiKey = firebaseConfig.apiKey;

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    if (weaknessAnalysisDisplay) weaknessAnalysisDisplay.textContent = text;
                    showStatusMessage("Weakness analysis received!", 'success');
                } else {
                    if (weaknessAnalysisDisplay) weaknessAnalysisDisplay.textContent = "Could not identify weaknesses. Please try again.";
                    console.error("Unexpected AI response structure for weakness analysis:", result);
                    showStatusMessage("Failed to identify weaknesses.", 'error');
                }
            } catch (error) {
                console.error("Error fetching weakness analysis:", error);
                if (weaknessAnalysisDisplay) weaknessAnalysisDisplay.textContent = "An error occurred while fetching weakness analysis.";
                showStatusMessage("Error fetching weakness analysis.", 'error');
            } finally {
                if (identifyWeaknessesButton) identifyWeaknessesButton.disabled = false;
            }
        }
        if (identifyWeaknessesButton) identifyWeaknessesButton.addEventListener('click', identifyWeaknessesAndSuggestPractice);


        // --- NEET Countdown Logic ---
        function getNeetUGDate() {
            const year = 2026;
            const month = 4; // May is 4 (0-indexed)
            let date = new Date(year, month, 1);
            // Find the first Sunday of May
            while (date.getDay() !== 0) { // 0 is Sunday
                date.setDate(date.getDate() + 1);
            }
            return date;
        }

        const neetUGDate = getNeetUGDate();

        function updateCountdown() {
            const now = new Date().getTime();
            const distance = neetUGDate.getTime() - now;

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            if (distance < 0) {
                if (countdownTimerDisplay) countdownTimerDisplay.textContent = "NEET UG 2026 has begun!";
                clearInterval(countdownInterval);
            } else {
                if (countdownTimerDisplay) countdownTimerDisplay.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
            }
        }

        let countdownInterval = setInterval(updateCountdown, 1000);

        // --- Motivational Quote Logic ---
        async function displayRandomQuoteAndSave() {
            const randomIndex = Math.floor(Math.random() * motivationalQuotes.length);
            const selectedQuote = motivationalQuotes[randomIndex];
            if (motivationalQuoteDisplay) {
                motivationalQuoteDisplay.textContent = `"${selectedQuote}"`;
            }

            if (userId && userId !== 'loading' && userId !== 'not-authenticated') {
                const today = new Date().toISOString().split('T')[0];
                const quoteStateDocRef = doc(db, `artifacts/${appId}/users/${userId}/appState`, 'quoteState');
                try {
                    await setDoc(quoteStateDocRef, {
                        lastQuoteDate: today,
                        lastQuoteIndex: randomIndex
                    });
                    console.log("Quote state saved to Firestore.");
                } catch (error) {
                    console.error("Error saving quote state:", error);
                }
            }
        }

        function displayRandomLoginQuote() {
            const randomIndex = Math.floor(Math.random() * motivationalQuotes.length);
            const selectedQuote = motivationalQuotes[randomIndex];
            if (loginQuoteDisplay) {
                loginQuoteDisplay.textContent = `"${selectedQuote}"`;
            }
        }

        // --- AI Goals Insights ---
        async function getAIGoalsInsights() {
            if (userId === 'not-authenticated') {
                showStatusMessage("Please sign in to get AI progress insights.", 'error');
                if (aiGoalsAnalysisDisplay) aiGoalsAnalysisDisplay.textContent = "Please sign in to get AI progress insights.";
                return;
            }

            let totalTasks = 0;
            let completedTasks = 0;

            [physicsGoalsData, chemistryGoalsData, biologyGoalsData].forEach(subjectData => {
                subjectData.forEach(chapterObj => {
                    const chapterName = chapterObj['Chapter Name'];
                    const subject = subjectData === physicsGoalsData ? 'physics' : (subjectData === chemistryGoalsData ? 'chemistry' : 'biology');
                    const baseChapterKey = `${subject}-${chapterName.replace(/\s|\(|\)/g, '_').replace(/_+/g, '_').toLowerCase()}`;

                    const subCategoriesForSubject = subject === 'physics' || subject === 'chemistry' ? physicsChemistrySubCategoriesOrdered : biologySubCategoriesOrdered;

                    // Count the chapter itself as a task if it doesn't have topics
                    if (!chapterObj.Topics || chapterObj.Topics.length === 0) {
                        totalTasks += subCategoriesForSubject.length; // Each book/module counts as a task for the chapter
                        subCategoriesForSubject.forEach(cat => {
                            const topicKey = `${baseChapterKey}-${baseChapterKey}`; // For biology, topicKey is same as chapterKey
                            if (chapterStatus[baseChapterKey] && chapterStatus[baseChapterKey][topicKey] && chapterStatus[baseChapterKey][topicKey].isCompleted) {
                                completedTasks++;
                            }
                        });
                    } else {
                        // For physics/chemistry, each topic is a task
                        chapterObj.Topics.forEach(topic => {
                            totalTasks += subCategoriesForSubject.length;
                            subCategoriesForSubject.forEach(cat => {
                                const topicKey = `${baseChapterKey}-${topic.replace(/\s|\(|\)/g, '_').replace(/_+/g, '_').toLowerCase()}`;
                                if (chapterStatus[baseChapterKey] && chapterStatus[baseChapterKey][topicKey] && chapterStatus[baseChapterKey][topicKey].isCompleted) {
                                    completedTasks++;
                                }
                            });
                        });
                    }
                });
            });

            if (totalTasks === 0) {
                if (aiGoalsAnalysisDisplay) aiGoalsAnalysisDisplay.textContent = "No syllabus data loaded to analyze. Please ensure chapters are loaded.";
                showStatusMessage("No syllabus data loaded.", 'error');
                return;
            }

            if (aiGoalsAnalysisDisplay) aiGoalsAnalysisDisplay.textContent = "Generating AI progress insights...";
            if (getAIGoalsInsightsButton) getAIGoalsInsightsButton.disabled = true;
            showStatusMessage("Getting AI progress insights...", 'info');

            try {
                const completionPercentage = (completedTasks / totalTasks) * 100;
                const remainingTasks = totalTasks - completedTasks;

                const targetDate = new Date('2026-03-07');
                const now = new Date();
                const daysRemainingUntilTarget = Math.ceil((targetDate - now) / (1000 * 60 * 60 * 24));

                let paceMessage = "";
                if (daysRemainingUntilTarget > 0 && remainingTasks > 0) {
                    const tasksPerDayNeeded = remainingTasks / daysRemainingUntilTarget;
                    paceMessage = `To complete the remaining ${remainingTasks} tasks by March 7, 2026, you need to cover approximately ${tasksPerDayNeeded.toFixed(2)} tasks per day.`;
                } else if (remainingTasks === 0) {
                    paceMessage = "You've completed all tasks! Excellent work!";
                } else {
                    paceMessage = "Keep up the great work!";
                }


                let prompt = `I have completed ${completedTasks} out of ${totalTasks} syllabus tasks (chapters + sub-categories) for NEET UG 2026. This is ${completionPercentage.toFixed(2)}% of the syllabus tasks. I have ${remainingTasks} tasks left. ${paceMessage} Provide an encouraging message about my progress and how much farther I have until completion. Incorporate advice from NEET UG toppers on staying motivated and consistent. Keep it concise and motivating.`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                const apiKey = firebaseConfig.apiKey;

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    if (aiGoalsAnalysisDisplay) aiGoalsAnalysisDisplay.textContent = text;
                    showStatusMessage("AI progress insights received!", 'success');
                } else {
                    if (aiGoalsAnalysisDisplay) aiGoalsAnalysisDisplay.textContent = "Could not get AI progress insights. Please try again.";
                    console.error("Unexpected AI response structure for goals analysis:", result);
                    showStatusMessage("Failed to get AI progress insights.", 'error');
                }
            } catch (error) {
                console.error("Error fetching AI progress insights:", error);
                if (aiGoalsAnalysisDisplay) aiGoalsAnalysisDisplay.textContent = "An error occurred while fetching AI progress insights.";
                showStatusMessage("Error fetching AI progress insights.", 'error');
            } finally {
                if (getAIGoalsInsightsButton) getAIGoalsInsightsButton.disabled = false;
            }
        }


        // --- Event Listeners and Initial Setup ---

        // Event listeners for save buttons
        if (saveDailyLogButton) saveDailyLogButton.addEventListener('click', saveDailyLog);
        if (saveUTButton) saveUTButton.addEventListener('click', saveUTData);
        if (saveBBCTSButton) saveBBCTSButton.addEventListener('click', saveBBCTSData);
        if (saveQuarterlyButton) saveQuarterlyButton.addEventListener('click', saveQuarterlyData);
        if (saveMissionNeetButton) saveMissionNeetButton.addEventListener('click', saveMissionNeetData);
        if (getAIGoalsInsightsButton) getAIGoalsInsightsButton.addEventListener('click', getAIGoalsInsights);
        if (savePlanButton) savePlanButton.addEventListener('click', saveUpcomingPlan); // NEW

        // Auth button listeners
        if (googleSignInButton) googleSignInButton.addEventListener('click', handleGoogleSignIn);
        if (signOutButton) signOutButton.addEventListener('click', handleSignOut);

        // NEW: Daily Routine - Subject/Book/Chapter/Topic dynamic population
        if (logSubjectSelect) {
            logSubjectSelect.addEventListener('change', () => {
                populateLogBookDropdown();
                populateLogChapterDropdown(); // Clear chapter/topics when subject changes
            });
        }
        if (logBookSelect) {
            logBookSelect.addEventListener('change', () => {
                populateLogChapterDropdown();
            });
        }
        if (logChapterSelect) {
            logChapterSelect.addEventListener('change', () => {
                populateLogTopicsChecklist();
            });
        }

        // NEW: MCQ Source toggle
        if (logMCQSourceSelect) {
            logMCQSourceSelect.addEventListener('change', () => {
                if (logMCQSourceSelect.value === 'Custom') {
                    manualMCQSourceSection.style.display = 'flex';
                    manualMCQTimeSection.style.display = 'flex';
                } else {
                    manualMCQSourceSection.style.display = 'none';
                    manualMCQTimeSection.style.display = 'none';
                    logManualMCQSourceNameInput.value = '';
                    logManualMCQTimeInput.value = '';
                }
            });
        }

        // NEW: Load syllabus data into global variables
        function loadSyllabusData() {
            physicsGoalsData = syllabusData.Physics.map(chapter => ({ 'Chapter Name': chapter['Chapter Name'], Topics: chapter.Topics || [] }));
            chemistryGoalsData = syllabusData.Chemistry.map(chapter => ({ 'Chapter Name': chapter['Chapter Name'], Topics: chapter.Topics || [] }));
            biologyGoalsData = syllabusData.Biology.map(chapter => ({ 'Chapter Name': chapter['Chapter Name'] })); // Biology has no topics
        }


        // NEW: Populate "Book/Module" dropdown based on selected subject
        function populateLogBookDropdown() {
            const selectedSubject = logSubjectSelect.value;
            logBookSelect.innerHTML = '<option value="">Select Book/Module</option>';
            logBookSelect.disabled = true;

            let categories = [];
            if (selectedSubject === 'Physics' || selectedSubject === 'Chemistry') {
                categories = physicsChemistrySubCategoriesOrdered;
            } else if (selectedSubject === 'Biology') {
                categories = biologySubCategoriesOrdered;
            }

            if (categories.length > 0) {
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.key;
                    option.textContent = cat.name;
                    logBookSelect.appendChild(option);
                });
                logBookSelect.disabled = false;
            }
        }

        // NEW: Populate "Chapter" dropdown based on selected subject
        function populateLogChapterDropdown() {
            const selectedSubject = logSubjectSelect.value;
            logChapterSelect.innerHTML = '<option value="">Select Chapter</option>';
            logChapterSelect.disabled = true;
            logTopicsContainer.innerHTML = '';
            logTopicsContainer.classList.add('hidden');
            biologyTopicNote.classList.add('hidden');


            if (selectedSubject) {
                const chapters = syllabusData[selectedSubject];
                if (chapters && chapters.length > 0) {
                    chapters.forEach(chapter => {
                        const option = document.createElement('option');
                        option.value = chapter['Chapter Name'];
                        option.textContent = chapter['Chapter Name'];
                        logChapterSelect.appendChild(option);
                    });
                    logChapterSelect.disabled = false;
                }
            }
        }

        // NEW: Populate "Topics" checklist based on selected chapter for Physics/Chemistry
        function populateLogTopicsChecklist() {
            const selectedSubject = logSubjectSelect.value;
            const selectedChapterName = logChapterSelect.value;
            logTopicsContainer.innerHTML = '';
            logTopicsContainer.classList.add('hidden');
            biologyTopicNote.classList.add('hidden');


            if (selectedSubject === 'Biology') {
                biologyTopicNote.classList.remove('hidden');
                return;
            }

            const subjectData = syllabusData[selectedSubject];
            const selectedChapter = subjectData ? subjectData.find(c => c['Chapter Name'] === selectedChapterName) : null;

            if (selectedChapter && selectedChapter.Topics && selectedChapter.Topics.length > 0) {
                selectedChapter.Topics.forEach(topic => {
                    const label = document.createElement('label');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = topic;
                    const span = document.createElement('span');
                    span.textContent = topic;
                    label.appendChild(checkbox);
                    label.appendChild(span);
                    logTopicsContainer.appendChild(label);
                });
                logTopicsContainer.classList.remove('hidden');
            } else if (selectedChapterName) {
                // If a chapter is selected but has no defined topics (e.g., if a P/C chapter wasn't given topics)
                logTopicsContainer.innerHTML = '<p class="text-gray-500">No specific topics listed for this chapter.</p>';
                logTopicsContainer.classList.remove('hidden');
            }
        }

        // NEW: Display daily logs for the currently selected date in the "Today" tab
        function displayDailyLogsForDate(date) {
            const logsForToday = regularDataLogs.filter(log => log.date === date);
            dailyLogDisplay.innerHTML = ''; // Clear previous entries

            if (logsForToday.length === 0) {
                dailyLogDisplay.textContent = `No entries for ${date}.`;
                return;
            }

            logsForToday.forEach(log => {
                const logItem = document.createElement('div');
                logItem.classList.add('daily-log-item');
                if (log.isCompleted) logItem.classList.add('completed');

                let topicsHtml = log.topics && log.topics.length > 0 ? `<p><strong>Topics:</strong> ${log.topics.join(', ')}</p>` : '';
                let mcqSourceInfo = '';
                if (log.mcqSource === 'Custom' && log.mcqSourceName) {
                    mcqSourceInfo = ` (Source: ${log.mcqSourceName}${log.mcqSourceTime ? `, ${log.mcqSourceTime}` : ''})`;
                } else if (log.mcqSource && log.mcqSource !== 'Custom') {
                    mcqSourceInfo = ` (Source: ${log.mcqSource})`;
                }

                logItem.innerHTML = `
                    <p><strong>Subject:</strong> ${log.subject || 'N/A'}</p>
                    <p><strong>Book/Module:</strong> ${log.book || 'N/A'}</p>
                    <p><strong>Chapter:</strong> ${log.chapter || 'N/A'}</p>
                    ${topicsHtml}
                    <p><strong>Study Type:</strong> ${log.studyTypes && log.studyTypes.length > 0 ? log.studyTypes.join(', ') : 'N/A'}</p>
                    <p><strong>MCQs Practised:</strong> ${log.mcqCount || 0} questions${mcqSourceInfo}</p>
                    <p><strong>Time Spent:</strong> ${log.timeSpent || 'N/A'}</p>
                    ${log.comments ? `<p><strong>Comments:</strong> ${log.comments}</p>` : ''}
                    <div class="action-buttons">
                        <button class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-1 px-3 rounded-lg text-sm edit-log-btn" data-id="${log.id}">Edit</button>
                        <button class="bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-lg text-sm delete-log-btn" data-id="${log.id}">Delete</button>
                    </div>
                `;
                dailyLogDisplay.appendChild(logItem);

                logItem.querySelector('.delete-log-btn').addEventListener('click', (e) => {
                    if (confirm('Are you sure you want to delete this log entry?')) {
                        deleteDailyLogEntry(e.target.dataset.id);
                    }
                });
                // TODO: Implement edit functionality later
                logItem.querySelector('.edit-log-btn').addEventListener('click', (e) => {
                    showStatusMessage("Edit functionality coming soon!", "info");
                });
            });
        }

        // NEW: Render Upcoming Plans
        function renderUpcomingPlans() {
            upcomingPlansDisplay.innerHTML = '';
            if (upcomingPlans.length === 0) {
                upcomingPlansDisplay.textContent = "No upcoming plans.";
                return;
            }

            const sortedPlans = [...upcomingPlans].sort((a, b) => new Date(a.date) - new Date(b.date));

            sortedPlans.forEach(plan => {
                const planItem = document.createElement('div');
                planItem.classList.add('daily-log-item');
                if (plan.isCompleted) planItem.classList.add('completed');
                if (plan.isBacklog) planItem.classList.add('backlog'); // Apply backlog styling

                planItem.innerHTML = `
                    <p><strong>Date:</strong> ${plan.date}</p>
                    <p><strong>Subject:</strong> ${plan.subject}</p>
                    <p><strong>Task:</strong> ${plan.chapter}</p>
                    <p><strong>Type:</strong> ${plan.studyType || 'N/A'}</p>
                    <p><strong>Estimated Time:</strong> ${plan.estimatedTime || 'N/A'}</p>
                    ${plan.comments ? `<p><strong>Comments:</strong> ${plan.comments}</p>` : ''}
                    <div class="action-buttons">
                        ${!plan.isCompleted ? `<button class="bg-green-500 hover:bg-green-600 text-white font-semibold py-1 px-3 rounded-lg text-sm mark-completed-plan-btn" data-id="${plan.id}">Mark Completed</button>` : '<span>✅ Completed</span>'}
                        <button class="bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-lg text-sm delete-plan-btn" data-id="${plan.id}">Delete</button>
                    </div>
                `;
                upcomingPlansDisplay.appendChild(planItem);

                if (!plan.isCompleted) {
                    planItem.querySelector('.mark-completed-plan-btn').addEventListener('click', (e) => {
                        markUpcomingPlanCompleted(e.target.dataset.id);
                    });
                }
                planItem.querySelector('.delete-plan-btn').addEventListener('click', (e) => {
                    if (confirm('Are you sure you want to delete this plan?')) {
                        deleteUpcomingPlan(e.target.dataset.id);
                    }
                });
            });
        }

        async function deleteUpcomingPlan(planId) {
            const updatedPlans = upcomingPlans.filter(plan => plan.id !== planId);
            const success = await saveDataToFirestore(
                'dailyRoutine', 'upcomingPlans', updatedPlans,
                "Plan deleted!", "Error deleting plan."
            );
            if (success) {
                renderUpcomingPlans();
                updateBacklogs();
                renderCalendar();
            }
        }


        // NEW: Update Backlogs
        function updateBacklogs() {
            const today = new Date().toISOString().split('T')[0];
            const backlogs = upcomingPlans.filter(plan =>
                !plan.isCompleted && plan.date < today
            ).map(plan => ({ ...plan, isBacklog: true })); // Mark as backlog

            backlogsDisplay.innerHTML = ''; // Clear previous entries

            if (backlogs.length === 0) {
                backlogsDisplay.textContent = "No pending backlogs.";
                return;
            }

            backlogs.forEach(plan => {
                const backlogItem = document.createElement('div');
                backlogItem.classList.add('daily-log-item', 'backlog'); // Apply backlog styling

                backlogItem.innerHTML = `
                    <p><strong>Overdue:</strong> ${plan.date}</p>
                    <p><strong>Subject:</strong> ${plan.subject}</p>
                    <p><strong>Task:</strong> ${plan.chapter}</p>
                    <p><strong>Type:</strong> ${plan.studyType || 'N/A'}</p>
                    <p><strong>Estimated Time:</strong> ${plan.estimatedTime || 'N/A'}</p>
                    ${plan.comments ? `<p><strong>Previous Comments:</strong> ${plan.comments}</p>` : ''}
                    <div class="mt-4 flex flex-col gap-2">
                        <label class="text-sm font-medium text-gray-700">Reschedule To:</label>
                        <input type="date" class="reschedule-date-input w-full" value="${currentDate}">
                        <label class="text-sm font-medium text-gray-700">Reason/Comment (Optional):</label>
                        <textarea class="reschedule-comment-input w-full text-sm" placeholder="Why was this delayed?"></textarea>
                    </div>
                    <div class="action-buttons">
                        <button class="bg-green-500 hover:bg-green-600 text-white font-semibold py-1 px-3 rounded-lg text-sm mark-completed-backlog-btn" data-id="${plan.id}">Mark Completed</button>
                        <button class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1 px-3 rounded-lg text-sm reschedule-backlog-btn" data-id="${plan.id}">Reschedule</button>
                    </div>
                `;
                backlogsDisplay.appendChild(backlogItem);

                backlogItem.querySelector('.mark-completed-backlog-btn').addEventListener('click', (e) => {
                    markUpcomingPlanCompleted(e.target.dataset.id);
                });

                backlogItem.querySelector('.reschedule-backlog-btn').addEventListener('click', (e) => {
                    const newDate = backlogItem.querySelector('.reschedule-date-input').value;
                    const comment = backlogItem.querySelector('.reschedule-comment-input').value;
                    if (newDate) {
                        rescheduleBacklog(e.target.dataset.id, newDate, comment);
                    } else {
                        showStatusMessage("Please select a new date to reschedule.", "error");
                    }
                });
            });
        }

        // NEW: Render Completed Tasks
        function renderCompletedTasks() {
            completedTasksDisplay.innerHTML = '';
            if (completedTasks.length === 0) {
                completedTasksDisplay.textContent = "No completed tasks yet.";
                return;
            }

            const sortedCompleted = [...completedTasks].sort((a, b) => new Date(b.completionDate || b.date) - new Date(a.completionDate || a.date)); // Sort by completion date or original date

            sortedCompleted.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.classList.add('daily-log-item', 'completed');
                taskItem.innerHTML = `
                    <p><strong>Completed On:</strong> ${task.completionDate || task.date}</p>
                    <p><strong>Subject:</strong> ${task.subject || 'N/A'}</p>
                    <p><strong>Task:</strong> ${task.chapter || 'N/A'}</p>
                    <p><strong>Type:</strong> ${task.studyType || task.studyTypes?.join(', ') || 'N/A'}</p>
                    <p><strong>Time Spent/Estimated:</strong> ${task.timeSpent || task.estimatedTime || 'N/A'}</p>
                    ${task.comments ? `<p><strong>Comments:</strong> ${task.comments}</p>` : ''}
                `;
                completedTasksDisplay.appendChild(taskItem);
            });
        }


        // NEW: Update Daily Summary Block
        function updateDailySummary() {
            const today = currentDate;
            const logsForToday = regularDataLogs.filter(log => log.date === today && log.isCompleted);

            let chaptersDoneToday = new Set();
            let timeSpentToday = 0; // in minutes
            let totalMCQsToday = 0;

            logsForToday.forEach(log => {
                if (log.chapter) chaptersDoneToday.add(log.chapter);
                if (log.timeSpent) {
                    const parts = log.timeSpent.match(/(\d+h)?\s*(\d+m)?/);
                    let hours = parseInt(parts[1]) || 0;
                    let minutes = parseInt(parts[2]) || 0;
                    timeSpentToday += (hours * 60) + minutes;
                }
                totalMCQsToday += log.mcqCount || 0;
            });

            const pendingBacklogs = upcomingPlans.filter(plan => !plan.isCompleted && plan.date < today).length;
            const totalPlannedItems = upcomingPlans.length + regularDataLogs.length; // Count daily logs as planned if they appear in this view
            const totalCompletedItems = completedTasks.length;
            const percentageCompleted = totalPlannedItems > 0 ? (totalCompletedItems / totalPlannedItems) * 100 : 0;

            dailySummaryBlock.innerHTML = `
                <p><strong>Chapters Done Today:</strong> ${chaptersDoneToday.size}</p>
                <p><strong>Time Spent Today:</strong> ${Math.floor(timeSpentToday / 60)}h ${timeSpentToday % 60}m</p>
                <p><strong>Total MCQs Today:</strong> ${totalMCQsToday}</p>
                <p><strong>Pending Backlogs:</strong> ${pendingBacklogs}</p>
                <p><strong>% of Planned Items Completed:</strong> ${percentageCompleted.toFixed(2)}%</p>
            `;
        }

        // NEW: Draw a circular progress chart (for MCQ Quota)
        function drawCircularProgressChart(canvasElement, current, target, labelText, color, instanceVar) {
            const ctx = canvasElement.getContext('2d');
            destroyChart(instanceVar); // Destroy previous instance

            const percentage = target > 0 ? (current / target) * 100 : 0;
            const dataValue = Math.min(percentage, 100); // Cap at 100%

            const newChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [dataValue, 100 - dataValue],
                        backgroundColor: [color, '#e5e7eb'], // Filled color, background color
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%', // Adjust thickness of the circle
                    plugins: {
                        tooltip: {
                            enabled: false
                        },
                        legend: {
                            display: false
                        }
                    },
                    events: [] // Disable all events
                }
            });

            // Update the text display
            canvasElement.nextElementSibling.textContent = labelText; // Label text is already correct here

            return newChartInstance;
        }


        // NEW: Update MCQ Quota Charts and display total for today
        async function updateMCQQuotaCharts() {
            const today = currentDate;
            const logsForToday = regularDataLogs.filter(log => log.date === today && log.studyTypes.includes('MCQs'));

            dailyMCQCount = { Physics: 0, Chemistry: 0, Biology: 0 };
            logsForToday.forEach(log => {
                if (log.subject && log.mcqCount) {
                    dailyMCQCount[log.subject] = (dailyMCQCount[log.subject] || 0) + log.mcqCount;
                }
            });

            physicsMCQQuotaValue.textContent = `${dailyMCQCount.Physics}/${mcqQuotas.Physics}`;
            chemistryMCQQuotaValue.textContent = `${dailyMCQCount.Chemistry}/${mcqQuotas.Chemistry}`;
            biologyMCQQuotaValue.textContent = `${dailyMCQCount.Biology}/${mcqQuotas.Biology}`;

            // Draw/update charts
            physicsMCQChartInstance = drawCircularProgressChart(physicsMCQQuotaChart.querySelector('canvas') || document.createElement('canvas'), dailyMCQCount.Physics, mcqQuotas.Physics, 'Physics', '#3b82f6', physicsMCQChartInstance);
            chemistryMCQChartInstance = drawCircularProgressChart(chemistryMCQQuotaChart.querySelector('canvas') || document.createElement('canvas'), dailyMCQCount.Chemistry, mcqQuotas.Chemistry, 'Chemistry', '#f97316', chemistryMCQChartInstance);
            biologyMCQChartInstance = drawCircularProgressChart(biologyMCQQuotaChart.querySelector('canvas') || document.createElement('canvas'), dailyMCQCount.Biology, mcqQuotas.Biology, 'Biology', '#10b981', biologyMCQChartInstance);

            // Check for quota completion and trigger AI praise
            clearTimeout(aiMCQEmotionMessageTimeout); // Clear previous timeout
            aiMCQEmotionMessage.classList.add('hidden'); // Hide previous message

            const subjectsMetQuota = [];
            if (dailyMCQCount.Physics >= mcqQuotas.Physics) subjectsMetQuota.push('Physics');
            if (dailyMCQCount.Chemistry >= mcqQuotas.Chemistry) subjectsMetQuota.push('Chemistry');
            if (dailyMCQCount.Biology >= mcqQuotas.Biology) subjectsMetQuota.push('Biology');

            if (subjectsMetQuota.length > 0) {
                generateMCQQuotaPraise(subjectsMetQuota);
            }

            renderCalendar(); // Update calendar with MCQ quota status
        }

        // NEW: AI praise for MCQ quota
        async function generateMCQQuotaPraise(subjects) {
            if (userId === 'not-authenticated') return;

            const subjectList = subjects.join(' and ');
            const prompt = `Generate a very short, encouraging, and celebratory message (max 15 words) with an emoji for meeting or exceeding the daily MCQ quota for ${subjectList}. Example: "Awesome work! Physics MCQs crushed! 🎉" or "Fantastic! You nailed all your subject quotas today! 🚀"`;

            try {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = firebaseConfig.apiKey;
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                let aiMessage = "Great job on your MCQs today!";
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    aiMessage = result.candidates[0].content.parts[0].text;
                }
                aiMCQEmotionMessage.textContent = aiMessage;
                aiMCQEmotionMessage.classList.remove('hidden');
                aiMCQEmotionMessageTimeout = setTimeout(() => {
                    aiMCQEmotionMessage.classList.add('hidden');
                }, 5000); // Hide after 5 seconds
            } catch (error) {
                console.error("Error generating AI MCQ praise:", error);
                // Do nothing, just don't show message
            }
        }


        // NEW: Calendar rendering logic
        function renderCalendar() {
            if (!calendarGrid || !currentMonthYearDisplay) return;

            calendarGrid.innerHTML = ''; // Clear previous grid
            const today = new Date();
            const currentDayString = today.toISOString().split('T')[0];
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const firstDayOfWeek = firstDayOfMonth.getDay(); // 0 for Sunday, 1 for Monday

            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            currentMonthYearDisplay.textContent = `${monthNames[currentMonth]} ${currentYear}`;

            const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
            dayNames.forEach(day => {
                const dayNameDiv = document.createElement('div');
                dayNameDiv.classList.add('day-name');
                dayNameDiv.textContent = day;
                calendarGrid.appendChild(dayNameDiv);
            });

            // Add empty cells for days before the first day of the month
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.classList.add('date-cell', 'empty');
                calendarGrid.appendChild(emptyCell);
            }

            // Add date cells
            for (let date = 1; date <= daysInMonth; date++) {
                const dateCell = document.createElement('div');
                dateCell.classList.add('date-cell');
                const fullDateString = new Date(currentYear, currentMonth, date).toISOString().split('T')[0];

                const dateNumber = document.createElement('div');
                dateNumber.classList.add('date-number');
                dateNumber.textContent = date;
                dateCell.appendChild(dateNumber);

                if (fullDateString === currentDayString) {
                    dateCell.classList.add('today');
                } else if (new Date(fullDateString) < today) {
                    dateCell.classList.add('past-day');
                }

                // Add tuition schedule
                const dayOfWeek = new Date(currentYear, currentMonth, date).getDay(); // 0-6
                const dayName = dayNames[dayOfWeek];
                const dailyTuitions = tuitionSchedule[dayName];
                if (dailyTuitions && dailyTuitions.length > 0) {
                    dailyTuitions.forEach(tuition => {
                        const tuitionDiv = document.createElement('div');
                        tuitionDiv.classList.add('tuition-slot');
                        tuitionDiv.textContent = `${tuition.subject.substring(0,3)}: ${tuition.time}`;
                        if (tuition.subject === 'Biology') tuitionDiv.classList.add('bio');
                        if (tuition.subject === 'Physics' || tuition.subject === 'Chemistry') tuitionDiv.classList.add('phychem');
                        dateCell.appendChild(tuitionDiv);
                    });
                }

                // Add event markers based on data
                const logsForThisDay = regularDataLogs.filter(log => log.date === fullDateString);
                const plansForThisDay = upcomingPlans.filter(plan => plan.date === fullDateString);
                const backlogsForThisDay = upcomingPlans.filter(plan => plan.date === fullDateString && !plan.isCompleted && new Date(plan.date) < today);

                // Upcoming plans marker
                if (plansForThisDay.length > 0 && new Date(fullDateString) > today) {
                    const marker = document.createElement('div');
                    marker.classList.add('event-marker', 'upcoming');
                    dateCell.appendChild(marker);
                }

                // Backlog marker (persistent)
                if (backlogsForThisDay.length > 0) {
                    const marker = document.createElement('div');
                    marker.classList.add('event-marker', 'backlog');
                    dateCell.appendChild(marker);
                }

                // MCQ Quota status markers
                const dailySubjectMCQs = { Physics: 0, Chemistry: 0, Biology: 0 };
                logsForThisDay.forEach(log => {
                    if (log.subject && log.mcqCount && log.studyTypes.includes('MCQs')) {
                        dailySubjectMCQs[log.subject] = (dailySubjectMCQs[log.subject] || 0) + log.mcqCount;
                    }
                });

                let missedQuota = false;
                let exceededQuota = false;

                if (fullDateString < currentDayString) { // Only check for past days
                    if (mcqQuotas.Physics > 0 && dailySubjectMCQs.Physics < mcqQuotas.Physics) missedQuota = true;
                    if (mcqQuotas.Chemistry > 0 && dailySubjectMCQs.Chemistry < mcqQuotas.Chemistry) missedQuota = true;
                    if (mcqQuotas.Biology > 0 && dailySubjectMCQs.Biology < mcqQuotas.Biology) missedQuota = true;

                    if (dailySubjectMCQs.Physics >= mcqQuotas.Physics ||
                        dailySubjectMCQs.Chemistry >= mcqQuotas.Chemistry ||
                        dailySubjectMCQs.Biology >= mcqQuotas.Biology) {
                            exceededQuota = true;
                    }
                } else if (fullDateString === currentDayString) { // For today
                    if (dailyMCQCount.Physics >= mcqQuotas.Physics ||
                        dailyMCQCount.Chemistry >= mcqQuotas.Chemistry ||
                        dailyMCQCount.Biology >= mcqQuotas.Biology) {
                            exceededQuota = true;
                    }
                }


                if (missedQuota) {
                    const marker = document.createElement('div');
                    marker.classList.add('event-marker', 'mcq-missed');
                    dateCell.appendChild(marker);
                }
                if (exceededQuota) {
                    const marker = document.createElement('div');
                    marker.classList.add('event-marker', 'mcq-exceeded');
                    dateCell.appendChild(marker);
                }


                calendarGrid.appendChild(dateCell);
            }
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        }

        prevMonthButton.addEventListener('click', () => changeMonth(-1));
        nextMonthButton.addEventListener('click', () => changeMonth(1));


        // Initial setup on window load
        window.onload = () => {
            initializeFirebase();
            loadSyllabusData(); // Load the detailed syllabus data
            populateLogBookDropdown(); // Populate book dropdown for daily routine
            populateLogChapterDropdown(); // Populate chapter dropdown for daily routine
            populateLogMCQSourceDropdown(); // Populate MCQ source dropdown
            activateMainTab('regularData'); // Set 'Daily Routine' as the default active main tab
            // Set today's date as default for daily log and all test entries
            const today = new Date().toISOString().split('T')[0];
            if (logDateInput) logDateInput.value = today;
            if (utDateInput) utDateInput.value = today;
            if (bbctsDateInput) bbctsDateInput.value = today;
            if (qtDateInput) qtDateInput.value = today;
            if (mnDateInput) mnDateInput.value = today;
            if (planDateInput) planDateInput.value = today;

            // Initial countdown update
            updateCountdown();
            displayRandomLoginQuote(); // Set initial quote for login page

            // Render calendar initially
            renderCalendar();
        };

        // Adjust canvas size on window resize to make it responsive
        window.addEventListener('resize', () => {
            if (tabContents.analytics && tabContents.analytics.classList.contains('active')) {
                if (analyticsSubTabContents.syllabusProgression && analyticsSubTabContents.syllabusProgression.classList.contains('active')) {
                    drawSyllabusProgressionChart();
                } else {
                    drawAllCharts();
                }
            }
        });

        // NEW: Populate MCQ Source dropdown
        function populateLogMCQSourceDropdown() {
            logMCQSourceSelect.innerHTML = '<option value="">Select Source (Optional)</option>';
            logMCQSourceSelect.innerHTML += '<option value="Custom">Other/Manual Entry</option>'; // Always allow custom

            const allCategories = [...physicsChemistrySubCategoriesOrdered, ...biologySubCategoriesOrdered];
            const uniqueCategoryNames = new Set();
            allCategories.forEach(cat => uniqueCategoryNames.add(cat.name));

            Array.from(uniqueCategoryNames).sort().forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                logMCQSourceSelect.appendChild(option);
            });
        }

        // Initialize MCQ quota charts on load (they will be empty until data is logged)
        if (physicsMCQQuotaChart && chemistryMCQQuotaChart && biologyMCQQuotaChart) {
            // Need to append canvas elements first if they don't exist
            if (!physicsMCQQuotaChart.querySelector('canvas')) {
                const canvas = document.createElement('canvas');
                physicsMCQQuotaChart.appendChild(canvas);
            }
            if (!chemistryMCQQuotaChart.querySelector('canvas')) {
                const canvas = document.createElement('canvas');
                chemistryMCQQuotaChart.appendChild(canvas);
            }
            if (!biologyMCQQuotaChart.querySelector('canvas')) {
                const canvas = document.createElement('canvas');
                biologyMCQQuotaChart.appendChild(canvas);
            }
            updateMCQQuotaCharts();
        }

        // Initial render of goals checkboxes
        renderSubcategoryCheckboxes('physics');
        renderSubcategoryCheckboxes('biology'); // This one is hidden by default.

    </script>
</body>
</html>
```
