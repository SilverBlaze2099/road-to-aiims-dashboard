<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Road to AIIMS</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background: linear-gradient(to bottom right, #e0f7fa, #bbdefb, #e3f2fd);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem;
            box-sizing: border-box;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        .container {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            padding: 2.5rem;
            width: 100%;
            max-width: 1200px; /* Increased max-width for calendar */
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        textarea {
            min-height: 150px;
            resize: vertical;
        }
        input[type="text"], input[type="number"], input[type="date"], input[type="time"], textarea, select {
            background-color: #f8fafc;
            border: 1px solid #cbd5e1;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
        }
        input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, input[type="time"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        .data-display {
            background-color: #f0f4f7;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1.25rem;
            min-height: 120px;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-y: auto;
            max-height: 350px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            color: #334155;
        }
        .tab-button {
            padding: 0.85rem 1.8rem;
            border-radius: 0.75rem;
            font-weight: 700;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 2px solid transparent;
            background-color: #e2e8f0;
            color: #475569;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .tab-button.active {
            background: linear-gradient(to right, #60a5fa, #3b82f6);
            color: #ffffff;
            border-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(59, 130, 246, 0.3);
        }
        .tab-button:not(.active):hover {
            background-color: #d1d5db;
            color: #1e293b;
            transform: translateY(-1px);
        }
        .sub-tab-button {
            padding: 0.6rem 1.2rem;
            border-radius: 0.6rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 1px solid transparent;
            font-size: 0.95rem;
            background-color: #e0f2f7;
            color: #0d9488;
        }
        .sub-tab-button.active {
            background: linear-gradient(to right, #2dd4bf, #14b8a6);
            color: #ffffff;
            border-color: #0f766e;
            box-shadow: 0 3px 6px rgba(45, 212, 191, 0.3);
        }
        .sub-tab-button:not(.active):hover {
            background-color: #a7f3d0;
            color: #064e3b;
        }
        .tab-content, .sub-tab-content { display: none; }
        .tab-content.active, .sub-tab-content.active { display: block; }

        .status-message {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1000;
            padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 500;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); opacity: 0; transition: opacity 0.3s ease-in-out;
        }
        .status-message.show { opacity: 1; }
        .status-message.success { background-color: #d1fae5; color: #065f46; }
        .status-message.error { background-color: #fee2e2; color: #991b1b; }
        .status-message.info { background-color: #e0f2fe; color: #1e40af; }

        .chart-container {
            position: relative; width: 100%; max-width: 700px; height: 350px; margin: 1rem auto;
            background-color: #ffffff; border: 1px solid #e5e7eb; border-radius: 0.75rem;
            padding: 1rem; box-sizing: border-box; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        #countdown-container {
            background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3); padding: 1.5rem; border-radius: 1rem;
            text-align: center; margin-bottom: 2rem; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            color: #1a202c; position: relative; overflow: hidden;
        }
        #countdown-timer { font-size: 2.5rem; font-weight: 800; color: #00796b; margin-top: 0.5rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        #motivational-quote { font-style: italic; margin-top: 1rem; font-size: 1.25rem; color: #4a5568; line-height: 1.5; }

        #login-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: url('https://placehold.co/1920x1080/60a5fa/ffffff?text=NEET+Success+Journey') no-repeat center center/cover;
            display: flex; justify-content: center; align-items: center; z-index: 1000;
            transition: opacity 0.5s ease-in-out; opacity: 1;
        }
        #login-page.hidden { opacity: 0; pointer-events: none; }
        #login-card {
            background-color: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px);
            border-radius: 1.5rem; padding: 2.5rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            text-align: center; width: 90%; max-width: 500px; animation: fadeInScale 0.7s ease-out forwards;
        }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        /* New Calendar Styles */
        #studyCalendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-header { font-weight: bold; text-align: center; padding: 0.5rem; background-color: #e2e8f0; border-radius: 4px; }
        .calendar-day { border: 1px solid #e2e8f0; border-radius: 6px; min-height: 120px; padding: 8px; font-size: 0.8rem; transition: background-color 0.2s; }
        .calendar-day.other-month { background-color: #f8fafc; color: #9ca3af; }
        .calendar-day.today { border: 2px solid #3b82f6; background-color: #eff6ff; }
        .day-number { font-weight: bold; font-size: 1rem; }
        .tuition-bio { background-color: #dcfce7; }
        .tuition-chem { background-color: #fef9c3; }
        .tuition-phy { background-color: #fee2e2; }
        .tuition-time { font-size: 0.7rem; color: #4b5563; }
        .backlog-marker { background-color: #fca5a5; border-color: #ef4444; }
        .upcoming-marker { background-color: #a5f3fc; border-color: #06b6d4; }
        .quota-fail { border-left: 5px solid #ef4444; }
        .quota-met { border-left: 5px solid #22c55e; }
        .quota-exceeded { border-left: 5px solid #f97316; }
        .ai-emoji { font-size: 1.25rem; text-align: right; }

        /* Quota Graph Styles */
        .quota-graph-container { width: 120px; height: 120px; position: relative; }
    </style>
</head>
<body>
    <!-- Full-screen Login Page -->
    <div id="login-page">
        <!-- Login Card content remains the same -->
    </div>

    <!-- Main App Content (Hidden until logged in) -->
    <div id="main-app-content" class="container hidden">
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-6">Road to AIIMS</h1>
        <!-- Countdown and other elements remain the same -->

        <!-- Main Tab Navigation -->
        <div class="flex justify-center gap-4 mb-8 flex-wrap">
            <button id="tabRegularData" class="tab-button active">Daily Routine</button>
            <button id="tabTests" class="tab-button">My Tests</button>
            <button id="tabAnalytics" class="tab-button">Analytics & Graphs</button>
            <button id="tabGoals" class="tab-button">Goals</button>
            <button id="tabAISuggestions" class="tab-button">AI Suggestions</button>
        </div>
        
        <!-- User info and Sign Out remains the same -->

        <!-- MODIFIED Daily Routine Tab -->
        <div id="contentRegularData" class="tab-content active">
            <!-- New Daily Routine Sub-Tabs -->
            <div class="flex justify-start gap-3 mb-6 flex-wrap">
                <button id="drSubTabToday" class="sub-tab-button active">Today</button>
                <button id="drSubTabUpcoming" class="sub-tab-button">Upcoming Plans</button>
                <button id="drSubTabBacklogs" class="sub-tab-button">Backlogs</button>
                <button id="drSubTabCompleted" class="sub-tab-button">Completed</button>
            </div>

            <!-- Today Sub-Tab Content -->
            <div id="drSubContentToday" class="sub-tab-content active">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Left Column: Calendar & Quota Graphs -->
                    <div>
                        <div class="flex items-center justify-between mb-4">
                            <button id="prevMonthBtn" class="bg-gray-200 hover:bg-gray-300 p-2 rounded-full">&lt;</button>
                            <h2 id="calendarMonthYear" class="text-xl font-bold text-gray-800"></h2>
                            <button id="nextMonthBtn" class="bg-gray-200 hover:bg-gray-300 p-2 rounded-full">&gt;</button>
                        </div>
                        <div id="studyCalendar"></div>
                        <div class="mt-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2 text-center">Daily MCQ Quota</h3>
                            <div id="dailyQuotaGraphs" class="flex justify-around items-center">
                                <!-- Graphs will be injected by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Data Entry -->
                    <div class="flex flex-col gap-6">
                        <!-- Physics Entry -->
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                             <h3 class="text-xl font-semibold text-gray-700 mb-3">Physics Log</h3>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <select id="physicsChapter" class="w-full"><option value="">Select Chapter</option></select>
                                <select id="physicsBook" class="w-full"><option value="">Select Book</option></select>
                            </div>
                            <div id="physicsTopicsContainer" class="mt-3 grid grid-cols-2 gap-2"></div>
                            <div class="mt-3 flex flex-wrap gap-4 items-center">
                                <input type="number" id="physicsMcqsBook" placeholder="Book MCQs" class="w-28">
                                <input type="text" id="physicsMcqsManualSource" placeholder="Other Source" class="flex-grow">
                                <input type="number" id="physicsMcqsManual" placeholder="MCQs" class="w-24">
                            </div>
                             <button id="addPhysicsEntry" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Add Physics Entry</button>
                        </div>
                        <!-- Chemistry Entry -->
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                             <h3 class="text-xl font-semibold text-gray-700 mb-3">Chemistry Log</h3>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <select id="chemistryChapter" class="w-full"><option value="">Select Chapter</option></select>
                                <select id="chemistryBook" class="w-full"><option value="">Select Book</option></select>
                            </div>
                            <div id="chemistryTopicsContainer" class="mt-3 grid grid-cols-2 gap-2"></div>
                             <div class="mt-3 flex flex-wrap gap-4 items-center">
                                <input type="number" id="chemistryMcqsBook" placeholder="Book MCQs" class="w-28">
                                <input type="text" id="chemistryMcqsManualSource" placeholder="Other Source" class="flex-grow">
                                <input type="number" id="chemistryMcqsManual" placeholder="MCQs" class="w-24">
                            </div>
                             <button id="addChemistryEntry" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Add Chemistry Entry</button>
                        </div>
                        <!-- Biology Entry -->
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                             <h3 class="text-xl font-semibold text-gray-700 mb-3">Biology Log</h3>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <select id="biologyChapter" class="w-full"><option value="">Select Chapter</option></select>
                                <select id="biologyBook" class="w-full"><option value="">Select Book</option></select>
                            </div>
                            <!-- No topics for Biology -->
                             <div class="mt-3 flex flex-wrap gap-4 items-center">
                                <input type="number" id="biologyMcqsBook" placeholder="Book MCQs" class="w-28">
                                <input type="text" id="biologyMcqsManualSource" placeholder="Other Source" class="flex-grow">
                                <input type="number" id="biologyMcqsManual" placeholder="MCQs" class="w-24">
                            </div>
                             <button id="addBiologyEntry" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Add Biology Entry</button>
                        </div>
                    </div>
                </div>
                 <div class="mt-8">
                    <h3 class="text-lg font-semibold text-gray-800">Entries for Today:</h3>
                    <div id="todayLogDisplay" class="data-display">No entries logged for today yet.</div>
                </div>
            </div>

            <!-- Upcoming Plans Sub-Tab Content -->
            <div id="drSubContentUpcoming" class="sub-tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Plan Your Study</h2>
                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 grid grid-cols-1 md:grid-cols-4 gap-4">
                     <input type="date" id="planDate">
                     <select id="planSubject"><option value="">Select Subject</option><option value="Physics">Physics</option><option value="Chemistry">Chemistry</option><option value="Biology">Biology</option></select>
                     <input type="text" id="planChapter" placeholder="Chapter/Topic">
                     <button id="addPlanButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">Add Plan</button>
                </div>
                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-800">Your Upcoming Plans:</h3>
                    <div id="upcomingPlansDisplay" class="data-display">No upcoming plans.</div>
                </div>
            </div>

            <!-- Backlogs Sub-Tab Content -->
            <div id="drSubContentBacklogs" class="sub-tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Pending Backlogs</h2>
                <div id="backlogsDisplay" class="data-display">No backlogs found. Great job!</div>
            </div>

            <!-- Completed Sub-Tab Content -->
            <div id="drSubContentCompleted" class="sub-tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Completed Tasks Log</h2>
                <div id="completedLogDisplay" class="data-display">No tasks completed yet.</div>
            </div>
        </div>

        <!-- Other main tab contents (Tests, Analytics, Goals, AI Suggestions) remain structurally the same but will be affected by JS changes -->
        <div id="contentTests" class="tab-content">...</div>
        <div id="contentAnalytics" class="tab-content">...</div>
        <div id="contentGoals" class="tab-content">...</div>
        <div id="contentAISuggestions" class="tab-content">...</div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        // Replace the values below with your actual Firebase project details
        const firebaseConfig = {
          apiKey: "AIzaSyA29MM64OLCgKRfnl8tr-I39IIoBE-RLFM",
          authDomain: "my-neet-tracker-app.firebaseapp.com",
          projectId: "my-neet-tracker-app",
          storageBucket: "my-neet-tracker-app.firebasestorage.app",
          messagingSenderId: "931350823768",
          appId: "1:931350823768:web:b01f2325b8292d7dbd5b2d",
          measurementId: "G-3WEYVYQRYE"
        };

        // --- Initialize Firebase ---
        let app = initializeApp(firebaseConfig);
        let db = getFirestore(app);
        let auth = getAuth(app);
        let userId = 'loading', userEmail = 'Not Logged In';
        let utTestData = [], bbctsData = [], quarterlyData = [], missionNeetData = [];
        let chapterStatus = {};
        let physicsGoalsData = [], chemistryGoalsData = [], biologyGoalsData = [];

        // NEW: Data stores for Daily Routine Redesign
        let dailyLogEntries = []; // All entries for all days
        let upcomingPlansData = []; // For "Upcoming Plans" tab
        let completedTasksData = []; // For "Completed" tab

        // Physics Topics Map
        const physicsTopics = {
            'Units and Measurements': ['SI units (fundamental & derived)', 'Least count', 'Significant figures', 'Errors in measurement', 'Dimensions & dimensional analysis'],
            'Motion in a Straight Line': ['Frame of reference', 'Position–time & velocity–time graphs', 'Speed, velocity, acceleration (uniform & non-uniform)', 'Average vs instantaneous velocity', 'Equations of motion under uniform acceleration'],
            'Motion in a Plane': ['Scalars vs vectors', 'Vector operations (addition, subtraction, dot & cross products)', 'Unit vectors, resolution of vectors', 'Relative velocity', 'Projectile motion', 'Uniform circular motion'],
            'Laws of Motion': ['Force, inertia, Newton’s 3 laws', 'Momentum, impulse & conservation of momentum', 'Equilibrium of forces', 'Friction (static, kinetic, rolling)', 'Dynamics of circular motion (centripetal force; banked roads)'],
            'Work, Energy and Power': ['Work by constant & variable forces', 'Kinetic & potential energy', 'Work–energy theorem', 'Power', 'Mechanical energy conservation', 'Conservative vs non-conservative forces', 'Motion in vertical circles', 'Elastic & inelastic collisions'],
            'System of Particles and Rotational Motion': ['Centre of mass (two-particle & rigid bodies)', 'Torque & moment of force', 'Moment of inertia, radius of gyration', 'Angular momentum & its conservation', 'Parallel & perpendicular axis theorems', 'Dynamics & equilibrium of rigid bodies'],
            'Gravitation': ['Newton’s universal law', 'Acceleration due to gravity (variation)', 'Kepler’s laws', 'Gravitational potential & energy', 'Escape velocity', 'Satellite motion (orbital velocity, period, energy)'],
            'Mechanical Properties of Solids': ['Elastic behaviour, stress–strain', 'Hooke’s law', 'Young’s, shear & bulk moduli'],
            'Mechanical Properties of Fluids': ['Pressure in fluids, buoyancy', 'Equation of continuity', 'Bernoulli’s theorem', 'Viscosity', 'Surface tension'],
            'Thermal Properties of Matter': ['Thermal expansion', 'Specific heat capacity, calorimetry', 'Latent heat', 'Heat transfer: conduction, convection, radiation'],
            'Thermodynamics': ['Zeroth, first & second laws', 'Internal energy & work', 'Processes: isothermal, adiabatic, cyclic', 'Carnot cycle & engine'],
            'Kinetic Theory': ['Ideal gas equation', 'RMS speed & Maxwell’s distribution', 'Degrees of freedom & equipartition theorem'],
            'Oscillations': ['Simple harmonic motion (SHM): definition, equation', 'Energy in SHM'],
            'Waves': ['Wave parameters (wavelength, frequency, speed)', 'Transverse & longitudinal waves', 'Wave propagation & interaction'],
            'Electric Charges and Fields': ['Coulomb’s law & system of charges', 'Electric field (lines, flux)', 'Gauss’s law & applications', 'Electric dipole in field'],
            'Electrostatic Potential and Capacitance': ['Electric potential & potential energy', 'Equipotential surfaces', 'Capacitors (parallel plate), combinations', 'Energy stored in capacitors'],
            'Current Electricity': ['Ohm’s law & resistivity', 'Series & parallel circuits', 'Kirchhoff’s laws', 'Electrical energy and power'],
            'Moving Charges and Magnetism': ['Magnetic force on moving charges & currents', 'Biot–Savart law, Ampère’s law'],
            'Magnetism and Matter': ['Magnetic dipole & dipole moment', 'Torque on dipole in magnetic field', 'Magnetic properties of materials'],
            'Electromagnetic Induction': ['Faraday’s law & Lenz’s law', 'Induced emf & current', 'Self and mutual inductance'],
            'Alternating Current': ['AC voltage & current in pure resistive, inductive, and capacitive circuits', 'LC oscillation', 'Resonance in LCR circuits'],
            'Electromagnetic Waves': ['Maxwell’s equations (qualitative)', 'Electromagnetic spectrum & properties'],
            'Ray Optics and Optical Instruments': ['Reflection, refraction, lenses, mirrors, magnification', 'Human eye (defects & correction)', 'Microscopes & telescopes'],
            'Wave Optics': ['Huygens’ principle', 'Interference, diffraction', 'Young’s double slit experiment'],
            'Dual Nature of Radiation and Matter': ['Photoelectric effect', 'de Broglie wavelength', 'Matter waves'],
            'Atoms': ['Rutherford & Bohr models', 'Energy levels, spectra, transitions'],
            'Nuclei': ['Composition & size of nucleus', 'Radioactivity (α, β, γ); decay law', 'Nuclear binding energy & fission/fusion'],
            'Semiconductor Electronics': ['Intrinsic & extrinsic semiconductors', 'p‑n junction diode operation & characteristics', 'Diode as rectifier; Zener diode', 'Logic Gates'],
        };

        // Chemistry Topics Map
        const chemistryTopics = {
            'Some Basic Concepts of Chemistry': ['Matter and its nature', 'Laws of chemical combination', 'Dalton’s atomic theory', 'Atoms, molecules, elements, compounds', 'Atomic and molecular masses', 'Mole concept, molar mass', 'Percentage composition', 'Empirical and molecular formulas', 'Chemical equations and stoichiometry'],
            'Structure of Atom': ['Subatomic particles', 'Atomic number, mass number, isotopes & isobars', 'Bohr’s model of the atom', 'Dual nature of matter & radiation', 'Quantum mechanical model', 'Electronic configuration'],
            'Classification of Elements & Periodicity in Properties': ['Modern periodic table & periodic law', 'Periodic trends: atomic/ionic radii, ionization enthalpy, electron gain enthalpy, electronegativity, valency'],
            'Chemical Bonding & Molecular Structure': ['Valence electrons & bond types', 'Lewis structures & resonance', 'VSEPR theory', 'Hybridization', 'Valence bond theory', 'Hydrogen bonding'],
            'Thermodynamics': ['System and surroundings', 'State and path functions, internal energy (ΔU), enthalpy (ΔH)', 'First law: P–V work, heat capacity, Hess’s law', 'Second law: entropy & spontaneity', 'Gibbs free energy'],
            'Equilibrium': ['Physical and chemical equilibrium', 'Law of mass action & equilibrium constant', 'Le Chatelier’s principle', 'Ionic equilibrium: pH, buffer solutions, solubility product & common-ion effect'],
            'Redox Reactions': ['Oxidation states and balancing redox reactions', 'Electrochemical cells (galvanic)'],
            'Some p‑Block Elements': ['General introduction & electronic configuration', 'Physical and chemical properties of group‑13 to group‑18', 'Unique behaviour of first elements'],
            'Organic Chemistry – Some Basic Principles & Techniques': ['IUPAC nomenclature', 'Electronic displacement effects', 'Isomerism', 'Reaction intermediates', 'Hybridization in organic compounds'],
            'Hydrocarbons': ['Alkanes, alkenes, alkynes, aromatic hydrocarbons', 'Conformations & isomerism', 'Electrophilic addition & substitution reactions'],
            'Solutions': ['Types of solutions, concentration terms', 'Colligative properties'],
            'Electrochemistry': ['Electrochemical cell, electrode potential', 'Nernst equation, conductance, electrolysis'],
            'Chemical Kinetics': ['Rate of reaction, order & molecularity', 'Rate laws and factors affecting reaction rate'],
            'The d‑ & f‑Block Elements': ['Electronic configuration', 'Oxidation states, color, magnetic properties, catalytic behavior', 'Preparation and properties of K₂Cr₂O₇ and KMnO₄'],
            'Coordination Compounds': ['Werner’s theory & terminology', 'Ligands, coordination numbers, chelation', 'IUPAC nomenclature & isomerism', 'Bonding theories: VBT & basics of CFT', 'Color, magnetic properties, biological/industrial importance'],
            'Haloalkanes and Haloarenes': ['Structure & nomenclature', 'Preparation and substitution mechanisms', 'Environmental effects'],
            'Alcohols, Phenols and Ethers': ['Structure, preparation, classification', 'Physical properties & acidic behavior', 'Reactions: dehydration, electrophilic substitution in phenols'],
            'Aldehydes, Ketones and Carboxylic Acids': ['Structure & nomenclature', 'Reactivity of carbonyl group', 'Oxidation & reduction', 'aldol condensation, Cannizzaro, haloform tests'],
            'Amines': ['Structure, classification', 'Basicity and identification tests', 'Diazonium salts and their synthetic importance'],
            'Biomolecules': ['Carbohydrates', 'Proteins', 'Vitamins', 'Nucleic acids (DNA/RNA)', 'Hormones'],
        };
        
        // --- NEW: DOM Element Selectors for Daily Routine Redesign ---
        const drSubTabButtons = {
            today: document.getElementById('drSubTabToday'),
            upcoming: document.getElementById('drSubTabUpcoming'),
            backlogs: document.getElementById('drSubTabBacklogs'),
            completed: document.getElementById('drSubTabCompleted'),
        };
        const drSubTabContents = {
            today: document.getElementById('drSubContentToday'),
            upcoming: document.getElementById('drSubContentUpcoming'),
            backlogs: document.getElementById('drSubContentBacklogs'),
            completed: document.getElementById('drSubContentCompleted'),
        };

        // Calendar elements
        const calendarEl = document.getElementById('studyCalendar');
        const calendarMonthYearEl = document.getElementById('calendarMonthYear');
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        // Quota Graph Elements
        const dailyQuotaGraphsEl = document.getElementById('dailyQuotaGraphs');
        let physicsQuotaChart, chemistryQuotaChart, biologyQuotaChart;
        
        // "Today" Log Form Elements
        // (Getting these elements dynamically inside functions is safer)
        const todayLogDisplay = document.getElementById('todayLogDisplay');

        // "Upcoming Plans" Form Elements
        const planDateInput = document.getElementById('planDate');
        const planSubjectInput = document.getElementById('planSubject');
        const planChapterInput = document.getElementById('planChapter');
        const addPlanButton = document.getElementById('addPlanButton');
        const upcomingPlansDisplay = document.getElementById('upcomingPlansDisplay');

        // "Backlogs" and "Completed" Display Elements
        const backlogsDisplay = document.getElementById('backlogsDisplay');
        const completedLogDisplay = document.getElementById('completedLogDisplay');
        

        // --- NEW & MODIFIED FUNCTIONS ---

        /**
         * Initializes the app, sets up listeners for NEW data structures.
         */
        function setupDataListeners() {
            // ... (All your existing onSnapshot listeners for tests, goals, etc. remain here)

            // NEW: Listener for Daily Log Entries
            const dailyLogDocRef = doc(db, `artifacts/${appId}/users/${userId}/dailyLogs`, 'allEntries');
            onSnapshot(dailyLogDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    dailyLogEntries = JSON.parse(docSnap.data().content || "[]");
                } else {
                    dailyLogEntries = [];
                }
                renderTodayLog();
                updateAllQuotaGraphs();
                renderCalendar(); 
            });

            // NEW: Listener for Upcoming Plans
            const upcomingPlansDocRef = doc(db, `artifacts/${appId}/users/${userId}/upcomingPlans`, 'allPlans');
            onSnapshot(upcomingPlansDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    upcomingPlansData = JSON.parse(docSnap.data().content || "[]");
                } else {
                    upcomingPlansData = [];
                }
                renderUpcomingPlans();
                renderBacklogs();
                renderCalendar();
            });
            
            // NEW: Listener for Completed Tasks
            const completedTasksDocRef = doc(db, `artifacts/${appId}/users/${userId}/completedTasks`, 'allCompleted');
            onSnapshot(completedTasksDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    completedTasksData = JSON.parse(docSnap.data().content || "[]");
                } else {
                    completedTasksData = [];
                }
                renderCompletedTasks();
            });
        }
        
        /**
         * Handles switching between the new Daily Routine sub-tabs.
         */
        function activateDRSubTab(subTabName) {
            Object.values(drSubTabButtons).forEach(btn => btn.classList.remove('active'));
            Object.values(drSubTabContents).forEach(content => content.classList.remove('active'));
            if (drSubTabButtons[subTabName]) drSubTabButtons[subTabName].classList.add('active');
            if (drSubTabContents[subTabName]) drSubTabContents[subTabName].classList.add('active');
        }

        /**
         * Renders the calendar for the current month and year.
         */
        function renderCalendar() {
            calendarEl.innerHTML = '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            calendarMonthYearEl.textContent = `${new Date(currentYear, currentMonth).toLocaleString('default', { month: 'long' })} ${currentYear}`;

            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.classList.add('calendar-header');
                dayEl.textContent = day;
                calendarEl.appendChild(dayEl);
            });

            for (let i = 0; i < firstDay; i++) {
                calendarEl.appendChild(document.createElement('div'));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                const currentDate = new Date(currentYear, currentMonth, day);
                dayEl.classList.add('calendar-day');
                if (currentDate.getTime() === today.getTime()) {
                    dayEl.classList.add('today');
                }
                
                let dayHtml = `<div class="day-number">${day}</div>`;
                
                // Add tuition info
                const dayOfWeek = currentDate.getDay(); // 0=Sun, 1=Mon...
                if (dayOfWeek === 1 || dayOfWeek === 4) { // Mon, Thu
                    dayEl.classList.add('tuition-bio');
                    dayHtml += `<div class="tuition-time">Biology 9am-12pm</div>`;
                }
                if (dayOfWeek === 3 || dayOfWeek === 6) { // Wed, Sat
                    dayEl.classList.add('tuition-chem');
                    dayHtml += `<div class="tuition-time">Chem 9am-12pm</div>`;
                }
                 if (dayOfWeek === 3 || dayOfWeek === 6) { // Wed, Sat
                    dayEl.classList.add('tuition-phy');
                    dayHtml += `<div class="tuition-time">Physics 12:30pm-3:30pm</div>`;
                }

                // Add markers
                const dateString = currentDate.toISOString().split('T')[0];
                if (upcomingPlansData.some(p => p.date === dateString && !p.isCompleted)) dayEl.classList.add('upcoming-marker');
                if (upcomingPlansData.some(p => new Date(p.date) < today && !p.isCompleted)) dayEl.classList.add('backlog-marker');

                // Add Quota Info & AI Emoji
                const todaysEntries = dailyLogEntries.filter(e => e.date === dateString);
                if (todaysEntries.length > 0) {
                    const mcqs = todaysEntries.reduce((acc, curr) => {
                        acc[curr.subject.toLowerCase()] = (acc[curr.subject.toLowerCase()] || 0) + (curr.mcqsBook || 0) + (curr.mcqsManual || 0);
                        return acc;
                    }, {});
                    
                    const phyQuota = (mcqs['physics'] || 0) / 100;
                    const chemQuota = (mcqs['chemistry'] || 0) / 100;
                    const bioQuota = (mcqs['biology'] || 0) / 150;
                    
                    let aiEmoji = '';
                    if (phyQuota >= 1 && chemQuota >= 1 && bioQuota >= 1) {
                         aiEmoji = '🎯'; // All met
                         if(phyQuota > 1 || chemQuota > 1 || bioQuota > 1) aiEmoji = '🚀'; // Exceeded
                    } else if (phyQuota > 0 || chemQuota > 0 || bioQuota > 0) {
                         aiEmoji = '💪'; // In progress
                    }

                    if (phyQuota >= 1) dayEl.classList.add('quota-met');
                    else if (phyQuota > 0) dayEl.classList.add('quota-fail');

                    dayHtml += `<div class="ai-emoji">${aiEmoji}</div>`;
                }


                dayEl.innerHTML = dayHtml;
                calendarEl.appendChild(dayEl);
            }
        }

        /**
         * Populates chapter dropdowns based on loaded goals data.
         */
        function populateChapterDropdowns() {
            const physicsChapterSelect = document.getElementById('physicsChapter');
            const chemistryChapterSelect = document.getElementById('chemistryChapter');
            const biologyChapterSelect = document.getElementById('biologyChapter');

            physicsChapterSelect.innerHTML = '<option value="">Select Chapter</option>';
            physicsGoalsData.forEach(chapter => {
                physicsChapterSelect.innerHTML += `<option value="${chapter['Chapter Name']}">${chapter['Chapter Name']}</option>`;
            });

            chemistryChapterSelect.innerHTML = '<option value="">Select Chapter</option>';
            chemistryGoalsData.forEach(chapter => {
                chemistryChapterSelect.innerHTML += `<option value="${chapter['Chapter Name']}">${chapter['Chapter Name']}</option>`;
            });

            biologyChapterSelect.innerHTML = '<option value="">Select Chapter</option>';
            biologyGoalsData.forEach(chapter => {
                biologyChapterSelect.innerHTML += `<option value="${chapter['Chapter Name']}">${chapter['Chapter Name']}</option>`;
            });
        }
        
        /**
         * Populates the topics checklist when a chapter is selected.
         */
        function populateTopics(subject) {
            const chapterSelect = document.getElementById(`${subject}Chapter`);
            const topicsContainer = document.getElementById(`${subject}TopicsContainer`);
            const selectedChapter = chapterSelect.value;
            topicsContainer.innerHTML = '';
            
            if (subject === 'Biology' || !selectedChapter) return;

            const topics = subject === 'Physics' ? physicsTopics[selectedChapter] : chemistryTopics[selectedChapter];
            if (topics) {
                topics.forEach(topic => {
                    topicsContainer.innerHTML += `
                        <label class="flex items-center space-x-2 text-sm">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 rounded" value="${topic}">
                            <span>${topic}</span>
                        </label>`;
                });
            }
        }
        
        // ... (Your original window.onload, activateMainTab, etc. will need to be adapted)
        

        // Stub for initializeFirebase to prevent ReferenceError
        function initializeFirebase() {
            // If you have Firebase initialization logic, move it here.
            // Currently, Firebase is initialized above with initializeApp(firebaseConfig).
            // This stub prevents ReferenceError and allows the app to load.
        }

        window.onload = () => {
            initializeFirebase();
            loadGoalsData().then(() => {
                // Now that goals data is loaded, populate the new dropdowns
                populateChapterDropdowns();
            }); 
            
            activateMainTab('regularData');
            activateDRSubTab('today');
            
            renderCalendar();
            initializeQuotaGraphs();
            
            // Event Listeners for new features
            prevMonthBtn.addEventListener('click', () => {
                currentMonth--;
                if (currentMonth < 0) { currentMonth = 11; currentYear--; }
                renderCalendar();
            });
            nextMonthBtn.addEventListener('click', () => {
                currentMonth++;
                if (currentMonth > 11) { currentMonth = 0; currentYear++; }
                renderCalendar();
            });
            
            document.getElementById('physicsChapter').addEventListener('change', () => populateTopics('physics'));
            document.getElementById('chemistryChapter').addEventListener('change', () => populateTopics('chemistry'));

            document.getElementById('addPhysicsEntry').addEventListener('click', () => addDailyLogEntry('Physics'));
            document.getElementById('addChemistryEntry').addEventListener('click', () => addDailyLogEntry('Chemistry'));
            document.getElementById('addBiologyEntry').addEventListener('click', () => addDailyLogEntry('Biology'));
            
            addPlanButton.addEventListener('click', addUpcomingPlan);
            
            // Add listeners for new DR sub-tabs
            drSubTabButtons.today.addEventListener('click', () => activateDRSubTab('today'));
            drSubTabButtons.upcoming.addEventListener('click', () => activateDRSubTab('upcoming'));
            drSubTabButtons.backlogs.addEventListener('click', () => activateDRSubTab('backlogs'));
            drSubTabButtons.completed.addEventListener('click', () => activateDRSubTab('completed'));
        };


        // --- You would need to move the original `loadGoalsData` function here, and adapt other functions.
        // --- The following are NEW functions required for the redesign.

        async function addDailyLogEntry(subject) {
            const subjectLower = subject.toLowerCase();
            const chapter = document.getElementById(`${subjectLower}Chapter`).value;
            const book = document.getElementById(`${subjectLower}Book`).value;
            const mcqsBook = parseInt(document.getElementById(`${subjectLower}McqsBook`).value) || 0;
            const mcqsManualSource = document.getElementById(`${subjectLower}McqsManualSource`).value;
            const mcqsManual = parseInt(document.getElementById(`${subjectLower}McqsManual`).value) || 0;

            const topicsContainer = document.getElementById(`${subjectLower}TopicsContainer`);
            const coveredTopics = topicsContainer ? [...topicsContainer.querySelectorAll('input:checked')].map(el => el.value) : [];
            
            const newEntry = {
                id: `log-${Date.now()}`,
                date: new Date().toISOString().split('T')[0],
                subject: subject,
                chapter: chapter,
                coveredTopics: coveredTopics,
                book: book,
                mcqsBook: mcqsBook,
                mcqsManualSource: mcqsManualSource,
                mcqsManual: mcqsManual,
            };

            // Don't add if no data was entered
            if (!chapter && !mcqsBook && !mcqsManual) {
                showStatusMessage('Please enter a chapter or MCQ count.', 'error');
                return;
            }

            dailyLogEntries.push(newEntry);
            await setDoc(doc(db, `artifacts/${appId}/users/${userId}/dailyLogs`, 'allEntries'), { content: JSON.stringify(dailyLogEntries) });
            
            // Auto-complete in goals
            if (chapter) {
                const chapterKey = `${subjectLower}-${chapter.replace(/\s|\(|\)/g, '_').replace(/_+/g, '_').toLowerCase()}`;
                if (!chapterStatus[chapterKey]) chapterStatus[chapterKey] = {};

                coveredTopics.forEach(topic => {
                    // This part needs the subCategoryKey from the book dropdown.
                    // For now, let's assume a default. This logic needs refinement.
                    const subCategoryKey = 'ncert_questions'; // Placeholder
                    if (!chapterStatus[chapterKey][subCategoryKey]) {
                        chapterStatus[chapterKey][subCategoryKey] = {};
                    }
                    chapterStatus[chapterKey][subCategoryKey].isCompleted = true;
                    chapterStatus[chapterKey][subCategoryKey].completionDate = new Date().toISOString().split('T')[0];
                });
                await saveChapterStatus(); // Your existing function to save chapterStatus to Firestore
            }

            showStatusMessage(`${subject} entry logged!`, 'success');
            // Reset form fields for that subject
        }

        function renderTodayLog() {
            const todayString = new Date().toISOString().split('T')[0];
            const todaysEntries = dailyLogEntries.filter(entry => entry.date === todayString);
            if (todaysEntries.length === 0) {
                todayLogDisplay.innerHTML = 'No entries logged for today yet.';
                return;
            }
            todayLogDisplay.innerHTML = todaysEntries.map(entry => `
                <div class="p-2 border-b">
                    <strong>${entry.subject}:</strong> ${entry.chapter} <br>
                    Topics: ${entry.coveredTopics.join(', ') || 'N/A'} <br>
                    MCQs: ${entry.mcqsBook + entry.mcqsManual}
                </div>
            `).join('');
        }

        // Functions for Upcoming Plans, Backlogs, Completed would be similar,
        // involving manipulation of their respective data arrays and saving to Firestore.
        // Example for adding a plan:
        async function addUpcomingPlan() {
            const newPlan = {
                id: `plan-${Date.now()}`,
                date: planDateInput.value,
                subject: planSubjectInput.value,
                chapter: planChapterInput.value,
                isCompleted: false
            };
            if(!newPlan.date || !newPlan.subject || !newPlan.chapter) {
                showStatusMessage('Please fill all fields to add a plan.', 'error');
                return;
            }
            upcomingPlansData.push(newPlan);
            await setDoc(doc(db, `artifacts/${appId}/users/${userId}/upcomingPlans`, 'allPlans'), { content: JSON.stringify(upcomingPlansData) });
            showStatusMessage('Plan added!', 'success');
        }

        // Functions to initialize and update the doughnut charts
        function initializeQuotaGraphs() {
            const createQuotaChart = (canvasId, label) => {
                const canvas = document.createElement('canvas');
                const container = document.createElement('div');
                container.classList.add('quota-graph-container', 'text-center');
                container.innerHTML = `<div class="font-bold">${label}</div>`;
                container.appendChild(canvas);
                dailyQuotaGraphsEl.appendChild(container);
                const ctx = canvas.getContext('2d');
                return new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Done', 'Remaining'],
                        datasets: [{ data: [0, 100], backgroundColor: ['#22c55e', '#e5e7eb'], borderWidth: 0 }]
                    },
                    options: { responsive: true, cutout: '70%', plugins: { legend: { display: false } } }
                });
            };
            physicsQuotaChart = createQuotaChart('physQuota', 'Physics');
            chemistryQuotaChart = createQuotaChart('chemQuota', 'Chemistry');
            biologyQuotaChart = createQuotaChart('bioQuota', 'Biology');
        }

        function updateQuotaGraphs() {
             const todayString = new Date().toISOString().split('T')[0];
             const todaysEntries = dailyLogEntries.filter(entry => entry.date === todayString);
             const mcqs = todaysEntries.reduce((acc, curr) => {
                acc[curr.subject.toLowerCase()] = (acc[curr.subject.toLowerCase()] || 0) + (curr.mcqsBook || 0) + (curr.mcqsManual || 0);
                return acc;
            }, {});

            const updateChartData = (chart, done, total) => {
                const percentage = Math.min((done / total) * 100, 100);
                chart.data.datasets[0].data = [percentage, 100 - percentage];
                chart.update();
            };
            
            updateChartData(physicsQuotaChart, mcqs.physics || 0, 100);
            updateChartData(chemistryQuotaChart, mcqs.chemistry || 0, 100);
            updateChartData(biologyQuotaChart, mcqs.biology || 0, 150);
        }

        // --- IMPORTANT: Placeholder for functions you need to implement/flesh out ---
        function renderUpcomingPlans() { /* Renders `upcomingPlansData` into `upcomingPlansDisplay` */ }
        function renderBacklogs() { /* Filters `upcomingPlansData` for overdue items and renders them */ }
        function renderCompletedTasks() { /* Renders `completedTasksData` into `completedLogDisplay` */ }
        // All original functions like saveUTData, getAIPerformanceInsights etc. remain the same

    </script>
</body>
</html>
